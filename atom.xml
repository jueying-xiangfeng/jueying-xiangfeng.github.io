<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç™½å¤œè¿½å‡¶</title>
  
  <subtitle>Talk is cheap. Show me the code.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-08-15T14:24:18.415Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Key</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å†…å­˜ç®¡ç†åŸç†æ¢ç©¶-ç»­</title>
    <link href="http://yoursite.com/2020/08/14/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-%E7%BB%AD/"/>
    <id>http://yoursite.com/2020/08/14/å†…å­˜ç®¡ç†åŸç†æ¢ç©¶-ç»­/</id>
    <published>2020-08-14T14:07:29.000Z</published>
    <updated>2020-08-15T14:24:18.415Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨åšçš®è‚¤é€‚é…æ—¶é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œè¿›è€Œäº§ç”Ÿäº†å¾ˆå¤šçš„ç–‘é—®ã€‚ä¸‹é¢æ˜¯æƒ³åˆ°äº†ä¸€äº›é—®é¢˜å’Œæœ€ç»ˆå¾—åˆ°çš„éªŒè¯ï¼Œå†…åŠŸå¤ªèœã€‚ä¹‹å‰ä¸€ç›´åœ¨æ€€ç–‘æ˜¯ä»–ä»¬éƒ½å¤ªé£˜äº†è¿˜æ˜¯æˆ‘æ‹¿ä¸åŠ¨åˆ€äº†ã€‚ç°åœ¨çœ‹çœ‹å†…åŠŸå¤ªèœï¼Œç¡®å®æ˜¯æˆ‘æ‰“ä¸åŠ¨åˆ€äº†ã€‚ã€‚ã€‚</p><p>ä¹‹å‰çœ‹ Autorelease æ—¶çŸ¥é“äº†åº•å±‚æ˜¯ç”± AutoreleasePoolPage å®ç°çš„ï¼Œå¹¶ä¸”æ˜¯ç”± RunLoop æ¥é©±åŠ¨çš„ã€‚é‚£ä¹ˆçš„ç–‘é—®å°±æ˜¯æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­æ·»åŠ  Autorelease æ—¶ï¼Œè¿™æ—¶æ²¡æœ‰ RunLoopï¼Œé‚£ä¹ˆ autorelease æ˜¯æ€æ ·å·¥ä½œçš„å‘¢ï¼Ÿ</p><a id="more"></a><p>æœ€è¿‘é‡åˆ°äº†ä¸€ä¸ªç–‘é—®ï¼Œä¹‹å‰çœ‹ Autorelease æ—¶çŸ¥é“äº†åº•å±‚æ˜¯ç”± AutoreleasePoolPage å®ç°çš„ï¼Œå¹¶ä¸”æ˜¯ç”± RunLoop æ¥é©±åŠ¨çš„ã€‚é‚£ä¹ˆçš„ç–‘é—®å°±æ˜¯æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­æ·»åŠ  Autorelease æ—¶ï¼Œè¿™æ—¶æ²¡æœ‰ RunLoopï¼Œé‚£ä¹ˆ autorelease æ˜¯æ€æ ·å·¥ä½œçš„å‘¢ï¼Ÿ</p><p>åœ¨æ•´ç†ä¸Šé¢çš„ç–‘é—®æ—¶è¿˜é‡åˆ°äº†å‡ ä¸ªåˆ«çš„å†…å­˜ç®¡ç†çš„é—®é¢˜ï¼š</p><ul><li>ARC åˆ°åº•æ˜¯æ€æ ·ç®¡ç†å†…å­˜çš„ï¼Œå¹³æ—¶åªçŸ¥é“åœ¨åˆé€‚çš„ä½ç½®å¸®æˆ‘ä»¬releaseï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶æœºæ˜¯åœ¨å“ªé‡Œï¼Ÿ</li><li>weakã€strongã€autoreleasing åœ¨ ARC ä¸‹çš„å…·ä½“å®ç°æ˜¯æ€æ ·çš„ï¼Ÿ</li></ul><h3 id="ARC-å†…å­˜ç®¡ç†åŸç†"><a href="#ARC-å†…å­˜ç®¡ç†åŸç†" class="headerlink" title="ARC å†…å­˜ç®¡ç†åŸç†"></a>ARC å†…å­˜ç®¡ç†åŸç†</h3><p><code>ARC</code>å³OCçš„è‡ªåŠ¨å¼•ç”¨è®¡æ•°æŠ€æœ¯ï¼Œé€šè¿‡åœ¨ç¼–è¯‘é˜¶æ®µè‡ªåŠ¨æ·»åŠ å¼•ç”¨è®¡æ•°ï¼Œè¾¾åˆ°è‡ªåŠ¨ç®¡ç†å¼•ç”¨è®¡æ•°çš„ç›®çš„ã€‚ä½¿ç”¨ARCå¯ä»¥åšåˆ°æ¥è¿‘åƒåœ¾å›æ”¶çš„ä»£ç ç¼–å†™ä½“éªŒï¼ŒåŒæ—¶æ‹¥æœ‰å¼•ç”¨è®¡æ•°çš„æ€§èƒ½ä¸æ•ˆç‡ã€‚é‚£ä¹ˆARCå…·ä½“æ˜¯æ€åšåˆ°è‡ªåŠ¨æ·»åŠ æ·»åŠ å’Œé‡Šæ”¾å¼•ç”¨è®¡æ•°çš„å‘¢ã€‚</p><h4 id="è‡ªåŠ¨-release"><a href="#è‡ªåŠ¨-release" class="headerlink" title="è‡ªåŠ¨ release"></a>è‡ªåŠ¨ release</h4><p>æ¥ä¸€æ®µæµ‹è¯•ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@implementation Person</span><br><span class="line">- (void)test &#123;    </span><br><span class="line">    id a;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>clang -S -fobjc-arc -emit-llvm Person.m -o person_arc.ll</code> å‘½ä»¤æ¥æŸ¥çœ‹ä¸‹ç”Ÿæˆçš„ä¸­é—´ä»£ç ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">define internal void @<span class="string">"\01-[Person test]"</span>(%0*, i8*) #0 &#123;</span><br><span class="line">  %3 = alloca %0*,<span class="built_in"> align </span>8</span><br><span class="line">  %4 = alloca i8*,<span class="built_in"> align </span>8</span><br><span class="line">  %5 = alloca i8*,<span class="built_in"> align </span>8</span><br><span class="line">  store %0* %0, %0** %3,<span class="built_in"> align </span>8</span><br><span class="line">  store i8* %1, i8** %4,<span class="built_in"> align </span>8</span><br><span class="line">  store i8* <span class="literal">null</span>, i8** %5,<span class="built_in"> align </span>8</span><br><span class="line">  call void @llvm.objc.storeStrong(i8** %5, i8* <span class="literal">null</span>) #2</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> alloca æ˜¯åœ¨å½“å‰æ‰§è¡Œçš„å‡½æ•°å †æ ˆå¸§ä¸­åˆ†é…å†…å­˜ã€‚store åˆ™è¡¨ç¤ºå°†å€¼å­˜åˆ°æŒ‡å®šåœ°å€ã€‚</p><p>å…³äº llvm è¯­æ³•é—®é¢˜å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š<code>https://llvm.org/docs/LangRef.html</code></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å‡½æ•°ï¼šobjc.storeStrong(i8*<em> %5, i8</em> null)ï¼Œæ¥çœ‹ä¸‹ objc çš„æºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">objc_storeStrong(id *location, id obj)</span><br><span class="line">&#123;</span><br><span class="line">    id prev = *location;</span><br><span class="line">    if (obj == prev) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    objc_retain(obj);</span><br><span class="line">    *location = obj;</span><br><span class="line">    objc_release(prev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…¶æ“ä½œå°±æ˜¯å°† obj åšä¸€æ¬¡ retain æ“ä½œï¼Œç„¶åå†å°† location æŒ‡å‘ objï¼Œæœ€åå°† location åšä¸€æ¬¡ releaseã€‚</p><p>OKï¼Œobjc.storeStrong(i8*<em> %5, i8</em> null) å‡½æ•°å…¶å®å°±æ˜¯å°† location ç½®ç©ºï¼Œå¹¶ä¸”æ˜¯åœ¨å‡½æ•°ä½œç”¨åŸŸç»“æŸæ—¶åšçš„ã€‚</p><h4 id="è‡ªåŠ¨-retain"><a href="#è‡ªåŠ¨-retain" class="headerlink" title="è‡ªåŠ¨ retain"></a>è‡ªåŠ¨ retain</h4><p>å†æ¥åŠ ç‚¹æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (void)test &#123;</span><br><span class="line">    id a;</span><br><span class="line">    __strong id b = a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define internal void @&quot;\01-[Person test]&quot;(%0*, i8*) #0 &#123;</span><br><span class="line">  %3 = alloca %0*, align 8</span><br><span class="line">  %4 = alloca i8*, align 8</span><br><span class="line">  %5 = alloca i8*, align 8</span><br><span class="line">  %6 = alloca i8*, align 8</span><br><span class="line">  store %0* %0, %0** %3, align 8</span><br><span class="line">  store i8* %1, i8** %4, align 8</span><br><span class="line">  store i8* null, i8** %5, align 8</span><br><span class="line">  %7 = load i8*, i8** %5, align 8</span><br><span class="line">  %8 = call i8* @llvm.objc.retain(i8* %7) #1</span><br><span class="line">  store i8* %8, i8** %6, align 8</span><br><span class="line">  call void @llvm.objc.storeStrong(i8** %6, i8* null) #1</span><br><span class="line">  call void @llvm.objc.storeStrong(i8** %5, i8* null) #1</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç»™ b æŒ‡é’ˆèµ‹å€¼æ—¶è°ƒç”¨äº†ä¸€æ¬¡ retainã€‚å¹¶åœ¨å‡½æ•°æœ€åé¢è°ƒç”¨äº†ä¸¤æ¬¡ objc.storeStrongã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨å¼ºæŒ‡é’ˆä¼šè‡ªåŠ¨æ’å…¥ retain æ“ä½œï¼Œè€Œåœ¨ä½œç”¨åŸŸç»“æŸæ—¶ä¼šæ’å…¥ release æ“ä½œã€‚</p><p>å†æ¥è¯•ä¸‹å…¶ä»–ä¿®é¥°ç¬¦ï¼š</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">/// __autoreleasing</span><br><span class="line"><span class="keyword">define</span> <span class="keyword">internal</span> void @<span class="string">"\01-[Person test]"</span>(<span class="symbol">%0</span>*, <span class="keyword">i8</span>*) <span class="symbol">#0</span> &#123;</span><br><span class="line">  <span class="symbol">%3</span> = <span class="keyword">alloca</span> <span class="symbol">%0</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%4</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%5</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%6</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="symbol">%0</span>* <span class="symbol">%0</span>, <span class="symbol">%0</span>** <span class="symbol">%3</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%1</span>, <span class="keyword">i8</span>** <span class="symbol">%4</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="keyword">null</span>, <span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%7</span> = <span class="keyword">load</span> <span class="keyword">i8</span>*, <span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%8</span> = <span class="keyword">call</span> <span class="keyword">i8</span>* <span class="title">@llvm.objc.retainAutorelease</span>(<span class="keyword">i8</span>* <span class="symbol">%7</span>) <span class="symbol">#1</span>// æ³¨æ„è¿™é‡Œ</span><br><span class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%8</span>, <span class="keyword">i8</span>** <span class="symbol">%6</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">call</span> void <span class="title">@llvm.objc.storeStrong</span>(<span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">i8</span>* <span class="keyword">null</span>) <span class="symbol">#1</span></span><br><span class="line">  <span class="keyword">ret</span> void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// __weak</span><br><span class="line"><span class="keyword">define</span> <span class="keyword">internal</span> void @<span class="string">"\01-[Person test]"</span>(<span class="symbol">%0</span>*, <span class="keyword">i8</span>*) <span class="symbol">#0</span> &#123;</span><br><span class="line">  <span class="symbol">%3</span> = <span class="keyword">alloca</span> <span class="symbol">%0</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%4</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%5</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%6</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="symbol">%0</span>* <span class="symbol">%0</span>, <span class="symbol">%0</span>** <span class="symbol">%3</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%1</span>, <span class="keyword">i8</span>** <span class="symbol">%4</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="keyword">null</span>, <span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%7</span> = <span class="keyword">load</span> <span class="keyword">i8</span>*, <span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%8</span> = <span class="keyword">call</span> <span class="keyword">i8</span>* <span class="title">@llvm.objc.initWeak</span>(<span class="keyword">i8</span>** <span class="symbol">%6</span>, <span class="keyword">i8</span>* <span class="symbol">%7</span>) <span class="symbol">#1</span></span><br><span class="line">  <span class="keyword">call</span> void <span class="title">@llvm.objc.destroyWeak</span>(<span class="keyword">i8</span>** <span class="symbol">%6</span>) <span class="symbol">#1</span></span><br><span class="line">  <span class="keyword">call</span> void <span class="title">@llvm.objc.storeStrong</span>(<span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">i8</span>* <span class="keyword">null</span>) <span class="symbol">#1</span></span><br><span class="line">  <span class="keyword">ret</span> void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// __unsafe_unretained</span><br><span class="line"><span class="keyword">define</span> <span class="keyword">internal</span> void @<span class="string">"\01-[Person test]"</span>(<span class="symbol">%0</span>*, <span class="keyword">i8</span>*) <span class="symbol">#0</span> &#123;</span><br><span class="line">  <span class="symbol">%3</span> = <span class="keyword">alloca</span> <span class="symbol">%0</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%4</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%5</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%6</span> = <span class="keyword">alloca</span> <span class="keyword">i8</span>*, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="symbol">%0</span>* <span class="symbol">%0</span>, <span class="symbol">%0</span>** <span class="symbol">%3</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%1</span>, <span class="keyword">i8</span>** <span class="symbol">%4</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="keyword">null</span>, <span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="symbol">%7</span> = <span class="keyword">load</span> <span class="keyword">i8</span>*, <span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">align</span> <span class="number">8</span>// æ³¨æ„è¿™é‡Œæ˜¯ç›´æ¥èµ‹å€¼</span><br><span class="line">  <span class="keyword">store</span> <span class="keyword">i8</span>* <span class="symbol">%7</span>, <span class="keyword">i8</span>** <span class="symbol">%6</span>, <span class="keyword">align</span> <span class="number">8</span></span><br><span class="line">  <span class="keyword">call</span> void <span class="title">@llvm.objc.storeStrong</span>(<span class="keyword">i8</span>** <span class="symbol">%5</span>, <span class="keyword">i8</span>* <span class="keyword">null</span>) <span class="symbol">#1</span></span><br><span class="line">  <span class="keyword">ret</span> void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>__autoreleasing å…¶å®å…¶å®å°±æ˜¯è°ƒç”¨ objc_retainAutorelease æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/// å¯¹ obj åšä¸€æ¬¡ retain æ“ä½œï¼Œç„¶ååŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± </span><br><span class="line">id objc_retainAutorelease(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    return objc_autorelease(objc_retain(obj));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>__weak æ˜¯è°ƒç”¨ objc_initWeak å¯¹ weak å¯¹è±¡èµ‹å€¼ï¼Œåœ¨ä½œç”¨åŸŸç»“æŸæ—¶è°ƒç”¨ objc_destryWeak è¿›è¡Œé‡Šæ”¾ã€‚</p><p>__unsafe_unretained åˆ™åªæ˜¯è¿›è¡ŒæŒ‡é’ˆçš„èµ‹å€¼ï¼Œå¹¶ä¸è€ƒè™‘å¼•ç”¨è®¡æ•°ç›¸å…³çš„é—®é¢˜ã€‚</p><p>ç»¼ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒARC ä¼šè‡ªåŠ¨çš„åœ¨èµ‹å€¼è¯­å¥ä¹‹å‰æ’å…¥ä¸€äº›å¼•ç”¨è®¡æ•°ç›¸å…³çš„å‡½æ•°ï¼Œè¿™å°±æ˜¯ ARC å®ç°çš„ä¸»è¦åŸç†ã€‚</p><h4 id="å¯¹-retainã€release-çš„ä¸€äº›ä¼˜åŒ–"><a href="#å¯¹-retainã€release-çš„ä¸€äº›ä¼˜åŒ–" class="headerlink" title="å¯¹ retainã€release çš„ä¸€äº›ä¼˜åŒ–"></a>å¯¹ retainã€release çš„ä¸€äº›ä¼˜åŒ–</h4><p><code>ARC</code>å¯¹äºä»¥<code>new</code>ã€<code>copy</code>ã€<code>mutableCopy</code>å’Œ<code>alloc</code>ä»¥åŠ ä»¥è¿™å››ä¸ªå•è¯å¼€å¤´çš„æ‰€æœ‰å‡½æ•°ï¼Œé»˜è®¤è®¤ä¸ºå‡½æ•°è¿”å›å€¼ç›´æ¥æŒæœ‰å¯¹è±¡ã€‚è¿™æ˜¯ARCä¸­å¿…é¡»è¦éµå®ˆçš„å‘½åè§„åˆ™ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)newPerson &#123;</span><br><span class="line">    Person * p = [Person new];    </span><br><span class="line">    return p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (instancetype)createPerson &#123;</span><br><span class="line">    Person * p = [Person new];</span><br><span class="line">    return p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define internal i8* @&quot;\01+[Person newPerson]&quot;(i8*, i8*) #0 &#123;</span><br><span class="line">  %3 = alloca i8*, align 8</span><br><span class="line">  %4 = alloca i8*, align 8</span><br><span class="line">  %5 = alloca %0*, align 8</span><br><span class="line">  store i8* %0, i8** %3, align 8</span><br><span class="line">  store i8* %1, i8** %4, align 8</span><br><span class="line">  %6 = load %struct._class_t*, %struct._class_t** @&quot;OBJC_CLASSLIST_REFERENCES_$_&quot;, align 8</span><br><span class="line">  %7 = bitcast %struct._class_t* %6 to i8*</span><br><span class="line">  %8 = call i8* @objc_opt_new(i8* %7)</span><br><span class="line">  %9 = bitcast i8* %8 to %0*</span><br><span class="line">  store %0* %9, %0** %5, align 8</span><br><span class="line">  %10 = load %0*, %0** %5, align 8</span><br><span class="line">  %11 = bitcast %0* %10 to i8*</span><br><span class="line">  %12 = call i8* @llvm.objc.retain(i8* %11) #1</span><br><span class="line">  %13 = bitcast i8* %12 to %0*</span><br><span class="line">  %14 = bitcast %0* %13 to i8*</span><br><span class="line">  %15 = bitcast %0** %5 to i8**</span><br><span class="line">  call void @llvm.objc.storeStrong(i8** %15, i8* null) #1</span><br><span class="line">  ret i8* %14</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define internal i8* @&quot;\01+[Person createPerson]&quot;(i8*, i8*) #0 &#123;</span><br><span class="line">  %3 = alloca i8*, align 8</span><br><span class="line">  %4 = alloca i8*, align 8</span><br><span class="line">  %5 = alloca %0*, align 8</span><br><span class="line">  store i8* %0, i8** %3, align 8</span><br><span class="line">  store i8* %1, i8** %4, align 8</span><br><span class="line">  %6 = load %struct._class_t*, %struct._class_t** @&quot;OBJC_CLASSLIST_REFERENCES_$_&quot;, align 8</span><br><span class="line">  %7 = bitcast %struct._class_t* %6 to i8*</span><br><span class="line">  %8 = call i8* @objc_opt_new(i8* %7)</span><br><span class="line">  %9 = bitcast i8* %8 to %0*</span><br><span class="line">  store %0* %9, %0** %5, align 8</span><br><span class="line">  %10 = load %0*, %0** %5, align 8</span><br><span class="line">  %11 = bitcast %0* %10 to i8*</span><br><span class="line">  %12 = call i8* @llvm.objc.retain(i8* %11) #1</span><br><span class="line">  %13 = bitcast i8* %12 to %0*</span><br><span class="line">  %14 = bitcast %0* %13 to i8*</span><br><span class="line">  %15 = bitcast %0** %5 to i8**</span><br><span class="line">  call void @llvm.objc.storeStrong(i8** %15, i8* null) #1</span><br><span class="line">  %16 = tail call i8* @llvm.objc.autoreleaseReturnValue(i8* %14) #1</span><br><span class="line">  ret i8* %16</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•° <code>newPerson</code> ä¸­ï¼Œå‡½æ•°çš„è¿”å›å€¼ä¸å¸¦ autoreleaseï¼Œæ˜¯ç›´æ¥æŒæœ‰å¯¹è±¡ã€‚è€Œå‡½æ•° <code>createPerson</code> ä¸­è¿”å›å¯¹è±¡çš„æœ€åä¸€æ­¥ä¼šè°ƒç”¨ <code>autoreleaseReturnValue</code>ã€‚</p><p>å†æ¥çœ‹ä¸‹ä½¿ç”¨èµ‹å€¼çš„æ—¶å€™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (void)test &#123;</span><br><span class="line">    Person * a = [Person createPerson];</span><br><span class="line">    Person * b = [Person newPerson];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define internal void @&quot;\01-[Person test]&quot;(%0*, i8*) #1 &#123;</span><br><span class="line">  %3 = alloca %0*, align 8</span><br><span class="line">  %4 = alloca i8*, align 8</span><br><span class="line">  %5 = alloca %0*, align 8</span><br><span class="line">  %6 = alloca %0*, align 8</span><br><span class="line">  store %0* %0, %0** %3, align 8</span><br><span class="line">  store i8* %1, i8** %4, align 8</span><br><span class="line">  %7 = load %struct._class_t*, %struct._class_t** @&quot;OBJC_CLASSLIST_REFERENCES_$_&quot;, align 8</span><br><span class="line">  %8 = load i8*, i8** @OBJC_SELECTOR_REFERENCES_, align 8, !invariant.load !9</span><br><span class="line">  %9 = bitcast %struct._class_t* %7 to i8*</span><br><span class="line">  %10 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %9, i8* %8)</span><br><span class="line">  %11 = notail call i8* @llvm.objc.retainAutoreleasedReturnValue(i8* %10) #2</span><br><span class="line">  %12 = bitcast i8* %11 to %0*</span><br><span class="line">  store %0* %12, %0** %5, align 8</span><br><span class="line">  %13 = load %struct._class_t*, %struct._class_t** @&quot;OBJC_CLASSLIST_REFERENCES_$_&quot;, align 8</span><br><span class="line">  %14 = load i8*, i8** @OBJC_SELECTOR_REFERENCES_.2, align 8, !invariant.load !9</span><br><span class="line">  %15 = bitcast %struct._class_t* %13 to i8*</span><br><span class="line">  %16 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %15, i8* %14)</span><br><span class="line">  %17 = bitcast i8* %16 to %0*</span><br><span class="line">  store %0* %17, %0** %6, align 8</span><br><span class="line">  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*))</span><br><span class="line">  %18 = bitcast %0** %6 to i8**</span><br><span class="line">  call void @llvm.objc.storeStrong(i8** %18, i8* null) #2</span><br><span class="line">  %19 = bitcast %0** %5 to i8**</span><br><span class="line">  call void @llvm.objc.storeStrong(i8** %19, i8* null) #2</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œèµ‹å€¼å‰ä¸ä¼šå¯¹ <code>[Person newPerson]</code> è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå¤–é¢æ˜¯ä¸€ä¸ª strong æŒ‡é’ˆï¼Œè€Œè¿”å›çš„å¯¹è±¡å·²ç»æŒæœ‰å¼•ç”¨è®¡æ•°ã€‚</p><p>è€Œå¯¹ <code>[Person createPerson]</code> çš„è¿”å›å€¼éœ€è¦ retainï¼Œå› ä¸ºå‡½æ•°å¯¹è¿”å›çš„å¯¹è±¡è¿›è¡Œäº†ä¸€æ¬¡ autoreleaseReturnValue æ“ä½œï¼Œå’Œå‰é¢çš„ retain æ“ä½œå¯¹åº”ï¼Œæ­£å¥½è¾¾åˆ°å¼•ç”¨è®¡æ•°å™¨çš„åŠ å‡å¹³è¡¡ï¼Œæ‰€ä»¥å¤–é¢çš„ strong æŒ‡é’ˆéœ€è¦å¯¹è¿”å›å€¼è¿›è¡ŒæŒæœ‰ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªARC çš„ä¼˜åŒ–ï¼Œå¦‚æœè¿”å›å€¼ä½¿ç”¨äº† <code>objc_autoreleaseReturnValue</code>å‡½æ•°ï¼Œåˆ™åœ¨èµ‹å€¼æ—¶å¯¹åº”ä½¿ç”¨ <code>objc_retainAutoreleasedReturnValue</code> å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// Prepare a value at +1 for return through a +0 autoreleasing convention.</span><br><span class="line">id </span><br><span class="line">objc_autoreleaseReturnValue(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (prepareOptimizedReturn(ReturnAtPlus1)) return obj;</span><br><span class="line"></span><br><span class="line">    return objc_autorelease(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Accept a value returned through a +0 autoreleasing convention for use at +1.</span><br><span class="line">id</span><br><span class="line">objc_retainAutoreleasedReturnValue(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (acceptOptimizedReturn() == ReturnAtPlus1) return obj;</span><br><span class="line"></span><br><span class="line">    return objc_retain(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ARC å¯¹å†…å­˜è°ƒç”¨å‡½æ•°è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå³ ARC ç›¸å…³çš„å‡½æ•°ä¸é€šè¿‡ OC çš„æ¶ˆæ¯å‘é€æœºåˆ¶ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨åº•å±‚çš„ C å‡½æ•°ï¼Œè€Œä¸” ARC æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µæœ‰ç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ å¼•ç”¨è®¡æ•°å‡½æ•°è°ƒç”¨ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶åˆ¤æ–­ã€‚ç»¼ä¸Šï¼ŒARC æ€§èƒ½è¦ä¼˜äº MRCã€‚</p><h5 id="PerformSelector-é—®é¢˜"><a href="#PerformSelector-é—®é¢˜" class="headerlink" title="PerformSelector é—®é¢˜"></a>PerformSelector é—®é¢˜</h5><p>å½“æˆ‘ä»¬è°ƒç”¨ performSelector æ—¶æ¥çœ‹ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„è­¦å‘Šï¼š</p><p><code>PerformSelector may cause a leak because its selector is unknown</code></p><p>å½“æˆ‘ä»¬äº†è§£å®Œ ARC çš„åŸç†åï¼Œè¿™ä¸ªå°±ä¸éš¾è§£é‡Šäº†ï¼Œå¯¹äº <code>performSelector</code> è¿”å›å€¼æ˜¯ idï¼Œå¯¹äºä»¥ä¸‹è°ƒç”¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)newP &#123;    </span><br><span class="line">    return [Person new];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test &#123;</span><br><span class="line">    SEL sel = NSSelectorFromString(@&quot;newP&quot;);</span><br><span class="line">    Person * person = [self performSelector:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ person ä¸ºå¼ºæŒ‡é’ˆï¼Œä¼šå¯¹ performSelector çš„è¿”å›å€¼è¿›è¡Œä¸€æ¬¡ retain æ“ä½œï¼Œç„¶ååœ¨ person ç¦»å¼€ä½œç”¨åŸŸæ—¶è¿›è¡Œä¸€æ¬¡ release æ“ä½œã€‚</p><p>è€Œå¦‚æœ sel æ˜¯ä»¥ newã€copyã€mutableCopyã€alloc å¼€å¤´çš„ï¼Œåˆ™è¿”å›çš„å¯¹è±¡æ—¶å¸¦æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°çš„ï¼Œæ‰€ä»¥ person åªè¿›è¡Œäº†ä¸€æ¬¡ retain å’Œä¸€æ¬¡ releaseï¼Œæ­¤æ—¶å¼•ç”¨è®¡æ•°è¿˜æ˜¯ä¸º 1ï¼Œè¿™å°±ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼é—®é¢˜ã€‚</p><h5 id="NSInvocation-è¿”å›å€¼é—®é¢˜"><a href="#NSInvocation-è¿”å›å€¼é—®é¢˜" class="headerlink" title="NSInvocation è¿”å›å€¼é—®é¢˜"></a>NSInvocation è¿”å›å€¼é—®é¢˜</h5><p>å½“æˆ‘ä»¬ä½¿ç”¨ NSInvocation çš„ <code>getReturnValue</code>è·å–è¿”å›å€¼æ—¶ï¼Œçœ‹è‹¹æœçš„å£°æ˜ï¼Œè¿™ä¸ªå‡½æ•°ç”±äºä¸çŸ¥é“è¿”å›å€¼ç±»å‹ï¼Œåªè¿›è¡ŒæŒ‡é’ˆèµ‹å€¼ä¸è¿›è¡Œå¯¹è±¡çš„å†…å­˜ç®¡ç†æ“ä½œï¼Œæ‰€ä»¥ç»“åˆä¸Šé¢è®²åˆ°çš„ ARC å†…å­˜ç®¡ç†é—®é¢˜æˆ‘ä»¬å°±è¦è€ƒè™‘å¦‚ä½•é¿å…å†…å­˜é—®é¢˜ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)newP &#123;</span><br><span class="line">    return [Person new];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)createPerson &#123;</span><br><span class="line">    return [Person new];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test &#123;</span><br><span class="line">    Person * targetPerson = [Person new];</span><br><span class="line">    SEL sel = @selector(newP);</span><br><span class="line">    NSMethodSignature * signature = [self methodSignatureForSelector:sel];</span><br><span class="line">    NSInvocation * invocation = [NSInvocation invocationWithMethodSignature:signature];</span><br><span class="line">    invocation.selector = sel;</span><br><span class="line">    [invocation invokeWithTarget:targetPerson];</span><br><span class="line">    </span><br><span class="line">    __strong Person * returnValue;</span><br><span class="line">    [invocation getReturnValue:&amp;returnValue];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå½“è¢«è°ƒç”¨å‡½æ•°æ˜¯ä»¥<code>new</code>ï¼Œ<code>copy</code>,<code>mutableCopy</code>å’Œ<code>alloc</code>å¼€å¤´çš„ç‰¹æ®Šå‡½æ•°æ—¶ï¼Œå‡½æ•°è¿”å›çš„çš„å¯¹è±¡æŒæœ‰å¼•ç”¨è®¡æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¾ç½®<code>returnValue</code>çš„ç±»å‹æ˜¯<code>__strong</code>ï¼Œè¿™æ ·åœ¨è¿™ä¸ª<code>returnValue</code>çš„ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œä¼šè¿›è¡Œ<code>release</code>ï¼Œå†…å­˜å¤„ç†æ­£å¸¸ã€‚</p><p>å½“è¢«è°ƒç”¨çš„å‡½æ•°æ˜¯ createPerson æ—¶ï¼Œç”±äºå‡½æ•°å†…éƒ¨æœ€åæ‰§è¡Œäº† autoreleaseï¼Œå¦‚æœæ­¤æ—¶æˆ‘ä»¬å†ä½¿ç”¨ strong æŒ‡é’ˆçš„è¯ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼é—®é¢˜ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦ä½¿ç”¨ autoreleasing æ¥ä¿®é¥° returnValueã€‚</p><h3 id="å­çº¿ç¨‹çš„-Autorelease-æ˜¯æ€æ ·ç»´æŠ¤çš„"><a href="#å­çº¿ç¨‹çš„-Autorelease-æ˜¯æ€æ ·ç»´æŠ¤çš„" class="headerlink" title="å­çº¿ç¨‹çš„ Autorelease æ˜¯æ€æ ·ç»´æŠ¤çš„"></a>å­çº¿ç¨‹çš„ Autorelease æ˜¯æ€æ ·ç»´æŠ¤çš„</h3><p>å‰é¢ä¸€ç« ä¸­æˆ‘ä»¬çŸ¥é“äº†ä¸»çº¿ç¨‹çš„ autorelease å¯¹è±¡æ˜¯ç”± AutoreleasePoolPage å¯¹è±¡ç®¡ç†çš„ï¼Œå¹¶ä¸” AutoreleasePoolPage çš„push å’Œ pop æ“ä½œæ˜¯ç”±ä¸»çº¿ç¨‹ä¸­åœ¨ RunLoop ä¸­æ³¨å†Œçš„ä¸¤ä¸ª observer ç»´æŠ¤çš„ã€‚é‚£ä¹ˆåœ¨å­çº¿ç¨‹ä¸­ autorelease å¯¹è±¡æ˜¯å¦‚ä½•ç»´æŠ¤çš„å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çŸ¥é“å­çº¿ç¨‹ä¸€èˆ¬æ˜¯æ²¡æœ‰ RunLoopçš„ï¼Œé‚£ä¹ˆåœ¨å­çº¿ç¨‹ä¸­æ˜¯å¦‚ä½•ç»´æŠ¤çš„å‘¢ï¼Ÿæ¥æºç ä¸­æ‰¾ä¸‹ç­”æ¡ˆï¼š</p><p>å­çº¿ç¨‹ AutoreleasePoolPage åˆ›å»º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((noinline,used))</span><br><span class="line">id </span><br><span class="line">objc_object::rootAutorelease2()</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(!isTaggedPointer());</span><br><span class="line">    // åŠ å…¥ autorealease å¯¹è±¡åˆ° page çš„å…¥å£å‡½æ•°</span><br><span class="line">    return AutoreleasePoolPage::autorelease((id)this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline id autorelease(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(obj);</span><br><span class="line">    ASSERT(!obj-&gt;isTaggedPointer());</span><br><span class="line">    // è°ƒç”¨ autoreleaseFast</span><br><span class="line">    id *dest __unused = autoreleaseFast(obj);</span><br><span class="line">    ASSERT(!dest  ||  dest == EMPTY_POOL_PLACEHOLDER  ||  *dest == obj);</span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline id *autoreleaseFast(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    AutoreleasePoolPage *page = hotPage();</span><br><span class="line">    if (page &amp;&amp; !page-&gt;full()) &#123;</span><br><span class="line">        return page-&gt;add(obj);</span><br><span class="line">    &#125; else if (page) &#123;</span><br><span class="line">        return autoreleaseFullPage(obj, page);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // å¦‚æœå½“å‰ page ä¸ºç©º</span><br><span class="line">        return autoreleaseNoPage(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static __attribute__((noinline))</span><br><span class="line">id *autoreleaseNoPage(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(!hotPage());</span><br><span class="line"></span><br><span class="line">    bool pushExtraBoundary = false;</span><br><span class="line">    if (haveEmptyPoolPlaceholder()) &#123;</span><br><span class="line">        pushExtraBoundary = true;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (obj != POOL_BOUNDARY  &amp;&amp;  DebugMissingPools) &#123;</span><br><span class="line">        objc_autoreleaseNoPool(obj);</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (obj == POOL_BOUNDARY  &amp;&amp;  !DebugPoolAllocation) &#123;</span><br><span class="line">        return setEmptyPoolPlaceholder();</span><br><span class="line">    &#125;</span><br><span class="line">    // Install the first page.</span><br><span class="line">    // å…³é”®æ¥äº†ï¼šå¦‚æœ page ä¸ºç©ºåˆ™åˆ›å»º page å¯¹è±¡</span><br><span class="line">    AutoreleasePoolPage *page = new AutoreleasePoolPage(nil);</span><br><span class="line">    setHotPage(page);</span><br><span class="line">    </span><br><span class="line">    // Push a boundary on behalf of the previously-placeholder&apos;d pool.</span><br><span class="line">    if (pushExtraBoundary) &#123;</span><br><span class="line">        page-&gt;add(POOL_BOUNDARY);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Push the requested object or pool.</span><br><span class="line">    return page-&gt;add(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­çº¿ç¨‹ AutoreleasePoolPage ç®¡ç†å¯¹è±¡çš„é‡Šæ”¾ï¼Œåœ¨çº¿ç¨‹é€€å‡ºæ—¶ä¼šè°ƒç”¨ <code>pthread_exit</code>æ–¹æ³•ï¼Œæœ€ç»ˆå›æ¥åˆ° <code>tls_dealloc</code> å‡½æ•°ã€‚ç”±äº objc çš„æºç ä¸èƒ½è°ƒè¯•åˆ° pthread_exit æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªèƒ½çœ‹å…³äº AutoreleasePoolPage çš„ç›¸å…³æºç ï¼Œå½“ if (!page-&gt;empty()) æ»¡è¶³æ—¶æ‰§è¡Œï¼šobjc_autoreleasePoolPop(page-&gt;begin()); æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static void tls_dealloc(void *p) </span><br><span class="line">&#123;</span><br><span class="line">    if (p == (void*)EMPTY_POOL_PLACEHOLDER) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // reinstate TLS value while we work</span><br><span class="line">    setHotPage((AutoreleasePoolPage *)p);</span><br><span class="line"></span><br><span class="line">    if (AutoreleasePoolPage *page = coldPage()) &#123;</span><br><span class="line">        if (!page-&gt;empty()) objc_autoreleasePoolPop(page-&gt;begin());  // pop all of the pools</span><br><span class="line">        if (slowpath(DebugMissingPools || DebugPoolAllocation)) &#123;</span><br><span class="line">            // pop() killed the pages already</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            page-&gt;kill();  // free all of the pages</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // clear TLS value so TLS destruction doesn&apos;t loop</span><br><span class="line">    setHotPage(nil);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œå­çº¿ç¨‹çš„ autorelease å¯¹è±¡ä¹Ÿæ˜¯ç”± AutoreleasePoolPage æ¥ç®¡ç†çš„ï¼Œå†åŠ å…¥pageæ—¶å¦‚æœ page ä¸ºç©ºåˆ™æ–°å»ºä¸€ä¸ªã€‚</p><p>åœ¨çº¿ç¨‹é€€å‡ºæ—¶åˆ™ä¼šè°ƒç”¨ <code>tls_dealloc</code> æ–¹æ³•ï¼Œç„¶åè¿›è¡Œ pop æ“ä½œ æ¥é‡Šæ”¾æ‰€æœ‰ç›¸å…³çš„ autorelease å¯¹è±¡ã€‚</p><p>å‚è€ƒï¼š</p><ul><li><a href="[https://suhou.github.io/2018/01/21/%E5%B8%A6%E7%9D%80%E9%97%AE%E9%A2%98%E7%9C%8B%E6%BA%90%E7%A0%81----%E5%AD%90%E7%BA%BF%E7%A8%8BAutoRelease%E5%AF%B9%E8%B1%A1%E4%BD%95%E6%97%B6%E9%87%8A%E6%94%BE/](https://suhou.github.io/2018/01/21/å¸¦ç€é—®é¢˜çœ‹æºç ----å­çº¿ç¨‹AutoReleaseå¯¹è±¡ä½•æ—¶é‡Šæ”¾/">å¸¦ç€é—®é¢˜çœ‹æºç â€”-å­çº¿ç¨‹AutoReleaseå¯¹è±¡ä½•æ—¶é‡Šæ”¾</a>)</li><li><a href="http://luoxianming.cn/2017/05/06/arc/" target="_blank" rel="noopener">ARCåŸç†æ¢ç©¶</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åœ¨åšçš®è‚¤é€‚é…æ—¶é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œè¿›è€Œäº§ç”Ÿäº†å¾ˆå¤šçš„ç–‘é—®ã€‚ä¸‹é¢æ˜¯æƒ³åˆ°äº†ä¸€äº›é—®é¢˜å’Œæœ€ç»ˆå¾—åˆ°çš„éªŒè¯ï¼Œå†…åŠŸå¤ªèœã€‚ä¹‹å‰ä¸€ç›´åœ¨æ€€ç–‘æ˜¯ä»–ä»¬éƒ½å¤ªé£˜äº†è¿˜æ˜¯æˆ‘æ‹¿ä¸åŠ¨åˆ€äº†ã€‚ç°åœ¨çœ‹çœ‹å†…åŠŸå¤ªèœï¼Œç¡®å®æ˜¯æˆ‘æ‰“ä¸åŠ¨åˆ€äº†ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹å‰çœ‹ Autorelease æ—¶çŸ¥é“äº†åº•å±‚æ˜¯ç”± AutoreleasePoolPage å®ç°çš„ï¼Œå¹¶ä¸”æ˜¯ç”± RunLoop æ¥é©±åŠ¨çš„ã€‚é‚£ä¹ˆçš„ç–‘é—®å°±æ˜¯æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­æ·»åŠ  Autorelease æ—¶ï¼Œè¿™æ—¶æ²¡æœ‰ RunLoopï¼Œé‚£ä¹ˆ autorelease æ˜¯æ€æ ·å·¥ä½œçš„å‘¢ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
    
      <category term="å†…å­˜ç®¡ç†ã€RunLoopã€Autorelease" scheme="http://yoursite.com/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E3%80%81RunLoop%E3%80%81Autorelease/"/>
    
  </entry>
  
  <entry>
    <title>å†…å­˜ç®¡ç†åŸç†æ¢ç©¶</title>
    <link href="http://yoursite.com/2020/08/08/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/"/>
    <id>http://yoursite.com/2020/08/08/å†…å­˜ç®¡ç†åŸç†æ¢ç©¶/</id>
    <published>2020-08-08T08:42:16.000Z</published>
    <updated>2020-08-15T14:24:20.984Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æ—¶é—´æ¯”è¾ƒæ•£ï¼Œè¿˜æœ‰å°±æ˜¯å…¬å¸æ¯”è¾ƒåŠ¨è¡ğŸ˜Œï¼Œå½“åˆæ€€ç€ä¸€é¢—åšäº‹çš„å¿ƒæ¥åˆ°è¿™é‡Œï¼Œæ²¡æƒ³åˆ°æœ€åè½å¾—è¿™æ ·çš„ç»“å±€ã€‚ä¸è¯´äº†ï¼Œè¿˜æ˜¯ä¿æŒæœ¬å¿ƒæ¯”è¾ƒå¥½ï¼Œå°½ç®¡æƒ³åšå¥½é£è¯»ï¼Œä½†æ˜¯æˆ‘ä»¬å°èŒå‘˜ä¹Ÿæ”¹å˜ä¸äº†ä»€ä¹ˆã€‚åšå¥½è‡ªå·±çš„äº‹æƒ…å°±å¥½ï¼ŒæŒ‰ç€å­¦ä¹ è®¡åˆ’ç»§ç»­ã€‚ã€‚ã€‚</p><a id="more"></a><h3 id="å®šæ—¶å™¨"><a href="#å®šæ—¶å™¨" class="headerlink" title="å®šæ—¶å™¨"></a>å®šæ—¶å™¨</h3><p>iOS çš„å†…å­˜ç®¡ç†å¿…ç„¶å°‘ä¸äº†å®šæ—¶å™¨ï¼Œä»¥å‰æ²¡æœ‰æ·±ç©¶è¿‡å…·ä½“çš„åŸç†ï¼ŒåªçŸ¥é“ timer ä¼šå¯¹ target äº§ç”Ÿå¼ºå¼•ç”¨ï¼Œç°åœ¨æ¥åˆ†æä¸‹ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå¼ºå¼•ç”¨ä»¥åŠæ€æ ·è§£å†³ã€‚</p><p>å…ˆæ¥çœ‹ä¸€æ®µæµ‹è¯•ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)testTimer &#123;   </span><br><span class="line">    self.timer = [NSTimer timerWithTimeInterval:1 target:self selector:@selector(timerAction) userInfo:nil repeats:YES];</span><br><span class="line">    [[NSRunLoop currentRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)timerAction &#123;</span><br><span class="line">    NSLog(@&quot;-- %s&quot;, __func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œå½“æˆ‘ä»¬é”€æ¯æ§åˆ¶å™¨æ—¶æ²¡æœ‰è°ƒç”¨ dealloc æ–¹æ³•ï¼Œ è¯´æ˜æ­¤æ—¶æœ‰å¾ªç¯å¼•ç”¨ã€‚ä¹‹å‰åªæ˜¯çŸ¥é“ timer ä¼šå¯¹ self äº§ç”Ÿå¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆå…·ä½“æ€ä¹ˆäº§ç”Ÿçš„å‘¢ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹ <a href="http://www.gnustep.org/resources/downloads.php" target="_blank" rel="noopener">GNU</a> æºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (id) initWithFireDate: (NSDate*)fd</span><br><span class="line">       interval: (NSTimeInterval)ti</span><br><span class="line"> target: (id)object</span><br><span class="line">       selector: (SEL)selector</span><br><span class="line">       userInfo: (id)info</span><br><span class="line">repeats: (BOOL)f</span><br><span class="line">&#123;</span><br><span class="line">  if (ti &lt;= 0.0)</span><br><span class="line">    &#123;</span><br><span class="line">      ti = 0.0001;</span><br><span class="line">    &#125;</span><br><span class="line">  if (fd == nil)</span><br><span class="line">    &#123;</span><br><span class="line">      _date = [[NSDate_class allocWithZone: NSDefaultMallocZone()]</span><br><span class="line">        initWithTimeIntervalSinceNow: ti];</span><br><span class="line">    &#125;</span><br><span class="line">  else</span><br><span class="line">    &#123;</span><br><span class="line">      _date = [fd copyWithZone: NSDefaultMallocZone()];</span><br><span class="line">    &#125;</span><br><span class="line">  _target = RETAIN(object);</span><br><span class="line">  _selector = selector;</span><br><span class="line">  _info = RETAIN(info);</span><br><span class="line">  if (f == YES)</span><br><span class="line">    &#123;</span><br><span class="line">      _repeats = YES;</span><br><span class="line">      _interval = ti;</span><br><span class="line">    &#125;</span><br><span class="line">  else</span><br><span class="line">    &#123;</span><br><span class="line">      _repeats = NO;</span><br><span class="line">      _interval = 0.0;</span><br><span class="line">    &#125;</span><br><span class="line">  return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå¯ä»¥çœ‹å‡º timer ä¼šå¯¹ target åšä¸€æ¬¡ retain æ“ä½œï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆä½¿ç”¨ __weak è§£å†³ä¸äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå› ä¸ºä¸ç®¡ target ä¼ å…¥ self è¿˜æ˜¯ weakSelfï¼Œtimer éƒ½ä¼šå¯¹ self åšä¸€æ¬¡ retain æ“ä½œã€‚</p><p><br></p><p>è¦æƒ³è§£å†³å¾ªç¯å¼•ç”¨ï¼Œé‚£ä¹ˆç›´æ¥çš„åŠæ³•å°±æ˜¯æ·»åŠ ä¸€ä¸ªä¸­é—´ä»£ç†ï¼Œä½¿ç”¨åˆ°äº† NSProxyï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@interface TargetProxy : NSProxy</span><br><span class="line">@property (nonatomic, weak) id target;</span><br><span class="line">+ (instancetype)proxyWithTarget:(id)target;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation TargetProxy</span><br><span class="line">+ (instancetype)proxyWithTarget:(id)target &#123;</span><br><span class="line">    TargetProxy * proxy = [TargetProxy alloc];</span><br><span class="line">    proxy.target = target;</span><br><span class="line">    return proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel &#123;</span><br><span class="line">    return [self.target methodSignatureForSelector:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)invocation &#123;</span><br><span class="line">    [invocation invokeWithTarget:self.target];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ³¨æ„ç‚¹ï¼šå½“ç¨‹åºé€€åˆ°åå°æ—¶ timer å°±ä¼šåœæ­¢ï¼Œå› ä¸º timer æ˜¯åŸºäº RunLoop çš„ï¼Œå¦‚ä¹‹å‰ RunLoop ç« èŠ‚æ‰€è®²ï¼Œ timer ä¹Ÿæ˜¯ä¸ç²¾å‡†çš„ã€‚å¯ä»¥é€šè¿‡æ·»åŠ  observer æ¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œå½“ç¨‹åºé€€åˆ°åå°æ—¶ï¼Œæœ€ç»ˆä¼šèµ°åˆ° kCFRunLoopBeforeWaiting çŠ¶æ€ï¼Œä»è€Œ timer åœæ­¢å·¥ä½œï¼Œå½“ç¨‹åºä»åå°å›åˆ°å‰å°æ—¶ï¼ŒRunLoop åˆä» kCFRunLoopAfterWaiting çŠ¶æ€å¼€å§‹æ‰§è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [self testTimer];</span><br><span class="line">    </span><br><span class="line">    CFRunLoopObserverRef observer = CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, kCFRunLoopAllActivities, YES, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity activity) &#123;</span><br><span class="line">        NSLog(@&quot;%lu&quot;, activity);</span><br><span class="line">    &#125;);</span><br><span class="line">    CFRunLoopAddObserver(CFRunLoopGetMain(), observer, kCFRunLoopCommonModes);</span><br><span class="line">    CFRelease(observer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CADisplayLink</code> åŸç†å’Œ <code>NSTimer</code> ç›¸åŒã€‚</p><p>å¦‚æœæƒ³è¦æ›´ç²¾å‡†çš„è®¾ç½® timerï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ GCD æ¥å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">@interface CTTimer : NSObject</span><br><span class="line">+ (id)executeTask:(dispatch_block_t)task</span><br><span class="line">            start:(NSTimeInterval)star</span><br><span class="line">         interval:(NSTimeInterval)interval</span><br><span class="line">         repeates:(BOOL)repeates</span><br><span class="line">            async:(BOOL)async;</span><br><span class="line"></span><br><span class="line">+ (id)executeWithTarget:(id)target</span><br><span class="line">                 action:(SEL)action</span><br><span class="line">                  start:(NSTimeInterval)star</span><br><span class="line">               interval:(NSTimeInterval)interval</span><br><span class="line">               repeates:(BOOL)repeates</span><br><span class="line">                  async:(BOOL)async;</span><br><span class="line"></span><br><span class="line">+ (void)cancelTask:(id)key;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation CTTimer</span><br><span class="line">static NSMutableDictionary * timers_;</span><br><span class="line">dispatch_semaphore_t semphore_;</span><br><span class="line"></span><br><span class="line">+ (void)initialize &#123;</span><br><span class="line">    timers_ = [NSMutableDictionary dictionary];</span><br><span class="line">    semphore_ = dispatch_semaphore_create(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (id)executeTask:(dispatch_block_t)task</span><br><span class="line">            start:(NSTimeInterval)star</span><br><span class="line">         interval:(NSTimeInterval)interval</span><br><span class="line">         repeates:(BOOL)repeates</span><br><span class="line">            async:(BOOL)async &#123;</span><br><span class="line">    </span><br><span class="line">    if (!task || star &lt; 0 || (interval &lt; 0 &amp;&amp; repeates)) &#123; return nil; &#125;</span><br><span class="line">    </span><br><span class="line">    static dispatch_queue_t _queue;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        _queue = dispatch_queue_create(&quot;queue timer&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_queue_t timerQueue = async ? _queue : dispatch_get_main_queue();</span><br><span class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, timerQueue);</span><br><span class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, star), interval * NSEC_PER_SEC, 0 * NSEC_PER_SEC);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(semphore_, DISPATCH_TIME_FOREVER);</span><br><span class="line">    NSString * key = [NSString stringWithFormat:@&quot;key_%lu&quot;, (unsigned long)timers_.count];</span><br><span class="line">    timers_[key] = timer;</span><br><span class="line">    dispatch_semaphore_signal(semphore_);</span><br><span class="line">    </span><br><span class="line">    dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">        if (task) &#123; task(); &#125;</span><br><span class="line">        if (!repeates) &#123;</span><br><span class="line">            [self cancelTask:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_resume(timer);</span><br><span class="line">    return key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (id)executeWithTarget:(id)target</span><br><span class="line">                 action:(SEL)action</span><br><span class="line">                  start:(NSTimeInterval)star</span><br><span class="line">               interval:(NSTimeInterval)interval</span><br><span class="line">               repeates:(BOOL)repeates</span><br><span class="line">                  async:(BOOL)async &#123;</span><br><span class="line">    </span><br><span class="line">    if (!target || !action) &#123; return nil; &#125;</span><br><span class="line">    </span><br><span class="line">    return [self executeTask:^&#123;</span><br><span class="line">        if ([target respondsToSelector:action]) &#123;</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;</span><br><span class="line">            [target performSelector:action];</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; start:star interval:interval repeates:repeates async:async];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)cancelTask:(id)key &#123;</span><br><span class="line">    if (!key) &#123; return; &#125;</span><br><span class="line">    dispatch_semaphore_wait(semphore_, DISPATCH_TIME_FOREVER);</span><br><span class="line">    dispatch_source_t timer = timers_[key];</span><br><span class="line">    if (timer) &#123;</span><br><span class="line">        dispatch_source_cancel(timer);</span><br><span class="line">        [timers_ removeObjectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_semaphore_signal(semphore_);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><h3 id="iOS-ç¨‹åºå†…å­˜å¸ƒå±€"><a href="#iOS-ç¨‹åºå†…å­˜å¸ƒå±€" class="headerlink" title="iOS ç¨‹åºå†…å­˜å¸ƒå±€"></a>iOS ç¨‹åºå†…å­˜å¸ƒå±€</h3><p>iOS å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80.png" alt="å†…å­˜å¸ƒå±€"></p><p>æ¥åšä¸ªç®€å•éªŒè¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">int a = 10;</span><br><span class="line">int b;</span><br><span class="line"></span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        static int c = 20;</span><br><span class="line">        static int d;</span><br><span class="line">        int e;</span><br><span class="line">        int f = 20;</span><br><span class="line">        NSString *str = @&quot;123&quot;;</span><br><span class="line">        NSObject *obj = [[NSObject alloc] init];</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;\n&amp;a=%p\n&amp;b=%p\n&amp;c=%p\n&amp;d=%p\n&amp;e=%p\n&amp;f=%p\nstr=%p\nobj=%p\n&quot;,</span><br><span class="line">              &amp;a, &amp;b, &amp;c, &amp;d, &amp;e, &amp;f, str, obj);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç»“æœ</span><br><span class="line">/*</span><br><span class="line"> å­—ç¬¦ä¸²å¸¸é‡</span><br><span class="line"> str=0x10dfa0068</span><br><span class="line"> </span><br><span class="line"> å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡</span><br><span class="line"> &amp;a =0x10dfa0db8</span><br><span class="line"> &amp;c =0x10dfa0dbc</span><br><span class="line"> </span><br><span class="line"> æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡</span><br><span class="line"> &amp;d =0x10dfa0e80</span><br><span class="line"> &amp;b =0x10dfa0e84</span><br><span class="line"> </span><br><span class="line"> å †</span><br><span class="line"> obj=0x608000012210</span><br><span class="line"> </span><br><span class="line"> æ ˆ</span><br><span class="line"> &amp;f =0x7ffee1c60fe0</span><br><span class="line"> &amp;e =0x7ffee1c60fe4</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><h3 id="Tagged-Pointer"><a href="#Tagged-Pointer" class="headerlink" title="Tagged Pointer"></a>Tagged Pointer</h3><blockquote><p>ä»64 bit å¼€å§‹ï¼ŒiOS å¼•å…¥äº† TaggedPointer æŠ€æœ¯ï¼Œç”¨äºä¼˜åŒ– NSNumberã€NSDateã€NSString ç­‰å°å¯¹è±¡çš„å­˜å‚¨ã€‚</p><p>åœ¨æ²¡æœ‰ Tagged Pointer ä¹‹å‰ï¼ŒNSNumber ç­‰å¯¹è±¡éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜ã€ç»´æŠ¤å¼•ç”¨è®¡æ•°ç­‰ï¼ŒNSNumber æŒ‡é’ˆå­˜å‚¨çš„æ˜¯å †ä¸­ NSNumber å¯¹è±¡çš„åœ°å€å€¼ã€‚</p><p>åœ¨ä½¿ç”¨äº† Tagged Pointer ä¹‹åï¼ŒNSNumber æŒ‡é’ˆé‡Œé¢å­˜å‚¨çš„æ•°æ®æ ‡ç§°äº†ï¼šTag+Dataï¼Œä¹Ÿå°±æ˜¯å°†æ•°æ®ç›´æ¥å­˜å‚¨åœ¨äº†æŒ‡é’ˆä¸­ã€‚</p><p>å½“æŒ‡é’ˆä¸å¤Ÿå­˜å‚¨æ•°æ®æ—¶ï¼Œæ‰ä¼šä½¿ç”¨åŠ¨æ€åˆ†é…å†…å­˜çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®ã€‚</p><p>objc_msgSend èƒ½è¯†åˆ« Tagged Pointerï¼Œæ¯”å¦‚ NSNumber çš„ intValue æ–¹æ³•ï¼Œç›´æ¥ä»æŒ‡é’ˆæå–æ•°æ®ï¼ŒèŠ‚çœäº†ä»¥å‰çš„è°ƒç”¨å¼€é”€ã€‚</p></blockquote><p>ä¸‹é¢æ¥çœ‹ä¸‹æ€ä¹ˆæ ·åˆ¤æ–­ä¸€ä¸ªæŒ‡é’ˆæ˜¯å¦æ˜¯ Tagged Pointer å‘¢ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">static inline bool </span><br><span class="line">_objc_isTaggedPointer(const void * _Nullable ptr) </span><br><span class="line">&#123;</span><br><span class="line">    return ((uintptr_t)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#if TARGET_OS_OSX &amp;&amp; __x86_64__</span><br><span class="line">    // 64-bit Mac - tag bit is LSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 0</span><br><span class="line">#else</span><br><span class="line">    // Everything else - tag bit is MSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 1</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if OBJC_MSB_TAGGED_POINTERS</span><br><span class="line">#   define _OBJC_TAG_MASK (1UL&lt;&lt;63)</span><br><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 60</span><br><span class="line">#   define _OBJC_TAG_SLOT_SHIFT 60</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_LSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_RSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_MASK (0xfUL&lt;&lt;60)</span><br><span class="line">#   define _OBJC_TAG_EXT_INDEX_SHIFT 52</span><br><span class="line">#   define _OBJC_TAG_EXT_SLOT_SHIFT 52</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_LSHIFT 12</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_RSHIFT 12</span><br><span class="line">#else</span><br><span class="line">#   define _OBJC_TAG_MASK 1UL</span><br><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 1</span><br><span class="line">#   define _OBJC_TAG_SLOT_SHIFT 0</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_LSHIFT 0</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_RSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_MASK 0xfUL</span><br><span class="line">#   define _OBJC_TAG_EXT_INDEX_SHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_SLOT_SHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_LSHIFT 0</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_RSHIFT 12</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼ŒæŒ‡é’ˆæ˜¯å¦æ˜¯ Tagged Pointer æ˜¯é€šè¿‡ <code>&amp;mask</code> å¾—åˆ°çš„ï¼Œçœ‹ä¸‹ä¸Šé¢çš„ mask å€¼æ˜¯åŒºåˆ† <code>iPhone</code> å’Œ <code>Mac</code> çš„ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>iOS å¹³å°ï¼šæœ€é«˜æœ‰æ•ˆä½æ˜¯ 1ï¼ˆç¬¬64 bitï¼‰</li><li>Mac å¹³å°ï¼šæœ€ä½æœ‰æ•ˆä½æ˜¯ 1</li></ul><p>å…·ä½“çš„ isa æŒ‡é’ˆå„ä¸ªä½çš„æ ‡è¯†ä¹‹å‰åœ¨ <a href="https://jueying-xiangfeng.github.io/2020/07/20/Runtime%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/" target="_blank" rel="noopener">RuntimeåŸç†æ¢ç©¶</a> ä¸­æœ‰è®²åˆ°è¿‡ã€‚</p><h3 id="OC-å¯¹è±¡çš„å†…å­˜ç®¡ç†"><a href="#OC-å¯¹è±¡çš„å†…å­˜ç®¡ç†" class="headerlink" title="OC å¯¹è±¡çš„å†…å­˜ç®¡ç†"></a>OC å¯¹è±¡çš„å†…å­˜ç®¡ç†</h3><p>åœ¨ iOS ä¸­ï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥ç®¡ç† OC å¯¹è±¡çš„å†…å­˜ã€‚</p><p>ä¸€ä¸ªæ–°åˆ›å»ºçš„ OC å¯¹è±¡å¼•ç”¨è®¡æ•°é»˜è®¤ä¸º 1ï¼Œå½“å¼•ç”¨è®¡æ•°å™¨å‡ä¸º0ï¼ŒOC å¯¹è±¡å°±é”€æ¯ï¼Œé‡Šæ”¾å ç”¨çš„å†…å­˜ç©ºé—´ã€‚</p><p>è°ƒç”¨ retain ä¼šè®© OC å¯¹è±¡çš„å¼•ç”¨è®¡æ•° +1ï¼Œrelease ä¼š -1.</p><p>å†…å­˜ç®¡ç†ç»éªŒæ€»ç»“ï¼š</p><ul><li>å½“è°ƒç”¨ allocã€mallocã€copyã€mutableCopy æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ä¸éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œè¦è°ƒç”¨ release æˆ–è€… autorelease æ¥é‡Šæ”¾ã€‚</li><li>æƒ³æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©å®ƒçš„å¼•ç”¨è®¡æ•° +1ï¼Œä¸æƒ³åœ¨æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©å®ƒçš„å¼•ç”¨è®¡æ•° -1ã€‚</li></ul><h3 id="copyã€mutableCopy"><a href="#copyã€mutableCopy" class="headerlink" title="copyã€mutableCopy"></a>copyã€mutableCopy</h3><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/copy%E3%80%81mutableCopy.png" alt="copyã€mutableCopy"></p><h3 id="weak-åŸç†"><a href="#weak-åŸç†" class="headerlink" title="weak åŸç†"></a>weak åŸç†</h3><p>å…ˆæ¥çœ‹ä¸‹ dealloc æ–¹æ³•çš„å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">inline void</span><br><span class="line">objc_object::rootDealloc()</span><br><span class="line">&#123;</span><br><span class="line">    if (isTaggedPointer()) return;  // fixme necessary?</span><br><span class="line"></span><br><span class="line">    if (fastpath(isa.nonpointer  &amp;&amp;  </span><br><span class="line">                 !isa.weakly_referenced  &amp;&amp;  </span><br><span class="line">                 !isa.has_assoc  &amp;&amp;  </span><br><span class="line">                 !isa.has_cxx_dtor  &amp;&amp;  </span><br><span class="line">                 !isa.has_sidetable_rc))</span><br><span class="line">    &#123;</span><br><span class="line">        assert(!sidetable_present());</span><br><span class="line">        free(this);</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">        object_dispose((id)this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id </span><br><span class="line">object_dispose(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (!obj) return nil;</span><br><span class="line"></span><br><span class="line">    objc_destructInstance(obj);    </span><br><span class="line">    free(obj);</span><br><span class="line"></span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void *objc_destructInstance(id obj) </span><br><span class="line">&#123;</span><br><span class="line">    if (obj) &#123;</span><br><span class="line">        // Read all of the flags at once for performance.</span><br><span class="line">        bool cxx = obj-&gt;hasCxxDtor();</span><br><span class="line">        bool assoc = obj-&gt;hasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">        // This order is important.</span><br><span class="line">        if (cxx) object_cxxDestruct(obj);</span><br><span class="line">        if (assoc) _object_remove_assocations(obj);</span><br><span class="line">        obj-&gt;clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline void </span><br><span class="line">objc_object::clearDeallocating()</span><br><span class="line">&#123;</span><br><span class="line">    if (slowpath(!isa.nonpointer)) &#123;</span><br><span class="line">        // Slow path for raw pointer isa.</span><br><span class="line">        sidetable_clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">    else if (slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</span><br><span class="line">        // Slow path for non-pointer isa with weak refs and/or side table data.</span><br><span class="line">        clearDeallocating_slow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assert(!sidetable_present());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">objc_object::clearDeallocating_slow()</span><br><span class="line">&#123;</span><br><span class="line">    assert(isa.nonpointer  &amp;&amp;  (isa.weakly_referenced || isa.has_sidetable_rc));</span><br><span class="line"></span><br><span class="line">    SideTable&amp; table = SideTables()[this];</span><br><span class="line">    table.lock();</span><br><span class="line">    if (isa.weakly_referenced) &#123;</span><br><span class="line">        weak_clear_no_lock(&amp;table.weak_table, (id)this);</span><br><span class="line">    &#125;</span><br><span class="line">    if (isa.has_sidetable_rc) &#123;</span><br><span class="line">        table.refcnts.erase(this);</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <a href="https://jueying-xiangfeng.github.io/2020/07/20/Runtime%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/" target="_blank" rel="noopener">RuntimeåŸç†æ¢ç©¶</a> ä¸­æˆ‘ä»¬è®²åˆ°è¿‡ ISA æŒ‡é’ˆçš„å„ä¸ªä½çš„ä½œç”¨ï¼Œåœ¨ dealloc æ—¶å¦‚æœæ²¡æœ‰ <code>å…³è”å¯¹è±¡(has_assoc)</code>ã€<code>c++ææ„å‡½æ•°(has_cxx_dtor)</code>ã€<code>å¼±å¼•ç”¨(weakly_referenced)</code>ã€<code>æ˜¯å¦ä½¿ç”¨ sidetable(has_sidetable_rc)</code> æ—¶é‡Šæ”¾ä¼šæ›´å¿«ã€‚è¿™é‡Œæˆ‘ä»¬å•ç‹¬çœ‹ä¸€ä¸‹ weakï¼Œè·Ÿåˆ° <code>clearDeallocating_slow</code> æ–¹æ³•å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„ç»“æ„ï¼š<code>SideTable</code>ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">struct SideTable &#123;</span><br><span class="line">    spinlock_t slock;</span><br><span class="line">    RefcountMap refcnts;</span><br><span class="line">    weak_table_t weak_table;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// RefcountMap disguises its pointers because we </span><br><span class="line">// don&apos;t want the table to act as a root for `leaks`.</span><br><span class="line">typedef objc::DenseMap&lt;DisguisedPtr&lt;objc_object&gt;,size_t,true&gt; RefcountMap;</span><br><span class="line"></span><br><span class="line">struct weak_table_t &#123;</span><br><span class="line">    weak_entry_t *weak_entries;</span><br><span class="line">    size_t    num_entries;</span><br><span class="line">    uintptr_t mask;</span><br><span class="line">    uintptr_t max_hash_displacement;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">typedef DisguisedPtr&lt;objc_object *&gt; weak_referrer_t;</span><br><span class="line"></span><br><span class="line">struct weak_entry_t &#123;</span><br><span class="line">    DisguisedPtr&lt;objc_object&gt; referent;</span><br><span class="line">    union &#123;</span><br><span class="line">        struct &#123;</span><br><span class="line">            weak_referrer_t *referrers;</span><br><span class="line">            uintptr_t        out_of_line_ness : 2;</span><br><span class="line">            uintptr_t        num_refs : PTR_MINUS_2;</span><br><span class="line">            uintptr_t        mask;</span><br><span class="line">            uintptr_t        max_hash_displacement;</span><br><span class="line">        &#125;;</span><br><span class="line">        struct &#123;</span><br><span class="line">            // out_of_line_ness field is low bits of inline_referrers[1]</span><br><span class="line">            weak_referrer_t  inline_referrers[WEAK_INLINE_COUNT];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    bool out_of_line() &#123;</span><br><span class="line">        return (out_of_line_ness == REFERRERS_OUT_OF_LINE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    weak_entry_t&amp; operator=(const weak_entry_t&amp; other) &#123;</span><br><span class="line">        memcpy(this, &amp;other, sizeof(other));</span><br><span class="line">        return *this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    weak_entry_t(objc_object *newReferent, objc_object **newReferrer)</span><br><span class="line">        : referent(newReferent)</span><br><span class="line">    &#123;</span><br><span class="line">        inline_referrers[0] = newReferrer;</span><br><span class="line">        for (int i = 1; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">            inline_referrers[i] = nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼ŒSidetable åŒ…å«ä¸‰éƒ¨åˆ†å†…å®¹ï¼Œlock éƒ¨åˆ†ä¸ç”¨ç®¡ï¼Œè¿™é‡Œçš„ RefcountMap å°±æ˜¯å½“ ISA æŒ‡é’ˆå­˜å‚¨ä¸ä¸‹å¼•ç”¨è®¡æ•°æ—¶æœ‰ Sidetable å­˜å‚¨çš„æ•£åˆ—è¡¨ã€‚å¦‚æœ <code>isa.has_sidetable_rc</code> ä¸º trueï¼Œåˆ™ä¼šè°ƒç”¨ <code>table.refcnts.erase(this);</code> æ¸…é™¤ç›¸å…³çš„å¼•ç”¨ã€‚</p><p>å†æ¥çœ‹ä¸‹ <code>weak_table</code> ç»“æ„ï¼Œå¯ä»¥çœ‹åˆ° weak_table ä¸ä¼šå¯¹ä¿®é¥°çš„å¯¹è±¡äº§ç”Ÿå¼ºå¼•ç”¨ï¼Œè€Œå½“å¯¹è±¡è¢« <code>weak</code> ä¿®é¥°è¿‡ï¼Œåˆ™åœ¨é‡Šæ”¾æ—¶å°±ä¼šè°ƒç”¨ <code>weak_clear_no_lock(&amp;table.weak_table, (id)this);</code> æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void </span><br><span class="line">weak_clear_no_lock(weak_table_t *weak_table, id referent_id) </span><br><span class="line">&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line"></span><br><span class="line">    weak_entry_t *entry = weak_entry_for_referent(weak_table, referent);</span><br><span class="line">    if (entry == nil) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    for (size_t i = 0; i &lt; count; ++i) &#123;</span><br><span class="line">        objc_object **referrer = referrers[i];</span><br><span class="line">        if (referrer) &#123;</span><br><span class="line">            // é‡ç‚¹ï¼šè¿™é‡Œå°† weakReference ç½®ä¸º nil</span><br><span class="line">            if (*referrer == referent) &#123;</span><br><span class="line">                *referrer = nil;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (*referrer) &#123;</span><br><span class="line">                objc_weak_error();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    weak_entry_remove(weak_table, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæºç æ‰€ç¤ºï¼Œåœ¨é‡Šæ”¾å†…å­˜æ—¶ï¼Œä¼šå°†ç›¸å…³çš„ weak reference è®¾ç½®ä¸º nilï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨ <code>__weak</code> ä¿®é¥°è¿‡çš„å˜é‡åœ¨è¢«ä¿®é¥°çš„å¯¹è±¡é‡Šæ”¾æ—¶èƒ½ç½®ä¸º nil çš„åŸç†ã€‚</p><blockquote><p>ARC å°±æ˜¯ LLVM ç¼–è¯‘å™¨å’Œ Runtime ç³»ç»Ÿç›¸äº’åä½œçš„ç»“æœ</p></blockquote><h3 id="Autorelease-åŸç†"><a href="#Autorelease-åŸç†" class="headerlink" title="Autorelease åŸç†"></a>Autorelease åŸç†</h3><p>å½“å°†å¯¹è±¡è°ƒç”¨ <code>autorelease</code> æ–¹æ³•åï¼Œå°±ä¼šè¢«åŠ å…¥åˆ° <code>è‡ªåŠ¨é‡Šæ”¾æ± </code> é‡Œé¢ï¼Œä½¿ç”¨ clang å‘½ä»¤æ¥çœ‹ä¸‹ autoreleasepool åˆ°åº•è¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¢«ç¼–è¯‘æˆäº† <code>__AtAutoreleasePool</code>ï¼Œç„¶ååœ¨ objc æºç é‡Œé¢æŸ¥æ‰¾ <code>autorelease</code> æ–¹æ³•ï¼Œæœ€ç»ˆå¯ä»¥çœ‹åˆ° autorelease çš„ç®¡ç†ç±»ï¼š<code>autoreleasepoolpage</code>ã€‚</p><p>æ‰€ä»¥è‡ªåŠ¨é‡Šæ”¾æ± çš„ä¸»è¦åº•å±‚æ•°æ®ç»“æ„æ˜¯ï¼š<code>__AtAutoreleasePool</code>ã€<code>AutoreleasePoolPage</code>ã€‚è°ƒç”¨äº† autorelease çš„å¯¹è±¡æœ€ç»ˆéƒ½æ˜¯é€šè¿‡ AutoreleasePoolPage å¯¹è±¡æ¥ç®¡ç†çš„ã€‚æ¥çœ‹ä¸‹ AutoreleasePoolPage çš„ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class AutoreleasePoolPage </span><br><span class="line">&#123;</span><br><span class="line">    static size_t const SIZE = </span><br><span class="line">#if PROTECT_AUTORELEASEPOOL</span><br><span class="line">        PAGE_MAX_SIZE;  // must be multiple of vm page size</span><br><span class="line">#else</span><br><span class="line">        PAGE_MAX_SIZE;  // size and alignment, power of 2 -- 4096</span><br><span class="line">#endif</span><br><span class="line">    static size_t const COUNT = SIZE / sizeof(id);</span><br><span class="line">  </span><br><span class="line">    magic_t const magic;</span><br><span class="line">    id *next;</span><br><span class="line">    pthread_t const thread;</span><br><span class="line">    AutoreleasePoolPage * const parent;</span><br><span class="line">    AutoreleasePoolPage *child;</span><br><span class="line">    uint32_t const depth;</span><br><span class="line">    uint32_t hiwat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ® AutoreleasePoolPage å®šä¹‰é‡Œé¢çš„ PAGE_MAX_SIZE å¯ä»¥çœ‹åˆ°å ç”¨ 4096 å­—èŠ‚çš„å†…å­˜ã€‚é™¤äº†ç”¨æ¥å­˜æ”¾å®ƒå†…å­˜çš„æˆå‘˜å˜é‡ï¼Œå‰©ä¸‹çš„ç©ºé—´ç”¨æ¥å­˜æ”¾ autorelease å¯¹è±¡çš„åœ°å€ã€‚</p><p>æ‰€æœ‰çš„ AutoreleasePoolPage å¯¹è±¡éƒ½æ˜¯é€šè¿‡åŒå‘é‡è¡¨çš„å½¢å¼è¿æ¥åœ¨ä¸€èµ·çš„ã€‚</p><p>æ¥çœ‹ä¸‹åŸç†ç»“æ„å›¾ï¼š</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/autoreleasepoolpage.png" alt="autoreleasepoolpageåŸç†"></p><p>è°ƒç”¨ push æ–¹æ³•ä¼šå°†ä¸€ä¸ª POOL_BOUNDARY å…¥æ ˆï¼Œå¹¶ä¸”è¿”å›å…¶å­˜æ”¾çš„å†…å­˜åœ°å€ã€‚</p><p>è°ƒç”¨ pop æ–¹æ³•æ—¶ä¼ å…¥ä¸€ä¸ª POOL_BOUNDARY çš„å†…å­˜åœ°å€ï¼Œä¼šä»æœ€åä¸€ä¸ªå…¥æ ˆçš„å¯¹è±¡å¼€å§‹å‘é€ release æ¶ˆæ¯ï¼Œç›´åˆ°é‡åˆ°è¿™ä¸ª POOL)BOUNDARYã€‚</p><p>id *next æŒ‡å‘äº†ä¸‹ä¸€ä¸ªèƒ½å­˜æ”¾ autorelease å¯¹è±¡åœ°å€çš„åŒºåŸŸã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">push</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    id *dest;</span><br><span class="line">    <span class="comment">// push æ—¶å°† POOL_BOUNDARY å…¥æ ˆï¼Œå¹¶è¿”å› POOL_BOUNDARY å…¥æ ˆçš„åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (DebugPoolAllocation) &#123;</span><br><span class="line">        <span class="comment">// Each autorelease pool starts on a new pool page.</span></span><br><span class="line">        dest = autoreleaseNewPage(POOL_BOUNDARY);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dest = autoreleaseFast(POOL_BOUNDARY);</span><br><span class="line">    &#125;</span><br><span class="line">    assert(dest == EMPTY_POOL_PLACEHOLDER || *dest == POOL_BOUNDARY);</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">(<span class="keyword">void</span> *token)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoreleasePoolPage *page;</span><br><span class="line">    id *stop;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯ hotpageï¼Œå¦‚æœä¸æ˜¯åˆ™è°ƒç”¨ coldePage çš„ pop æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰æ˜¯ hotPageï¼Œåˆ™è°ƒç”¨ releaseUntil æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (token == (<span class="keyword">void</span>*)EMPTY_POOL_PLACEHOLDER) &#123;</span><br><span class="line">        <span class="comment">// Popping the top-level placeholder pool.</span></span><br><span class="line">        <span class="keyword">if</span> (hotPage()) &#123;</span><br><span class="line">            <span class="comment">// Pool was used. Pop its contents normally.</span></span><br><span class="line">            <span class="comment">// Pool pages remain allocated for re-use as usual.</span></span><br><span class="line">            pop(coldPage()-&gt;begin());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Pool was never used. Clear the placeholder.</span></span><br><span class="line">            setHotPage(nil);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    page = pageForPointer(token);</span><br><span class="line">    stop = (id *)token;</span><br><span class="line">    <span class="keyword">if</span> (*stop != POOL_BOUNDARY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stop == page-&gt;begin()  &amp;&amp;  !page-&gt;parent) &#123;</span><br><span class="line">            <span class="comment">// Start of coldest page may correctly not be POOL_BOUNDARY:</span></span><br><span class="line">            <span class="comment">// 1. top-level pool is popped, leaving the cold page in place</span></span><br><span class="line">            <span class="comment">// 2. an object is autoreleased with no pool</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Error. For bincompat purposes this is not </span></span><br><span class="line">            <span class="comment">// fatal in executables built with old SDKs.</span></span><br><span class="line">            <span class="keyword">return</span> badPop(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PrintPoolHiwat) printHiwat();</span><br><span class="line"></span><br><span class="line">    page-&gt;releaseUntil(stop);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">releaseUntil</span><span class="params">(id *stop)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>-&gt;next != stop) &#123;</span><br><span class="line">        AutoreleasePoolPage *page = hotPage();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fixme I think this `while` can be `if`, but I can't prove it</span></span><br><span class="line">        <span class="keyword">while</span> (page-&gt;empty()) &#123;</span><br><span class="line">            page = page-&gt;parent;</span><br><span class="line">            setHotPage(page);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        page-&gt;unprotect();</span><br><span class="line">        id obj = *--page-&gt;next;</span><br><span class="line">        <span class="built_in">memset</span>((<span class="keyword">void</span>*)page-&gt;next, SCRIBBLE, <span class="keyword">sizeof</span>(*page-&gt;next));</span><br><span class="line">        page-&gt;protect();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// çŸ¥é“æ‰¾åˆ°ä¸Šä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ POOL_BOUNDARYï¼Œå¦åˆ™ä¸­é—´çš„å¯¹è±¡éƒ½è°ƒç”¨ release æ–¹æ³•è¿›è¡Œé‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">if</span> (obj != POOL_BOUNDARY) &#123;</span><br><span class="line">            objc_release(obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸‹ä¸€ä¸ªå˜é‡è¢«æ ‡è®°ä¸º autorelease åï¼Œæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ release çš„ã€‚</p><p>è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯æœ‰ RunLoop æ§åˆ¶çš„ï¼ŒåŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± çš„å˜é‡ä¼šåœ¨æŸæ¬¡ RunLoop å¾ªç¯ä¸­ï¼ŒRunLoopä¼‘çœ ä¹‹å‰è°ƒç”¨ releaseã€‚</p><p>è€Œæˆ‘ä»¬å¹³æ—¶å¼€å‘æ—¶ä¸»çº¿ç¨‹çš„ RunLoop ä¸­å·²ç»æ³¨å†Œäº† 2 ä¸ª observerï¼š</p><ol><li>ç¬¬ä¸€ä¸ª observer ç›‘å¬äº† kCFRunLoopEntry äº‹ä»¶ï¼Œä¼šè°ƒç”¨ objc_autoreleasePoolPush()ã€‚</li><li>ç¬¬äºŒä¸ª observer ç›‘å¬äº†ä¸¤ä¸ªäº‹ä»¶<ul><li>kCFRunLoopBeforeWaiting äº‹ä»¶ï¼Œä¼šè°ƒç”¨ objc_autoreleasePoolPop()ã€objc_autoreleasePoolPush()ã€‚</li><li>kCFRunLoopBeforeExit äº‹ä»¶ï¼Œä¼šè°ƒç”¨ objc_autoreleasePoolPop()ã€‚</li></ul></li></ol><p>å…·ä½“çš„åº”ç”¨å¯ä»¥çœ‹ä¸‹ YY å¤§ç¥çš„ <a href="https://github.com/ibireme/YYKit/blob/master/YYKit/Base/Foundation/NSThread%2BYYAdd.m" target="_blank" rel="noopener">YYKit</a>  NSThread+YYAdd ç›¸å…³ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">static inline void YYAutoreleasePoolPush() &#123;</span><br><span class="line">    NSMutableDictionary *dic =  [NSThread currentThread].threadDictionary;</span><br><span class="line">    NSMutableArray *poolStack = dic[YYNSThreadAutoleasePoolStackKey];</span><br><span class="line">    </span><br><span class="line">    if (!poolStack) &#123;</span><br><span class="line">        /*</span><br><span class="line">         do not retain pool on push,</span><br><span class="line">         but release on pop to avoid memory analyze warning</span><br><span class="line">         */</span><br><span class="line">        CFArrayCallBacks callbacks = &#123;0&#125;;</span><br><span class="line">        callbacks.retain = PoolStackRetainCallBack;</span><br><span class="line">        callbacks.release = PoolStackReleaseCallBack;</span><br><span class="line">        poolStack = (id)CFArrayCreateMutable(CFAllocatorGetDefault(), 0, &amp;callbacks);</span><br><span class="line">        dic[YYNSThreadAutoleasePoolStackKey] = poolStack;</span><br><span class="line">        CFRelease(poolStack);</span><br><span class="line">    &#125;</span><br><span class="line">    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init]; // create</span><br><span class="line">    [poolStack addObject:pool]; // push</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void YYAutoreleasePoolPop() &#123;</span><br><span class="line">    NSMutableDictionary *dic =  [NSThread currentThread].threadDictionary;</span><br><span class="line">    NSMutableArray *poolStack = dic[YYNSThreadAutoleasePoolStackKey];</span><br><span class="line">    [poolStack removeLastObject]; // pop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void YYRunLoopAutoreleasePoolObserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info) &#123;</span><br><span class="line">    switch (activity) &#123;</span><br><span class="line">        // è¿›å…¥ loop æ—¶ push</span><br><span class="line">        case kCFRunLoopEntry: &#123;</span><br><span class="line">            YYAutoreleasePoolPush();</span><br><span class="line">        &#125; break;</span><br><span class="line">        // loop ä¸€åœˆèµ°å®Œï¼Œå…ˆ pop ç„¶ååœ¨ push</span><br><span class="line">        case kCFRunLoopBeforeWaiting: &#123;</span><br><span class="line">            YYAutoreleasePoolPop();</span><br><span class="line">            YYAutoreleasePoolPush();</span><br><span class="line">        &#125; break;</span><br><span class="line">        // é€€å‡ºæ—¶ pop</span><br><span class="line">        case kCFRunLoopExit: &#123;</span><br><span class="line">            YYAutoreleasePoolPop();</span><br><span class="line">        &#125; break;</span><br><span class="line">        default: break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void YYRunloopAutoreleasePoolSetup() &#123;</span><br><span class="line">    CFRunLoopRef runloop = CFRunLoopGetCurrent();</span><br><span class="line">    // å½“å‰çº¿ç¨‹æ·»åŠ ç›‘å¬ï¼škCFRunLoopEntryã€kCFRunLoopBeforeWaiting | kCFRunLoopExit</span><br><span class="line">    CFRunLoopObserverRef pushObserver;</span><br><span class="line">    pushObserver = CFRunLoopObserverCreate(CFAllocatorGetDefault(), kCFRunLoopEntry,</span><br><span class="line">                                           true,         // repeat</span><br><span class="line">                                           -0x7FFFFFFF,  // before other observers</span><br><span class="line">                                           YYRunLoopAutoreleasePoolObserverCallBack, NULL);</span><br><span class="line">    CFRunLoopAddObserver(runloop, pushObserver, kCFRunLoopCommonModes);</span><br><span class="line">    CFRelease(pushObserver);</span><br><span class="line">    </span><br><span class="line">    CFRunLoopObserverRef popObserver;</span><br><span class="line">    popObserver = CFRunLoopObserverCreate(CFAllocatorGetDefault(), kCFRunLoopBeforeWaiting | kCFRunLoopExit,</span><br><span class="line">                                          true,        // repeat</span><br><span class="line">                                          0x7FFFFFFF,  // after other observers</span><br><span class="line">                                          YYRunLoopAutoreleasePoolObserverCallBack, NULL);</span><br><span class="line">    CFRunLoopAddObserver(runloop, popObserver, kCFRunLoopCommonModes);</span><br><span class="line">    CFRelease(popObserver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@implementation NSThread (YYAdd)</span><br><span class="line"></span><br><span class="line">+ (void)addAutoreleasePoolToCurrentRunloop &#123;</span><br><span class="line">    // ä¸»çº¿ç¨‹å­˜åœ¨è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦åœ¨å­çº¿ç¨‹ä¸­æ·»åŠ   </span><br><span class="line">    if ([NSThread isMainThread]) return; // The main thread already has autorelease pool.</span><br><span class="line">    NSThread *thread = [self currentThread];</span><br><span class="line">    if (!thread) return;</span><br><span class="line">    if (thread.threadDictionary[YYNSThreadAutoleasePoolKey]) return; // already added</span><br><span class="line">    YYRunloopAutoreleasePoolSetup();</span><br><span class="line">    thread.threadDictionary[YYNSThreadAutoleasePoolKey] = YYNSThreadAutoleasePoolKey; // mark the state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘æ—¶é—´æ¯”è¾ƒæ•£ï¼Œè¿˜æœ‰å°±æ˜¯å…¬å¸æ¯”è¾ƒåŠ¨è¡ğŸ˜Œï¼Œå½“åˆæ€€ç€ä¸€é¢—åšäº‹çš„å¿ƒæ¥åˆ°è¿™é‡Œï¼Œæ²¡æƒ³åˆ°æœ€åè½å¾—è¿™æ ·çš„ç»“å±€ã€‚ä¸è¯´äº†ï¼Œè¿˜æ˜¯ä¿æŒæœ¬å¿ƒæ¯”è¾ƒå¥½ï¼Œå°½ç®¡æƒ³åšå¥½é£è¯»ï¼Œä½†æ˜¯æˆ‘ä»¬å°èŒå‘˜ä¹Ÿæ”¹å˜ä¸äº†ä»€ä¹ˆã€‚åšå¥½è‡ªå·±çš„äº‹æƒ…å°±å¥½ï¼ŒæŒ‰ç€å­¦ä¹ è®¡åˆ’ç»§ç»­ã€‚ã€‚ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å†…å­˜ç®¡ç†" scheme="http://yoursite.com/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>å¤šçº¿ç¨‹</title>
    <link href="http://yoursite.com/2020/08/05/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    <id>http://yoursite.com/2020/08/05/å¤šçº¿ç¨‹/</id>
    <published>2020-08-05T07:11:52.000Z</published>
    <updated>2020-08-05T14:51:49.736Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>RunLoopåŸç†æ¢ç©¶</title>
    <link href="http://yoursite.com/2020/07/29/RunLoop%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/"/>
    <id>http://yoursite.com/2020/07/29/RunLoopåŸç†æ¢ç©¶/</id>
    <published>2020-07-29T03:17:19.000Z</published>
    <updated>2020-08-15T14:30:57.273Z</updated>
    
    <content type="html"><![CDATA[<h3 id="RunLoop-æ¦‚å¿µ"><a href="#RunLoop-æ¦‚å¿µ" class="headerlink" title="RunLoop æ¦‚å¿µ"></a>RunLoop æ¦‚å¿µ</h3><p>é¡¾åæ€ä¹‰ï¼ŒRunLoop å°±æ˜¯è¿è¡Œå¾ªç¯ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¾ªç¯åšä¸€äº›äº‹æƒ…ã€‚è¿™ç§æ¨¡å‹é€šå¸¸è¢«ç§°ä½œ <a href="https://en.wikipedia.org/wiki/Event_loop" target="_blank" rel="noopener">Event Loop</a>ï¼Œè¿™ç§æ¨¡å‹çš„å…³é”®ç‚¹åœ¨äºï¼šå¦‚ä½•ç®¡ç†äº‹ä»¶/æ¶ˆæ¯ï¼Œå¦‚æœä¿è¯çº¿ç¨‹åœ¨æ²¡æœ‰å¤„ç†æ¶ˆæ¯æ—¶ä¼‘çœ é¿å…èµ„æºå ç”¨ã€å†æœ‰æ¶ˆæ¯åˆ°æ¥æ—¶ç«‹åˆ»è¢«å”¤é†’ã€‚</p><a id="more"></a><p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆåçº¿ç¨‹å°±ä¼šé€€å‡ºï¼Œå¦‚æœè¦ä¿è¯çº¿ç¨‹èƒ½éšæ—¶å¤„ç†äº‹ä»¶ä½†ä¸é€€å‡ºï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦è¿™æ ·åšï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        int retVal = 0;</span><br><span class="line">        do &#123;</span><br><span class="line">            // ç¡çœ ä¸­ç­‰å¾…æ¶ˆæ¯</span><br><span class="line">            int message = sleep_and_wait();</span><br><span class="line">            // å¤„ç†æ¶ˆæ¯</span><br><span class="line">            retVal = process_message(message);</span><br><span class="line">        &#125; while (retVal == 0);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RunLoop å…¶å®å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç®¡ç†äº†å…¶éœ€è¦å¤„ç†çš„æ¶ˆæ¯å’Œäº‹ä»¶ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªå…¥å£å‡½æ•°æ¥æ‰§è¡Œä¸Šé¢çš„ Event Loop é€»è¾‘ã€‚çº¿ç¨‹æ‰§è¡Œäº†è¿™ä¸ªå‡½æ•°åï¼Œä¼šä¸€ç›´å¤„äºï¼šæ¥å—æ¶ˆæ¯-&gt;ç­‰å¾…-&gt;å¤„ç†æ¶ˆæ¯ çš„å¾ªç¯ä¸­ï¼Œç›´åˆ° retVal ä¸º0æ‰ä¼šé€€å‡ºå‡½æ•°ã€‚</p><p>å¯ä»¥åœ¨<a href="http://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">è¿™é‡Œ</a>ä¸‹è½½åˆ° CoreFoundationçš„æºç æ¥æŸ¥çœ‹å…·ä½“å®ç°ã€‚</p><h3 id="RunLoop-ç»“æ„"><a href="#RunLoop-ç»“æ„" class="headerlink" title="RunLoop ç»“æ„"></a>RunLoop ç»“æ„</h3><p>iOS æœ‰ä¸¤å¥— API æ¥è®¿é—®å’Œä½¿ç”¨ RunLoopï¼š<code>NSRunLoop</code>ã€<code>CFRunLoop</code>ã€‚NSRunLoop æ˜¯åŸºäº CFRunLoop çš„åŒ…è£…</p><p>Core Foundation ä¸­å…³äº RunLoop çš„ç±»æœ‰5ä¸ªï¼š</p><ol><li>CFRunLoopRef</li><li>CFRunLoopModeRef</li><li>CFRunLoopSourceRef</li><li>CFRunLoopTimerRef</li><li>CFRunLoopObserverRef</li></ol><p>CFRunLoopRefï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> &#123;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> _pthread;</span><br><span class="line">    CFMutableSetRef _commonModes;<span class="comment">// set</span></span><br><span class="line">    CFMutableSetRef _commonModeItems; <span class="comment">// set&lt;Sourceã€Observerã€Timer&gt;</span></span><br><span class="line">    CFRunLoopModeRef _currentMode;<span class="comment">// current mode</span></span><br><span class="line">    CFMutableSetRef _modes;<span class="comment">// set</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>CFRunLoopModeRefï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> &#123;</span></span><br><span class="line">    CFStringRef _name; <span class="comment">// mode nameï¼šsuch as - kCFRunLoopDefaultMode</span></span><br><span class="line">    CFMutableSetRef _sources0;<span class="comment">// set</span></span><br><span class="line">    CFMutableSetRef _sources1;<span class="comment">// set</span></span><br><span class="line">    CFMutableArrayRef _observers;<span class="comment">// array</span></span><br><span class="line">    CFMutableArrayRef _timers;<span class="comment">// array</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªæ¦‚å¿µå«åš commonModesï¼šä¸€ä¸ª mode å¯ä»¥å°†è‡ªå·±æ ‡è®°ä¸º common å±æ€§ï¼ˆé€šè¿‡å°†å…¶ mode name æ·»åŠ åˆ° RunLoop çš„ commonModes ä¸­ï¼‰ã€‚æ¯å½“ RunLoop å†…å®¹å‘ç”Ÿæ—¶ï¼ŒRunLoop ä¼šè‡ªåŠ¨å°† commonModeItems é‡Œé¢çš„ source/observer/timer åŒæ­¥åˆ°å…·æœ‰ common æ ‡è®°çš„æ‰€æœ‰ mode é‡Œé¢ã€‚</p><p>CFRunLoop å¯¹å¤–æš´éœ²çš„ç®¡ç† mode çš„æ¥å£æœ‰ä¸¤ä¸ªï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoopAddCommonMode(CFRunLoopRef runloop, CFStringRef modeName);</span><br><span class="line">CFRunLoopRunInMode(CFStringRef modeName, ...);</span><br></pre></td></tr></table></figure><p>mode æš´éœ²çš„ç®¡ç† mode item çš„æ¥å£æœ‰ä»¥ä¸‹å‡ ä¸ª</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoopAddSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFStringRef modeName);</span><br><span class="line">CFRunLoopAddObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFStringRef modeName);</span><br><span class="line">CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef timer, CFStringRef mode);</span><br><span class="line">CFRunLoopRemoveSource(CFRunLoopRef rl, CFRunLoopSourceRef source, CFStringRef modeName);</span><br><span class="line">CFRunLoopRemoveObserver(CFRunLoopRef rl, CFRunLoopObserverRef observer, CFStringRef modeName);</span><br><span class="line">CFRunLoopRemoveTimer(CFRunLoopRef rl, CFRunLoopTimerRef timer, CFStringRef mode);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªèƒ½é€šè¿‡ mode name æ¥æ“ä½œå†…éƒ¨çš„ modeï¼Œå½“ä¼ å…¥ä¸€ä¸ªæ–°çš„ mode name å• RunLoop é‡Œé¢æ²¡æœ‰å¯¹åº”çš„ mode æ—¶ï¼ŒRunLoop å†…éƒ¨ä¼šè‡ªåŠ¨åˆ›å»º CFRunLoopModeRefã€‚å¯¹äºä¸€ä¸ª Runloop æ¥è¯´ï¼Œå†…éƒ¨çš„ mode åªèƒ½å¢åŠ ï¼Œä¸èƒ½åˆ é™¤ã€‚</p><p>è‹¹æœå…¬å¼€çš„ mode æœ‰ä¸¤ä¸ª</p><ol><li>kCFRunLoopDefaultModeï¼ˆNSDefaultRunLoopModeï¼‰</li><li>UITrackingRunLoopMode</li></ol><p>è¿™é‡Œè¿˜æä¾›äº†ä¸€ä¸ªæ“ä½œ common æ ‡è®°ç¬¦çš„å­—ç¬¦ä¸² kCFRunLoopCommonModes (NSRunLoopCommonModes)ã€‚ä½¿ç”¨æ—¶æ³¨æ„è¿™ä¸ªæ ‡è®°å’Œå…¶ä»–çš„ mode nameã€‚</p><p>çœ‹ä¸‹ RunLoop å›¾ç¤ºç»“æ„ï¼š</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/runloop/runloop%E7%BB%93%E6%9E%84.png" alt="RunLoopç»“æ„"></p><p>ä»ä¸Šå›¾çš„ç»“æ„å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ª RunLoop åŒ…å«è‹¥å¹²ä¸ª modeï¼Œæ¯ä¸ª mode æœ‰åŒ…å«è‹¥å¹²ä¸ª source/observer/timerï¼Œæ¯æ¬¡è°ƒç”¨ RunLoop çš„ä¸»å‡½æ•°æ—¶ï¼Œåªèƒ½æŒ‡å®šå…¶ä¸­ä¸€ä¸ª mode ä½œä¸º currentModeã€‚å¦‚æœéœ€è¦åˆ‡æ¢ modeï¼Œåªèƒ½é€€å‡ºå½“å‰ loopï¼Œå†é‡æ–°æŒ‡å®šä¸€ä¸ª mode è¿›å…¥ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ä¸åŒç»„çš„ source/observer/timerï¼Œå¯ä»¥åšåˆ°äº’ä¸å½±å“ã€‚</p><p><strong>CFRunLoopSourceRef</strong> æ˜¯äº‹ä»¶äº§ç”Ÿçš„åœ°æ–¹ã€‚source æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šsource0 å’Œ source1</p><ul><li>source0ï¼šåªåŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œå®ƒå¹¶ä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ã€‚ä½¿ç”¨æ—¶éœ€è¦å…ˆè°ƒç”¨ CFRunLoopSourceSignal(source)ï¼Œå°†è¿™ä¸ª source æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œç„¶åæ‰‹åŠ¨è°ƒç”¨ CFRunLoopWakeUp(runloop) æ¥å”¤é†’ RunLoopï¼Œè®©å…¶å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚ â€“ è§¦æ‘¸äº‹ä»¶å¤„ç†ã€performSelector:onThreadï¼›</li><li>source1ï¼šåŒ…å«äº†ä¸€ä¸ª mach_port å’Œä¸€ä¸ªå›è°ƒï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰ï¼Œè¢«ç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶ä»–çº¿ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯ï¼Œè¿™ç§ source èƒ½ä¸»åŠ¨å”¤é†’ RunLoop çš„çº¿ç¨‹ã€‚ â€“ åŸºäº port çš„çº¿ç¨‹é—´é€šä¿¡ã€ç³»ç»Ÿäº‹ä»¶æ•æ‰ã€‚</li></ul><p><strong>CFRunLoopTimerRef</strong> æ˜¯åŸºäºäº‹ä»¶çš„è§¦å‘å™¨ï¼Œå®ƒå’Œ NSTimer æ˜¯å¯ä»¥æ··ç”¨çš„ã€‚å½“åŠ å…¥åˆ° RunLoop æ—¶ï¼ŒRunLoop ä¼šæ³¨å†Œå¯¹åº”çš„æ—¶é—´ç‚¹ï¼Œå½“æ—¶é—´ç‚¹åˆ°æ—¶ï¼ŒRunLoop ä¼šè¢«å”¤é†’ä»¥æ‰§è¡Œé‚£ä¸ªä»»åŠ¡ã€‚ â€“ NSTimerã€performSelector:withObject:afterDelay:</p><p><strong>CFRunLoopObserverRef</strong> æ˜¯è§‚å¯Ÿè€…ï¼Œæ¯ä¸ª observer éƒ½åŒ…å«äº†ä¸€ä¸ªå›è°ƒï¼Œå½“ RunLoop çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œè§‚å¯Ÿè€…å°±èƒ½é€šè¿‡å›è°ƒæ¥æ”¶åˆ°è¿™ä¸ªå˜åŒ–ã€‚</p><p>â€“ ç”¨äºç›‘å¬ RunLoop çš„çŠ¶æ€ã€UI åˆ·æ–°ï¼ˆBeforeWaitingï¼‰ã€Autorelease poolï¼ˆBeforeWaitingï¼‰</p><p>å¯ä»¥è§‚æµ‹åˆ°çš„çŠ¶æ€æœ‰ä¸€ä¸‹å‡ ä¸ªï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/* Run Loop Observer Activities */</span><br><span class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</span><br><span class="line">    kCFRunLoopEntry         = (1UL &lt;&lt; 0), // å³å°†è¿›å…¥ RunLoop</span><br><span class="line">    kCFRunLoopBeforeTimers  = (1UL &lt;&lt; 1), // å³å°†å¤„ç† timer</span><br><span class="line">    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), // å³å°†å¤„ç† source</span><br><span class="line">    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5), // å³å°†è¿›å…¥ä¼‘çœ </span><br><span class="line">    kCFRunLoopAfterWaiting  = (1UL &lt;&lt; 6), // å³å°†è¢«å”¤é†’</span><br><span class="line">    kCFRunLoopExit          = (1UL &lt;&lt; 7), // å³å°†é€€å‡º RunLoop</span><br><span class="line">    kCFRunLoopAllActivities = 0x0FFFFFFFU</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ source/timer/observer ç»Ÿç§°ä¸º mode itemï¼Œä¸€ä¸ª item å¯ä»¥è¢«åŒæ—¶åŠ å…¥å¤šä¸ª modeï¼Œä½†ä¸€ä¸ª item è¢«é‡å¤åŠ å…¥åŒä¸€ä¸ª mode æ˜¯ä¸ä¼šæœ‰æ•ˆæœçš„ã€‚å¦‚æœä¸€ä¸ª mode é‡Œé¢ä¸€ä¸ª item éƒ½æ²¡æœ‰ï¼Œåˆ™ RunLoop ä¼šç›´æ¥é€€å‡ºï¼Œä¸è¿›å…¥å¾ªç¯ã€‚</p><h3 id="RunLoop-ä¸çº¿ç¨‹çš„å…³ç³»"><a href="#RunLoop-ä¸çº¿ç¨‹çš„å…³ç³»" class="headerlink" title="RunLoop ä¸çº¿ç¨‹çš„å…³ç³»"></a>RunLoop ä¸çº¿ç¨‹çš„å…³ç³»</h3><p>æ¯æ¡çº¿ç¨‹éƒ½æœ‰å”¯ä¸€ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ RunLoop å¯¹è±¡ï¼Œä»–ä»¬æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚</p><p>çº¿ç¨‹åœ¨åˆšåˆ›å»ºæ—¶æ˜¯æ²¡æœ‰ RunLoop å¯¹è±¡çš„ï¼ŒRunLoop ä¼šåœ¨ç¬¬ä¸€æ¬¡è·å–å®ƒæ—¶åˆ›å»ºï¼Œæˆ‘ä»¬é€šå¸¸è·å–çš„æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoopGetCurrent();</span><br><span class="line">CFRunLoopGetMain();</span><br><span class="line">[NSRunLoop currentRunLoop];</span><br><span class="line">[NSRunLoop mainRunLoop];</span><br></pre></td></tr></table></figure><p>æ¥çœ‹ä¸‹è·å–çš„æºç ï¼Œå·² getCurrent ä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€çš„ Dictionaryï¼Œkey æ˜¯ pthread_tï¼Œvalue æ˜¯ CFRunLoopRef</span></span><br><span class="line"><span class="keyword">static</span> CFMutableDictionaryRef __CFRunLoops = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> CFLock_t loopsLock = CFLockInit;<span class="comment">// è®¿é—® __CFRunLoops æ—¶çš„é”</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// should only be called by Foundation</span></span><br><span class="line"><span class="comment">// t==0 is a synonym for "main thread" that always works</span></span><br><span class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(<span class="keyword">pthread_t</span> t) &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹ä¸ºç©ºåˆ™è·å–ä¸»çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_equal(t, kNilPthreadT)) &#123;</span><br><span class="line">        t = pthread_main_thread_np();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå…¨å±€çš„ CFMutableDictionaryRef ä¸ºç©ºï¼Œåˆ™å…ˆåˆå§‹åŒ–å…¨å±€çš„ CFMutableDictionaryRefï¼Œå¹¶å…ˆä¸ºä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ª RunLoop</span></span><br><span class="line">    <span class="keyword">if</span> (!__CFRunLoops) &#123;</span><br><span class="line">        CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());</span><br><span class="line">        CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›´æ¥ä»å…¨å±€ CFMutableDictionaryRef é‡Œé¢è·å–</span></span><br><span class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ä¸åˆ°åˆ™åˆ›å»ºä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (!loop) &#123;</span><br><span class="line">        CFRunLoopRef newLoop = __CFRunLoopCreate(t);</span><br><span class="line">        CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“çº¿ç¨‹é”€æ¯æ—¶ï¼Œé¡ºä¾¿ä¹Ÿé”€æ¯å…¶å¯¹åº”çš„ RunLoop</span></span><br><span class="line">    _CFSetTSD(__CFTSDKeyRunLoopCntr, (<span class="keyword">void</span> *)(PTHREAD_DESTRUCTOR_ITERATIONS<span class="number">-1</span>), (<span class="keyword">void</span> (*)(<span class="keyword">void</span> *))__CFFinalizeRunLoop);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æºç åˆ†æå¯çŸ¥ï¼š</p><ul><li>çº¿ç¨‹å’Œ RunLoop æ˜¯ä¸€ä¸€å¯¹åº”çš„</li><li>RunLoop ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„ Dictionary é‡Œé¢ï¼Œpthread_t ä¸º keyï¼ŒRunLoop ä¸º value</li><li>çº¿ç¨‹åˆšåˆ›å»ºæ—¶å¹¶æ²¡æœ‰ RunLoopï¼ŒRunLoop ä¼šåœ¨ç¬¬ä¸€æ¬¡è·å–å®ƒæ—¶åˆ›å»º</li><li>RunLoop ä¼šåœ¨çº¿ç¨‹ç»“æŸæ—¶é”€æ¯</li><li>åªèƒ½åœ¨çº¿ç¨‹å†…éƒ¨è·å– RunLoopï¼ˆä¸»çº¿ç¨‹é™¤å¤–ï¼‰</li></ul><h3 id="4ã€RunLoop-çš„è¿è¡Œé€»è¾‘"><a href="#4ã€RunLoop-çš„è¿è¡Œé€»è¾‘" class="headerlink" title="4ã€RunLoop çš„è¿è¡Œé€»è¾‘"></a>4ã€RunLoop çš„è¿è¡Œé€»è¾‘</h3><p>å…ˆæ¥çœ‹æµç¨‹å›¾ï¼š</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/runloop/runloop%E6%B5%81%E7%A8%8B.png" alt="runloopæµç¨‹"></p><p>æ¥åˆ†æä¸‹æºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">void CFRunLoopRun(void) &#123;/* DOES CALLOUT */</span><br><span class="line">    int32_t result;</span><br><span class="line">    do &#123;</span><br><span class="line">        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 1.0e10, false);</span><br><span class="line">    &#125; while (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SInt32 CFRunLoopRunSpecific(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) &#123;     /* DOES CALLOUT */</span><br><span class="line">    </span><br><span class="line">    /// æ ¹æ® mode name æ‰¾æ‰“å¯¹åº” mode</span><br><span class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, false);</span><br><span class="line">    </span><br><span class="line">    /// å¦‚æœ mode é‡Œé¢æ²¡æœ‰ source/timer/observer åˆ™ç›´æ¥è¿”å›</span><br><span class="line">    if (__CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) &#123; return; &#125;</span><br><span class="line">    </span><br><span class="line">    volatile _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);</span><br><span class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;</span><br><span class="line">    rl-&gt;_currentMode = currentMode;</span><br><span class="line">    int32_t result = kCFRunLoopRunFinished;</span><br><span class="line"></span><br><span class="line">/// 1ã€é€šçŸ¥ observer å³å°†è¿›å…¥ loop</span><br><span class="line">    __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</span><br><span class="line">    </span><br><span class="line">    /// è¿›å…¥ RunLoop</span><br><span class="line">result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</span><br><span class="line">    </span><br><span class="line">    /// 11ã€é€šçŸ¥ observer é€€å‡º loop</span><br><span class="line">__CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</span><br><span class="line">    </span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* rl, rlm are locked on entrance and exit */</span><br><span class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    </span><br><span class="line">    int32_t retVal = 0;</span><br><span class="line">    do &#123;</span><br><span class="line">        // 2ã€é€šçŸ¥Observersï¼šå³å°†å¤„ç†Timers</span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line">        </span><br><span class="line">        // 3ã€é€šçŸ¥Observersï¼šå³å°†å¤„ç†Sources</span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line"></span><br><span class="line">        // 4ã€å¤„ç†Blocks</span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line"></span><br><span class="line">        // 5ã€å¤„ç†Source0</span><br><span class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</span><br><span class="line">        if (sourceHandledThisLoop) &#123;</span><br><span class="line">            // å¤„ç†Blocks</span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Boolean poll = sourceHandledThisLoop || (0ULL == timeout_context-&gt;termTSR);</span><br><span class="line"></span><br><span class="line">        // 6ã€åˆ¤æ–­æœ‰æ— Source1</span><br><span class="line">        if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0, &amp;voucherState, NULL)) &#123;</span><br><span class="line">            // å¦‚æœæœ‰Source1 åˆ™è·³è½¬åˆ° handle_msg -- å³ ç¬¬ 8 æ­¥</span><br><span class="line">            goto handle_msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 7ã€é€šçŸ¥Observersï¼šå³å°†ä¼‘çœ </span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">        __CFRunLoopSetSleeping(rl);</span><br><span class="line">        </span><br><span class="line">        // ç­‰å¾…åˆ«çš„æ¶ˆæ¯å”¤é†’å½“å‰çº¿ç¨‹</span><br><span class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">        </span><br><span class="line">        // user callouts now OK again</span><br><span class="line">        __CFRunLoopUnsetSleeping(rl);</span><br><span class="line">        // 8ã€é€šçŸ¥Observersï¼šç»“æŸä¼‘çœ  -- è¢«æŸä¸ªæ¶ˆæ¯å”¤é†’</span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line"></span><br><span class="line">    handle_msg:</span><br><span class="line">        </span><br><span class="line">        if (è¢«timerå”¤é†’) &#123;</span><br><span class="line">            // 8.1ã€å¤„ç†Timers</span><br><span class="line">            __CFRunLoopDoTimers(rl, rlm, mach_absolute_time());</span><br><span class="line">        &#125; else if (è¢«GCDå”¤é†’) &#123;</span><br><span class="line">            // 8.2ã€å¤„ç† GCD</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 8.3ã€å¤„ç†Source1</span><br><span class="line">            __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">        // 9ã€å¤„ç†BLocks</span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        </span><br><span class="line">        // 10ã€æ ¹æ®å½“å‰ç»“æœå†³å®šå¦‚ä½•æ“ä½œ</span><br><span class="line">        // -- 1&gt; å›åˆ°ç¬¬ 2 æ­¥</span><br><span class="line">        // -- 2&gt; é€€å‡º RunLoop</span><br><span class="line">        if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">            // è¿›å…¥ loop æ—¶å¤„ç†å®Œäº‹ä»¶å°±è¿”å›</span><br><span class="line">            retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            // è¶…å‡ºä¼ å…¥å‚æ•°æ ‡è®°çš„æ—¶é—´äº†</span><br><span class="line">            retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">        &#125; else if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            // è¢«å¤–éƒ¨è°ƒç”¨å¼ºåˆ¶åœæ­¢äº†</span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125;  else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">            // source/timer/observer ä¸€ä¸ªéƒ½æ²¡æœ‰æ—¶</span><br><span class="line">            retVal = kCFRunLoopRunFinished;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        voucher_mach_msg_revert(voucherState);</span><br><span class="line">        os_release(voucherCopy);</span><br><span class="line">        </span><br><span class="line">    &#125; while (0 == retVal);</span><br><span class="line">    </span><br><span class="line">    return retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹ä¸‹ RunLoop ä¼‘çœ åŸç†ï¼š</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/runloop/runloop%E4%BC%91%E7%9C%A0%E5%8E%9F%E7%90%86.png" alt="runloopä¼‘çœ åŸç†"></p><h3 id="RunLoop-åº”ç”¨"><a href="#RunLoop-åº”ç”¨" class="headerlink" title="RunLoop åº”ç”¨"></a>RunLoop åº”ç”¨</h3><h4 id="NSTimer"><a href="#NSTimer" class="headerlink" title="NSTimer"></a>NSTimer</h4><p>æˆ‘ä»¬çŸ¥é“ NSTimer æ˜¯ä¸€ä¸ªä¸å‡†ç¡®çš„å®šæ—¶å™¨ï¼Œæ˜¯æœ‰è¯¯å·®çš„ã€‚</p><p>å½“ä¸€ä¸ª NSTimer æ³¨å†Œåˆ° RunLoop åï¼ŒRunLoop ä¼šä¸ºå…¶é‡å¤çš„æ—¶é—´ç‚¹æ³¨å†Œå¥½äº‹ä»¶ã€‚RunLoop ä¸ºäº†èŠ‚çœèµ„æºï¼Œå¹¶ä¸ä¼šåœ¨éå¸¸å‡†ç¡®çš„æ—¶é—´ç‚¹å›è°ƒè¿™ä¸ª Timerã€‚Timer æœ‰ä¸ªå±æ€§å«åš toleranceï¼ˆå®½å®¹åº¦ï¼‰ï¼Œæ ‡ç¤ºäº†å½“æ—¶é—´ç‚¹åˆ°åï¼Œå®¹è®¸æœ‰å¤šå°‘æœ€å¤§è¯¯å·®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopTimer</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">uint16_t</span> _bits;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;</span><br><span class="line">    CFRunLoopRef _runLoop;</span><br><span class="line">    CFMutableSetRef _rlModes;</span><br><span class="line">    CFAbsoluteTime _nextFireDate;</span><br><span class="line">    CFTimeInterval _interval;<span class="comment">/* immutable */</span></span><br><span class="line">  <span class="comment">/// è¯¯å·® -- å®½å®¹åº¦</span></span><br><span class="line">    CFTimeInterval _tolerance;          <span class="comment">/* mutable */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> _fireTSR;<span class="comment">/* TSR units */</span></span><br><span class="line">    CFIndex _order;<span class="comment">/* immutable */</span></span><br><span class="line">    CFRunLoopTimerCallBack _callout;<span class="comment">/* immutable */</span></span><br><span class="line">    CFRunLoopTimerContext _context;<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦‚æœ timer é”™è¿‡äº†æŸä¸ªæ—¶é—´ç‚¹ï¼Œä¾‹å¦‚æ‰§è¡Œä¸€ä¸ªå¾ˆé•¿çš„ä»»åŠ¡ï¼Œåˆ™è¿™ä¸ªæ—¶é—´ç‚¹çš„å›è°ƒä¹Ÿä¼šè·³è¿‡å»ï¼Œä¸ä¼šå»¶åæ‰§è¡Œã€‚æ‰€ä»¥é”™è¿‡äº†å°±éœ€è¦ç­‰ä¸‹ä¸€æ¬¡çš„ loopï¼Œè¿™ä¹Ÿå°±æ˜¯ timer ä¸å‡†ç¡®çš„åŸå› ã€‚</p><p>å†æœ‰å°±æ˜¯ Timer åœ¨æ»‘åŠ¨æ—¶ä¼šå¤±æ•ˆçš„é—®é¢˜ã€‚å› ä¸º RunLoop åªèƒ½é€‰æ‹©ä¸€ä¸ª mode è¿è¡Œï¼Œå¦‚æœ timer å¤„äº kCFRunLoopDefaultMode æ—¶ï¼Œæ­¤æ—¶ç•Œé¢æ»‘åŠ¨ï¼ŒRunLoop ä¼šåˆ‡æ¢åˆ°å¦ä¸€ç§æ¨¡å¼ï¼šUITrackingRunLoopModeï¼Œæ­¤æ—¶ç•Œé¢å¤„äºè·Ÿè¸ª modeï¼Œæ­¤ç§æ¨¡å¼ç”¨äº scrollView è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»– mode å½±å“ï¼Œä½†æ˜¯ç›¸å¯¹äº†ä¹Ÿä¼šä½¿å¤„äº default mode çš„ timer å¤±æ•ˆã€‚</p><p>æœ‰ä¸¤ç§æ–¹å¼è§£å†³ï¼š</p><ol><li>å°† timer ä¾æ¬¡åŠ å…¥åˆ°ä¸Šè¿°ä¸¤ä¸ª mode é‡Œé¢</li><li>å°† timer æ”¾åˆ°é¡¶å±‚çš„ commonModeItems é‡Œé¢ï¼ŒcommonModeItems ä¼šè¢« RunLoop è‡ªåŠ¨æ›´æ–°åˆ°å…·æœ‰ common å±æ€§çš„ mode é‡Œé¢å»</li></ol><h4 id="GCD"><a href="#GCD" class="headerlink" title="GCD"></a>GCD</h4><p>GCD çš„æŸäº›æ¥å£ä¹Ÿç”¨åˆ°äº† RunLoopï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dispatch_async(<span class="name">dispatch_get_global_queue</span>(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    </span><br><span class="line">    // å¤„ç†ä¸€äº›å­çº¿ç¨‹çš„é€»è¾‘</span><br><span class="line">    </span><br><span class="line">    // å›åˆ°ä¸»çº¿ç¨‹å»åˆ·æ–°UIç•Œé¢</span><br><span class="line">    dispatch_async(<span class="name">dispatch_get_main_queue</span>(), ^&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;)<span class="comment">;</span></span><br><span class="line">&#125;)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>å½“è°ƒç”¨ <code>dispatch_async(dispatch_get_main_queue(), ^{})</code> æ—¶ï¼ŒlibDispatch ä¼šå‘ä¸»çº¿ç¨‹çš„ RunLoop å‘é€æ¶ˆæ¯ï¼ŒRunLoop ä¼šè¢«å”¤é†’ï¼Œå¹¶ä»æ¶ˆæ¯ä¸­å–å¾—è¿™ä¸ª blockï¼Œå¹¶åœ¨å›è°ƒé‡Œé¢æ‰§è¡Œè¿™ä¸ª blockã€‚è¿™ä¸ªé€»è¾‘ä»…é™äº dispatch åˆ°ä¸»çº¿ç¨‹ï¼Œdispatch åˆ°å…¶ä»–çº¿ç¨‹ä»ç„¶æ˜¯æœ‰ libDispatch å¤„ç†çš„ã€‚ </p><h4 id="PerformSelector"><a href="#PerformSelector" class="headerlink" title="PerformSelector"></a>PerformSelector</h4><p>çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">  </span><br><span class="line">    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        </span><br><span class="line">        [self performSelector:@selector(test1)];</span><br><span class="line">        [self performSelector:@selector(test2) withObject:nil];</span><br><span class="line">        [self performSelector:@selector(test3) withObject:nil withObject:nil];</span><br><span class="line">        </span><br><span class="line">        [self performSelector:@selector(test4) withObject:nil afterDelay:0];</span><br><span class="line">        </span><br><span class="line">        [self performSelector:@selector(test5) onThread:[NSThread currentThread] withObject:nil waitUntilDone:NO];</span><br><span class="line">        </span><br><span class="line">//        [[NSRunLoop currentRunLoop] addPort:[NSPort new] forMode:NSDefaultRunLoopMode];</span><br><span class="line">//        [[NSRunLoop currentRunLoop] run];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test1 &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test2 &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test3 &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test4 &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test5 &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ²¡æœ‰åœ¨å­çº¿ç¨‹è·å– RunLoop æ—¶ï¼Œæ˜¯æ²¡æœ‰ test4 å’Œ test5 æ–¹æ³•æ‰“å°çš„ï¼Œå½“æ·»åŠ  RunLoop æ—¶æ‰ä¼šæœ‰æ–¹æ³•æ‰“å°ã€‚å› ä¸ºå­çº¿ç¨‹é»˜è®¤æ˜¯æ²¡æœ‰ RunLoop çš„ã€‚</p><p>æ¥çœ‹ä¸‹ <code>[self performSelector:@selector(test4) withObject:nil afterDelay:0];</code>çš„è°ƒç”¨æ ˆï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* thread #<span class="number">4</span>, queue = <span class="string">'com.apple.root.default-qos'</span>, stop reason = breakpoint <span class="number">1.1</span></span><br><span class="line">  * frame #<span class="number">0</span>: <span class="number">0x0000000109013387</span> Interview01-runloopæµç¨‹`-[ViewController test4](self=<span class="number">0x00007fd80c40b680</span>, _cmd=<span class="string">"test4"</span>) at ViewController.m:<span class="number">66</span>:<span class="number">5</span></span><br><span class="line">    frame #<span class="number">1</span>: <span class="number">0x00007fff25958d64</span> Foundation`__NSFireDelayedPerform + <span class="number">420</span></span><br><span class="line">    frame #<span class="number">2</span>: <span class="number">0x00007fff23da2414</span> CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + <span class="number">20</span></span><br><span class="line">    frame #<span class="number">3</span>: <span class="number">0x00007fff23da20ae</span> CoreFoundation`__CFRunLoopDoTimer + <span class="number">1038</span></span><br><span class="line">    frame #<span class="number">4</span>: <span class="number">0x00007fff23da170a</span> CoreFoundation`__CFRunLoopDoTimers + <span class="number">282</span></span><br><span class="line">    frame #<span class="number">5</span>: <span class="number">0x00007fff23d9c35e</span> CoreFoundation`__CFRunLoopRun + <span class="number">1950</span></span><br><span class="line">    frame #<span class="number">6</span>: <span class="number">0x00007fff23d9b8a4</span> CoreFoundation`CFRunLoopRunSpecific + <span class="number">404</span></span><br><span class="line">    frame #<span class="number">7</span>: <span class="number">0x00007fff25957c71</span> Foundation`-[NSRunLoop(NSRunLoop) runMode:beforeDate:] + <span class="number">211</span></span><br><span class="line">    frame #<span class="number">8</span>: <span class="number">0x00007fff25957e85</span> Foundation`-[NSRunLoop(NSRunLoop) run] + <span class="number">76</span></span><br><span class="line">    frame #<span class="number">9</span>: <span class="number">0x0000000109013254</span> Interview01-runloopæµç¨‹`__29-[ViewController viewDidLoad]_block_invoke(.block_descriptor=<span class="number">0x00006000022fe3d0</span>) at ViewController.m:<span class="number">48</span>:<span class="number">9</span></span><br><span class="line">    frame #<span class="number">10</span>: <span class="number">0x000000010927af11</span> libdispatch.dylib`_dispatch_call_block_and_release + <span class="number">12</span></span><br><span class="line">    frame #<span class="number">11</span>: <span class="number">0x000000010927be8e</span> libdispatch.dylib`_dispatch_client_callout + <span class="number">8</span></span><br><span class="line">    frame #<span class="number">12</span>: <span class="number">0x000000010927e2d8</span> libdispatch.dylib`_dispatch_queue_override_invoke + <span class="number">1022</span></span><br><span class="line">    frame #<span class="number">13</span>: <span class="number">0x000000010928d399</span> libdispatch.dylib`_dispatch_root_queue_drain + <span class="number">351</span></span><br><span class="line">    frame #<span class="number">14</span>: <span class="number">0x000000010928dca6</span> libdispatch.dylib`_dispatch_worker_thread2 + <span class="number">135</span></span><br><span class="line">    frame #<span class="number">15</span>: <span class="number">0x00007fff522b39f7</span> libsystem_pthread.dylib`_pthread_wqthread + <span class="number">220</span></span><br><span class="line">    frame #<span class="number">16</span>: <span class="number">0x00007fff522b2b77</span> libsystem_pthread.dylib`start_wqthread + <span class="number">15</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè§¦å‘çš„æ˜¯ timerã€‚</p><p>å†æ¥çœ‹ä¸‹ <code>[self performSelector:@selector(test5) onThread:[NSThread currentThread] withObject:nil waitUntilDone:NO];</code>çš„è°ƒç”¨æ ˆï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">* thread #<span class="number">4</span>, queue = <span class="string">'com.apple.root.default-qos'</span>, stop reason = breakpoint <span class="number">2.1</span></span><br><span class="line">  * frame #<span class="number">0</span>: <span class="number">0x00000001090133b7</span> Interview01-runloopæµç¨‹`-[ViewController test5](self=<span class="number">0x00007fd80c40b680</span>, _cmd=<span class="string">"test5"</span>) at ViewController.m:<span class="number">70</span>:<span class="number">5</span></span><br><span class="line">    frame #<span class="number">1</span>: <span class="number">0x00007fff2596de42</span> Foundation`__NSThreadPerformPerform + <span class="number">209</span></span><br><span class="line">    frame #<span class="number">2</span>: <span class="number">0x00007fff23da1c91</span> CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + <span class="number">17</span></span><br><span class="line">    frame #<span class="number">3</span>: <span class="number">0x00007fff23da1bbc</span> CoreFoundation`__CFRunLoopDoSource0 + <span class="number">76</span></span><br><span class="line">    frame #<span class="number">4</span>: <span class="number">0x00007fff23da1394</span> CoreFoundation`__CFRunLoopDoSources0 + <span class="number">180</span></span><br><span class="line">    frame #<span class="number">5</span>: <span class="number">0x00007fff23d9bf8e</span> CoreFoundation`__CFRunLoopRun + <span class="number">974</span></span><br><span class="line">    frame #<span class="number">6</span>: <span class="number">0x00007fff23d9b8a4</span> CoreFoundation`CFRunLoopRunSpecific + <span class="number">404</span></span><br><span class="line">    frame #<span class="number">7</span>: <span class="number">0x00007fff25957c71</span> Foundation`-[NSRunLoop(NSRunLoop) runMode:beforeDate:] + <span class="number">211</span></span><br><span class="line">    frame #<span class="number">8</span>: <span class="number">0x00007fff25957e85</span> Foundation`-[NSRunLoop(NSRunLoop) run] + <span class="number">76</span></span><br><span class="line">    frame #<span class="number">9</span>: <span class="number">0x0000000109013254</span> Interview01-runloopæµç¨‹`__29-[ViewController viewDidLoad]_block_invoke(.block_descriptor=<span class="number">0x00006000022fe3d0</span>) at ViewController.m:<span class="number">48</span>:<span class="number">9</span></span><br><span class="line">    frame #<span class="number">10</span>: <span class="number">0x000000010927af11</span> libdispatch.dylib`_dispatch_call_block_and_release + <span class="number">12</span></span><br><span class="line">    frame #<span class="number">11</span>: <span class="number">0x000000010927be8e</span> libdispatch.dylib`_dispatch_client_callout + <span class="number">8</span></span><br><span class="line">    frame #<span class="number">12</span>: <span class="number">0x000000010927e2d8</span> libdispatch.dylib`_dispatch_queue_override_invoke + <span class="number">1022</span></span><br><span class="line">    frame #<span class="number">13</span>: <span class="number">0x000000010928d399</span> libdispatch.dylib`_dispatch_root_queue_drain + <span class="number">351</span></span><br><span class="line">    frame #<span class="number">14</span>: <span class="number">0x000000010928dca6</span> libdispatch.dylib`_dispatch_worker_thread2 + <span class="number">135</span></span><br><span class="line">    frame #<span class="number">15</span>: <span class="number">0x00007fff522b39f7</span> libsystem_pthread.dylib`_pthread_wqthread + <span class="number">220</span></span><br><span class="line">    frame #<span class="number">16</span>: <span class="number">0x00007fff522b2b77</span> libsystem_pthread.dylib`start_wqthread + <span class="number">15</span></span><br></pre></td></tr></table></figure><p>è¿™æ¬¡è§¦å‘çš„æ˜¯ source0ã€‚</p><h4 id="çº¿ç¨‹ä¿æ´»"><a href="#çº¿ç¨‹ä¿æ´»" class="headerlink" title="çº¿ç¨‹ä¿æ´»"></a>çº¿ç¨‹ä¿æ´»</h4><p>æˆ‘ä»¬çŸ¥é“å½“çº¿ç¨‹åœ¨æ‰§è¡Œå®Œå½“å‰ä»»åŠ¡åå°±ä¼šé€€å‡ºï¼Œé‚£ä¹ˆå¦‚æœæƒ³è¦çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¾ç„¶ä¿ç•™ï¼Œå½“æˆ‘ä»¬å½»åº•ä¸éœ€è¦æ—¶å†å°†çº¿ç¨‹é€€å‡ºã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨ RunLoop æ¥åšåˆ°çº¿ç¨‹ä¿æ´»ï¼Œæˆ‘ä»¬è‡ªå·±æ¥æ§åˆ¶çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>æ¥åšä¸ªæµ‹è¯•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@interface XFThread : NSThread</span><br><span class="line">@end</span><br><span class="line">@implementation XFThread</span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic, strong) XFThread * thread;</span><br><span class="line">@end</span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    self.thread = [[XFThread alloc] initWithBlock:^&#123;</span><br><span class="line">        NSLog(@&quot;---- tread begin -----&quot;);</span><br><span class="line">      </span><br><span class="line">        NSLog(@&quot;---- tread end -----&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    [self stop:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    [self performSelector:@selector(threadAction) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)threadAction &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>å½“ push è¿› ViewController æ—¶ï¼Œå¯ä»¥çœ‹åˆ° thread çš„ beginã€end éƒ½å·²ç»æ‰“å°å®Œï¼Œæ­¤æ—¶å½“æˆ‘ä»¬ç‚¹å‡»å±å¹•çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰èµ° <code>threadAction</code>æ–¹æ³•ï¼Œè€Œå½“æŠŠ waitUntilDone å‚æ•°è®¾ç½®ä¸º YES æ—¶ï¼Œä¼šç›´æ¥æŠ¥å‡ºåå†…å­˜è®¿é—®çš„ crashï¼Œå› ä¸ºçº¿ç¨‹åœ¨ start æ—¶å·²ç»æ‰§è¡Œå®Œä»»åŠ¡äº†ï¼Œè¿™æ¡çº¿ç¨‹å·²ç»æ˜¯ä¸€ä¸ªæ²¡ç”¨çš„çº¿ç¨‹ï¼Œä¸èƒ½å†ç”¨æ¥æ‰§è¡Œä»»åŠ¡äº†ã€‚</p><p>è¿™æ˜¯å°±éœ€è¦ç”¨åˆ°äº† RunLoopï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">  </span><br><span class="line">    self.thread = [[XFThread alloc] initWithBlock:^&#123;</span><br><span class="line"></span><br><span class="line">        NSLog(@&quot;---- tread begin -----&quot;);</span><br><span class="line">        </span><br><span class="line">        [[NSRunLoop currentRunLoop] addPort:[[NSPort alloc] init] forMode:NSDefaultRunLoopMode];</span><br><span class="line">        [[NSRunLoop currentRunLoop] run];</span><br><span class="line"> </span><br><span class="line">        NSLog(@&quot;---- tread end -----&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (IBAction)stop:(id)sender &#123;</span><br><span class="line">    [self performSelector:@selector(stopThread) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)stopThread &#123;</span><br><span class="line">    CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    [self stop:nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ  RunLoop åå†å¢åŠ ä¸€ä¸ª stop æŒ‰é’®ï¼Œå½“ç‚¹å‡» stop æ—¶ï¼Œæˆ‘ä»¬å‘ç°å¹¶æ²¡æœ‰æ‰§è¡Œ tread endã€‚è¿™æ˜¯å› ä¸º run æ–¹æ³•å¯¼è‡´çš„ï¼Œæ¥çœ‹ä¸‹ run æ–¹æ³•çš„å®˜æ–¹è§£é‡Šï¼š</p><blockquote><h2 id="Discussion"><a href="#Discussion" class="headerlink" title="Discussion"></a>Discussion</h2><p>If no input sources or timers are attached to the run loop, this method exits immediately; otherwise, it runs the receiver in the <code>NSDefaultRunLoopMode</code> by repeatedly invoking <a href="apple-reference-documentation://hcGlc34FMW" target="_blank" rel="noopener"><code>runMode:beforeDate:</code></a>. In other words, this method effectively begins an infinite loop that processes data from the run loopâ€™s input sources and timers. </p><p>Manually removing all known input sources and timers from the run loop is not a guarantee that the run loop will exit. macOS can install and remove additional input sources as needed to process requests targeted at the receiverâ€™s thread. Those sources could therefore prevent the run loop from exiting. </p><p>If you want the run loop to terminate, you shouldnâ€™t use this method. Instead, use one of the other run methods and also check other arbitrary conditions of your own, in a loop. A simple example would be:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; BOOL shouldKeepRunning = YES; // global</span><br><span class="line">&gt; NSRunLoop *theRL = [NSRunLoop currentRunLoop];</span><br><span class="line">&gt; while (shouldKeepRunning &amp;&amp; [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>where <code>shouldKeepRunning</code> is set to <code>NO</code> somewhere else in the program.</p></blockquote><p>å¯ä»¥çœ‹åˆ° run æ–¹æ³•æ˜¯ç”¨æ¥è®¾ç½®æ°¸ä¸é”€æ¯çš„çº¿ç¨‹çš„ï¼Œå¦‚æœæƒ³è¦æ§åˆ¶çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œéœ€è¦ä½¿ç”¨ example é‡Œé¢çš„æ–¹æ³•ã€‚æ¥è¯•ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic, strong) XFThread * thread;</span><br><span class="line">@property (nonatomic, assign, getter=isStoped) BOOL stoped;</span><br><span class="line">@end</span><br><span class="line">  </span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    typeof(self) __weak weakSelf = self;</span><br><span class="line">    self.stoped = NO;</span><br><span class="line">    </span><br><span class="line">    self.thread = [[XFThread alloc] initWithBlock:^&#123;</span><br><span class="line"></span><br><span class="line">        NSLog(@&quot;---- tread begin -----&quot;);</span><br><span class="line">        [[NSRunLoop currentRunLoop] addPort:[[NSPort alloc] init] forMode:NSDefaultRunLoopMode];</span><br><span class="line">        while (weakSelf &amp;&amp; !weakSelf.isStoped) &#123;</span><br><span class="line">            [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];</span><br><span class="line">        &#125;</span><br><span class="line">        NSLog(@&quot;---- tread end -----&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [self.thread start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)threadAction &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    [self stop:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (IBAction)stop:(id)sender &#123;</span><br><span class="line">    if (!self.thread) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [self performSelector:@selector(stopThread) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)stopThread &#123;</span><br><span class="line">    self.stoped = YES;</span><br><span class="line"></span><br><span class="line">    CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line"></span><br><span class="line">    self.thread = nil;</span><br><span class="line"></span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    </span><br><span class="line">    if (!self.thread) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [self performSelector:@selector(threadAction) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ­¤æ—¶ç›´æ¥é€€å‡ºç•Œé¢æˆ–è€…ä¸»åŠ¨è§¦å‘ stopï¼Œä¼šå‡ºç° crashï¼Œå› ä¸ºæ­¤æ—¶ stopThread å’Œ dealloc æ–¹æ³•æ˜¯åŒäº‹è¿›è¡Œçš„ï¼Œè¿™é‡Œéœ€è¦ä¿è¯å…ˆæ‰§è¡Œ stopTreadï¼Œç„¶ååœ¨æ‰§è¡Œ deallocã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦æŠŠ waitUntilDone æ–¹æ³•è®¾ç½®ä¸º YESï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (IBAction)stop:(id)sender &#123;</span><br><span class="line">    if (!self.thread) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [self performSelector:@selector(stopThread) onThread:self.thread withObject:nil waitUntilDone:YES];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œç¾è§£å†³~</p><p>ç®€å•æ¥å°è£…ä¸‹ threadï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">@interface XFThread : NSThread</span><br><span class="line">@end</span><br><span class="line">@implementation XFThread</span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">  </span><br><span class="line">@interface XFPermenentThread : NSObject</span><br><span class="line">- (void)stop;</span><br><span class="line">- (void)executeTask:(dispatch_block_t)task;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface XFPermenentThread ()</span><br><span class="line">@property (nonatomic, strong) XFThread * innerThread;</span><br><span class="line">@property (nonatomic, assign, getter=isStopped) BOOL stopped;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation XFPermenentThread</span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        self.stopped = NO;</span><br><span class="line">        </span><br><span class="line">        typeof(self) __weak weakSelf = self;</span><br><span class="line">        </span><br><span class="line">        self.innerThread = [[XFThread alloc] initWithBlock:^&#123;</span><br><span class="line">            </span><br><span class="line">            [[NSRunLoop currentRunLoop] addPort:[[NSPort alloc] init] forMode:NSDefaultRunLoopMode];</span><br><span class="line">            </span><br><span class="line">            while (weakSelf &amp;&amp; !weakSelf.isStopped) &#123;</span><br><span class="line">                [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">        [self.innerThread start];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)stop &#123;</span><br><span class="line">    if (!self.innerThread) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    [self performSelector:@selector(__stop) onThread:self.innerThread withObject:nil waitUntilDone:YES];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)executeTask:(dispatch_block_t)task &#123;</span><br><span class="line">    if (!self.innerThread || !task) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    [self performSelector:@selector(__executeTask:) onThread:self.innerThread withObject:task waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">    [self stop];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)__stop &#123;</span><br><span class="line">    self.stopped = YES;</span><br><span class="line">    CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">    self.innerThread = nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)__executeTask:(dispatch_block_t)task &#123;</span><br><span class="line">    !task ? : task();</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>è‡³æ­¤æˆ‘ä»¬å¯ä»¥åšåˆ°æ‰‹åŠ¨æ§åˆ¶ä¸€æ¡çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><h3 id="å‚è€ƒ-ï¼š"><a href="#å‚è€ƒ-ï¼š" class="headerlink" title="å‚è€ƒ ï¼š"></a>å‚è€ƒ ï¼š</h3><ol><li>YY å¤§ç¥ï¼š<a href="https://blog.ibireme.com/2015/05/18/runloop/#more-41710" target="_blank" rel="noopener">https://blog.ibireme.com/2015/05/18/runloop/#more-41710</a></li><li>å®˜æ–¹æºç ï¼š<a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">https://opensource.apple.com/tarballs/CF/</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;RunLoop-æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#RunLoop-æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;RunLoop æ¦‚å¿µ&quot;&gt;&lt;/a&gt;RunLoop æ¦‚å¿µ&lt;/h3&gt;&lt;p&gt;é¡¾åæ€ä¹‰ï¼ŒRunLoop å°±æ˜¯è¿è¡Œå¾ªç¯ï¼Œåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¾ªç¯åšä¸€äº›äº‹æƒ…ã€‚è¿™ç§æ¨¡å‹é€šå¸¸è¢«ç§°ä½œ &lt;a href=&quot;https://en.wikipedia.org/wiki/Event_loop&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Event Loop&lt;/a&gt;ï¼Œè¿™ç§æ¨¡å‹çš„å…³é”®ç‚¹åœ¨äºï¼šå¦‚ä½•ç®¡ç†äº‹ä»¶/æ¶ˆæ¯ï¼Œå¦‚æœä¿è¯çº¿ç¨‹åœ¨æ²¡æœ‰å¤„ç†æ¶ˆæ¯æ—¶ä¼‘çœ é¿å…èµ„æºå ç”¨ã€å†æœ‰æ¶ˆæ¯åˆ°æ¥æ—¶ç«‹åˆ»è¢«å”¤é†’ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="RunLoop" scheme="http://yoursite.com/tags/RunLoop/"/>
    
  </entry>
  
  <entry>
    <title>RuntimeåŸç†æ¢ç©¶</title>
    <link href="http://yoursite.com/2020/07/20/Runtime%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/"/>
    <id>http://yoursite.com/2020/07/20/RuntimeåŸç†æ¢ç©¶/</id>
    <published>2020-07-20T02:39:44.000Z</published>
    <updated>2020-08-15T14:30:11.425Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åŸè®¡åˆ’ä¸€å‘¨ä¸€ä¸ªæ¨¡å—ï¼Œä½†æ˜¯çœ‹åˆ° runTime è¿™é‡ŒæŒç»­æ—¶é—´æœ‰ç‚¹é•¿ï¼Œåº•å±‚å†…å®¹å¾ˆå¤šå•Šï¼ŒåŸå› è¿˜æ˜¯ä¹‹å‰åŸºç¡€å¤ªå·®ï¼Œèœçš„æŠ è„šã€‚ã€‚ã€‚è¿˜æœ‰æ•´ç†å®Œ block åå†æƒ³ block hook åº”è¯¥æ€ä¹ˆå®ç°ï¼Œçæäº†ä¸€é€šæœ€åæ‰¾åˆ°äº†å¼€æºçš„åº“ <code>blockHook</code>ï¼Œçœ‹äº†å‡ å¤©çš„æºç å‘ç°åº•å±‚æŒæ¡çš„è¿˜æ˜¯ä¸ç‰¢ï¼Œå…¶ä¸­åŒ…æ‹¬ runtime éƒ¨åˆ†ï¼Œå…ˆæ•´ç†å®Œ runtime éƒ¨åˆ†ç„¶åå†å›å¤´é‡æ–°åˆ†æ blockHookã€‚</p></blockquote><p>ä¸‹æ–‡å†…å®¹æ˜¯æ ¹æ® <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">objc4-723</a> ç‰ˆæœ¬åˆ†æçš„ï¼Œç›®å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">objc4-781</a>ï¼Œæœ€æ–°ç‰ˆæœ¬åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œä¸è¿‡ä¸å½±å“æˆ‘ä»¬ç†è§£ã€‚</p><h3 id="isa-è¯¦è§£"><a href="#isa-è¯¦è§£" class="headerlink" title="isa è¯¦è§£"></a>isa è¯¦è§£</h3><a id="more"></a><p>åœ¨ arm64 ç»“æ„ä¹‹å‰ï¼Œisa å°±æ˜¯ä¸€ä¸ªæ™®é€šæŒ‡é’ˆï¼Œå­˜å‚¨ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚</p><p>ä» arm64 ç»“æ„å¼€å§‹ï¼Œå¯¹ isa è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå˜æˆäº†ä¸€ä¸ªå…±ç”¨ä½“ï¼ˆunionï¼‰ç»“æ„ï¼Œä½¿ç”¨ä½åŸŸæ¥å­˜å‚¨æ›´å¤šä¿¡æ¯</p><p>æ›´å¤šä¿¡æ¯æ˜¯æŒ‡ isa é™¤äº†å­˜å‚¨å¯¹è±¡å†…å­˜åœ°å€å¤–è¿˜å­˜å‚¨äº†å…¶ä»–çš„ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">union isa_t </span><br><span class="line">&#123;</span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line"># if __arm64__</span><br><span class="line">#   define ISA_MASK        0x0000000ffffffff8ULL</span><br><span class="line">#   define ISA_MAGIC_MASK  0x000003f000000001ULL</span><br><span class="line">#   define ISA_MAGIC_VALUE 0x000001a000000001ULL  </span><br><span class="line">    struct &#123;</span><br><span class="line">        uintptr_t nonpointer        : 1;</span><br><span class="line">        uintptr_t has_assoc         : 1;</span><br><span class="line">        uintptr_t has_cxx_dtor      : 1;</span><br><span class="line">        uintptr_t shiftcls          : 33;</span><br><span class="line">        uintptr_t magic             : 6;</span><br><span class="line">        uintptr_t weakly_referenced : 1;</span><br><span class="line">        uintptr_t deallocating      : 1;</span><br><span class="line">        uintptr_t has_sidetable_rc  : 1;</span><br><span class="line">        uintptr_t extra_rc          : 19;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>nonpointerï¼š0 ä»£è¡¨æ™®é€šæŒ‡é’ˆï¼Œå­˜å‚¨ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œ1 ä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¯¹ä¿¡æ¯</li><li>has_assocï¼šæ˜¯å¦æœ‰è®¾ç½®è¿‡å…³è”å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾æ—¶æ›´å¿«</li><li>has_cxx_dtorï¼šæ˜¯å¦æœ‰ C++ çš„ææ„å‡½æ•°ï¼ˆ.cxx_destructï¼‰ï¼Œå¦‚æœæ²¡æœ‰é‡Šæ”¾æ—¶æ›´å¿«</li><li>shiftclsï¼šå­˜å‚¨ç€ Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯</li><li>magicï¼šç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹ç›¸å…³æ˜¯å¦å®Œæˆåˆå§‹åŒ–</li><li>weakly_referencedï¼šæ˜¯å¦æœ‰è¢«å¼±å¼•ç”¨æŒ‡å‘è¿‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ›´å¿«</li><li>deallocatingï¼š å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾</li><li>has_sidetable_rcï¼šå¼•ç”¨è®¡æ•°å™¨æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨isaä¸­ã€‚1æ ‡è¯†å¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨side tableçš„ç±»å±æ€§ä¸­</li><li>extra_rcï¼šé‡Œé¢å­˜å‚¨çš„å€¼æ˜¯å¼•ç”¨è®¡æ•°å™¨å‡1</li></ul><p>è¿™é‡Œå¯ä»¥ç®€å•çœ‹ä¸€ä¸‹å®ä¾‹å¯¹è±¡ isa æŒ‡é’ˆé‡Œé¢å­˜å‚¨çš„ç±»ï¼Œæˆ‘ä»¬è¿™é‡Œåªç ”ç©¶ arm64 æ¶æ„ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢æœ‰ ISA_MASKï¼Œè¿™ä¸ªæ˜¯ç”¨æ¥å– Classã€Meta-Class å¯¹è±¡çš„å†…å­˜åœ°å€çš„ï¼Œæ¥ä¸ªå°å®éªŒï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NSLog(@<span class="string">"--- %p"</span>, [ViewController <span class="class"><span class="keyword">class</span>]);</span></span><br><span class="line"></span><br><span class="line">ç»“æœ<span class="symbol">:</span></span><br><span class="line">--- <span class="number">0x1000b1cf0</span></span><br><span class="line"></span><br><span class="line">å†æ¥æ‰“å° <span class="keyword">self</span> çš„ isaï¼š</span><br><span class="line">(lldb) p/x <span class="keyword">self</span>-&gt;isa</span><br><span class="line">(Class) $0 = <span class="number">0x000005a1000b1cf7</span> ViewController</span><br><span class="line"></span><br><span class="line">å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä¸¤ä¸ªåœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ ¹æ®ä¸Šé¢çš„ç»“æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨ ISA_MASK æ¥å–ä¸€ä¸‹ isa ä¸­å…³äºå¯¹è±¡çš„å†…å­˜åœ°å€ï¼š</span><br><span class="line">(lldb) p/x <span class="number">0x000005a1000b1cf7</span> &amp; <span class="number">0x0000000ffffffff8</span>ULL</span><br><span class="line">(unsigned long long) $1 = <span class="number">0x00000001000b1cf0</span></span><br><span class="line"></span><br><span class="line">ç”±ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œç”± isa å–å‡ºæ¥çš„åœ°å€å’Œ ViewController <span class="class"><span class="keyword">class</span> ç±»çš„çœŸå®åœ°å€æ˜¯ä¸€æ ·çš„ã€‚</span></span><br></pre></td></tr></table></figure><p>å…³äºä¸Šè¿°æ ‡è®°ä½ä¸­æ›´å¿«é‡Šæ”¾ï¼Œå¯ä»¥å† objc4 é‡Œé¢çœ‹åˆ°æºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">inline void</span><br><span class="line">objc_object::rootDealloc()</span><br><span class="line">&#123;</span><br><span class="line">    if (isTaggedPointer()) return;  // fixme necessary?</span><br><span class="line"></span><br><span class="line">    if (fastpath(isa.nonpointer  &amp;&amp;  </span><br><span class="line">                 !isa.weakly_referenced  &amp;&amp;  </span><br><span class="line">                 !isa.has_assoc  &amp;&amp;  </span><br><span class="line">                 !isa.has_cxx_dtor  &amp;&amp;  </span><br><span class="line">                 !isa.has_sidetable_rc))</span><br><span class="line">    &#123;</span><br><span class="line">        assert(!sidetable_present());</span><br><span class="line">        free(this);</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">        object_dispose((id)this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id </span><br><span class="line">object_dispose(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (!obj) return nil;</span><br><span class="line"></span><br><span class="line">    objc_destructInstance(obj);    </span><br><span class="line">    free(obj);</span><br><span class="line"></span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void *objc_destructInstance(id obj) </span><br><span class="line">&#123;</span><br><span class="line">    if (obj) &#123;</span><br><span class="line">        // Read all of the flags at once for performance.</span><br><span class="line">        bool cxx = obj-&gt;hasCxxDtor();</span><br><span class="line">        bool assoc = obj-&gt;hasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">        // This order is important.</span><br><span class="line">        if (cxx) object_cxxDestruct(obj);</span><br><span class="line">        if (assoc) _object_remove_assocations(obj);</span><br><span class="line">        obj-&gt;clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œåœ¨ dealloc æ—¶ä¼šåˆ†åˆ«è·å–æ˜¯å¦æœ‰å…³è”å¯¹è±¡ã€ææ„å‡½æ•°ã€å¼±æŒ‡é’ˆç­‰æ ‡è®°ä½ï¼Œå¦‚æœæ²¡æœ‰æ˜¯ç›´æ¥é‡Šæ”¾çš„ï¼Œå¦åˆ™ä¼šè°ƒç”¨ç›¸å…³çš„æ–¹å¼é‡Šæ”¾å¯¹åº”çš„èµ„æºã€‚</p><h3 id="Class-ç»“æ„"><a href="#Class-ç»“æ„" class="headerlink" title="Class ç»“æ„"></a>Class ç»“æ„</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">struct objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct objc_class : objc_object &#123;</span><br><span class="line">    // Class ISA;</span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;             // formerly cache pointer and vtable</span><br><span class="line">    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bits &amp; FAST_DATA_MASK å¯ä»¥æ‹¿åˆ° class_rw_t</span><br><span class="line"></span><br><span class="line">struct class_rw_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t version;</span><br><span class="line">    const class_ro_t *ro;</span><br><span class="line">    method_array_t methods;</span><br><span class="line">    property_array_t properties;</span><br><span class="line">    protocol_array_t protocols;</span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line">    char *demangledName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct class_ro_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t instanceStart;</span><br><span class="line">    uint32_t instanceSize;</span><br><span class="line">#ifdef __LP64__</span><br><span class="line">    uint32_t reserved;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    const uint8_t * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    const char * name;</span><br><span class="line">    method_list_t * baseMethodList;</span><br><span class="line">    protocol_list_t * baseProtocols;</span><br><span class="line">    const ivar_list_t * ivars;</span><br><span class="line">    const uint8_t * weakIvarLayout;</span><br><span class="line">    property_list_t *baseProperties;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>class_rw_t é‡Œé¢çš„ methodsã€propertiesã€protocols æ˜¯äºŒç»´æ•°ç»„ï¼Œæ˜¯å¯è¯»å¯å†™çš„ï¼ŒåŒ…å«ç±»çš„åˆå§‹å†…å®¹ã€åˆ†ç±»çš„å†…å®¹ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">method_array_t</span> :</span> </span><br><span class="line"><span class="keyword">public</span> list_array_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>&gt; </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typedef</span> list_array_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>&gt; Super;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Class_ro_t é‡Œé¢çš„ baseMethodListã€baseProtocolsã€ivarsã€baseProperties æ˜¯ä¸€ç»´æ•°ç»„ï¼Œæ˜¯åªè¯»çš„ï¼ŒåŒ…å«äº†ç±»çš„åˆå§‹ä¿¡æ¯ã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸‹ method_t çš„ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct method_t &#123;</span><br><span class="line">    SEL name;// å‡½æ•°å</span><br><span class="line">    const char *types;// ç¼–ç ï¼ˆè¿”å›å€¼ç±»å‹ã€å‚æ•°ç±»å‹ï¼‰</span><br><span class="line">    IMP imp; // æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼ˆå‡½æ•°åœ°å€ï¼‰</span><br><span class="line"></span><br><span class="line">    struct SortBySELAddress :</span><br><span class="line">        public std::binary_function&lt;const method_t&amp;,</span><br><span class="line">                                    const method_t&amp;, bool&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        bool operator() (const method_t&amp; lhs,</span><br><span class="line">                         const method_t&amp; rhs)</span><br><span class="line">        &#123; return lhs.name &lt; rhs.name; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>IMP ä»£è¡¨å‡½æ•°çš„å…·ä½“å®ç°ï¼š</p><p><code>typedef id _Nullable (*IMP)(id _Nonnull, SEL _Nonnull, ...);</code></p><p>SEL ä»£è¡¨æ–¹æ³•\å‡½æ•°åï¼Œä¸€èˆ¬ç§°ä½œé€‰æ‹©å™¨ï¼Œåº•å±‚ç»“æ„å’Œ char* ç±»å‹</p><ul><li>å¯ä»¥é€šè¿‡ @selector() å’Œ sel_registerName() è·å¾—</li><li>å¯ä»¥é€šè¿‡ sel_getName() å’Œ NSStringFromSelector() è½¬æˆå­—ç¬¦ä¸²</li><li>ä¸åŒç±»ä¸­ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œæ‰€å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„</li></ul><p><code>typedef struct objc_selector *SEL;</code></p><p>types æ˜¯åŒ…å«äº†å‡½æ•°è¿”å›å€¼ã€å‚æ•°ç¼–ç çš„å­—ç¬¦ä¸²</p><h3 id="æ–¹æ³•ç¼“å­˜"><a href="#æ–¹æ³•ç¼“å­˜" class="headerlink" title="æ–¹æ³•ç¼“å­˜"></a>æ–¹æ³•ç¼“å­˜</h3><p>Class å†…éƒ¨ç»“æ„ç”¨æœ‰ä¸ªæ–¹æ³•ç¼“å­˜ï¼ˆcache_tï¼‰ï¼Œç”¨æ•£åˆ—è¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰æ¥ç¼“å­˜æ›¾ç»è°ƒç”¨è¿‡çš„æ–¹æ³•ï¼Œå¯ä»¥æé«˜æ–¹æ³•çš„æŸ¥æ‰¾é€Ÿåº¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">struct bucket_t &#123;</span><br><span class="line">private:</span><br><span class="line">    cache_key_t _key; // SEL ä½œä¸º key</span><br><span class="line">    IMP _imp;// å‡½æ•°çš„å†…å­˜åœ°å€</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    inline cache_key_t key() const &#123; return _key; &#125;</span><br><span class="line">    inline IMP imp() const &#123; return (IMP)_imp; &#125;</span><br><span class="line">    inline void setKey(cache_key_t newKey) &#123; _key = newKey; &#125;</span><br><span class="line">    inline void setImp(IMP newImp) &#123; _imp = newImp; &#125;</span><br><span class="line"></span><br><span class="line">    void set(cache_key_t newKey, IMP newImp);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct cache_t &#123;</span><br><span class="line">    struct bucket_t *_buckets; // æ•£åˆ—è¡¨</span><br><span class="line">    mask_t _mask;// æ•£åˆ—è¡¨é•¿åº¦ - 1</span><br><span class="line">    mask_t _occupied; // å·²ç»ç¼“å­˜çš„æ–¹æ³•æ•°é‡</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    struct bucket_t *buckets();</span><br><span class="line">    mask_t mask();</span><br><span class="line">    mask_t occupied();</span><br><span class="line">    void incrementOccupied();</span><br><span class="line">    void setBucketsAndMask(struct bucket_t *newBuckets, mask_t newMask);</span><br><span class="line">    void initializeToEmpty();</span><br><span class="line"></span><br><span class="line">    mask_t capacity();</span><br><span class="line">    bool isConstantEmptyCache();</span><br><span class="line">    bool canBeFreed();</span><br><span class="line"></span><br><span class="line">    static size_t bytesForCapacity(uint32_t cap);</span><br><span class="line">    static struct bucket_t * endMarker(struct bucket_t *b, uint32_t cap);</span><br><span class="line"></span><br><span class="line">    void expand();</span><br><span class="line">    void reallocate(mask_t oldCapacity, mask_t newCapacity);</span><br><span class="line">    struct bucket_t * find(cache_key_t key, id receiver);</span><br><span class="line"></span><br><span class="line">    static void bad_cache(id receiver, SEL sel, Class isa) __attribute__((noreturn));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸‹è·å– cache çš„å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// å¦‚æœ iä¸º0åˆ™ä»maskå¼€å§‹æŸ¥æ‰¾ï¼ˆmaskä¸ºè¡¨é•¿åº¦-1ï¼‰ï¼Œå¦‚æœiä¸ä¸ºç©ºåˆ™ä»i-1å¼€å§‹æŸ¥æ‰¾</span><br><span class="line">static inline mask_t cache_next(mask_t i, mask_t mask) &#123;</span><br><span class="line">    return i ? i-1 : mask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bucket_t * cache_t::find(cache_key_t k, id receiver)</span><br><span class="line">&#123;</span><br><span class="line">    assert(k != 0);</span><br><span class="line"></span><br><span class="line">    bucket_t *b = buckets();</span><br><span class="line">    mask_t m = mask();</span><br><span class="line">    mask_t begin = cache_hash(k, m);</span><br><span class="line">    mask_t i = begin;</span><br><span class="line">    do &#123;</span><br><span class="line">        if (b[i].key() == 0  ||  b[i].key() == k) &#123;</span><br><span class="line">            return &amp;b[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while ((i = cache_next(i, m)) != begin);</span><br><span class="line"></span><br><span class="line">    // hack</span><br><span class="line">    Class cls = (Class)((uintptr_t)this - offsetof(objc_class, cache));</span><br><span class="line">    cache_t::bad_cache(receiver, (SEL)k, cls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•£åˆ—è¡¨æ‰©å®¹ï¼Œä»æºç å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡æ‰©å®¹éƒ½æ˜¯åŸæ¥å®¹ç§¯çš„ä¸¤å€ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void cache_t::expand()</span><br><span class="line">&#123;</span><br><span class="line">    cacheUpdateLock.assertLocked();</span><br><span class="line">    </span><br><span class="line">    uint32_t oldCapacity = capacity();</span><br><span class="line">    uint32_t newCapacity = oldCapacity ? oldCapacity*2 : INIT_CACHE_SIZE;</span><br><span class="line"></span><br><span class="line">    if ((uint32_t)(mask_t)newCapacity != newCapacity) &#123;</span><br><span class="line">        // mask overflow - can&apos;t grow further</span><br><span class="line">        // fixme this wastes one bit of mask</span><br><span class="line">        newCapacity = oldCapacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reallocate(oldCapacity, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="objc-msgSend-æ‰§è¡Œæµç¨‹"><a href="#objc-msgSend-æ‰§è¡Œæµç¨‹" class="headerlink" title="objc_msgSend æ‰§è¡Œæµç¨‹"></a>objc_msgSend æ‰§è¡Œæµç¨‹</h3><h4 id="ç¬¬ä¸€ä¸ªé˜¶æ®µ-æ¶ˆæ¯å‘é€"><a href="#ç¬¬ä¸€ä¸ªé˜¶æ®µ-æ¶ˆæ¯å‘é€" class="headerlink" title="ç¬¬ä¸€ä¸ªé˜¶æ®µ - æ¶ˆæ¯å‘é€"></a>ç¬¬ä¸€ä¸ªé˜¶æ®µ - æ¶ˆæ¯å‘é€</h4><p>çœ‹ä¸€ä¸‹ä¸‹é¢çš„ç»å…¸è°ƒç”¨å›¾ç‰‡</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/runtime/oc-class.png" alt="oc-class.png"></p><p>ä¸‹é¢çœ‹ä¸‹æ¶ˆæ¯å‘é€çš„æµç¨‹ï¼š</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/runtime/%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81.png" alt="æ¶ˆæ¯å‘é€"></p><h4 id="ç¬¬äºŒä¸ªé˜¶æ®µ-åŠ¨æ€æ–¹æ³•è§£æ"><a href="#ç¬¬äºŒä¸ªé˜¶æ®µ-åŠ¨æ€æ–¹æ³•è§£æ" class="headerlink" title="ç¬¬äºŒä¸ªé˜¶æ®µ - åŠ¨æ€æ–¹æ³•è§£æ"></a>ç¬¬äºŒä¸ªé˜¶æ®µ - åŠ¨æ€æ–¹æ³•è§£æ</h4><p>è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/runtime/%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95%E8%A7%A3%E6%9E%90.png" alt="åŠ¨æ€æ–¹æ³•è§£æ"></p><p>è¿™é‡Œå¯ä»¥ä» objc çš„æºç é‡Œé¢æŸ¥åˆ°ï¼ˆlookUpImpOrForward æ–¹æ³•ï¼‰ï¼š</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (resolver  &amp;&amp;  !triedResolver) &#123;</span><br><span class="line">    runtimeLock.unlockRead();</span><br><span class="line">    _class_resolveMethod(<span class="keyword">cls</span>, sel, inst);</span><br><span class="line">    runtimeLock.read();</span><br><span class="line">    <span class="comment">// Don't cache the result; we don't hold the lock so it may have </span></span><br><span class="line">    <span class="comment">// changed already. Re-do the search from scratch instead.</span></span><br><span class="line">    triedResolver = YES;</span><br><span class="line">    <span class="keyword">goto</span> retry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// No implementation found, and method resolver didn't help. </span></span><br><span class="line"><span class="comment">// Use forwarding.</span></span><br><span class="line"></span><br><span class="line">imp = (IMP)_objc_msgForward_impcache;</span><br><span class="line">cache_fill(<span class="keyword">cls</span>, sel, imp, inst);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ ‡è®°ä½ triedResolver å’Œæˆ‘ä»¬æµç¨‹å›¾é‡Œé¢å¯¹åº”ã€‚</p><h4 id="ç¬¬ä¸‰ä¸ªé˜¶æ®µ-æ¶ˆæ¯è½¬å‘"><a href="#ç¬¬ä¸‰ä¸ªé˜¶æ®µ-æ¶ˆæ¯è½¬å‘" class="headerlink" title="ç¬¬ä¸‰ä¸ªé˜¶æ®µ - æ¶ˆæ¯è½¬å‘"></a>ç¬¬ä¸‰ä¸ªé˜¶æ®µ - æ¶ˆæ¯è½¬å‘</h4><p>çœ‹ä¸‹æµç¨‹å›¾ï¼š</p><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/runtime/%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91.png" alt="æ¶ˆæ¯è½¬å‘"></p><p>ç”±äºæ¶ˆæ¯è½¬å‘é˜¶æ®µæ²¡æœ‰å¼€æºï¼Œè¿™é‡Œåœ¨ç½‘ä¸Šæ‰’å‡ºå¤§ç¥æ•´ç†çš„ä¼ªä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç </span></span><br><span class="line"><span class="keyword">int</span> __forwarding__(<span class="keyword">void</span> *frameStackPointer, <span class="keyword">int</span> isStret) &#123;</span><br><span class="line">    <span class="keyword">id</span> receiver = *(<span class="keyword">id</span> *)frameStackPointer;</span><br><span class="line">    SEL sel = *(SEL *)(frameStackPointer + <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *selName = sel_getName(sel);</span><br><span class="line">    Class receiverClass = object_getClass(receiver);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ forwardingTargetForSelector:</span></span><br><span class="line">    <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(forwardingTargetForSelector:))) &#123;</span><br><span class="line">        <span class="keyword">id</span> forwardingTarget = [receiver forwardingTargetForSelector:sel];</span><br><span class="line">        <span class="keyword">if</span> (forwardingTarget &amp;&amp; forwardingTarget != receiver) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isStret == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> ret;</span><br><span class="line">                objc_msgSend_stret(&amp;ret,forwardingTarget, sel, ...);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> objc_msgSend(forwardingTarget, sel, ...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åƒµå°¸å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *className = class_getName(receiverClass);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *zombiePrefix = <span class="string">"_NSZombie_"</span>;</span><br><span class="line">    size_t prefixLen = strlen(zombiePrefix); <span class="comment">// 0xa</span></span><br><span class="line">    <span class="keyword">if</span> (strncmp(className, zombiePrefix, prefixLen) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">CFLog</span>(kCFLogLevelError,</span><br><span class="line">              <span class="string">@"*** -[%s %s]: message sent to deallocated instance %p"</span>,</span><br><span class="line">              className + prefixLen,</span><br><span class="line">              selName,</span><br><span class="line">              receiver);</span><br><span class="line">        &lt;breakpoint-interrupt&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ methodSignatureForSelector è·å–æ–¹æ³•ç­¾ååå†è°ƒç”¨ forwardInvocation</span></span><br><span class="line">    <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(methodSignatureForSelector:))) &#123;</span><br><span class="line">        <span class="built_in">NSMethodSignature</span> *methodSignature = [receiver methodSignatureForSelector:sel];</span><br><span class="line">        <span class="keyword">if</span> (methodSignature) &#123;</span><br><span class="line">            <span class="built_in">BOOL</span> signatureIsStret = [methodSignature _frameDescriptor]-&gt;returnArgInfo.flags.isStruct;</span><br><span class="line">            <span class="keyword">if</span> (signatureIsStret != isStret) &#123;</span><br><span class="line">                <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</span><br><span class="line">                      <span class="string">@"*** NSForwarding: warning: method signature and compiler disagree on struct-return-edness of '%s'.  Signature thinks it does%s return a struct, and compiler thinks it does%s."</span>,</span><br><span class="line">                      selName,</span><br><span class="line">                      signatureIsStret ? <span class="string">""</span> : not,</span><br><span class="line">                      isStret ? <span class="string">""</span> : not);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (class_respondsToSelector(receiverClass, <span class="keyword">@selector</span>(forwardInvocation:))) &#123;</span><br><span class="line">                <span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> _invocationWithMethodSignature:methodSignature frame:frameStackPointer];</span><br><span class="line"></span><br><span class="line">                [receiver forwardInvocation:invocation];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">void</span> *returnValue = <span class="literal">NULL</span>;</span><br><span class="line">                [invocation getReturnValue:&amp;value];</span><br><span class="line">                <span class="keyword">return</span> returnValue;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</span><br><span class="line">                      <span class="string">@"*** NSForwarding: warning: object %p of class '%s' does not implement forwardInvocation: -- dropping message"</span>,</span><br><span class="line">                      receiver,</span><br><span class="line">                      className);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SEL *registeredSel = sel_getUid(selName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// selector æ˜¯å¦å·²ç»åœ¨ Runtime æ³¨å†Œè¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (sel != registeredSel) &#123;</span><br><span class="line">        <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</span><br><span class="line">              <span class="string">@"*** NSForwarding: warning: selector (%p) for message '%s' does not match selector known to Objective C runtime (%p)-- abort"</span>,</span><br><span class="line">              sel,</span><br><span class="line">              selName,</span><br><span class="line">              registeredSel);</span><br><span class="line">    &#125; <span class="comment">// doesNotRecognizeSelector</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (class_respondsToSelector(receiverClass,<span class="keyword">@selector</span>(doesNotRecognizeSelector:))) &#123;</span><br><span class="line">        [receiver doesNotRecognizeSelector:sel];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">CFLog</span>(kCFLogLevelWarning ,</span><br><span class="line">              <span class="string">@"*** NSForwarding: warning: object %p of class '%s' does not implement doesNotRecognizeSelector: -- abort"</span>,</span><br><span class="line">              receiver,</span><br><span class="line">              className);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The point of no return.</span></span><br><span class="line">    kill(getpid(), <span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Super-æœ¬è´¨"><a href="#Super-æœ¬è´¨" class="headerlink" title="Super æœ¬è´¨"></a>Super æœ¬è´¨</h3><h4 id="super-æœ¬è´¨è°ƒç”¨"><a href="#super-æœ¬è´¨è°ƒç”¨" class="headerlink" title="super æœ¬è´¨è°ƒç”¨"></a>super æœ¬è´¨è°ƒç”¨</h4><p>äº†è§£å®Œ objc_msgSend æœºåˆ¶å†æ¥çœ‹ä¸‹ super çš„æœ¬è´¨ã€‚</p><p>åšä¸ªæµ‹è¯•ï¼Œé‡å†™ forwardInvocation æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation &#123;</span><br><span class="line">    [super forwardInvocation:anInvocation];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨ clang æŸ¥çœ‹è½¬æ¢æˆçš„ c++ ä»£ç </span><br><span class="line"></span><br><span class="line">((void (*)(__rw_objc_super *, SEL, NSInvocation *))(void *)objc_msgSendSuper)((__rw_objc_super)&#123;(id)self, (id)class_getSuperclass(objc_getClass(&quot;MJPerson&quot;))&#125;, sel_registerName(&quot;forwardInvocation:&quot;), (NSInvocation *)anInvocation);</span><br><span class="line"></span><br><span class="line">åˆ é™¤å¼ºåˆ¶è½¬æ¢ï¼š</span><br><span class="line">    objc_msgSendSuper(</span><br><span class="line">                      &#123;self, (id)class_getSuperclass(objc_getClass(&quot;MJPerson&quot;))&#125;,</span><br><span class="line">                      sel_registerName(&quot;forwardInvocation:&quot;),</span><br><span class="line">                      anInvocation);</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œä½¿ç”¨ super è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ä¸å†æ˜¯ objc_msgSendï¼Œè€Œæ˜¯ objc_msgSendSuperï¼Œå‘é€æ¶ˆæ¯æ—¶æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p><ol><li>ç»“æ„ä½“ struct __rw_objc_super</li><li>æ–¹æ³•å SEL</li><li>å‚æ•° anInvocation</li></ol><p>è¿™é‡Œä¸»è¦çœ‹ä¸‹ç¬¬ä¸€ä¸ªå‚æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__rw_objc_super</span></span> &#123; </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *object; </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *superClass; </span><br><span class="line">__rw_objc_super(<span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *o, <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span></span> *s) : object(o), superClass(s) &#123;&#125; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢  objc_msgSendSuper åˆå§‹åŒ–çš„è°ƒç”¨å¯ä»¥çœ‹åˆ°ï¼Œsuper çš„å®è´¨å…¶å®è¿˜æ˜¯å‘ self å‘é€æ¶ˆæ¯ï¼Œreceiver ä¾ç„¶æ˜¯ selfï¼Œåªä¸è¿‡ç¬¬äºŒä¸ªå‚æ•°æ˜¯ superClassã€‚</p><p>æ‰€ä»¥ super çš„æœ¬è´¨å°±æ˜¯å‘ selfï¼ˆreceiverï¼‰å‘é€æ¶ˆæ¯ï¼Œä¸è¿‡æŸ¥æ‰¾æ–¹æ³•æ—¶æ˜¯ä» super å¼€å§‹æŸ¥æ‰¾ã€‚</p><p>å…¶å®è¿™é‡Œçœ‹åˆ°çš„ä¹Ÿå¹¶éæœ€ç»ˆçš„è°ƒç”¨æ–¹å¼ï¼Œé€šè¿‡æºç æˆ–è€…æ±‡ç¼–ä»£ç ï¼Œæˆ–è€…ç”¨ <a href="https://github.com/RetVal/objc-runtime" target="_blank" rel="noopener">è¿™é‡Œ</a> è°ƒè¯•æŸ¥çœ‹ï¼Œæœ€ç»ˆ super ç”Ÿæˆçš„ç»“æ„æ˜¯ï¼š</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct </span>objc_super2 &#123;</span><br><span class="line">    id receiver<span class="comment">;</span></span><br><span class="line">    Class current_class<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="symbol">ENTRY</span> _objc_msgSendSuper2</span><br><span class="line"></span><br><span class="line"><span class="keyword">ldr</span><span class="built_in">r9</span>, [<span class="built_in">r0</span>, <span class="symbol">#CLASS</span>]// class = <span class="keyword">struct </span>super-&gt;class</span><br><span class="line">// é€šè¿‡ current_class æ‰¾åˆ° superClass</span><br><span class="line"><span class="keyword">ldr</span><span class="built_in">r9</span>, [<span class="built_in">r9</span>, <span class="symbol">#SUPERCLASS</span>]   // class = class-&gt;superclass</span><br><span class="line"><span class="symbol">CacheLookup</span> NORMAL, _objc_msgSendSuper2</span><br><span class="line">// cache hit, IMP in <span class="built_in">r12</span>, eq already set for nonstret forwarding</span><br><span class="line"><span class="keyword">ldr</span><span class="built_in">r0</span>, [<span class="built_in">r0</span>, <span class="symbol">#RECEIVER</span>]// load real receiver</span><br><span class="line"><span class="keyword">bx</span><span class="built_in">r12</span>// call imp</span><br><span class="line"></span><br><span class="line"><span class="symbol">CacheLookup2</span> NORMAL, _objc_msgSendSuper2</span><br><span class="line">// cache miss</span><br><span class="line"><span class="keyword">ldr</span><span class="built_in">r9</span>, [<span class="built_in">r0</span>, <span class="symbol">#CLASS</span>]// class = <span class="keyword">struct </span>super-&gt;class</span><br><span class="line"><span class="keyword">ldr</span><span class="built_in">r9</span>, [<span class="built_in">r9</span>, <span class="symbol">#SUPERCLASS</span>]   // class = class-&gt;superclass</span><br><span class="line"><span class="keyword">ldr</span><span class="built_in">r0</span>, [<span class="built_in">r0</span>, <span class="symbol">#RECEIVER</span>]// load real receiver</span><br><span class="line"><span class="keyword">b</span>__objc_msgSend_uncached</span><br><span class="line"></span><br><span class="line"><span class="symbol">END_ENTRY</span> _objc_msgSendSuper2</span><br></pre></td></tr></table></figure><p>ä¸ç®¡æ˜¯ objc_super è¿˜æ˜¯ objc_super2ï¼Œå¯¹è¿™é‡Œçš„ç†è§£æ˜¯æ²¡æœ‰å½±å“çš„ï¼Œæ¶ˆæ¯çš„æ¥æ”¶è€…å°±æ˜¯ selfï¼Œä¸è¿‡æŸ¥æ‰¾æ–¹æ³•æ˜¯ä» superClass å¼€å§‹æŸ¥æ‰¾çš„ã€‚</p><h4 id="ç»“åˆæ¶ˆæ¯å‘é€æœºåˆ¶å¯¹-super-è°ƒç”¨æ–¹æ³•çš„ç–‘é—®"><a href="#ç»“åˆæ¶ˆæ¯å‘é€æœºåˆ¶å¯¹-super-è°ƒç”¨æ–¹æ³•çš„ç–‘é—®" class="headerlink" title="ç»“åˆæ¶ˆæ¯å‘é€æœºåˆ¶å¯¹ super è°ƒç”¨æ–¹æ³•çš„ç–‘é—®"></a>ç»“åˆæ¶ˆæ¯å‘é€æœºåˆ¶å¯¹ super è°ƒç”¨æ–¹æ³•çš„ç–‘é—®</h4><blockquote><p>æ˜¨å¤©å†™åˆ° super çš„æ—¶å€™çªç„¶æƒ³åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ super çš„æœ¬è´¨æ˜¯ï¼šæ¶ˆæ¯æ¥å—è€…ä¸º selfï¼Œä¸è¿‡æŸ¥æ‰¾æ–¹æ³•æ˜¯åœ¨ superClass å¼€å§‹æŸ¥æ‰¾ï¼Œæ ¹æ®æ¶ˆæ¯å‘é€æœºåˆ¶ï¼ŒæŸ¥æ‰¾åˆ°æ–¹æ³•åä¼šå°† IMP å­˜å…¥åˆ° bucket é‡Œé¢ã€‚</p><p>æ³¨æ„ï¼šè¿™é‡Œçš„ bucket æ˜¯å“ªä¸ª cls çš„å‘¢ï¼Ÿ</p><p>ç”±äºå¯¹ä¸Šé¢ ã€4ã€æ¶ˆæ¯å‘é€ã€‘é‚£å¼ ç»å…¸å›¾ç‰‡ç†è§£çš„ä¸å¤Ÿï¼Œè®¤ä¸ºæŸ¥æ‰¾åˆ°ç›®æ ‡æ–¹æ³•åå°±æ˜¯æŠŠå¯¹åº”çš„æ–¹æ³•æ”¾åˆ° receiver çš„ cache_t é‡Œé¢ï¼Œç»“æœå°±æœ‰äº†ä¸‹é¢çš„è¿™ä¸ªçŒœæƒ³ã€‚ã€‚ã€‚</p></blockquote><p>çŒœæƒ³æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@interface Student : NSObject</span><br><span class="line">- (void)studentTest;</span><br><span class="line">@end</span><br><span class="line">@implementation Student</span><br><span class="line">- (void)studentTest &#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface GoodStudent : Student</span><br><span class="line">- (void)test;</span><br><span class="line">@end</span><br><span class="line">@implementation GoodStudent</span><br><span class="line">- (void)studentTest &#123;</span><br><span class="line">    [super studentTest];</span><br><span class="line">    NSLog(@&quot;%s&quot;, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test &#123;</span><br><span class="line">    [super studentTest];</span><br><span class="line">    [self studentTest];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæˆ‘ä»¬ä½¿ç”¨ GoodStudent å®ä¾‹è°ƒç”¨ test æ–¹æ³•ï¼Œ</p><ol><li>å½“è°ƒç”¨å®Œ <code>[super studentTest];</code>åï¼ŒGoodStudent çš„ cache_t é‡Œé¢å°±åº”è¯¥æœ‰äº†<code>studentTest</code>æ–¹æ³•çš„ç¼“å­˜</li><li>å½“æ‰§è¡Œ <code>[self studentTest];</code>æ—¶ï¼Œæ ¹æ®æ¶ˆæ¯å‘é€æœºåˆ¶ï¼Œåœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾åˆ°äº†ç¬¬ä¸€æ­¥è°ƒç”¨çš„ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯ superClass çš„æ–¹æ³•ç¼“å­˜</li><li>æ‰€ä»¥ç»“æœå°±æ˜¯åªè¦ç¼“å­˜è¿˜åœ¨å°±ä¸ä¼šè°ƒç”¨åˆ° self çš„ <code>studentTest</code> æ–¹æ³•</li></ol><p>çœ‹å®Œæˆ‘çš„çŒœæƒ³æ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆæ‰¯ï¼Œä½†æ˜¯å°±è¿™å›°æƒ‘äº†æˆ‘å¾ˆä¹…ï¼Œä»æ˜¨å¤©æ™šä¸Šå¼€å§‹æŸ¥èµ„æ–™ï¼Œä¸€ç›´åˆ°ä»Šå¤©æ—©ä¸Šæ—©æ—©æ¥å…¬å¸ï¼Œçœ‹äº†åŠå¤© objc çš„æºç æ‰æ‰¾åˆ°ç­”æ¡ˆï¼Œå…¶å®ç­”æ¡ˆå·²ç»çœ‹è¿‡å¾ˆå¤šéï¼Œä¸è¿‡ç”±äºæ ¹æ®ç½‘ç»œä¸Šé¢å„ç§æ–‡ç« çš„æ´—è„‘ï¼Œä»æ¥æ²¡æœ‰é™ä¸‹å¿ƒæ¥ä¸€å¥ä¸€å¥çš„åˆ†æ objc çš„æºç ï¼Œç°åœ¨æ¥çœ‹ä¸‹è¿™ä¸ªå¾ˆæ‰¯çš„æƒ³æ³•æ˜¯æ€æ ·è¢«æ¨ç¿»çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// 1ã€æ‰§è¡Œ [super studentTest]; </span><br><span class="line">// 2ã€ä¼šè°ƒç”¨ lookUpImpOrForward æ–¹æ³•ï¼Œæ³¨æ„ï¼šinst å°±æ˜¯ receiver(self)ï¼Œcls å°±æ˜¯ superClass</span><br><span class="line">IMP lookUpImpOrForward(id inst, SEL sel, Class cls, int behavior)</span><br><span class="line"></span><br><span class="line">// 3ã€æŸ¥æ‰¾åˆ°æ–¹æ³•åä¼šè°ƒç”¨ log_and_fill_cacheï¼Œè¿™é‡Œ receiver å°±æ˜¯ selfï¼Œcls ä¸º superClass</span><br><span class="line">static void</span><br><span class="line">log_and_fill_cache(Class cls, IMP imp, SEL sel, id receiver, Class implementer)</span><br><span class="line"></span><br><span class="line">// 4ã€è°ƒç”¨ cache_fill æ–¹æ³•</span><br><span class="line">// çœ‹ä¸‹ç¼“å­˜çš„ cache_t æ˜¯åœ¨ cls é‡Œé¢å–å‡ºæ¥çš„ï¼Œè€Œå°† imp ç¼“å­˜åˆ° cache æ—¶ä¼šè°ƒç”¨ cache-&gt;insert</span><br><span class="line">void cache_fill(Class cls, SEL sel, IMP imp, id receiver)</span><br><span class="line">&#123;</span><br><span class="line">    if (cls-&gt;isInitialized()) &#123;</span><br><span class="line">        cache_t *cache = getCache(cls);</span><br><span class="line">        cache-&gt;insert(cls, sel, imp, receiver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 5ã€cache-&gt;insert æ–¹æ³•</span><br><span class="line">// æ³¨æ„è¿™é‡Œ set ç¼“å­˜æ—¶ï¼Œæ˜¯æ”¾åœ¨äº† cls é‡Œé¢ï¼Œè€Œ receiver çš„ä½œç”¨å°±æ˜¯åœ¨è®¾ç½®ç¼“å­˜å¤±è´¥æ—¶æ¥æ”¶æ¶ˆæ¯ï¼Œè¿™å°±å¯¹ä¸Šäº†ï¼Œå› ä¸ºself æœ¬æ¥å°±æ˜¯å•çº¯çš„ receiverï¼Œå’Œæ–¹æ³•çš„ç¼“å­˜æ²¡æœ‰å…³ç³»ï¼Œè¿™é‡Œæ–¹æ³•çš„ç¼“å­˜åªå’Œ cls æœ‰å…³</span><br><span class="line">void cache_t::insert(Class cls, SEL sel, IMP imp, id receiver)</span><br><span class="line">&#123;</span><br><span class="line">    // Use the cache as-is if it is less than 3/4 full</span><br><span class="line">    mask_t newOccupied = occupied() + 1;</span><br><span class="line">    unsigned oldCapacity = capacity(), capacity = oldCapacity;</span><br><span class="line">    if (slowpath(isConstantEmptyCache())) &#123;</span><br><span class="line">        // Cache is read-only. Replace it.</span><br><span class="line">        if (!capacity) capacity = INIT_CACHE_SIZE;</span><br><span class="line">        reallocate(oldCapacity, capacity, /* freeOld */false);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (fastpath(newOccupied &lt;= capacity / 4 * 3)) &#123;</span><br><span class="line">        // Cache is less than 3/4 full. Use it as-is.</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        capacity = capacity ? capacity * 2 : INIT_CACHE_SIZE;</span><br><span class="line">        if (capacity &gt; MAX_CACHE_SIZE) &#123;</span><br><span class="line">            capacity = MAX_CACHE_SIZE;</span><br><span class="line">        &#125;</span><br><span class="line">        reallocate(oldCapacity, capacity, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bucket_t *b = buckets();</span><br><span class="line">    mask_t m = capacity - 1;</span><br><span class="line">    mask_t begin = cache_hash(sel, m);</span><br><span class="line">    mask_t i = begin;</span><br><span class="line"></span><br><span class="line">    // Scan for the first unused slot and insert there.</span><br><span class="line">    // There is guaranteed to be an empty slot because the</span><br><span class="line">    // minimum size is 4 and we resized at 3/4 full.</span><br><span class="line">    do &#123;</span><br><span class="line">        if (fastpath(b[i].sel() == 0)) &#123;</span><br><span class="line">            incrementOccupied();</span><br><span class="line">            b[i].set&lt;Atomic, Encoded&gt;(sel, imp, cls);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (b[i].sel() == sel) &#123;</span><br><span class="line">            // The entry was added to the cache by some other thread</span><br><span class="line">            // before we grabbed the cacheUpdateLock.</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while (fastpath((i = cache_next(i, m)) != begin));</span><br><span class="line"></span><br><span class="line">    cache_t::bad_cache(receiver, (SEL)sel, cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 6ã€ç»è¿‡ä¸Šé¢åˆ†æï¼Œåœ¨è°ƒç”¨ [self studentTest]; æ—¶ï¼Œä¼šå…ˆä» self.class é‡Œé¢æŸ¥æ‰¾ç¼“å­˜ï¼Œæ­¤æ—¶æ˜¯æ²¡æœ‰çš„ï¼Œå› ä¸º super è°ƒç”¨æ—¶ç¼“å­˜æ˜¯åœ¨ superClass é‡Œé¢çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šä»æ–°èµ°æ¶ˆæ¯å‘é€çš„æµç¨‹ã€‚</span><br></pre></td></tr></table></figure><p>æ‰¯å½’æ‰¯ï¼Œä½†æ˜¯è¿™é‡Œä¸€å®šè¦æ¸…æ¥šè¿™é‡Œçš„æ–¹æ³•æŸ¥æ‰¾å’Œç¼“å­˜æ˜¯é’ˆå¯¹ cls çš„ã€‚</p><p>å…³äºè¿™ä¸ªå¾ˆæ‰¯é—®é¢˜çš„åˆ†æä½¿ç”¨çš„æ˜¯ objc æœ€æ–°çš„ä»£ç ç‰ˆæœ¬ï¼ˆ781ï¼‰ï¼Œå’Œä¹‹å‰çš„ç‰ˆæœ¬æ˜¯æœ‰ä¸€äº›ä¸åŒçš„ï¼Œå…³äºæœ€æ–°ç‰ˆæœ¬ objc çš„ä¼˜åŒ–é¡¹å¯ä»¥çœ‹<a href="https://mp.weixin.qq.com/s/47fSMCwhl8KwhVWk9uRoag" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚ </p><h3 id="å‡ ä¸ª-runtime-ç›¸å…³çš„åº”ç”¨"><a href="#å‡ ä¸ª-runtime-ç›¸å…³çš„åº”ç”¨" class="headerlink" title="å‡ ä¸ª runtime ç›¸å…³çš„åº”ç”¨"></a>å‡ ä¸ª runtime ç›¸å…³çš„åº”ç”¨</h3><h4 id="å¸¸ç”¨çš„å‡ ä¸ªç±»çš„å®ç°"><a href="#å¸¸ç”¨çš„å‡ ä¸ªç±»çš„å®ç°" class="headerlink" title="å¸¸ç”¨çš„å‡ ä¸ªç±»çš„å®ç°"></a>å¸¸ç”¨çš„å‡ ä¸ªç±»çš„å®ç°</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">+ (Class)class &#123;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)class &#123;</span><br><span class="line">    return object_getClass(self);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (Class)superclass &#123;</span><br><span class="line">    return self-&gt;superclass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)superclass &#123;</span><br><span class="line">    return [self class]-&gt;superclass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return self-&gt;ISA() == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return [self class] == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = self-&gt;ISA(); tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        if (tcls == cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = [self class]; tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        if (tcls == cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æœ‰ä¸¤ä¸ªï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 1ã€isKindOfClass ä¸ isMemberOfClass çš„åŒºåˆ«</span><br><span class="line">-+ (BOOL)isKindOfClass:(Class)cls;</span><br><span class="line">-+ (BOOL)isMemberOfClass:(Class)cls;</span><br><span class="line"></span><br><span class="line">// 2ã€object_getClass ä¸ objc_getClass çš„åŒºåˆ«</span><br><span class="line">Class object_getClass(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (obj) return obj-&gt;getIsa();</span><br><span class="line">    else return Nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Class objc_getClass(const char *aClassName)</span><br><span class="line">&#123;</span><br><span class="line">    if (!aClassName) return Nil;</span><br><span class="line"></span><br><span class="line">    // NO unconnected, YES class handler</span><br><span class="line">    return look_up_class(aClassName, NO, YES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç»å…¸çš„-hook-å®ç°"><a href="#ç»å…¸çš„-hook-å®ç°" class="headerlink" title="ç»å…¸çš„ hook å®ç°"></a>ç»å…¸çš„ hook å®ç°</h4><p>åˆ›å»ºä¸¤ä¸ªæµ‹è¯•ç±»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@interface Animal : NSObject</span><br><span class="line">@end</span><br><span class="line">@implementation Animal</span><br><span class="line">- (void)animalTest &#123;</span><br><span class="line">    NSLog(@&quot;Animal test&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface Person : Animal</span><br><span class="line">@end</span><br><span class="line">@implementation Person</span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        Method originalMethod = class_getInstanceMethod(self, @selector(animalTest));</span><br><span class="line">        Method swizzlingMethod = class_getInstanceMethod(self, @selector(hook_animalTest));</span><br><span class="line">        method_exchangeImplementations(originalMethod, swizzlingMethod);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)hook_animalTest &#123;</span><br><span class="line">    NSLog(@&quot;hook_animalTest test&quot;);</span><br><span class="line">    [self hook_animalTest];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        // æµ‹è¯• 1</span><br><span class="line">        Person * p = [[Person alloc] init];</span><br><span class="line">        [p animalTest];</span><br><span class="line">      </span><br><span class="line">        // æµ‹è¯• 2</span><br><span class="line">        Animal * a = [[Animal alloc] init];</span><br><span class="line">        [a animalTest];</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œæˆ‘ä»¬ hook <code>animalTest</code>æ–¹æ³•ï¼Œç„¶åè¿è¡Œ</p><p>æµ‹è¯•1 å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ‰“å°ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020<span class="selector-tag">-07-22</span> 14<span class="selector-pseudo">:53</span><span class="selector-pseudo">:25.496785+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[75368:2985804]</span> <span class="selector-tag">hook_animalTest</span> <span class="selector-tag">test</span></span><br><span class="line">2020<span class="selector-tag">-07-22</span> 14<span class="selector-pseudo">:53</span><span class="selector-pseudo">:25.500559+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[75368:2985804]</span> <span class="selector-tag">Animal</span> <span class="selector-tag">test</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åˆ°æµ‹è¯•2 çš„æ—¶å€™ç¨‹åºç¨‹åºæŒ‚æ‰äº†ï¼Œå¯ä»¥çœ‹ä¸‹crashä¿¡æ¯ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">2020-07-22 14:54:43.493195+0800 debug-objc[75425:2989235] hook_animalTest test</span><br><span class="line">2020-07-22 14:54:43.493866+0800 debug-objc[75425:2989235] Animal test</span><br><span class="line">2020-07-22 14:54:45.558115+0800 debug-objc[75425:2989235] hook_animalTest test</span><br><span class="line">2020-07-22 14:54:45.558828+0800 debug-objc[75425:2989235] -[Animal hook_animalTest]: unrecognized selector sent to<span class="built_in"> instance </span>0x1019183a0</span><br><span class="line">2020-07-22 14:54:45.563992+0800 debug-objc[75425:2989235] *** Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: '-[Animal hook_animalTest]: unrecognized selector sent to<span class="built_in"> instance </span>0x1019183a0'</span><br><span class="line">*** First<span class="built_in"> throw </span>call stack:</span><br><span class="line">(</span><br><span class="line">0   CoreFoundation                      0x00007fff374ffbe7 __exceptionPreprocess + 250</span><br><span class="line">1   libobjc.A.dylib                     0x000000010038f350 objc_exception_throw + 48</span><br><span class="line">2   CoreFoundation                      0x00007fff3757ec77 -[NSObject(NSObject) __retain_OA] + 0</span><br><span class="line">3   CoreFoundation                      0x00007fff3746444b ___forwarding___ + 1427</span><br><span class="line">4   CoreFoundation                      0x00007fff37463e28 _CF_forwarding_prep_0 + 120</span><br><span class="line">5   debug-objc                          0x0000000100001bfd -[Person hook_animalTest] + 61</span><br><span class="line">6   debug-objc                          0x0000000100001c9d main + 141</span><br><span class="line">7   libdyld.dylib                       0x00007fff7147ecc9 start + 1</span><br><span class="line">)</span><br><span class="line">libc++abi.dylib: terminating with uncaught exception of type NSException</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿ</p><p>æ¥åˆ†æä¸‹ <code>method_exchangeImplementations</code>å…¶å®å°±æ˜¯äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„ IMPï¼Œç”±äº <code>animalTest</code>æ–¹æ³•æ˜¯åœ¨çˆ¶ç±» Animal é‡Œé¢ï¼Œæ‰€ä»¥åœ¨å­ç±» Person è¦äº¤æ¢æ–¹æ³•æ—¶ï¼Œå…¶å®äº¤æ¢çš„æ˜¯çˆ¶ç±» Animal é‡Œé¢çš„æ–¹æ³•å®ç°ï¼Œè¿™ç§æƒ…å†µå¯¹å­ç±»Personæ˜¯æ²¡æœ‰å½±å“çš„ï¼Œå®Œå…¨å¯ä»¥è¾¾åˆ° hook çš„ç›®çš„ï¼Œä½†æ˜¯å¯¹çˆ¶ç±» Animal å°±ä¸ä¸€æ ·äº†ï¼Œå› ä¸ºè¿™ç§æ–¹æ³•ç›´æ¥æ›¿æ¢äº†çˆ¶ç±»çš„å®ç°ï¼Œå½“çˆ¶ç±»åœ¨è°ƒç”¨ <code>animalTest</code>æ—¶å…¶å®æœ€ç»ˆå°±æ˜¯åœ¨è°ƒç”¨å­ç±»çš„ <code>hook_animalTest</code>ï¼Œå› ä¸ºä¸¤ä¸ªæ–¹æ³•çš„IMPå·²ç»äº¤æ¢äº†ï¼Œç„¶åå­ç±»é‡Œé¢åœ¨æ‰§è¡Œ <code>[self hook_animalTest]</code>æ—¶ï¼Œæ­¤æ—¶çš„ self æ˜¯ Animalï¼Œæ„æ€æ˜¯å‘ Animal å‘é€ <code>hook_animalTest</code>çš„æ¶ˆæ¯ï¼Œæ ¹æ®æˆ‘ä»¬ä¸Šé¢åˆ†æçš„æ¶ˆæ¯å‘é€æœºåˆ¶å¯ä»¥å¾—åˆ°è¿™é‡Œå¿…ç„¶ä¼šå‡ºç°è¿™ä¸ªç»å…¸çš„crash <code>**unrecognized selector sent to instance</code>ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šé¢çš„éšè—é—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ hook çš„æ­£ç¡®å§¿åŠ¿ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">+ (void)load &#123;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        </span><br><span class="line">        Method originalMethod = class_getInstanceMethod(self, @selector(animalTest));</span><br><span class="line">        Method swizzlingMethod = class_getInstanceMethod(self, @selector(hook_animalTest));</span><br><span class="line">        </span><br><span class="line">        // å¦‚æœè¿”å› YES åˆ™è¯æ˜å½“å‰ç±»æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ–¹æ³•å¯èƒ½åœ¨çˆ¶ç±»é‡Œé¢ï¼Œæ‰€ä»¥éœ€è¦å°†æˆ‘ä»¬æœ€ç»ˆç›®æ ‡çš„ method æ·»åŠ åˆ° Person é‡Œé¢ï¼Œå¹¶ä¸”å°† Person çš„ hook_animalTest æ–¹æ³•ä¸åŸæ¥ method äº’æ¢ã€‚</span><br><span class="line">        // å¦‚æœè¿”å› NO åˆ™è¯æ˜å½“å‰ç±»æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œç›´æ¥äº¤æ¢å°±å¥½</span><br><span class="line">        BOOL addResult = class_addMethod(self,</span><br><span class="line">                                         method_getName(originalMethod),</span><br><span class="line">                                         method_getImplementation(swizzlingMethod),</span><br><span class="line">                                         method_getTypeEncoding(swizzlingMethod));</span><br><span class="line">        if (addResult) &#123;</span><br><span class="line">            class_replaceMethod(self,</span><br><span class="line">                                method_getName(swizzlingMethod),</span><br><span class="line">                                method_getImplementation(originalMethod),</span><br><span class="line">                                method_getTypeEncoding(originalMethod));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzlingMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥çœ‹ä¸‹ objc æºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">BOOL </span><br><span class="line">class_addMethod(Class cls, SEL name, IMP imp, const char *types)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cls) return NO;</span><br><span class="line"></span><br><span class="line">    mutex_locker_t lock(runtimeLock);</span><br><span class="line">    // addMethodè¿”å›çš„ IMP == nil ? YES : NO</span><br><span class="line">    return ! addMethod(cls, name, imp, types ?: &quot;&quot;, NO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static IMP </span><br><span class="line">addMethod(Class cls, SEL name, IMP imp, const char *types, bool replace)</span><br><span class="line">&#123;</span><br><span class="line">    IMP result = nil;</span><br><span class="line"></span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    checkIsKnownClass(cls);</span><br><span class="line">    </span><br><span class="line">    ASSERT(types);</span><br><span class="line">    ASSERT(cls-&gt;isRealized());</span><br><span class="line"></span><br><span class="line">    method_t *m;</span><br><span class="line">  </span><br><span class="line">    // 1ã€å¦‚æœ cls é‡Œé¢æœ‰ name å¯¹åº”çš„ methodï¼Œåˆ™ç›´æ¥è¿”å›å¯¹åº”çš„ IMP</span><br><span class="line">    if ((m = getMethodNoSuper_nolock(cls, name))) &#123;</span><br><span class="line">        // already exists</span><br><span class="line">        if (!replace) &#123;</span><br><span class="line">            result = m-&gt;imp;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            result = _method_setImplementation(cls, m, imp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 2ã€å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°† hook çš„æ–¹æ³•æ·»åŠ åˆ° cls ä¸­</span><br><span class="line">        method_list_t *newlist;</span><br><span class="line">        newlist = (method_list_t *)calloc(sizeof(*newlist), 1);</span><br><span class="line">        newlist-&gt;entsizeAndFlags = </span><br><span class="line">            (uint32_t)sizeof(method_t) | fixed_up_method_list;</span><br><span class="line">        newlist-&gt;count = 1;</span><br><span class="line">        newlist-&gt;first.name = name;</span><br><span class="line">        newlist-&gt;first.types = strdupIfMutable(types);</span><br><span class="line">        newlist-&gt;first.imp = imp;</span><br><span class="line"></span><br><span class="line">        prepareMethodLists(cls, &amp;newlist, 1, NO, NO);</span><br><span class="line">        cls-&gt;data()-&gt;methods.attachLists(&amp;newlist, 1);</span><br><span class="line">        flushCaches(cls);</span><br><span class="line"></span><br><span class="line">        result = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸‹ replace æºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// å¯ä»¥çœ‹å‡ºå’Œ class_addMethod æºç è°ƒç”¨çš„æ˜¯åŒä¸€ä¸ªæ–¹æ³•ï¼Œåªä¸è¿‡ç»™ addMethod çš„æœ€åä¸€ä¸ªå‚æ•°ï¼šreplace ä¼ çš„ YES</span><br><span class="line">IMP </span><br><span class="line">class_replaceMethod(Class cls, SEL name, IMP imp, const char *types)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cls) return nil;</span><br><span class="line"></span><br><span class="line">    mutex_locker_t lock(runtimeLock);</span><br><span class="line">    return addMethod(cls, name, imp, types ?: &quot;&quot;, YES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å¦‚æœ replace ä¸º YESæ˜¯èµ°çš„ _method_setImplementation æ–¹æ³•</span><br><span class="line">// å¯ä»¥çœ‹å‡ºè¿™é‡Œå°±æ˜¯æ›¿æ¢äº† method_t çš„ IMP</span><br><span class="line">static IMP </span><br><span class="line">_method_setImplementation(Class cls, method_t *m, IMP imp)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    if (!m) return nil;</span><br><span class="line">    if (!imp) return nil;</span><br><span class="line"></span><br><span class="line">    IMP old = m-&gt;imp;</span><br><span class="line">    m-&gt;imp = imp;</span><br><span class="line"></span><br><span class="line">    // Cache updates are slow if cls is nil (i.e. unknown)</span><br><span class="line">    // RR/AWZ updates are slow if cls is nil (i.e. unknown)</span><br><span class="line">    // fixme build list of classes whose Methods are known externally?</span><br><span class="line"></span><br><span class="line">    flushCaches(cls);</span><br><span class="line"></span><br><span class="line">    adjustCustomFlagsForMethodChange(cls, m);</span><br><span class="line"></span><br><span class="line">    return old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒç¥ç»ç—…é™¢ç³»åˆ—ï¼š"><a href="#å‚è€ƒç¥ç»ç—…é™¢ç³»åˆ—ï¼š" class="headerlink" title="å‚è€ƒç¥ç»ç—…é™¢ç³»åˆ—ï¼š"></a>å‚è€ƒç¥ç»ç—…é™¢ç³»åˆ—ï¼š</h3><ol><li><a href="https://halfrost.com/objc_runtime_isa_class/" target="_blank" rel="noopener">https://halfrost.com/objc_runtime_isa_class/</a></li><li><a href="https://halfrost.com/objc_runtime_objc_msgsend/" target="_blank" rel="noopener">https://halfrost.com/objc_runtime_objc_msgsend/</a></li><li><a href="https://halfrost.com/how_to_use_runtime/" target="_blank" rel="noopener">https://halfrost.com/how_to_use_runtime/</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;åŸè®¡åˆ’ä¸€å‘¨ä¸€ä¸ªæ¨¡å—ï¼Œä½†æ˜¯çœ‹åˆ° runTime è¿™é‡ŒæŒç»­æ—¶é—´æœ‰ç‚¹é•¿ï¼Œåº•å±‚å†…å®¹å¾ˆå¤šå•Šï¼ŒåŸå› è¿˜æ˜¯ä¹‹å‰åŸºç¡€å¤ªå·®ï¼Œèœçš„æŠ è„šã€‚ã€‚ã€‚è¿˜æœ‰æ•´ç†å®Œ block åå†æƒ³ block hook åº”è¯¥æ€ä¹ˆå®ç°ï¼Œçæäº†ä¸€é€šæœ€åæ‰¾åˆ°äº†å¼€æºçš„åº“ &lt;code&gt;blockHook&lt;/code&gt;ï¼Œçœ‹äº†å‡ å¤©çš„æºç å‘ç°åº•å±‚æŒæ¡çš„è¿˜æ˜¯ä¸ç‰¢ï¼Œå…¶ä¸­åŒ…æ‹¬ runtime éƒ¨åˆ†ï¼Œå…ˆæ•´ç†å®Œ runtime éƒ¨åˆ†ç„¶åå†å›å¤´é‡æ–°åˆ†æ blockHookã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ä¸‹æ–‡å†…å®¹æ˜¯æ ¹æ® &lt;a href=&quot;https://opensource.apple.com/tarballs/objc4/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;objc4-723&lt;/a&gt; ç‰ˆæœ¬åˆ†æçš„ï¼Œç›®å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ &lt;a href=&quot;https://opensource.apple.com/tarballs/objc4/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;objc4-781&lt;/a&gt;ï¼Œæœ€æ–°ç‰ˆæœ¬åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œä¸è¿‡ä¸å½±å“æˆ‘ä»¬ç†è§£ã€‚&lt;/p&gt;
&lt;h3 id=&quot;isa-è¯¦è§£&quot;&gt;&lt;a href=&quot;#isa-è¯¦è§£&quot; class=&quot;headerlink&quot; title=&quot;isa è¯¦è§£&quot;&gt;&lt;/a&gt;isa è¯¦è§£&lt;/h3&gt;
    
    </summary>
    
    
      <category term="Runtime" scheme="http://yoursite.com/tags/Runtime/"/>
    
  </entry>
  
  <entry>
    <title>block6-å¾ªç¯å¼•ç”¨</title>
    <link href="http://yoursite.com/2020/07/06/block6-%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8/"/>
    <id>http://yoursite.com/2020/07/06/block6-å¾ªç¯å¼•ç”¨/</id>
    <published>2020-07-06T03:15:01.000Z</published>
    <updated>2020-08-15T14:26:10.515Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¾ªç¯å¼•ç”¨"><a href="#å¾ªç¯å¼•ç”¨" class="headerlink" title="å¾ªç¯å¼•ç”¨"></a>å¾ªç¯å¼•ç”¨</h3><p>ä¸‹é¢æ˜¯ block å¾ªç¯å¼•ç”¨çš„ç»å…¸å›¾ç‰‡ï¼š</p><p><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ggh999v50lj30pa0h6n31.jpg" alt="retaincircly.png"></p><a id="more"></a><p>çœ‹ä¸€ä¸‹æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="keyword">void</span> (^block)(<span class="keyword">void</span>);</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Animal * animal = [[Animal alloc] init];</span><br><span class="line">animal.block = ^&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"--- %d"</span>, animal.age);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"---- "</span>);</span><br></pre></td></tr></table></figure><p>åˆ†æä¸‹å„ä¸ªéƒ¨åˆ†æŒ‡é’ˆæŒ‡å‘ï¼š</p><p><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ggh3caddxqj317w0t4acx.jpg" alt="retaincircle1.png"></p><p>è§£å†³å¾ªç¯å¼•ç”¨çš„åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œè¿™é‡Œåªéœ€è¦å°†å…¶ä¸­çš„ä¸€ä¸ªå¼ºæŒ‡é’ˆæ”¹ä¸ºå¼±æŒ‡é’ˆå°±å¯ä»¥äº†ï¼Œæ ¹æ®å‰é¢ block æ•è·çš„çŸ¥è¯†å¯ä»¥å¾—åˆ°ï¼šä½¿ç”¨ __weak å¯ä»¥è§£å†³ï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Animal</span> * <span class="keyword">animal</span> = <span class="comment">[<span class="comment">[Animal alloc]</span> init]</span>;   </span><br><span class="line">__weak typeof(<span class="keyword">animal</span>) weakAnimal = <span class="keyword">animal</span>;</span><br><span class="line"><span class="keyword">animal</span>.block = ^&#123;</span><br><span class="line">  NSLog(@<span class="string">"--- %d"</span>, weakAnimal.age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ggh3fzscb9j317g0po0vh.jpg" alt="retaincircly2.png"></p><p>è¿˜å¯ä»¥ä½¿ç”¨ <code>__unsafe_unretained</code> æ¥è§£å†³ï¼Œä¸è¿‡å’Œ <code>__weak</code> çš„åŒºåˆ«æ˜¯ï¼š<code>__unsafe_unretained</code> ä¸ä¼šå°†é‡Šæ”¾çš„æŒ‡é’ˆç½®ä¸º nilã€‚</p><h4 id="block-è§£å†³å¾ªç¯å¼•ç”¨"><a href="#block-è§£å†³å¾ªç¯å¼•ç”¨" class="headerlink" title="__block è§£å†³å¾ªç¯å¼•ç”¨"></a>__block è§£å†³å¾ªç¯å¼•ç”¨</h4><p>__block ä¹Ÿå¯ä»¥è§£å†³å¾ªç¯å¼•ç”¨ï¼Œä¸è¿‡æ–¹æ³•æœ‰ç‚¹ç‰¹æ®Šï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">Animal</span> * <span class="keyword">animal</span> = <span class="comment">[<span class="comment">[Animal alloc]</span> init]</span>;   </span><br><span class="line"><span class="keyword">animal</span>.block = ^&#123;</span><br><span class="line">  NSLog(@<span class="string">"--- %d"</span>, <span class="keyword">animal</span>.age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åˆ†æä¸‹æŒ‡é’ˆçš„æŒ‡å‘ï¼š</p><p><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ggh3nyy6hbj31hw102n2w.jpg" alt="retaincircly3.png"></p><p>ç°åœ¨æ˜¯ä¸‰è§’çš„é—­ç¯ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•æ¥è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼š</p><p><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ggh41xn5gcj31hy0ymjx3.jpg" alt="retaincircly4.png"></p><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">Animal</span> * <span class="keyword">animal</span> = <span class="comment">[<span class="comment">[Animal alloc]</span> init]</span>;</span><br><span class="line">   </span><br><span class="line"><span class="keyword">animal</span>.block = ^&#123;</span><br><span class="line">  NSLog(@<span class="string">"--- %d"</span>, <span class="keyword">animal</span>.age);</span><br><span class="line">  <span class="keyword">animal</span> = nil;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">animal</span>.block();</span><br></pre></td></tr></table></figure><p>æ­¤ç§æ–¹å‘å¿…é¡»è°ƒç”¨ blockï¼Œè€Œä¸”åœ¨è°ƒç”¨å®Œ block åéœ€è¦è®¾ç½® __block å˜é‡ä¸º nilã€‚</p><h3 id="MRC-çš„å¾ªç¯å¼•ç”¨"><a href="#MRC-çš„å¾ªç¯å¼•ç”¨" class="headerlink" title="MRC çš„å¾ªç¯å¼•ç”¨"></a>MRC çš„å¾ªç¯å¼•ç”¨</h3><p>1ã€ä½¿ç”¨ __unsafe_unretained è§£å†³ã€‚</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Animal</span> * <span class="keyword">animal</span> = <span class="comment">[<span class="comment">[Animal alloc]</span> init]</span>;   </span><br><span class="line">__unsafe_unretained <span class="keyword">Animal</span> * weakAnimal = <span class="keyword">animal</span>;</span><br><span class="line"><span class="keyword">animal</span>.block = ^&#123;</span><br><span class="line">  NSLog(@<span class="string">"--- %d"</span>, weakAnimal.age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>2ã€ä½¿ç”¨ __blockï¼Œå‰é¢è®²åˆ°è¿‡åœ¨ MRC ç¯å¢ƒä¸‹ __block å˜é‡å¯¹ animal ä¸€ç›´éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ __block å°±èƒ½è§£å†³ã€‚</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">Animal</span> * <span class="keyword">animal</span> = <span class="comment">[<span class="comment">[Animal alloc]</span> init]</span>;   </span><br><span class="line"><span class="keyword">animal</span>.block = ^&#123;</span><br><span class="line">  NSLog(@<span class="string">"--- %d"</span>, <span class="keyword">animal</span>.age);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å¾ªç¯å¼•ç”¨&quot;&gt;&lt;a href=&quot;#å¾ªç¯å¼•ç”¨&quot; class=&quot;headerlink&quot; title=&quot;å¾ªç¯å¼•ç”¨&quot;&gt;&lt;/a&gt;å¾ªç¯å¼•ç”¨&lt;/h3&gt;&lt;p&gt;ä¸‹é¢æ˜¯ block å¾ªç¯å¼•ç”¨çš„ç»å…¸å›¾ç‰‡ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://ww1.sinaimg.cn/large/005O0Zogly1ggh999v50lj30pa0h6n31.jpg&quot; alt=&quot;retaincircly.png&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="block å¾ªç¯å¼•ç”¨" scheme="http://yoursite.com/tags/block-%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>block5-blockå†…å­˜ç®¡ç†</title>
    <link href="http://yoursite.com/2020/07/06/block5-block%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    <id>http://yoursite.com/2020/07/06/block5-blockå†…å­˜ç®¡ç†/</id>
    <published>2020-07-06T01:09:58.000Z</published>
    <updated>2020-08-15T14:26:04.499Z</updated>
    
    <content type="html"><![CDATA[<h3 id="block-å†…å­˜ç®¡ç†"><a href="#block-å†…å­˜ç®¡ç†" class="headerlink" title="block å†…å­˜ç®¡ç†"></a>block å†…å­˜ç®¡ç†</h3><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NSObject * object = [[NSObject alloc] init]<span class="comment">;</span></span><br><span class="line">__block NSObject * <span class="keyword">blockObject </span>= [[NSObject alloc] init]<span class="comment">;</span></span><br><span class="line">void (^<span class="keyword">block)(void) </span>= ^&#123;</span><br><span class="line">  NSLog(@<span class="string">"--- %@"</span>, object)<span class="comment">;</span></span><br><span class="line">  NSLog(@<span class="string">"--- %@"</span>, <span class="keyword">blockObject);</span></span><br><span class="line"><span class="keyword">&#125;;</span></span><br><span class="line"><span class="keyword">block(); </span></span><br><span class="line">NSLog(@<span class="string">"----"</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>æŸ¥çœ‹ cpp æ–‡ä»¶ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __Block_byref_blockObject_0 &#123;</span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_blockObject_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_copy)(<span class="keyword">void</span>*, <span class="keyword">void</span>*);</span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_dispose)(<span class="keyword">void</span>*);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// æœ€ç»ˆè¢«æ•è·åˆ°çš„ blockObject å˜é‡</span></span><br><span class="line"> <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> blockObject;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> object;</span><br><span class="line">  __Block_byref_blockObject_0 *blockObject; <span class="comment">// by ref</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> _object, __Block_byref_blockObject_0 *_blockObject, <span class="keyword">int</span> flags=<span class="number">0</span>) : object(_object), blockObject(_blockObject-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    </span><br><span class="line">    __Block_byref_blockObject_0 *blockObject = __cself-&gt;blockObject; <span class="comment">// bound by ref</span></span><br><span class="line">    <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> object = __cself-&gt;object; <span class="comment">// bound by copy</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_3a341f_mi_0, object);</span><br><span class="line">    <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_3a341f_mi_1, (blockObject-&gt;__forwarding-&gt;blockObject));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;</span><br><span class="line">    </span><br><span class="line">    _Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;object, (<span class="keyword">void</span>*)src-&gt;object, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);</span><br><span class="line">    _Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;blockObject, (<span class="keyword">void</span>*)src-&gt;blockObject, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;</span><br><span class="line">    </span><br><span class="line">    _Block_object_dispose((<span class="keyword">void</span>*)src-&gt;object, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);</span><br><span class="line">    _Block_object_dispose((<span class="keyword">void</span>*)src-&gt;blockObject, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSObject</span> * object = ((<span class="built_in">NSObject</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)((<span class="built_in">NSObject</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)objc_getClass(<span class="string">"NSObject"</span>), sel_registerName(<span class="string">"alloc"</span>)), sel_registerName(<span class="string">"init"</span>));</span><br><span class="line"></span><br><span class="line">        __attribute__((__blocks__(<span class="keyword">byref</span>))) __Block_byref_blockObject_0 blockObject = &#123;</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            (__Block_byref_blockObject_0 *)&amp;blockObject,</span><br><span class="line">            <span class="number">33554432</span>, <span class="keyword">sizeof</span>(__Block_byref_blockObject_0),</span><br><span class="line">            __Block_byref_id_object_copy_131,</span><br><span class="line">            __Block_byref_id_object_dispose_131,</span><br><span class="line">            ((<span class="built_in">NSObject</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)((<span class="built_in">NSObject</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)objc_getClass(<span class="string">"NSObject"</span>), sel_registerName(<span class="string">"alloc"</span>)), sel_registerName(<span class="string">"init"</span>))&#125;;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = &amp;__main_block_impl_0(__main_block_func_0,</span><br><span class="line">                                                   &amp;__main_block_desc_0_DATA,</span><br><span class="line">                                                   object,</span><br><span class="line">                                                   (__Block_byref_blockObject_0 *)&amp;blockObject,</span><br><span class="line">                                                   <span class="number">570425344</span>));</span><br><span class="line"></span><br><span class="line">        block-&gt;FuncPtr(block);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_3a341f_mi_2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†æä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºé __block ä¿®é¥°çš„ auto å˜é‡ object å†…å­˜ç®¡ç†å’Œæˆ‘ä»¬ <a href="https://jueying-xiangfeng.github.io/2020/07/02/block3-%E7%B1%BB%E5%9E%8B%E3%80%81copy%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">å‰é¢</a> è®²è¿‡çš„ copy è¿‡ç¨‹ä¸€æ ·ï¼š</p><p>æŒæœ‰ï¼š</p><blockquote><p>1ã€block å†…éƒ¨è°ƒç”¨ desp é‡Œé¢çš„ copy å‡½æ•°<br>2ã€copy å‡½æ•°ä¼šè°ƒç”¨ <code>_Block_object_assign</code><br>3ã€<code>_Block_object_assign</code> å‡½æ•°ä¼šæ ¹æ® auto å˜é‡ä¿®é¥°ç¬¦çš„ç±»å‹ï¼ˆ<code>__strong</code>ã€<code>__weak</code>ã€<code>__unsafe_unretained</code>ï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨æˆ–å¼±å¼•ç”¨</p></blockquote><p>é”€æ¯ï¼š</p><blockquote><p>1ã€block å†…éƒ¨è°ƒç”¨ å¾—æœ é‡Œé¢çš„ dispose å‡½æ•°<br>2ã€dispose å‡½æ•°ä¼šè°ƒç”¨ <code>_Block_object_dispose</code><br>3ã€<code>_Block_object_dispose</code> å‡½æ•°ä¼šé‡Šæ”¾å¼•ç”¨çš„ auto å˜é‡</p></blockquote><p>ä¸Šé¢å°±æ˜¯é __block ä¿®é¥°çš„å¯¹è±¡ç±»å‹çš„ auto å˜é‡å†…å­˜ç®¡ç†ã€‚</p><p><br></p><p>ä¸‹é¢æ¥åˆ†æä¸‹ __block ä¿®é¥°çš„å¯¹è±¡ç±»å‹çš„ auto å˜é‡å†…å­˜ç®¡ç†ï¼š<br><a href="https://jueying-xiangfeng.github.io/2020/07/03/block3-block%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">ä¸Šä¸€èŠ‚</a> è®²åˆ°äº† __block çš„åŸç†ï¼Œå¯ä»¥æƒ³åˆ° blockObject è¢«åŒ…è£…æˆäº†ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œ <code>\_\_Block\_byref\_blockObject\_0</code> é‡Œé¢çš„ <code>NSObject *\_\_strong blockObject;</code> å°±æ˜¯æœ€ç»ˆè¢«æ•è·çš„å˜é‡ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ä¿®é¥°ç¬¦æ˜¯ __strongï¼Œæ ¹æ®å‰é¢è®²è¿‡çš„ copy åŸç†çŒœæƒ³ä¸€ä¸‹è¿™é‡Œçš„æ•è·ç»“æœå¯èƒ½å’Œè¢«ä¿®é¥°çš„ auto å˜é‡çš„å¼ºå¼±æœ‰å…³ï¼Œæ¥åšä¸€ä¸ªæµ‹è¯•ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void (^<span class="keyword">block)(void);</span></span><br><span class="line"><span class="keyword">&#123;</span></span><br><span class="line"><span class="keyword"> </span> Animal * object = [[Animal alloc] init]<span class="comment">;</span></span><br><span class="line">  __block __weak Animal * weakObject = object<span class="comment">;</span></span><br><span class="line">  <span class="keyword">block </span>= ^&#123;</span><br><span class="line">      NSLog(@<span class="string">"--- %@"</span>, weakObject)<span class="comment">;</span></span><br><span class="line">  &#125;<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ‰“å°ç»“æœï¼ŒAnimal æ˜¯åœ¨ä½œç”¨åŸŸç»“æŸåå°±é‡Šæ”¾äº†ï¼Œè€Œæ­¤æ—¶ block è¿˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œçœ‹ä¸‹ cpp æ–‡ä»¶çš„ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_weakObject_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_weakObject_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_copy)(<span class="keyword">void</span>*, <span class="keyword">void</span>*);</span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_dispose)(<span class="keyword">void</span>*);</span><br><span class="line"> Animal *__weak weakObject;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯´æ˜æ•è·åˆ°çš„ç¡®å®æ˜¯ __weak çš„ç±»å‹ã€‚</p><p>å†æ¥çœ‹ä¸€ä¸‹ä¸Šé¢ blockObject è¢«æ•è·å¯¹è±¡åˆå§‹åŒ–çš„åœ°æ–¹ï¼Œè¿™é‡Œå¤šäº†ä¸¤ä¸ªå‡½æ•°ï¼š<code>__Block_byref_id_object_copy_131</code>ã€<code>__Block_byref_id_object_dispose_131</code>ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„å®ç°ï¼š</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">__Block_byref_id_object_copy_131</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src)</span> </span>&#123;</span><br><span class="line"> _Block_object_assign((<span class="keyword">char</span>*)dst + <span class="number">40</span>, *(<span class="keyword">void</span> * *) ((<span class="keyword">char</span>*)src + <span class="number">40</span>), <span class="number">131</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">__Block_byref_id_object_dispose_131</span><span class="params">(<span class="keyword">void</span> *src)</span> </span>&#123;</span><br><span class="line"> _Block_object_dispose(*(<span class="keyword">void</span> * *) ((<span class="keyword">char</span>*)src + <span class="number">40</span>), <span class="number">131</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè·Ÿæˆ‘ä»¬å‰é¢è®² copy çš„æ—¶å€™è°ƒç”¨çš„æ–¹æ³•æ˜¯ä¸€æ ·ï¼Œçœ‹ä¸‹ _Block_object_assign å‡½æ•°çš„å‚æ•°ï¼š<code>(char*)dst + 40</code>ï¼Œè¿™é‡Œçš„ dst å°±æ˜¯ <code>__Block_byref_blockObject_0</code>ï¼Œé‚£ä¹ˆ +40 ä»£è¡¨ä»€ä¹ˆå‘¢ï¼Ÿçœ‹ä¸‹ <code>__Block_byref_blockObject_0</code> çš„ç»“æ„ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __Block_byref_blockObject_0 &#123;</span><br><span class="line">  <span class="keyword">void</span> *__isa;  <span class="number">8</span></span><br><span class="line">__Block_byref_blockObject_0 *__forwarding; <span class="number">8</span></span><br><span class="line"> <span class="keyword">int</span> __flags; <span class="number">4</span></span><br><span class="line"> <span class="keyword">int</span> __size; <span class="number">4</span></span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_copy)(<span class="keyword">void</span>*, <span class="keyword">void</span>*); <span class="number">8</span></span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_dispose)(<span class="keyword">void</span>*); <span class="number">8</span></span><br><span class="line"> <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> blockObject;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>+40 çš„åœ°å€æ­£å¥½æ˜¯ blockObject çš„åœ°å€ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯ç”¨æ¥ç®¡ç† blockObject çš„ã€‚</p><p>æ€»ç»“ä¸‹ __block ä¿®é¥°å˜é‡çš„å†…å­˜ç®¡ç†ï¼š</p><p>æŒæœ‰ï¼š</p><blockquote><p>1ã€blockObject è¢«åŒ…è£…æˆ <code>__Block_byref_blockObject_0</code> å¯¹è±¡ï¼Œ<code>__Block_byref_blockObject_0</code> å¯¹è±¡é‡Œé¢æŒæœ‰ blockObjectï¼ˆblockObject çš„å¼ºå¼±æ˜¯æ ¹æ®è‡ªèº«çš„ä¿®é¥°ç¬¦å†³å®šçš„ï¼‰<br>2ã€<code>__main_block_impl_0</code> æŒæœ‰ <code>__Block_byref_blockObject_0</code><br>3ã€<code>__Block_byref_blockObject_0</code> çš„å†…å­˜ç®¡ç†ä¾èµ– <code>__main_block_impl_0</code> çš„ desp çš„ copy å‡½æ•°ï¼ˆ<code>_Block_object_assign</code>ï¼‰<br>4ã€blockObject å¯¹è±¡çš„å†…å­˜ç®¡ç†ä¾èµ– <code>__Block_byref_blockObject_0</code> çš„ copy å‡½æ•°ï¼ˆ<code>_Block_object_assign</code>ï¼‰</p></blockquote><p>é”€æ¯ï¼š</p><blockquote><p>1ã€<code>__main_block_impl_0</code> é€šè¿‡ desp çš„ dispose å‡½æ•°é‡Šæ”¾ <code>__Block_byref_blockObject_0</code>ï¼ˆ<code>_Block_object_dispose</code>ï¼‰<br>2ã€<code>__Block_byref_blockObject_0</code> é€šè¿‡è°ƒç”¨å†…éƒ¨çš„ <code>__Block_byref_blockObject_0</code> å‡½æ•°é‡Šæ”¾æœ€ç»ˆçš„ blockObject å¯¹è±¡</p></blockquote><p><br></p><h4 id="ç»“è®ºæ€»ç»“"><a href="#ç»“è®ºæ€»ç»“" class="headerlink" title="ç»“è®ºæ€»ç»“"></a>ç»“è®ºæ€»ç»“</h4><ul><li>å½“ block åœ¨æ ˆä¸Šæ—¶ï¼Œå¯¹å¯¹è±¡ç±»å‹çš„ auto å˜é‡ã€__block å˜é‡ä¸ä¼šäº§ç”Ÿå¼ºå¼•ç”¨</li><li>å½“ block è¢« copy åˆ°å †ä¸Šé¢æ—¶ä¼šé€šè¿‡ copy å‡½æ•°æ¥å¤„ç† (__block å˜é‡ï¼š    _Block_object_assign((void<em>)&amp;dst-&gt;a, (void</em>)src-&gt;a, 8/<em>BLOCK_FIELD_IS_BYREF</em>/)ï¼Œ auto å˜é‡ï¼š_Block_object_assign((void<em>)&amp;dst-&gt;p, (void</em>)src-&gt;p, 3/<em>BLOCK_FIELD_IS_OBJECT</em>/))</li><li>_Block_object_assignå‡½æ•°ä¼šæ ¹æ®æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®é¥°ç¬¦ï¼ˆ<strong>strongã€</strong>weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä»…é™äºARCæ—¶ä¼šretainï¼ŒMRCæ—¶ä¸ä¼šretainï¼‰</li><li>å½“ block ä»å †ä¸Šç§»é™¤æ—¶ä¼šè°ƒç”¨ dispose å‡½æ•°å¤„ç†ï¼ˆ__block å˜é‡ï¼š_Block_object_dispose((void<em>)src-&gt;a, 8/</em>BLOCK_FIELD_IS_BYREF<em>/)ï¼Œ auto å˜é‡ï¼š_Block_object_dispose((void</em>)src-&gt;p, 3/<em>BLOCK_FIELD_IS_OBJECT</em>/)ï¼‰</li><li>_Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾æŒ‡å‘çš„å¯¹è±¡ï¼ˆreleaseï¼‰</li></ul><h3 id="block-çš„-forwarding-æŒ‡é’ˆ"><a href="#block-çš„-forwarding-æŒ‡é’ˆ" class="headerlink" title="block çš„ forwarding æŒ‡é’ˆ"></a><strong>block çš„ </strong>forwarding æŒ‡é’ˆ</h3><p>ä¸Šé¢ blockObject çš„è®¿é—®å…¶å®æ˜¯ï¼šblockObject-&gt;__forwarding-&gt;blockObjectï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¦å¤šä¸€æ­¥ __forwarding çš„æ“ä½œå‘¢ï¼Œè€Œä¸” __forwarding è¿˜æ˜¯æŒ‡å‘è‡ªå·±çš„ã€‚<br>å› ä¸ºå½“æ ˆä¸Šçš„ block copy åˆ°å †ä¸Šæ—¶ï¼Œblock å®é™…è®¿é—®çš„å…¶å®æ˜¯å †ä¸Šçš„å†…å­˜ï¼Œå¦‚æœè¿™æ—¶å†è®¿é—®æ ˆå†…å­˜æ˜¯ä¸æ­£ç¡®çš„ï¼Œæ‰€ä»¥æ­¤æ—¶æ ˆä¸Šçš„ __forwarding æŒ‡é’ˆä¼šæŒ‡å‘å †ä¸Šé¢çš„å†…å­˜ï¼Œå½“è®¿é—® blockObject çš„æ—¶å€™å…¶å®è®¿é—®çš„æ˜¯æœ€ç»ˆè¢« copy åˆ°å †ä¸Šé¢çš„å†…å­˜ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°è®¿é—®é”™ä¹±çš„é—®é¢˜ã€‚</p><p>å¯ä»¥æ¥éªŒè¯ä¸€ä¸‹ï¼Œä½¿ç”¨ MRC çš„ç¯å¢ƒï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSObject</span> * object = [[<span class="built_in">NSObject</span> alloc] init];     </span><br><span class="line">__block <span class="built_in">NSObject</span> * blockObject = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"--- %@"</span>, object);</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"--- %@"</span>, blockObject);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 * blockImpl = (<span class="keyword">struct</span> __main_block_impl_0 *)block;   </span><br><span class="line">[block <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"---- %@"</span>, blockImpl);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ block æ˜¯åœ¨æ ˆä¸Šé¢ï¼Œæ¥æ‰“å°ä¸‹æ­¤æ—¶çš„åœ°å€ï¼š<code>(__Block_byref_blockObject_0 *) __forwarding = 0x00007ffeefbff468</code><br>å½“è°ƒç”¨å®Œ copy å‡½æ•°ä¹‹åï¼š<code>(__Block_byref_blockObject_0 *) __forwarding = 0x000000010053af80</code>ï¼Œå¾ˆæ˜æ˜¾ï¼Œæ­¤æ—¶çš„åœ°å€ä»æ ˆä¸ŠæŒ‡å‘äº†å †ç©ºé—´ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;block-å†…å­˜ç®¡ç†&quot;&gt;&lt;a href=&quot;#block-å†…å­˜ç®¡ç†&quot; class=&quot;headerlink&quot; title=&quot;block å†…å­˜ç®¡ç†&quot;&gt;&lt;/a&gt;block å†…å­˜ç®¡ç†&lt;/h3&gt;&lt;p&gt;æµ‹è¯•ä»£ç ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight mipsasm&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;NSObject * object = [[NSObject alloc] init]&lt;span class=&quot;comment&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;__block NSObject * &lt;span class=&quot;keyword&quot;&gt;blockObject &lt;/span&gt;= [[NSObject alloc] init]&lt;span class=&quot;comment&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;void (^&lt;span class=&quot;keyword&quot;&gt;block)(void) &lt;/span&gt;= ^&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  NSLog(@&lt;span class=&quot;string&quot;&gt;&quot;--- %@&quot;&lt;/span&gt;, object)&lt;span class=&quot;comment&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  NSLog(@&lt;span class=&quot;string&quot;&gt;&quot;--- %@&quot;&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;blockObject);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;block(); &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NSLog(@&lt;span class=&quot;string&quot;&gt;&quot;----&quot;&lt;/span&gt;)&lt;span class=&quot;comment&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="block å†…å­˜ç®¡ç†" scheme="http://yoursite.com/tags/block-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>block4-__blockåŸç†</title>
    <link href="http://yoursite.com/2020/07/03/block3-block%E5%8E%9F%E7%90%86/"/>
    <id>http://yoursite.com/2020/07/03/block3-blockåŸç†/</id>
    <published>2020-07-03T03:25:51.000Z</published>
    <updated>2020-08-15T14:25:45.330Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Block-åŸç†"><a href="#Block-åŸç†" class="headerlink" title="__Block åŸç†"></a>__Block åŸç†</h4><p>å…ˆæ¥æµ‹è¯•ä¸€ä¸ªç»å…¸çš„æ¡ˆä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">int</span> <span class="string">age</span> <span class="string">=</span> <span class="number">10</span><span class="string">;</span></span><br><span class="line"><span class="string">void</span> <span class="string">(^block)(void)</span> <span class="string">=</span> <span class="string">^&#123;</span></span><br><span class="line"><span class="string">NSLog(@"---</span> <span class="string">age</span> <span class="string">=</span> <span class="string">%d",</span> <span class="string">age);</span></span><br><span class="line"><span class="string">&#125;;</span> </span><br><span class="line"><span class="string">age</span> <span class="string">=</span> <span class="number">20</span><span class="string">;</span></span><br><span class="line"><span class="string">block();</span></span><br><span class="line"></span><br><span class="line"><span class="string">///</span> <span class="string">è¾“å‡ºç»“æœ</span> <span class="meta">---</span> <span class="string">age</span> <span class="string">=</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><a id="more"></a><p>è¿™ä¸ªæ¡ˆä¾‹æƒ³å¿…ä¸ä¼šé™Œç”Ÿï¼ŒåŸç†å¯ä»¥æ ¹æ®å‰é¢å˜é‡çš„æ•è·åˆ†æï¼Œæ¥çœ‹ä¸‹ cpp ä»£ç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__block_impl</span></span> <span class="keyword">impl</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span>* Desc;</span><br><span class="line">  int age; <span class="comment">/// è¢«æ•è·çš„ age å€¼</span></span><br><span class="line">  __main_block_impl_0(void *fp, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> *desc, int _age, int flags=<span class="number">0</span>) : age(_age) &#123;</span><br><span class="line">    <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    <span class="keyword">impl</span>.Flags = flags;</span><br><span class="line">    <span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>age è¢«æ•è·åˆ°äº† block é‡Œé¢ï¼Œæ­¤æ—¶ age å’Œè¢« block æ•è·çš„ age å®Œå…¨å°±æ˜¯ä¸¤ä¸ªä¸ç›¸å¹²çš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥ä¿®æ”¹å¤–é¢çš„ age å¯¹ block é‡Œé¢çš„ age æ˜¯æ²¡æœ‰å½±å“çš„ï¼Œè¯•ä¸‹åœ¨ block é‡Œé¢ç›´æ¥ä¿®æ”¹ age çš„å€¼å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°ç¼–è¯‘æŠ¥é”™ï¼Œæç¤ºä¸èƒ½ä¿®æ”¹ age çš„å€¼ï¼Œæˆ‘ä»¬æ¥ä» cpp ä»£ç åˆ†æä¸‹ä¸ºä»€ä¹ˆï¼š</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">__main_block_func_0</span><span class="params">(struct __main_block_impl_0 *__cself)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> age = __cself-&gt;age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, age, <span class="number">570425344</span>));</span><br><span class="line"></span><br><span class="line">        age = <span class="number">20</span>;</span><br><span class="line">        ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œåœ¨ block é‡Œé¢è®¿é—® ageï¼Œæœ€ç»ˆæ˜¯åœ¨å‡½æ•° <strong>main_block_func_0 è®¿é—®çš„ç»“æ„ä½“ </strong>main_block_impl_0 é‡Œé¢æ•è·çš„ ageï¼Œè€Œä¸” age å˜é‡æ˜¯åœ¨ä¸»å‡½æ•°å£°æ˜çš„ï¼Œç°åœ¨æƒ³è¦åœ¨ <strong>main_block_func_0 å‡½æ•°ä¿®æ”¹æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸ºè¿™æ˜¯ä¸¤ä¸ªå‡½æ•°ï¼Œè°ƒç”¨æ ˆä¹Ÿä¸ä¸€æ ·ã€‚<br>é‚£ä¹ˆæ€ä¹ˆæ‰èƒ½åœ¨ block é‡Œé¢ä¿®æ”¹è¿™ç§ auto ç±»å‹çš„å˜é‡å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯ä½¿ç”¨ `</strong>block`ã€‚</p><p>æŠŠä¸Šé¢çš„ int age å˜é‡åŠ ä¸Šä¿®é¥°ç¬¦ __blockï¼Œå†æ¥çœ‹ cpp ä»£ç ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">struct <span class="variable">__Block_byref_age_0</span> &#123;</span><br><span class="line">  void *<span class="variable">__isa</span>;</span><br><span class="line"><span class="variable">__Block_byref_age_0</span> *<span class="variable">__forwarding</span>;</span><br><span class="line"> int <span class="variable">__flags</span>;</span><br><span class="line"> int <span class="variable">__size</span>;</span><br><span class="line"> int age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct <span class="variable">__main_block_impl_0</span> &#123;</span><br><span class="line">  struct <span class="variable">__block_impl</span> impl;</span><br><span class="line">  struct <span class="variable">__main_block_desc_0</span>* Desc;</span><br><span class="line">  <span class="variable">__Block_byref_age_0</span> *age; <span class="comment">// by ref</span></span><br><span class="line">  <span class="variable">__main_block_impl_0</span>(void *fp, struct <span class="variable">__main_block_desc_0</span> *desc, <span class="variable">__Block_byref_age_0</span> *<span class="variable">_age</span>, int flags=<span class="number">0</span>) : age(<span class="variable">_age</span>-&gt;<span class="variable">__forwarding</span>) &#123;</span><br><span class="line">    impl.isa = &amp;<span class="variable">_NSConcreteStackBlock</span>;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void <span class="variable">__main_block_func_0</span>(struct <span class="variable">__main_block_impl_0</span> *<span class="variable">__cself</span>) &#123;</span><br><span class="line">  <span class="variable">__Block_byref_age_0</span> *age = <span class="variable">__cself</span>-&gt;age; <span class="comment">// bound by ref</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            NSLog((NSString *)&amp;<span class="variable">__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_f5d64f_mi_0</span>, (age-&gt;<span class="variable">__forwarding</span>-&gt;age));</span><br><span class="line">        &#125;</span><br><span class="line">static void <span class="variable">__main_block_copy_0</span>(struct <span class="variable">__main_block_impl_0</span>*dst, struct <span class="variable">__main_block_impl_0</span>*src) &#123;<span class="variable">_Block_object_assign</span>((void*)&amp;dst-&gt;age, (void*)src-&gt;age, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line">static void <span class="variable">__main_block_dispose_0</span>(struct <span class="variable">__main_block_impl_0</span>*src) &#123;<span class="variable">_Block_object_dispose</span>((void*)src-&gt;age, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line">static struct <span class="variable">__main_block_desc_0</span> &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  void (*copy)(struct <span class="variable">__main_block_impl_0</span>*, struct <span class="variable">__main_block_impl_0</span>*);</span><br><span class="line">  void (*dispose)(struct <span class="variable">__main_block_impl_0</span>*);</span><br><span class="line">&#125; <span class="variable">__main_block_desc_0_DATA</span> = &#123; <span class="number">0</span>, <span class="built_in">sizeof</span>(struct <span class="variable">__main_block_impl_0</span>), <span class="variable">__main_block_copy_0</span>, <span class="variable">__main_block_dispose_0</span>&#125;;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; <span class="variable">__AtAutoreleasePool</span> <span class="variable">__autoreleasepool</span>; </span><br><span class="line"></span><br><span class="line">        <span class="variable">__attribute__</span>((<span class="variable">__blocks__</span>(byref))) <span class="variable">__Block_byref_age_0</span> age = &#123;(void*)<span class="number">0</span>,(<span class="variable">__Block_byref_age_0</span> *)&amp;age, <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="variable">__Block_byref_age_0</span>), <span class="number">10</span>&#125;;</span><br><span class="line"></span><br><span class="line">        void (*block)(void) = ((void (*)())&amp;<span class="variable">__main_block_impl_0</span>((void *)<span class="variable">__main_block_func_0</span>, &amp;<span class="variable">__main_block_desc_0_DATA</span>, (<span class="variable">__Block_byref_age_0</span> *)&amp;age, <span class="number">570425344</span>));</span><br><span class="line"></span><br><span class="line">        (age.<span class="variable">__forwarding</span>-&gt;age) = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        ((void (*)(<span class="variable">__block_impl</span> *))((<span class="variable">__block_impl</span> *)block)-&gt;FuncPtr)((<span class="variable">__block_impl</span> *)block);</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/************* æ¥æ•´ç†ä¸€ä¸‹ä¸Šé¢çš„ä»£ç  *************/</span></span><br><span class="line"></span><br><span class="line">struct <span class="variable">__Block_byref_age_0</span> &#123;</span><br><span class="line">  void *<span class="variable">__isa</span>;</span><br><span class="line"><span class="variable">__Block_byref_age_0</span> *<span class="variable">__forwarding</span>;</span><br><span class="line"> int <span class="variable">__flags</span>;</span><br><span class="line"> int <span class="variable">__size</span>;</span><br><span class="line"> int age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct <span class="variable">__main_block_impl_0</span> &#123;</span><br><span class="line">  struct <span class="variable">__block_impl</span> impl;</span><br><span class="line">  struct <span class="variable">__main_block_desc_0</span>* Desc;</span><br><span class="line">  <span class="variable">__Block_byref_age_0</span> *age; <span class="comment">// by ref</span></span><br><span class="line">  <span class="variable">__main_block_impl_0</span>(void *fp, struct <span class="variable">__main_block_desc_0</span> *desc, <span class="variable">__Block_byref_age_0</span> *<span class="variable">_age</span>, int flags=<span class="number">0</span>) : age(<span class="variable">_age</span>-&gt;<span class="variable">__forwarding</span>) &#123;</span><br><span class="line">    impl.isa = &amp;<span class="variable">_NSConcreteStackBlock</span>;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void <span class="variable">__main_block_func_0</span>(struct <span class="variable">__main_block_impl_0</span> *<span class="variable">__cself</span>) &#123;</span><br><span class="line">  <span class="variable">__Block_byref_age_0</span> *age = <span class="variable">__cself</span>-&gt;age; <span class="comment">// bound by ref</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void <span class="variable">__main_block_copy_0</span>(struct <span class="variable">__main_block_impl_0</span>*dst, struct <span class="variable">__main_block_impl_0</span>*src) &#123;</span><br><span class="line"><span class="variable">_Block_object_assign</span>((void*)&amp;dst-&gt;age, (void*)src-&gt;age, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void <span class="variable">__main_block_dispose_0</span>(struct <span class="variable">__main_block_impl_0</span>*src) &#123;</span><br><span class="line"><span class="variable">_Block_object_dispose</span>((void*)src-&gt;age, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static struct <span class="variable">__main_block_desc_0</span> &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  void (*copy)(struct <span class="variable">__main_block_impl_0</span>*, struct <span class="variable">__main_block_impl_0</span>*);</span><br><span class="line">  void (*dispose)(struct <span class="variable">__main_block_impl_0</span>*);</span><br><span class="line">&#125; <span class="variable">__main_block_desc_0_DATA</span> = &#123; <span class="number">0</span>, <span class="built_in">sizeof</span>(struct <span class="variable">__main_block_impl_0</span>), <span class="variable">__main_block_copy_0</span>, <span class="variable">__main_block_dispose_0</span>&#125;;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; <span class="variable">__AtAutoreleasePool</span> <span class="variable">__autoreleasepool</span>; </span><br><span class="line"></span><br><span class="line">        <span class="variable">__Block_byref_age_0</span> age = &#123;</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        (<span class="variable">__Block_byref_age_0</span> *)&amp;age,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        <span class="built_in">sizeof</span>(<span class="variable">__Block_byref_age_0</span>), </span><br><span class="line">        <span class="number">10</span>&#125;;</span><br><span class="line"></span><br><span class="line">        void (*block)(void) = &amp;<span class="variable">__main_block_impl_0</span>(</span><br><span class="line">        <span class="variable">__main_block_func_0</span>,</span><br><span class="line">         &amp;<span class="variable">__main_block_desc_0_DATA</span>,</span><br><span class="line">         &amp;age,</span><br><span class="line">         <span class="number">570425344</span>);</span><br><span class="line"></span><br><span class="line">        (age.<span class="variable">__forwarding</span>-&gt;age) = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        block-&gt;FuncPtr(block);</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ ä¸Š <strong>block åå¯ä»¥çœ‹åˆ°åœ¨ block é‡Œé¢æ•è·çš„ age çš„ä½ç½®å˜æˆäº† </strong>Block_byref_age_0ï¼Œè€Œåœ¨ <strong>Block_byref_age_0 é‡Œé¢æœ‰ä¸€ä¸ª int age å˜é‡ï¼Œåœ¨ main å‡½æ•°é‡Œé¢å£°æ˜çš„ int age è¢«åŒ…è£…æˆäº† </strong>Block_byref_age_0 çš„ç±»å‹ï¼Œåœ¨ä¿®æ”¹ age = 20 æ—¶å®é™…ä»£ç æ˜¯é€šè¿‡ __Block_byref_age_0 æ¥è®¿é—® int age çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç®¡åœ¨ main å‡½æ•°è¿˜æ˜¯åœ¨ block å†…éƒ¨ï¼Œä¿®æ”¹ age çš„è¯éƒ½æ˜¯ä¿®æ”¹çš„åŒ…è£…ç±»å‹é‡Œé¢çš„ ageã€‚</p><p><strong>__block åŸç†æ€»ç»“</strong></p><ul><li>__block ä¿®é¥°ç¬¦å¯ä»¥ç”¨ä»¥è§£å†³ block å†…éƒ¨æ— æ³•ä¿®æ”¹ auto å˜é‡å€¼çš„é—®é¢˜</li><li>__block ä¸èƒ½ä¿®æ”¹å…¨å±€å˜é‡ã€static å˜é‡</li><li>ç¼–è¯‘å™¨ä¼šå°† __block å˜é‡åŒ…è£…æˆä¸€ä¸ªå¯¹è±¡</li></ul><p>å…·ä½“æµç¨‹å¦‚ä¸‹</p><blockquote><p>1ã€å°† <strong>block å˜é‡åŒ…è£…æˆ </strong>Block_byref_age_0 ç±»å‹çš„å¯¹è±¡<br>2ã€è®¿é—® age æ—¶éƒ½æ˜¯è®¿é—®çš„ <strong>Block_byref_age_0 é‡Œé¢çš„ age<br>3ã€è®¿é—® age æ—¶æ˜¯é€šè¿‡ `</strong>forwarding` æŒ‡é’ˆæ¥è®¿é—®çš„ï¼ˆåˆå§‹åŒ–é»˜è®¤æŒ‡å‘è‡ªå·±ï¼‰</p></blockquote><p>å†æ¥çœ‹ä¸‹å¦‚æœåœ¨ block å¤–é¢æ‰“å° age çš„åœ°å€ï¼Œè¿™ä¸ªåœ°å€åˆ°åº•æ˜¯ __Block_byref_age_0 age çš„åœ°å€è¿˜æ˜¯ int age çš„åœ°å€ï¼š</p><p>ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œå°† block ç”Ÿæˆçš„ç»“æ„ä½“æ‹¿è¿‡æ¥ç”¨ä¸€ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_age_0</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> *__isa;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>  __<span class="title">Block_byref_age_0</span> *__<span class="title">forwarding</span>;</span></span><br><span class="line">    <span class="keyword">int</span> __flags;</span><br><span class="line">    <span class="keyword">int</span> __size;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*copy)(<span class="keyword">void</span>);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(<span class="keyword">void</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_age_0</span> *<span class="title">age</span>;</span> <span class="comment">// by ref</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// main å‡½æ•°ä»£ç </span></span><br><span class="line">__block <span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">  NSLog(@<span class="string">"--- age = %d"</span>, age);</span><br><span class="line">  age = <span class="number">30</span>;</span><br><span class="line">  NSLog(@<span class="string">"--- age = %d"</span>, age);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> * <span class="title">blockImpl</span> = (__<span class="title">bridge</span> <span class="title">struct</span> __<span class="title">main_block_impl_0</span> *)<span class="title">block</span>;</span></span><br><span class="line">   </span><br><span class="line">NSLog(@<span class="string">"-- age address : %p"</span>, &amp;age);</span><br></pre></td></tr></table></figure><p>åœ¨ NSLog(@â€â€“ age address : %pâ€, &amp;age); å¤„æ‰“æ–­ç‚¹ï¼Œæ¥æŸ¥çœ‹ä¸€ä¸‹ä¸¤ä¸ª age å˜é‡çš„åœ°å€ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p/x &amp;(blockImpl-&gt;age) : (__Block_byref_age_0 **) <span class="variable">$2</span> = 0x000000010064a030</span><br><span class="line"></span><br><span class="line">p/x &amp;(blockImpl-&gt;age-&gt;age) : (int *) <span class="variable">$3</span> = 0x000000010064a058</span><br><span class="line"></span><br><span class="line">NSLog æ‰“å°åœ°å€ï¼š -- age<span class="built_in"> address </span>: 0x10064a058</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥æ‰“å° age çš„åœ°å€å’Œç”Ÿæˆçš„åŒ…è£…å¯¹è±¡é‡Œé¢çš„ age å˜é‡åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå¯èƒ½ç±»ä¼¼ KVOï¼Œè‹¹æœä¸æƒ³è®©å¼€å‘è€…çœ‹åˆ°å®ç°çš„è¿‡ç¨‹ï¼Œç›´æ¥å±è”½äº†ï¼Œå¯¹äºæˆ‘ä»¬å¼€å‘è€…æ¥è¯´ï¼Œè®¿é—®çš„å…¶å®å°±æ˜¯ int age æœ¬èº«ã€‚</p><p>æœ€åå†æ¥çœ‹ä¸‹é¢ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSMutableArray *<span class="built_in"> array </span>= [NSMutableArray array];        </span><br><span class="line">void (^block)(void) = ^&#123;</span><br><span class="line">  [array addObject:@<span class="string">"1"</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¸€ä¸‹æˆåŠŸï¼Œæ‰§è¡Œå®Œ block ååœ¨æ‰“å° arrayï¼Œæ·»åŠ  object æˆåŠŸï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè¿™é‡Œæ˜¯ä½¿ç”¨æŒ‡é’ˆ arrayï¼Œå¹¶ä¸æ˜¯ä¿®æ”¹æŒ‡é’ˆï¼Œå¦‚æœ array = nil é‚£ä¹ˆå°±ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œå› ä¸ºè¦ä¿®æ”¹çš„è¯éœ€è¦ä½¿ç”¨ __block ä¿®é¥°ç¬¦ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;Block-åŸç†&quot;&gt;&lt;a href=&quot;#Block-åŸç†&quot; class=&quot;headerlink&quot; title=&quot;__Block åŸç†&quot;&gt;&lt;/a&gt;__Block åŸç†&lt;/h4&gt;&lt;p&gt;å…ˆæ¥æµ‹è¯•ä¸€ä¸ªç»å…¸çš„æ¡ˆä¾‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;age&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;(^block)(void)&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;^&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;string&quot;&gt;NSLog(@&quot;---&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;age&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;%d&quot;,&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;age);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&amp;#125;;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;age&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;string&quot;&gt;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;block();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;///&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;è¾“å‡ºç»“æœ&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;---&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;age&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="block åŸç†" scheme="http://yoursite.com/tags/block-%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>block3-ç±»å‹ã€copyåŸç†</title>
    <link href="http://yoursite.com/2020/07/02/block3-%E7%B1%BB%E5%9E%8B%E3%80%81copy%E5%8E%9F%E7%90%86/"/>
    <id>http://yoursite.com/2020/07/02/block3-ç±»å‹ã€copyåŸç†/</id>
    <published>2020-07-02T08:15:21.000Z</published>
    <updated>2020-08-15T14:25:20.731Z</updated>
    
    <content type="html"><![CDATA[<h3 id="block-ç±»å‹"><a href="#block-ç±»å‹" class="headerlink" title="block ç±»å‹"></a>block ç±»å‹</h3><p>block çš„ç±»å‹æœ‰3ä¸­ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ class æ–¹æ³•æˆ–è€… isa æŒ‡é’ˆæŸ¥çœ‹å…·ä½“ç±»å‹ï¼Œæœ€ç»ˆéƒ½æ˜¯é›†æˆå­ NSBlock ç±»å‹</p><ol><li>æ•°æ®åŒºï¼š<strong>NSGlobalBlock</strong> ï¼ˆ _NSConcreteGlobalBlock ï¼‰</li><li>æ ˆåŒºï¼š<strong>NSStackBlock</strong> ï¼ˆ _NSConcreteStackBlock ï¼‰</li><li>å †åŒºï¼š<strong>NSMallocBlock</strong> ï¼ˆ _NSConcreteMallocBlock ï¼‰</li></ol><blockquote><p>block ç±»å‹çš„å…·ä½“ç±»å‹åŒºåˆ†ï¼š</p></blockquote><table><thead><tr><th>block ç±»å‹</th><th>ç¯å¢ƒ</th></tr></thead><tbody><tr><td>__NSGlobalBlock__</td><td>æ²¡æœ‰è®¿é—® auto å˜é‡</td></tr><tr><td>__NSStackBlock__</td><td>è®¿é—®äº† auto å˜é‡</td></tr><tr><td>__NSMallocBlock__</td><td>__NSStackBlock__ è°ƒç”¨äº† copy</td></tr></tbody></table><a id="more"></a><p>çœ‹ä¸€ä¸‹æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (^block1)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"block1"</span>);</span><br><span class="line">&#125;;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">int</span> age = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">void</span> (^block2)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"block2 -- %d"</span>, age);</span><br><span class="line">&#125;;</span><br><span class="line">        </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@  %@  %@"</span>, [block1 <span class="keyword">class</span>], [block2 <span class="keyword">class</span>], [^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"block3 -- %d"</span>, age);</span><br><span class="line">        &#125; <span class="keyword">class</span>]);</span><br><span class="line">        </span><br><span class="line">ARC ç¯å¢ƒæ‰“å°ç»“æœï¼š</span><br><span class="line">__NSGlobalBlock__  __NSMallocBlock__  __NSStackBlock__</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¸Šé¢ block çš„ç±»å‹åŒºåˆ†åˆ†ææµ‹è¯•ä»£ç é‡Œé¢çš„ block2 åº”è¯¥æ˜¯åœ¨æ ˆç©ºé—´çš„ï¼Œå¯æ˜¯æ‰“å°å‡ºçš„ç±»å‹å´æ˜¯åœ¨å †ç©ºé—´ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘çœ‹æ¥çœ‹ä¸‹ç”Ÿæˆçš„ cpp æ–‡ä»¶ï¼Œä¸‰ç§ç±»å‹çš„ block isa æŒ‡é’ˆç±»å‹éƒ½æ˜¯ï¼š_NSConcreteStackBlockï¼Œæ„Ÿè§‰ä¹Ÿä¸å¯¹ã€‚<br>åˆ°è¿™é‡Œå°±ä¸èƒ½åªçœ‹é™æ€ç¼–è¯‘çš„ cpp æ–‡ä»¶ä»£ç æ¥åˆ†æäº†ï¼Œè¿™é‡Œè¦ä»¥è¿è¡Œæ—¶çš„ç»“æœä¸ºå‡†ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰“å°çš„ç»“æœï¼Œå› ä¸ºç›®å‰çš„ç¯å¢ƒæ˜¯ ARC ç¯å¢ƒï¼ŒARC å¸®æˆ‘ä»¬åšäº†ä¸€äº›å¤„ç†ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ MRC ç¯å¢ƒåœ¨èµ°ä¸€éä¸Šé¢çš„æ‰“å°ï¼š<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// MRC ç¯å¢ƒæ‰“å°ç»“æœ</span></span><br><span class="line"><span class="variable">__NSGlobalBlock__</span>  <span class="variable">__NSStackBlock__</span>  <span class="variable">__NSStackBlock__</span></span><br></pre></td></tr></table></figure></p><p>ARC ç»“æœä¸æˆ‘ä»¬åˆ†æçš„ä¸æ­£ç¡®æ˜¯å› ä¸ºåœ¨ ARC ç¯å¢ƒä¸‹ä¼šå¯¹ stack ç±»å‹çš„ block åšä¸€æ¬¡ copy æ“ä½œã€‚</p><p><br></p><h3 id="block-copy"><a href="#block-copy" class="headerlink" title="block copy"></a>block copy</h3><p>ä¸åŒç±»å‹çš„ block copy ç»“æœ</p><table><thead><tr><th>Block ç±»å‹</th><th>å‰¯æœ¬æºçš„é…ç½®å­˜å‚¨åŸŸ</th><th>copy æ•ˆæœ</th></tr></thead><tbody><tr><td>__NSGlobalBlock__</td><td>ç¨‹åºçš„æ•°æ®åŒºåŸŸ</td><td>ä»€ä¹ˆä¹Ÿä¸åš</td></tr><tr><td>__NSStackBlock__</td><td>æ ˆ</td><td>ä»æ ˆèµ‹å€¼åˆ°å †</td></tr><tr><td>__NSMallocBlock__</td><td>å †</td><td>å¼•ç”¨è®¡æ•°å¢åŠ </td></tr></tbody></table><p>å†æ¥çœ‹ä¸‹ ARC ç¯å¢ƒä¸‹æ ˆç©ºé—´ block è‡ªåŠ¨ copy çš„æƒ…å†µï¼š</p><blockquote><p>block ä½œä¸ºå‚æ•°è¿”å›å€¼<br>å°† block èµ‹å€¼ç»™ __strong æŒ‡é’ˆæ—¶<br>block ä½œä¸º cocoa api ä¸­æ–¹æ³•åå«æœ‰ usingBlock çš„æ–¹æ³•å‚æ•°æ—¶<br>block ä½œä¸º GCD api çš„æ–¹æ³•å‚æ•°æ—¶</p></blockquote><p>æ ˆç©ºé—´çš„ block æ˜¯æ•è·äº† auto çš„ç±»å‹å˜é‡ï¼Œè€Œ auto ç±»å‹æ˜¯è‡ªåŠ¨é”€æ¯ç±»å‹ï¼Œåœ¨ä½œç”¨åŸŸæ¶ˆå¤±åä¼šå›æ”¶å†…å­˜ï¼Œå¦‚æœæ ˆç©ºé—´çš„ block ä¸åš copy çš„è¯å†…å­˜è®¿é—®å¯èƒ½ä¼šå‡ºç°é”™ä¹±çš„é—®é¢˜ï¼Œçœ‹ä¸‹æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// MRC ç¯å¢ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(^Block)</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">Block block;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line">    block = ^&#123;</span><br><span class="line">        NSLog(@<span class="string">"---- block -- %d"</span>, age);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">       test();</span><br><span class="line">       block();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰“å°çš„ç»“æœå°±æ˜¯éšæœºå€¼ï¼Œå› ä¸ºä¸Šé¢ block çš„å†…å­˜åˆ†é…åœ¨æ ˆç©ºé—´ï¼Œå½“ä½œç”¨åŸŸç»“æŸåå†…å­˜ä¼šå›æ”¶ï¼Œæ‰€ä»¥æ•è·çš„ageçš„å†…å­˜ç©ºé—´ä¼šå›æ”¶ï¼Œå½“æˆ‘ä»¬å†æ¬¡è®¿é—®æ—¶å°±ä¼šæˆä¸ºéšæœºå€¼ã€‚</p><p><br></p><h3 id="å¯¹è±¡ç±»å‹çš„-auto-å˜é‡"><a href="#å¯¹è±¡ç±»å‹çš„-auto-å˜é‡" class="headerlink" title="å¯¹è±¡ç±»å‹çš„ auto å˜é‡"></a>å¯¹è±¡ç±»å‹çš„ auto å˜é‡</h3><p>ç‰¹æ®Šçš„ç»“è®ºï¼š</p><blockquote><p>å½“ block å†…å­˜è®¿é—®äº†å¯¹è±¡ç±»å‹çš„ auto å˜é‡æ—¶ï¼Œå¦‚æœ block æ˜¯åœ¨æ ˆä¸Šï¼Œå°†ä¸ä¼šå¯¹ auto å˜é‡äº§ç”Ÿå¼ºå¼•ç”¨ã€‚</p></blockquote><p>å› ä¸ºæ ˆç©ºé—´çš„ block è‡ªå·±éƒ½å¯èƒ½éšæ—¶é”€æ¯ï¼Œè¿™é‡Œä¸ä¼šå¯¹å¯¹è±¡ç±»å‹çš„ auto å˜é‡äº§ç”Ÿå¼ºå¼•ç”¨ã€‚</p><p><br></p><p>block è¢«æ‹·è´åˆ°å †ä¸Šé¢çš„æƒ…å†µï¼š<br>çœ‹ä¸‹æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 1ã€è®¿é—® <span class="keyword">animal</span></span><br><span class="line">Block testBlock;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">Animal</span> * <span class="keyword">animal</span> = <span class="comment">[<span class="comment">[Animal alloc]</span> init]</span>;</span><br><span class="line"><span class="keyword">animal</span>.age = 10;</span><br><span class="line"></span><br><span class="line">testBlock = ^&#123;</span><br><span class="line">NSLog(@<span class="string">"--- %d"</span>, <span class="keyword">animal</span>.age);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 2ã€wealAnimal</span><br><span class="line">Block testBlock;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">Animal</span> * <span class="keyword">animal</span> = <span class="comment">[<span class="comment">[Animal alloc]</span> init]</span>;</span><br><span class="line"><span class="keyword">animal</span>.age = 10;</span><br><span class="line">__weak <span class="keyword">Animal</span> * weakAnimal = <span class="keyword">animal</span>;</span><br><span class="line">testBlock = ^&#123;</span><br><span class="line">NSLog(@<span class="string">"--- %d"</span>, weakAnimal.age);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œç¬¬ä¸€ç§æƒ…å†µ animal çš„é‡Šæ”¾æ˜¯åœ¨ testBlock é”€æ¯æ—¶æ‰ä¼šé‡Šæ”¾ï¼Œç¬¬äºŒç§æ˜¯åœ¨ animal ä½œç”¨åŸŸç»“æŸä¹Ÿå°±æ˜¯å¤§æ‹¬å·ç»“æŸæ—¶å°±é‡Šæ”¾äº†ï¼Œè¯´æ˜è¿™ä¸¤ç§æƒ…å†µä¸‹çš„æ•è·æœ‰åŒºåˆ«ï¼Œæ¥ cpp æ–‡ä»¶çœ‹ä¸‹æ•è·çš„æƒ…å†µï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1ã€è®¿é—® animal</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__block_impl</span></span> <span class="keyword">impl</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span>* Desc;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ•è·çš„æ˜¯ __strong ç±»å‹</span></span><br><span class="line">  Animal *__strong animal;</span><br><span class="line">  __main_block_impl_0(void *fp, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> *desc, Animal *__strong _animal, int flags=<span class="number">0</span>) : animal(_animal) &#123;</span><br><span class="line">    <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    <span class="keyword">impl</span>.Flags = flags;</span><br><span class="line">    <span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2ã€wealAnimal</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__block_impl</span></span> <span class="keyword">impl</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span>* Desc;   </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// æ•è·çš„æ˜¯ __weak ç±»å‹</span></span><br><span class="line">  Animal *__weak weakAnimal;</span><br><span class="line">  __main_block_impl_0(void *fp, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> *desc, Animal *__weak _weakAnimal, int flags=<span class="number">0</span>) : weakAnimal(_weakAnimal) &#123;</span><br><span class="line">    <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    <span class="keyword">impl</span>.Flags = flags;</span><br><span class="line">    <span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨å †ç©ºé—´ block å¯¹è±¡ç±»å‹çš„ auto å˜é‡æ•è·æ˜¯æ ¹æ®æ•è·çš„æŒ‡é’ˆçš„å¼ºå¼±è¿›è¡Œçš„ã€‚<br>å†çœ‹ cpp ä»£ç ï¼Œç”Ÿæˆçš„ __main_block_desc_0 ç»“æ„æœ‰ä¸€ç‚¹ç‚¹çš„å·®åˆ«ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> void __main_block_copy_0(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*dst, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;weakAnimal, (void*)src-&gt;weakAnimal, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> void __main_block_dispose_0(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*src) &#123;_Block_object_dispose((void*)src-&gt;weakAnimal, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  void (*copy)(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*);</span><br><span class="line">  void (*dispose)(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ç”Ÿæˆçš„  __main_block_desc_0 ä¸­å¤šäº†ä¸¤ä¸ªå‡½æ•°ï¼š <code>copy</code> å’Œ <code>dispose</code>ã€‚è¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥ç®¡ç†æ•è·åˆ°çš„å¯¹è±¡æŒ‡é’ˆçš„ã€‚</p><p>æ€»ç»“è°ƒç”¨æµç¨‹ï¼š</p><p><strong>å¦‚æœ block è¢«æ‹·è´åˆ°å †ä¸Š</strong></p><blockquote><p>1ã€è°ƒç”¨ block å†…éƒ¨çš„ copy å‡½æ•°<br>2ã€copy å‡½æ•°ä¼šè°ƒç”¨ <code>_Block_object_assign</code> å‡½æ•°<br>3ã€<code>_Block_object_assign</code> å‡½æ•°ä¼šæ ¹æ® auto å˜é‡ä¿®é¥°ç¬¦çš„ç±»å‹ï¼ˆ<code>__strong</code>ã€<code>__weak</code>ã€<code>__unsafe_unretained</code>ï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨æˆ–å¼±å¼•ç”¨</p></blockquote><p><strong>block ä»å †ä¸Šé¢ç§»é™¤</strong></p><blockquote><p>1ã€è°ƒç”¨ block å†…éƒ¨çš„ dispose å‡½æ•°<br>2ã€dispose å‡½æ•°ä¼šè°ƒç”¨ <code>_Block_object_dispose</code> å‡½æ•°<br>3ã€<code>_Block_object_dispose</code> å‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„ auto å˜é‡</p></blockquote><table><thead><tr><th>å‡½æ•°</th><th>è°ƒç”¨æ—¶æœº</th></tr></thead><tbody><tr><td>copy</td><td>æ ˆä¸Šçš„ block èµ‹å€¼åˆ°å †ä¸Š</td></tr><tr><td>dispose</td><td>æ ˆä¸Šçš„ block è¢«åºŸå¼ƒ</td></tr></tbody></table><p><br></p><h4 id="clang-å‘½ä»¤ï¼š"><a href="#clang-å‘½ä»¤ï¼š" class="headerlink" title="clang å‘½ä»¤ï¼š"></a>clang å‘½ä»¤ï¼š</h4><p>æ™®é€šï¼š<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m</code></p><p>éœ€è¦ç¼–è¯‘ <code>__weak</code> ä¿®é¥°ç¬¦ï¼š<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-13.0.0 main.m</code></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;block-ç±»å‹&quot;&gt;&lt;a href=&quot;#block-ç±»å‹&quot; class=&quot;headerlink&quot; title=&quot;block ç±»å‹&quot;&gt;&lt;/a&gt;block ç±»å‹&lt;/h3&gt;&lt;p&gt;block çš„ç±»å‹æœ‰3ä¸­ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ class æ–¹æ³•æˆ–è€… isa æŒ‡é’ˆæŸ¥çœ‹å…·ä½“ç±»å‹ï¼Œæœ€ç»ˆéƒ½æ˜¯é›†æˆå­ NSBlock ç±»å‹&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ•°æ®åŒºï¼š&lt;strong&gt;NSGlobalBlock&lt;/strong&gt; ï¼ˆ _NSConcreteGlobalBlock ï¼‰&lt;/li&gt;
&lt;li&gt;æ ˆåŒºï¼š&lt;strong&gt;NSStackBlock&lt;/strong&gt; ï¼ˆ _NSConcreteStackBlock ï¼‰&lt;/li&gt;
&lt;li&gt;å †åŒºï¼š&lt;strong&gt;NSMallocBlock&lt;/strong&gt; ï¼ˆ _NSConcreteMallocBlock ï¼‰&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;block ç±»å‹çš„å…·ä½“ç±»å‹åŒºåˆ†ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;block ç±»å‹&lt;/th&gt;
&lt;th&gt;ç¯å¢ƒ&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;__NSGlobalBlock__&lt;/td&gt;
&lt;td&gt;æ²¡æœ‰è®¿é—® auto å˜é‡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__NSStackBlock__&lt;/td&gt;
&lt;td&gt;è®¿é—®äº† auto å˜é‡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;__NSMallocBlock__&lt;/td&gt;
&lt;td&gt;__NSStackBlock__ è°ƒç”¨äº† copy&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
    
      <category term="block ç±»å‹ã€copy" scheme="http://yoursite.com/tags/block-%E7%B1%BB%E5%9E%8B%E3%80%81copy/"/>
    
  </entry>
  
  <entry>
    <title>block2-å˜é‡çš„æ•è·</title>
    <link href="http://yoursite.com/2020/07/02/block2-%E5%8F%98%E9%87%8F%E7%9A%84%E6%8D%95%E8%8E%B7/"/>
    <id>http://yoursite.com/2020/07/02/block2-å˜é‡çš„æ•è·/</id>
    <published>2020-07-02T06:14:51.000Z</published>
    <updated>2020-08-15T14:25:10.171Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å˜é‡çš„æ•è·"><a href="#å˜é‡çš„æ•è·" class="headerlink" title="å˜é‡çš„æ•è·"></a>å˜é‡çš„æ•è·</h3><p>ä¸ºäº†ä¿è¯ block å†…éƒ¨èƒ½å¤Ÿæ­£å¸¸è®¿é—®å¤–éƒ¨å˜é‡ï¼Œblock æœ‰ä¸ªå˜é‡æ•è·æœºåˆ¶ï¼š</p><table><thead><tr><th>å˜é‡ç±»å‹</th><th>æ•è·åˆ° block å†…éƒ¨</th><th>è®¿é—®æ–¹å¼</th></tr></thead><tbody><tr><td>å±€éƒ¨å˜é‡ - auto</td><td>âˆš</td><td>å€¼ä¼ é€’</td></tr><tr><td>å±€éƒ¨å˜é‡ - static</td><td>âˆš</td><td>æŒ‡é’ˆä¼ é€’</td></tr><tr><td>å…¨å±€å˜é‡</td><td>x</td><td>ç›´æ¥è®¿é—®</td></tr></tbody></table><a id="more"></a><p>ä¸‹é¢æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// å…¨å±€å˜é‡</span></span><br><span class="line"><span class="keyword">int</span> a_ = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> sa_ = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="meta">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">/// å±€éƒ¨ auto å˜é‡</span></span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">10</span>;</span><br><span class="line">        <span class="comment">/// å±€éƒ¨ static å˜é‡</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> sb = <span class="number">10</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">            NSLog(@<span class="string">"log -- %d, %d, %d, %d"</span>, a_, sa_, b, sb);</span><br><span class="line">        &#125;;</span><br><span class="line">        block();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ clang æŸ¥çœ‹ä¸Šé¢ä»£ç çš„ç¼–è¯‘ç»“æœï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a_ = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> sa_ = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">  <span class="keyword">int</span> *sb;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> _b, <span class="keyword">int</span> *_sb, <span class="keyword">int</span> flags=<span class="number">0</span>) : b(_b), sb(_sb) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="keyword">int</span> b = __cself-&gt;b; <span class="comment">// bound by copy</span></span><br><span class="line">  <span class="keyword">int</span> *sb = __cself-&gt;sb; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_3ee42d_mi_0, a_, sa_, b, (*sb));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> sb = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, b, &amp;sb));</span><br><span class="line"></span><br><span class="line">        ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/// è¿™é‡Œæ˜¯åˆ é™¤ç±»å‹è½¬æ¢åçš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = &amp;__main_block_impl_0(__main_block_func_0,</span><br><span class="line">                                                   &amp;__main_block_desc_0_DATA,</span><br><span class="line">                                                   b,</span><br><span class="line">                                                   &amp;sb));</span><br><span class="line"></span><br><span class="line">        block-&gt;FuncPtr(block);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå¯ä»¥çœ‹åˆ° block ç»“æ„ä½“åˆå§‹åŒ–æ—¶é™¤äº†ä¼ é€’ FuncPtr å’Œ desp ä¸¤ä¸ªå‚æ•°å¤–ï¼Œå¤šäº† b å’Œ &amp;sb å‚æ•°ï¼Œå†çœ‹ç»“æ„ä½“ <code>__main_block_impl_0</code> é‡Œé¢ç¡®å®å¤šäº†è¿™ä¸¤ä¸ªå‚æ•°ï¼Œæ³¨æ„è¿™é‡Œå¹¶æ²¡æœ‰å’Œ a ç›¸å…³çš„æ•è·ã€‚<br>æˆ‘ä»¬åœ¨ block é‡Œé¢è®¿é—®äº†å››ä¸ªå˜é‡ï¼Œæ¥çœ‹ <code>__main_block_func_0</code> å‡½æ•°é‡Œé¢æ˜¯å¦‚ä½•è®¿é—®çš„ï¼š</p><ol><li>å…¨å±€å˜é‡ a_ å’Œ sa_ æ˜¯ç›´æ¥è®¿é—®çš„</li><li>å±€éƒ¨å˜é‡ b å’Œ sb æ˜¯è®¿é—®çš„ <code>__main_block_impl_0</code> é‡Œé¢æ•è·çš„å€¼</li><li>b æ˜¯æ•è·çš„å€¼ï¼Œsb æ˜¯ int* ç±»å‹ï¼Œæ ‡è¯†çš„æ˜¯æ•è·çš„åœ°å€</li></ol><p>ç”±ä¸Šå¯ä»¥éªŒè¯æˆ‘ä»¬å˜é‡æ•è·çš„ç»“è®ºã€‚</p><p><br></p><h4 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h4><p>ä¸‹é¢æˆ‘ä»¬æ¥åšä¸€ä¸ªæµ‹è¯•ï¼Œæ–°å»ºä¸€ä¸ª <code>Animal</code> çš„ç±»ï¼Œå£°æ˜ä¸€ä¸ª age å±æ€§å’Œ test æ–¹æ³•ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Animal</span></span></span><br><span class="line">- (<span class="keyword">void</span>)test &#123;</span><br><span class="line">    <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"--- %d"</span>, <span class="keyword">self</span>.age);</span><br><span class="line">    &#125;;</span><br><span class="line">    block();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæµ‹è¯•ä»£ç ï¼Œblock æœ‰æ•è· self å—ï¼Ÿ</p><p>æ¥çœ‹ä¸‹ clang ç¼–è¯‘çš„ç»“æœï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__Animal__test_block_impl_0</span></span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__block_impl</span></span> <span class="keyword">impl</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__Animal__test_block_desc_0</span></span>* Desc;</span><br><span class="line">  Animal *<span class="keyword">const</span> __strong <span class="keyword">self</span>;</span><br><span class="line">  __Animal__test_block_impl_0(void *fp, <span class="class"><span class="keyword">struct</span> <span class="title">__Animal__test_block_desc_0</span></span> *desc, Animal *<span class="keyword">const</span> __strong _<span class="keyword">self</span>, int flags=<span class="number">0</span>) : <span class="keyword">self</span>(_<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    <span class="keyword">impl</span>.Flags = flags;</span><br><span class="line">    <span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹ç»“æœæ˜¯æœ‰æ•è·çš„ï¼Œè¿™é‡Œæœ‰æ²¡æœ‰ç–‘é—®ï¼Œself éš¾é“ä¸æ˜¯å…¨å±€å˜é‡å—ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œä¼šæœ‰æ•è·å‘¢ï¼Ÿæ ¹æ® block æ•è·çš„æœºåˆ¶ï¼Œåªæœ‰ auto å˜é‡æ‰ä¼šæ•è·ï¼Œè¿™é‡Œæ—¢ç„¶æœ‰æ•è· selfï¼Œå°±è¯æ˜ self ä¸æ˜¯å…¨å±€å˜é‡ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹ test æ–¹æ³•ï¼ŒéªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static <span class="literal">void</span> _I_Animal_test(Animal * self, SEL _cmd) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="literal">void</span> (*block)(<span class="literal">void</span>) = ((<span class="literal">void</span> (*)())&amp;__Animal__test_block_impl_0((<span class="literal">void</span> *)__Animal__test_block_func_0, &amp;__Animal__test_block_desc_0_DATA, self, <span class="number">570425344</span>));</span><br><span class="line">    <span class="function"><span class="params">((<span class="literal">void</span> (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block)</span>;</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">   /// ç®€åŒ–ä¸€ä¸‹</span></span><br><span class="line"><span class="function">    <span class="title">void</span> <span class="params">(*block)(<span class="literal">void</span>)</span> = &amp;<span class="title">__Animal__test_block_impl_0</span><span class="params">(__Animal__test_block_func_0, </span></span></span><br><span class="line"><span class="function"><span class="params">        &amp;__Animal__test_block_desc_0_DATA,</span></span></span><br><span class="line"><span class="function"><span class="params">         self,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="number">570425344</span>)</span>);</span></span><br><span class="line"><span class="function">          </span></span><br><span class="line"><span class="function">    <span class="title">block</span>-&gt;</span>FuncPtr(block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šå¯ä»¥çœ‹åˆ° <strong>Animal</strong>test_block_impl_0 åœ¨åˆå§‹åŒ–æ—¶ç¡®å®ä¼ é€’äº† self å‚æ•°ï¼Œå†çœ‹ test æ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°ï¼š<code>self</code>ã€<code>_cmd</code>ï¼Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œè¿™æ˜¯æ¯ä¸ªæ–¹æ³•é‡Œé¢é»˜è®¤è‡ªå¸¦çš„å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰èƒ½åœ¨æ–¹æ³•é‡Œé¢ä½¿ç”¨ self å’Œ _cmdã€‚<br>åˆ°è¿™é‡Œä¹Ÿå°±æ˜ç™½äº†ï¼Œself æ˜¯ä½œä¸ºå½¢å‚è¢«æ•è·çš„ï¼Œå®Œå…¨ç¬¦åˆæˆ‘ä»¬æ€»ç»“çš„ block æ•è·æœºåˆ¶ã€‚</p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><blockquote><p>å˜é‡æœ‰æ²¡æœ‰è¢« block æ•è·ï¼Œå°±çœ‹å˜é‡çš„ç±»å‹æ˜¯å…¨å±€å˜é‡è¿˜æ˜¯å±€éƒ¨å˜é‡ã€‚</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å˜é‡çš„æ•è·&quot;&gt;&lt;a href=&quot;#å˜é‡çš„æ•è·&quot; class=&quot;headerlink&quot; title=&quot;å˜é‡çš„æ•è·&quot;&gt;&lt;/a&gt;å˜é‡çš„æ•è·&lt;/h3&gt;&lt;p&gt;ä¸ºäº†ä¿è¯ block å†…éƒ¨èƒ½å¤Ÿæ­£å¸¸è®¿é—®å¤–éƒ¨å˜é‡ï¼Œblock æœ‰ä¸ªå˜é‡æ•è·æœºåˆ¶ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å˜é‡ç±»å‹&lt;/th&gt;
&lt;th&gt;æ•è·åˆ° block å†…éƒ¨&lt;/th&gt;
&lt;th&gt;è®¿é—®æ–¹å¼&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;å±€éƒ¨å˜é‡ - auto&lt;/td&gt;
&lt;td&gt;âˆš&lt;/td&gt;
&lt;td&gt;å€¼ä¼ é€’&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;å±€éƒ¨å˜é‡ - static&lt;/td&gt;
&lt;td&gt;âˆš&lt;/td&gt;
&lt;td&gt;æŒ‡é’ˆä¼ é€’&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;å…¨å±€å˜é‡&lt;/td&gt;
&lt;td&gt;x&lt;/td&gt;
&lt;td&gt;ç›´æ¥è®¿é—®&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
    
      <category term="block å˜é‡æ•è·" scheme="http://yoursite.com/tags/block-%E5%8F%98%E9%87%8F%E6%8D%95%E8%8E%B7/"/>
    
  </entry>
  
  <entry>
    <title>blockåŸç†æ¢ç©¶</title>
    <link href="http://yoursite.com/2020/07/01/block%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/"/>
    <id>http://yoursite.com/2020/07/01/blockåŸç†æ¢ç©¶/</id>
    <published>2020-07-01T11:36:19.000Z</published>
    <updated>2020-08-15T14:28:02.349Z</updated>
    
    <content type="html"><![CDATA[<p><br></p><blockquote><p>æœ€è¿‘åœ¨åšä¸šåŠ¡æ—¶ï¼Œå¯è°“ä¸€æ­¥ä¸€ä¸ªå‘ï¼Œæ‰€ä»¥å›è¿‡å¤´æ¥è¡¥å……ä¸‹æœ€åŸºç¡€çš„åŸç†çŸ¥è¯†ã€‚<br>PSï¼šåŸºç¡€å¥½æ‰æ˜¯çœŸçš„å¥½ï¼ï¼ï¼</p></blockquote><a id="more"></a><h3 id="Block-åŸç†æ¢ç©¶"><a href="#Block-åŸç†æ¢ç©¶" class="headerlink" title="Block åŸç†æ¢ç©¶"></a>Block åŸç†æ¢ç©¶</h3><p>å°† block ç›¸å…³çš„çŸ¥è¯†ç‚¹å½’çº³å¦‚ä¸‹ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1. </span>block æœ¬è´¨</span><br><span class="line"><span class="bullet">2. </span>block å˜é‡æ•è·</span><br><span class="line"><span class="bullet">3. </span>block ç±»å‹ã€copy åŸç†</span><br><span class="line"><span class="bullet">4. </span>__block åŸç†</span><br><span class="line"><span class="bullet">5. </span>block å†…å­˜ç®¡ç†</span><br><span class="line"><span class="bullet">6. </span>block å¾ªç¯å¼•ç”¨</span><br></pre></td></tr></table></figure><h3 id="Block-æœ¬è´¨"><a href="#Block-æœ¬è´¨" class="headerlink" title="Block æœ¬è´¨"></a>Block æœ¬è´¨</h3><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="meta">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;  </span><br><span class="line">            NSLog(@<span class="string">"block --"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        block();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·å‡º <code>clang</code> å‘½ä»¤çœ‹ä¸€ä¸‹ block è¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆï¼š</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int main(<span class="name">int</span> argc, const char * argv[]) &#123;</span><br><span class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        void (*block)(<span class="name">void</span>) = ((<span class="name">void</span> (<span class="name">*</span>)())<span class="symbol">&amp;__main_block_impl_0</span>((<span class="name">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line"></span><br><span class="line">        ((void (*)(<span class="name">__block_impl</span> *))((__block_impl *)block)-&gt;FuncPtr)((<span class="name">__block_impl</span> *)block);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ä¸Šé¢çš„ç±»å‹è½¬æ¢ä»£ç åˆ é™¤ä¹‹åå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æ„ï¼š</p><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">void</span> (*<span class="keyword">block</span>)(<span class="built_in">void</span>) = &amp;__main_block_impl_0(__main_block_func_0,</span><br><span class="line">                                           &amp;__main_block_desc_0_DATA));</span><br><span class="line"></span><br><span class="line"><span class="keyword">block</span>-&gt;<span class="type">FuncPtr</span>(<span class="keyword">block</span>);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨ block() å…¶å®å°±æ˜¯è°ƒç”¨ block-&gt;FuncPtr(block)ã€‚</p><p>å†æ¥çœ‹çœ‹ block è¢«ç¼–è¯‘åçš„å…·ä½“ç»“æ„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__block_impl</span></span> <span class="keyword">impl</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span>* Desc;</span><br><span class="line">  __main_block_impl_0(void *fp, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> *desc, int flags=<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    <span class="keyword">impl</span>.Flags = flags;</span><br><span class="line">    <span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> void __main_block_func_0(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> *__cself) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_395a2c_mi_0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>)&#125;;</span><br></pre></td></tr></table></figure><p>ç”± <code>void (*block)(void) = &amp;__main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA));</code> å‚ç…§ä¸Šé¢ block è¢«ç¼–è¯‘çš„å…·ä½“ç»“æ„å¯ä»¥çœ‹åˆ°ï¼Œblock è¢«ç¼–è¯‘æˆäº†ç»“æ„ä½“ <code>struct __main_block_impl_0</code>ï¼Œè€Œ <code>struct __main_block_impl_0</code> ç”±ç»“æ„ä½“ <code>struct __block_impl impl</code> å’Œ <code>struct __main_block_desc_0* Desc</code> æ„æˆï¼Œå†æ¥çœ‹ä¸‹ impl çš„ç»“æ„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ isa æŒ‡é’ˆï¼Œè€Œæœ€åä¸€ä¸ª FuncPtr æŒ‡é’ˆå°±æ˜¯æˆ‘ä»¬è°ƒç”¨ block æ—¶æ‰€è°ƒç”¨çš„ï¼š<code>block-&gt;FuncPtr(block)</code>ã€‚</p><p>ç”±ä¸Šåˆ†æå¯ä»¥å¾—å‡º block è°ƒç”¨çš„æµç¨‹ï¼š</p><ol><li>block è¢«ç¼–è¯‘æˆäº†ç»“æ„ä½“ <code>struct __main_block_impl_0</code></li><li>ç»“æ„ä½“åˆå§‹åŒ–æ—¶ä¼ é€’äº†ä¸¤ä¸ªå‚æ•°ï¼š<code>__main_block_func_0</code> å’Œ <code>&amp;__main_block_desc_0_DATA</code></li><li><code>__main_block_func_0</code> å°±æ˜¯æˆ‘ä»¬è¦å®ç°çš„ block å†…éƒ¨çš„ä»£ç (block å†…éƒ¨ä»£ç è¢«åŒ…è£…åˆ°äº†è¿™ä¸ªå‡½æ•°é‡Œé¢)</li><li><code>&amp;__main_block_desc_0_DATA</code> çš„ç»“æ„é‡Œé¢æœ‰ä¸€ä¸ª sizeï¼Œçœ‹ç»“æ„ä½“çš„åˆå§‹åŒ–èµ‹å€¼ï¼šsizeof(struct __main_block_impl_0) å¯ä»¥å¾—å‡ºï¼Œsize å­˜å‚¨çš„å°±æ˜¯æ•´ä½“ block çš„å¤§å°</li><li><code>__main_block_impl_0</code> ç»“æ„ä½“åˆå§‹åŒ–æ—¶é€šè¿‡å†…éƒ¨çš„åŒåæ„é€ å‡½æ•°å°†åŒ…è£…å¥½çš„ block å®ç°å‡½æ•° <code>__main_block_func_0</code> æŒ‡é’ˆå’Œç»“æ„ä½“ <code>__main_block_desc_0_DATA</code> çš„åœ°å€ä¼ ç»™äº† <code>__main_block_impl_0</code> ç›¸å…³çš„å€¼</li><li><code>__block_impl</code> é‡Œé¢çš„ FuncPtr å­˜å‚¨çš„å°±æ˜¯ block å†…å­˜ä»£ç è¢«åŒ…è£…çš„å‡½æ•°æŒ‡é’ˆ</li><li>block è°ƒç”¨æœ€ç»ˆå°±æ˜¯é€šè¿‡ <code>void (*block)(void)</code> block æŒ‡é’ˆè°ƒç”¨ FuncPtr å‡½æ•°ï¼š<code>block-&gt;FuncPtr(block)</code></li></ol><p>é€šè¿‡ struct __block_impl é‡Œé¢çš„ isa æŒ‡é’ˆå¯ä»¥æƒ³åˆ° block å¯èƒ½æ˜¯ä¸€ä¸ª OC å¯¹è±¡ï¼Œä¸‹é¢æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">NSLog</span>(@<span class="string">"%@ - %@ - %@ - %@"</span>,</span><br><span class="line">              </span><br><span class="line">              [block class],</span><br><span class="line">              [[block superclass] class],</span><br><span class="line">              [[[block superclass] superclass] class],</span><br><span class="line">              [[[[block superclass] superclass] superclass] class]);</span><br></pre></td></tr></table></figure></p><p>è¾“å‡ºç»“æœ</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__NSGlobalBlock__ - __NSGlobalBlock - <span class="built_in">NSBlock</span> - <span class="built_in">NSObject</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œblock æœ€ç»ˆçš„ superclass å°±æ˜¯ç»§æ‰¿è‡ª NSObjectï¼Œæ‰€ä»¥ block å°±æ˜¯ä¸€ä¸ª OC å¯¹è±¡ã€‚</p><h4 id="ç»¼åˆä¸Šå¾—å‡ºï¼š"><a href="#ç»¼åˆä¸Šå¾—å‡ºï¼š" class="headerlink" title="ç»¼åˆä¸Šå¾—å‡ºï¼š"></a>ç»¼åˆä¸Šå¾—å‡ºï¼š</h4><blockquote><p>block å°±æ˜¯å°è£…äº†å‡½æ•°è°ƒç”¨å’Œå‡½æ•°è°ƒç”¨ç¯å¢ƒçš„ OC å¯¹è±¡</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;br&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;æœ€è¿‘åœ¨åšä¸šåŠ¡æ—¶ï¼Œå¯è°“ä¸€æ­¥ä¸€ä¸ªå‘ï¼Œæ‰€ä»¥å›è¿‡å¤´æ¥è¡¥å……ä¸‹æœ€åŸºç¡€çš„åŸç†çŸ¥è¯†ã€‚&lt;br&gt;PSï¼šåŸºç¡€å¥½æ‰æ˜¯çœŸçš„å¥½ï¼ï¼ï¼&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="block" scheme="http://yoursite.com/tags/block/"/>
    
  </entry>
  
  <entry>
    <title>2018æ€»ç»“-2019è®¡åˆ’</title>
    <link href="http://yoursite.com/2019/01/22/2018%E6%80%BB%E7%BB%93-2019%E8%AE%A1%E5%88%92/"/>
    <id>http://yoursite.com/2019/01/22/2018æ€»ç»“-2019è®¡åˆ’/</id>
    <published>2019-01-22T07:31:50.000Z</published>
    <updated>2020-08-15T14:23:23.201Z</updated>
    
    <content type="html"><![CDATA[<h3 id="2018æ€»ç»“"><a href="#2018æ€»ç»“" class="headerlink" title="2018æ€»ç»“"></a>2018æ€»ç»“</h3><p>ä¸å¹³å‡¡çš„2018ï¼Œå¾ˆæ— å¥ˆçš„æ¢äº†å››ä»½å·¥ä½œï¼Œæœ€è¿‘ä¹Ÿåœ¨æƒ³åŸå› ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š</p><ul><li>æŠ€æœ¯ä¸å¤Ÿç¡¬</li><li>å¤„ä¸–ä¸å¤Ÿåœ†æ»‘</li><li>è¿æ°”ä¸å¥½</li></ul><p>æ€ä¹ˆä¼šè¯´è¿æ°”å‘¢ï¼Ÿä¸ªäººæ€§æ ¼æ˜¯é‚£ç§å®å¹²è¡Œçš„ï¼Œæœ‰ä»€ä¹ˆäº‹éƒ½ä¼šæ¯”è¾ƒè´Ÿè´£çš„å»å®Œæˆï¼Œä½†æ˜¯åœ¨æ¸£æµªå¥½åƒåˆ·æ–°äº†æˆ‘çš„ä¸‰è§‚ï¼Œå°±æ˜¯ä¸åˆé€‚å§ï¼Œæ¢ä¸ªç¯å¢ƒä¹Ÿè®¸ä¸æ˜¯åäº‹ã€‚</p><p>æ–­æ–­ç»­ç»­çš„å†™äº†å‡ ç¯‡æŠ€æœ¯åšå®¢ï¼Œç®—æ˜¯ç¬”è®°å§ï¼Œåœ¨æ¸£æµªç¡®å®æ˜¯å¤ªæ”¾æ¾äº†ï¼Œä¸Šç­å¼€å°å·®ä¸‹ç­å„ç§ç©ï¼Œæ¥ä¸‹æ¥åº”è¯¥æ”¹å˜ä¸€ä¸‹äº†ï¼Œç»§ç»­å†™åšå®¢è®°ç¬”è®°ã€‚</p><p>åšæŒæ˜¯2018ä¸€ç‚¹éƒ½æ²¡æœ‰åšä¸‹å»çš„ï¼Œè·‘æ­¥ã€çœ‹ä¹¦ã€ç”µå­ç´ã€åšå®¢â€¦ ä¸€ä»¶ä¹Ÿæ²¡æœ‰åšæŒä¸‹å»ï¼Œæ¥ä¸‹æ¥æ€ä¹ˆåŠå¿ƒé‡Œæ²¡ç‚¹æ•°å—(~~)ã€‚</p><p>ä»¥å‰æ€»è§‰å¾—è‡ªå·±è¿˜å°ï¼Œæœ‰ä»€ä¹ˆäº‹éƒ½å¯ä»¥äº¤ç»™è€çˆ¸è€å¦ˆï¼Œ2018ä¹‹åä¸ä¼šå†æœ‰è¿™ç§æƒ³æ³•äº†ï¼Œå‘ä»€ä¹ˆå¥½å¤šäº‹ï¼Œçªç„¶å‘ç°åŸæ¥è€çˆ¸è€å¦ˆçœŸçš„è€äº†ï¼Œæœ‰äº›äº‹éœ€è¦è‡ªå·±æˆç†Ÿç‚¹è®¤çœŸå¯¹å¾…äº†ã€‚</p><p>å°±åœ¨åˆšåˆšå†™åˆ°ä¸€åŠæ¥åˆ°äº†ç¦»èŒç”³è¯·çš„é€šè¿‡é€šçŸ¥ï¼Œä¸çŸ¥å’‹åœ°_å¦‚é‡Šé‡è´Ÿã€‚æ¥æ¸£æµª6ä¸ªæœˆå‹¤å‹¤æ³æ³çš„å·¥ä½œï¼Œæœ€åæ˜¯è¿™æ ·çš„ç»“æœæœ‰è§‰å¾—æœ‰ç‚¹ä¸ç”˜ï¼Œæˆ–è€…è¯´æœ‰ç‚¹ä¸å€¼å¾—ï¼Œæ€»ä¹‹ä»¥åå†æ²¡äº¤é›†ï¼Œæ­¤åˆ»å¾ˆæƒ³å¤§å–Šä¸€å¥ï¼šæ¸£æµª~ä¸€ç”Ÿé»‘~~æ‹œæ‹œ~</p><h4 id="2018æœ€å¤§çš„æ”¶è·"><a href="#2018æœ€å¤§çš„æ”¶è·" class="headerlink" title="2018æœ€å¤§çš„æ”¶è·"></a>2018æœ€å¤§çš„æ”¶è·</h4><p>2018.5.20å¾ˆç‰¹åˆ«çš„ä¸€å¤©ï¼Œæƒ³å¥½å„ç§å§¿åŠ¿è¡¨ç™½ï¼Œæ²¡æƒ³åˆ°æœ€åæ†‹äº†åŠå¤©å°±è¹¦å‡ºä¸€å¥åšæˆ‘å¥³æœ‹å‹å§ï¼ŒçœŸæƒ³è¯´å½“æ—¶çœŸæ˜¯æ€‚çš„ä¸€æ‰¹ï¼Œæœ‰ç‚¹é—æ†¾æ²¡æœ‰ç»™å¥¹ä¸€ä¸ªéš†é‡çš„æœ€èµ·ç æ­£å¼çš„è¡¨ç™½(å½“æ—¶çœŸçš„å¾ˆæ€‚~å¾ˆæ€‚~æ€‚)â€¦</p><p>è·Ÿå¥¹çš„ä¼‘æ¯æ—¶é—´æœ‰ç‚¹ä¸å¤ªæ­ï¼Œåªèƒ½é€‰æ‹©å‘¨æœ«ç­‰å¥¹ä¸‹ç­ï¼Œä½†æ˜¯æ¯å‘¨ç­‰çš„æ—¶å€™å°±æ˜¯æœ€æœŸå¾…çš„äº‹æƒ…å§(\^\^)ï¼Œæ¯æ¬¡åœ¨åœ°é“é‡Œé¢çš„äººç¾¤ä¸­çœ‹åˆ°å¥¹ï¼ŒçœŸçš„ï¼Œåªæœ‰å¥¹ï¼Œå‘¨å›´çš„äººè‡ªåŠ¨æ‰“ä¸Šäº†é©¬èµ›å…‹ï¼Œè¿™å°±æ˜¯å–œæ¬¢å§ï¼Œå¿ƒè·³ç °ç °ç °ï¼Œè¿˜å¥½ç°åœ¨ä¸ä¼šè„¸çº¢äº†ï¼Œå˜¿å˜¿ã€‚2018ä¸€èµ·å»äº†èœ¡åƒé¦†ã€å°çŒªæ¼”å”±ä¼šã€è¿ªå£«å°¼ã€å¤–æ»©â€¦ï¼Œå¸Œæœ›2019èƒ½è·Ÿå¥¹ç»§ç»­å‰è¡Œï¼Œæ­¤ç”Ÿ~å”¯ä¸€ï¼</p><h3 id="2019è®¡åˆ’"><a href="#2019è®¡åˆ’" class="headerlink" title="2019è®¡åˆ’"></a>2019è®¡åˆ’</h3><p>åå¤©å»é˜…æ–‡ï¼Œé‡æ–°å¼€å§‹ï¼Œè¿™æ¬¡ä¸å†é¢“åºŸï¼Œä¸å†è¿·èŒ«ï¼Œä»¥å‰æ€»æ„Ÿè§‰æ˜¯å°å­©åªæœ‰è‡ªå·±ï¼Œç°åœ¨ä¸ä»…æœ‰è‡ªå·±è¿˜æœ‰å¥¹ï¼Œè¿˜æœ‰è€çˆ¸è€å¦ˆï¼Œä»¥åæœ‰ä»€ä¹ˆäº‹æˆ‘æ¥æ‰›ä¸‹ã€‚</p><h4 id="å­¦ä¹ è®¡åˆ’"><a href="#å­¦ä¹ è®¡åˆ’" class="headerlink" title="å­¦ä¹ è®¡åˆ’"></a>å­¦ä¹ è®¡åˆ’</h4><ul><li>iOSåº•å±‚åŸç†åšå®¢åˆ†æç¬”è®°</li><li>ocä¹‹å¤–çš„è¯­è¨€å­¦ä¹ </li><li>çœ‹å®Œ8æœ¬ä¹¦(éšæ—¶åšç¬”è®°)</li><li>ç»§ç»­ç”µå­ç´</li><li>è·Ÿå¥¹å­¦ç”»ç”»(\(\^o\^)/~)</li></ul><h4 id="è¿åŠ¨"><a href="#è¿åŠ¨" class="headerlink" title="è¿åŠ¨"></a>è¿åŠ¨</h4><ul><li>800å…¬é‡Œ (å»å¹´çš„1000ä¸€ç‚¹æ²¡è·‘ï¼Œä»Šå¹´ç†æ€§800ï¼ŒæŒ‰ä¸€å¤©5å…¬é‡Œè®¡ç®—ï¼Œç•™å‡ºå·æ‡’æ—¶é—´)</li><li>ä¸¤æ¬¡åŠç¨‹é©¬æ‹‰æ¾ï¼ˆæœ‰æœºä¼šå®Œæˆçº¿ä¸Šçš„èµ›ç¨‹ï¼‰</li><li>å¸¦ä¸Šå¥¹é”»ç‚¼é”»ç‚¼ï¼ˆçˆ¬å±±ã€è·‘æ­¥ã€é€›å…¬å›­ï¼‰</li></ul><h4 id="å·¥ä½œ"><a href="#å·¥ä½œ" class="headerlink" title="å·¥ä½œ"></a>å·¥ä½œ</h4><p>åŠªåŠ›åŠªåŠ›å†åŠªåŠ›</p><h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><ul><li>è·Ÿå¥¹å‡ºå»æ—…æ¸¸å‡ æ¬¡</li><li>å‚¬è€çˆ¸è€å¦ˆå„ç§é”»ç‚¼</li><li>äº†è§£ä¸€äº›æ•™è‚²ç›¸å…³çš„çŸ¥è¯†ï¼ˆå°†æ¥å¼€å­¦æ ¡æ˜¯è¦è·Ÿè€æ¿å¨˜æ··çš„ï¼Œå˜¿å˜¿ï¼Œå…ˆåšå¥½åŠŸè¯¾ï¼‰</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;2018æ€»ç»“&quot;&gt;&lt;a href=&quot;#2018æ€»ç»“&quot; class=&quot;headerlink&quot; title=&quot;2018æ€»ç»“&quot;&gt;&lt;/a&gt;2018æ€»ç»“&lt;/h3&gt;&lt;p&gt;ä¸å¹³å‡¡çš„2018ï¼Œå¾ˆæ— å¥ˆçš„æ¢äº†å››ä»½å·¥ä½œï¼Œæœ€è¿‘ä¹Ÿåœ¨æƒ³åŸå› ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŠ€æœ¯ä¸å¤Ÿç¡¬&lt;/
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>blockåŸç†ç„¶å°±-3</title>
    <link href="http://yoursite.com/2019/01/14/block%E5%8E%9F%E7%90%86%E7%84%B6%E5%B0%B1-3/"/>
    <id>http://yoursite.com/2019/01/14/blockåŸç†ç„¶å°±-3/</id>
    <published>2019-01-14T11:49:18.000Z</published>
    <updated>2020-08-15T14:27:37.901Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><p>æµ‹è¯•</p><h3 id="block-åº•å±‚æ•°æ®ç»“æ„"><a href="#block-åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="block åº•å±‚æ•°æ®ç»“æ„"></a>block åº•å±‚æ•°æ®ç»“æ„</h3><p>æµ‹è¯•ä»£ç :</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="meta">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">            NSLog(@<span class="string">"block1234"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        block();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;p&gt;æµ‹è¯•&lt;/p&gt;
&lt;h3 id=&quot;block-åº•å±‚æ•°æ®ç»“æ„&quot;&gt;&lt;a href=&quot;#block-åº•å±‚æ•°æ®ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;block åº•å±‚æ•°æ®ç»“æ„&quot;&gt;&lt;/a&gt;block åº•å±‚æ•°æ®ç»“æ„&lt;/h3&gt;&lt;p&gt;æµ‹è¯•
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>blockåŸç†æ¢ç©¶-2</title>
    <link href="http://yoursite.com/2019/01/14/block%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-2/"/>
    <id>http://yoursite.com/2019/01/14/blockåŸç†æ¢ç©¶-2/</id>
    <published>2019-01-14T11:25:32.000Z</published>
    <updated>2020-08-15T14:27:46.075Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h3 id="blockçš„ç±»å‹"><a href="#blockçš„ç±»å‹" class="headerlink" title="blockçš„ç±»å‹"></a>blockçš„ç±»å‹</h3><p>å…ˆæ¥çœ‹ä¸€ä¸‹æµ‹è¯•:</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (^block1)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"block1--- %d  %d  %d"</span>, age, height, weight);</span><br><span class="line">&#125;;</span><br><span class="line">        </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@  %@  %@  %@"</span>, [block1 <span class="keyword">class</span>], [[block1 <span class="keyword">class</span>] superclass], [[[block1 <span class="keyword">class</span>] superclass] superclass], [[[[block1 <span class="keyword">class</span>] superclass] superclass] superclass]);</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœ:</span><br><span class="line">__NSMallocBlock__  __NSMallocBlock  <span class="built_in">NSBlock</span>  <span class="built_in">NSObject</span></span><br></pre></td></tr></table></figure><p>blockç¡®å®æ˜¯å¯¹è±¡,ç»§æ‰¿å…³ç³»:</p><blockquote><p>__NSMallocBlock__ : __NSMallocBlock : NSBlock : NSObject</p></blockquote><p>åº”ç”¨ç¨‹åºçš„å†…å­˜åˆ†é…å…³ç³»ä¸ºï¼š</p><p><code>ç¨‹åºåŒº</code> â€“&gt; <code>æ•°æ®åŒº</code>     â€“&gt; <code>å †åŒº</code> â€“&gt; <code>æ ˆåŒº</code><br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-&gt;</p><p>blockç±»å‹åˆ†ä¸ºä¸‰ç§:</p><blockquote><p>__NSGlobalBlock__     (æ²¡æœ‰è®¿é—® auto å˜é‡ â€“ <code>æ•°æ®åŒº</code> â€“ copy:æ— æ“ä½œ)<br>__NSStackBlock__  (è®¿é—®äº† auto å˜é‡ â€“ <code>æ ˆåŒº</code> â€“ copy:ç”±æ ˆå¤åˆ¶åˆ°å †)<br>__NSMallocBlock__     (<strong>NSStackBlock</strong>è°ƒç”¨äº†copy â€“ <code>å †åŒº</code> â€“ copy:å¼•ç”¨è®¡æ•°å¢åŠ )</p></blockquote><h3 id="æ€»ç»“ä¸‹blockçš„copy"><a href="#æ€»ç»“ä¸‹blockçš„copy" class="headerlink" title="æ€»ç»“ä¸‹blockçš„copy"></a>æ€»ç»“ä¸‹blockçš„copy</h3><h4 id="1ã€ARCç¯å¢ƒä¸‹"><a href="#1ã€ARCç¯å¢ƒä¸‹" class="headerlink" title="1ã€ARCç¯å¢ƒä¸‹"></a>1ã€ARCç¯å¢ƒä¸‹</h4><p>åœ¨ARCç¯å¢ƒä¸‹ç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼š</p><ul><li>blockä½œä¸ºå‡½æ•°è¿”å›å€¼</li><li>å°†blockèµ‹å€¼ç»™__strongæŒ‡é’ˆ</li><li>blockä½œä¸ºCocoa APIä¸­çš„æ–¹æ³•åå«æœ‰usingBlockçš„æ–¹æ³•å‚æ•°æ—¶</li><li>blockä½œä¸ºGCD APIçš„æ–¹æ³•å‚æ•°æ—¶ </li></ul><h4 id="2ã€blockä½œä¸ºå±æ€§çš„å†™æ³•-ä¿®é¥°"><a href="#2ã€blockä½œä¸ºå±æ€§çš„å†™æ³•-ä¿®é¥°" class="headerlink" title="2ã€blockä½œä¸ºå±æ€§çš„å†™æ³• (ä¿®é¥°)"></a>2ã€blockä½œä¸ºå±æ€§çš„å†™æ³• (ä¿®é¥°)</h4><ul><li>ARC ï¼šstrong/copy</li><li>MRC ï¼šcopy</li></ul><h3 id="è¡¥å……ï¼šå¯¹è±¡ç±»å‹çš„AUTOå˜é‡"><a href="#è¡¥å……ï¼šå¯¹è±¡ç±»å‹çš„AUTOå˜é‡" class="headerlink" title="è¡¥å……ï¼šå¯¹è±¡ç±»å‹çš„AUTOå˜é‡"></a>è¡¥å……ï¼šå¯¹è±¡ç±»å‹çš„AUTOå˜é‡</h3><p>å½“blockå†…éƒ¨è®¿é—®äº†å¯¹è±¡ç±»å‹çš„autoå˜é‡æ—¶ï¼š</p><p>1ã€ å¦‚æœblockåœ¨æ ˆä¸Šï¼Œä¸ä¼šå¯¹autoå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨<br>2ã€ å¦‚æœblockè¢«æ‹·è´åˆ°å †ä¸Šä¼šè°ƒç”¨blockçš„copyå‡½æ•°</p><ul><li>copyå‡½æ•°è°ƒç”¨_Block_object_assign</li><li>_Block_object_assignå‡½æ•°ä¼šæ ¹æ®autoå˜é‡çš„ä¿®é¥°ç¬¦ (__strongã€<strong>weakã€</strong>unsafe_unretained)åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨æˆ–å¼±å¼•ç”¨</li></ul><p>3ã€å¦‚æœblockä»å †ä¸Šç§»é™¤ä¼šè°ƒç”¨disposeå‡½æ•°</p><ul><li>disposeå‡½æ•°ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°</li><li>_Block_object_disposeä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„autoå˜é‡(release)</li></ul><h4 id="clangå‘½ä»¤æ— æ³•æ”¯æŒ-weakçš„é—®é¢˜"><a href="#clangå‘½ä»¤æ— æ³•æ”¯æŒ-weakçš„é—®é¢˜" class="headerlink" title="clangå‘½ä»¤æ— æ³•æ”¯æŒ__weakçš„é—®é¢˜"></a>clangå‘½ä»¤æ— æ³•æ”¯æŒ__weakçš„é—®é¢˜</h4><p>åœ¨ä½¿ç”¨clangè½¬æ¢OCä¸ºC++æ—¶ï¼Œé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š<br>cannot create __weak refrence in file using manual refrence</p><p>è§£å†³ï¼šæ”¯æŒARCã€æŒ‡å®šè¿è¡Œæ—¶ç³»ç»Ÿç‰ˆæœ¬ï¼š<br>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-8.0.0 main.m</p><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^Block)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        Block block;</span><br><span class="line">        </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NSObject</span> * obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">            </span><br><span class="line">            __<span class="keyword">weak</span> <span class="keyword">typeof</span>(obj) weakObj = obj;</span><br><span class="line">            </span><br><span class="line">            block = [^&#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"---- %@"</span>, weakObj);</span><br><span class="line">            &#125; <span class="keyword">copy</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        block();</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"------"</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¬æ¢C++ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__block_impl</span></span> <span class="keyword">impl</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span>* Desc;</span><br><span class="line">  NSObject *__weak weakObj;<span class="comment">// ä¸ºæ•è·åˆ°çš„å¯¹è±¡autoå˜é‡</span></span><br><span class="line">  __main_block_impl_0(void *fp, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> *desc, NSObject *__weak _weakObj, int flags=<span class="number">0</span>) : weakObj(_weakObj) &#123;</span><br><span class="line">    <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    <span class="keyword">impl</span>.Flags = flags;</span><br><span class="line">    <span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> void __main_block_func_0(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> *__cself) &#123;</span><br><span class="line">  NSObject *__weak weakObj = __cself-&gt;weakObj; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">                NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_lw_6z_mkyd178q8n6w9m1vqbk9w0000gn_T_main_5e91db_mi_0, weakObj);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="keyword">static</span> void __main_block_copy_0(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*dst, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*src) &#123;</span><br><span class="line">    </span><br><span class="line">    _Block_object_assign((void*)&amp;dst-&gt;weakObj, (void*)src-&gt;weakObj, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> void __main_block_dispose_0(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*src) &#123;</span><br><span class="line">    </span><br><span class="line">    _Block_object_dispose((void*)src-&gt;weakObj, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¤šå‡ºä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°  copyã€dispose</span></span><br><span class="line">  void (*copy)(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*);</span><br><span class="line">  void (*dispose)(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>*);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;blockçš„ç±»å‹&quot;&gt;&lt;a href=&quot;#blockçš„ç±»å‹&quot; class=&quot;headerlink&quot; title=&quot;blockçš„ç±»å‹&quot;&gt;&lt;/a&gt;blockçš„ç±»å‹&lt;/h3&gt;&lt;p&gt;å…ˆæ¥çœ‹ä¸€ä¸‹æµ‹è¯•:&lt;/p&gt;
&lt;figure class=&quot;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>blockåŸç†æ¢ç©¶-1</title>
    <link href="http://yoursite.com/2018/07/25/block%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-1/"/>
    <id>http://yoursite.com/2018/07/25/blockåŸç†æ¢ç©¶-1/</id>
    <published>2018-07-25T05:26:21.000Z</published>
    <updated>2020-08-15T14:27:42.132Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h3 id="block-åº•å±‚æ•°æ®ç»“æ„"><a href="#block-åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="block åº•å±‚æ•°æ®ç»“æ„"></a>block åº•å±‚æ•°æ®ç»“æ„</h3><p>æµ‹è¯•ä»£ç :</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="meta">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">            NSLog(@<span class="string">"block1234"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        block();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ <code>clang</code> ç¼–è¯‘æŸ¥çœ‹ .cpp æ–‡ä»¶, çœ‹blockè¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆ:</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void (<span class="name">*block</span>)(<span class="name">void</span>) = ((<span class="name">void</span> (<span class="name">*</span>)())<span class="symbol">&amp;__main_block_impl_0</span>((<span class="name">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line"></span><br><span class="line">((void (*)(<span class="name">__block_impl</span> *))((__block_impl *)block)-&gt;FuncPtr)((<span class="name">__block_impl</span> *)block);</span><br><span class="line"></span><br><span class="line">å»æ‰ä¸Šé¢çš„å¼ºåˆ¶ç±»å‹è½¬æ¢å¦‚ä¸‹:</span><br><span class="line">void (*block)(<span class="name">void</span>) = <span class="symbol">&amp;__main_block_impl_0</span>(<span class="name">__main_block_func_0</span>, <span class="symbol">&amp;__main_block_desc_0_DATA</span>))<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">block-&gt;FuncPtr(<span class="name">block</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆblockçš„è°ƒç”¨å°±æ˜¯ <code>block-&gt;FuncPtr(block);</code> , å°±æ˜¯è°ƒç”¨å‡½æ•°</p><p>çœ‹ä¸€ä¸‹blockçš„ <code>__main_block_impl_0</code> çš„ç»“æ„:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__block_impl</span></span> &#123;</span><br><span class="line">  void *isa;</span><br><span class="line">  int Flags;</span><br><span class="line">  int Reserved;</span><br><span class="line">  void *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__block_impl</span></span> <span class="keyword">impl</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span>* Desc;</span><br><span class="line">  __main_block_impl_0(void *fp, <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> *desc, int flags=<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    <span class="keyword">impl</span>.Flags = flags;</span><br><span class="line">    <span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> void __main_block_func_0(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span> *__cself) &#123;</span><br><span class="line"></span><br><span class="line">           NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_y5_bv8t9pxx6jg830_kh4l6p_800000gn_T_main_fc5269_mi_0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">__main_block_desc_0</span></span> &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">__main_block_impl_0</span></span>)&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°blockå…¶å®å°±æ˜¯ä¸€ä¸ªç»“æ„ä½“,å†ä»”ç»†çœ‹ä¸€ä¸‹è¿˜æœ‰isaæŒ‡é’ˆ,æ˜¯ä¸æ˜¯è·Ÿæˆ‘ä»¬å‰é¢è®²åˆ°çš„å¯¹è±¡ä¸€æ ·,æ‰€ä»¥blockä¹Ÿæ˜¯OCçš„å¯¹è±¡,é‡Œé¢æœ‰ <code>struct __block_impl impl;</code> å’Œ <code>struct __main_block_desc_0* Desc;</code> ç»“æ„, è€Œ <code>__block_impl</code> é‡Œé¢æœ‰isaæŒ‡é’ˆå’Œ <code>void *FuncPtr;</code> ,ä¸è¿‡ç»“æ„ä½“é‡Œé¢æœ‰æ„é€ å‡½æ•° <code>__main_block_impl_0</code> .</p><p>å¯ä»¥åˆ†æblockåœ¨ç¼–è¯‘çš„æ—¶å€™æ˜¯è¿™æ ·çš„: æ ¹æ®blocké‡Œé¢çš„å®ç°å…ˆç”Ÿæˆä¸€ä¸ªå‡½æ•° <code>__main_block_func_0</code> ,ç„¶åæ¥ç€ç”Ÿæˆä¸€ä¸ª <code>__main_block_impl_0</code> ç±»å‹çš„ç»“æ„ä½“,å°†ç”Ÿæˆçš„å‡½æ•°æŒ‡é’ˆå’Œ <code>__main_block_desc_0</code> ä¼ å…¥å¹¶è°ƒç”¨æ„é€ å‡½æ•°åˆå§‹åŒ–block,è¿™æ ·blockçš„ç»“æ„å°±ç”Ÿæˆäº†.<br>å½“æˆ‘ä»¬è°ƒç”¨blockæ—¶å…¶å®å°±æ˜¯æ ¹æ® <code>__block_impl</code> æŸ¥æ‰¾å‡½æ•°æŒ‡é’ˆ <code>void *FuncPtr</code> ,ç„¶åè°ƒç”¨å¯¹åº”çš„å‡½æ•°çš„è¿‡ç¨‹.</p><h3 id="block-å˜é‡çš„æ•è·"><a href="#block-å˜é‡çš„æ•è·" class="headerlink" title="block å˜é‡çš„æ•è·"></a>block å˜é‡çš„æ•è·</h3><p>æˆ‘ä»¬æ¥é’ˆå¯¹ä¸‰ç§æ–¹å¼æ¥æµ‹è¯•:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1.å…¨å±€å˜é‡ --&gt;</span></span><br><span class="line">int weight = 10;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        <span class="comment">&lt;!-- 2.å±€éƒ¨å˜é‡ autoä¿®é¥°(é»˜è®¤å€¼) --&gt;</span></span><br><span class="line">        auto int age = 10;</span><br><span class="line">        <span class="comment">&lt;!-- 3.å±€éƒ¨å˜é‡ staticä¿®é¥° --&gt;</span></span><br><span class="line">        static int height = 10;</span><br><span class="line">        </span><br><span class="line">        void (^block1)(void) = ^&#123;</span><br><span class="line">            NSLog(@"block1--- %d  %d  %d", age, height, weight);</span><br><span class="line">        &#125;;</span><br><span class="line">        age = 20;</span><br><span class="line">        height = 20;</span><br><span class="line">        weight = 20;</span><br><span class="line">        </span><br><span class="line">        block1();</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡æ–°ç”¨clangç¼–è¯‘æŸ¥çœ‹ç»“æœ:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> weight = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  <span class="keyword">int</span> age;</span><br><span class="line">  <span class="keyword">int</span> *height;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> _age, <span class="keyword">int</span> *_height, <span class="keyword">int</span> flags=<span class="number">0</span>) : age(_age), height(_height) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="keyword">int</span> age = __cself-&gt;age; <span class="comment">// bound by copy</span></span><br><span class="line">  <span class="keyword">int</span> *height = __cself-&gt;height; <span class="comment">// bound by copy</span></span><br><span class="line"></span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_k8_chp8jt5d231d16l0s6w3c_gh0000gn_T_main_53994b_mi_0, age, (*height), weight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> <span class="keyword">int</span> age = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> height = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> (*block1)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, age, &amp;height));</span><br><span class="line"></span><br><span class="line">        age = <span class="number">20</span>;</span><br><span class="line">        height = <span class="number">20</span>;</span><br><span class="line">        weight = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">        ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)block1)-&gt;FuncPtr)((__block_impl *)block1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°blocké‡Œé¢åªæ•æ‰åˆ°äº†å±€éƒ¨å˜é‡,è€Œä¸”æ•æ‰åˆ°çš„å±€éƒ¨å˜é‡çš„ç±»å‹ä¸ä¸€æ ·, <code>auto</code> ç±»å‹çš„ä¸ºå€¼ä¼ é€’,è€Œ <code>static</code> ç±»å‹çš„ä¸ºæŒ‡é’ˆä¼ é€’.å…¨å±€å˜é‡ç±»å‹çš„ä¸ºç›´æ¥è®¿é—®.</p><blockquote><p>blockèƒ½æ•è·åˆ°å±€éƒ¨å˜é‡,ä¸èƒ½æ•è·åˆ°å…¨å±€å˜é‡.</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;block-åº•å±‚æ•°æ®ç»“æ„&quot;&gt;&lt;a href=&quot;#block-åº•å±‚æ•°æ®ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;block åº•å±‚æ•°æ®ç»“æ„&quot;&gt;&lt;/a&gt;block åº•å±‚æ•°æ®ç»“æ„&lt;/h3&gt;&lt;p&gt;æµ‹è¯•ä»£ç :&lt;/p&gt;
&lt;f
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>categoryåŸç†æ¢ç©¶-3</title>
    <link href="http://yoursite.com/2018/07/22/category%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-3/"/>
    <id>http://yoursite.com/2018/07/22/categoryåŸç†æ¢ç©¶-3/</id>
    <published>2018-07-22T10:40:53.000Z</published>
    <updated>2020-08-15T14:28:27.126Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å…³è”å¯¹è±¡çš„ä½¿ç”¨"><a href="#å…³è”å¯¹è±¡çš„ä½¿ç”¨" class="headerlink" title="å…³è”å¯¹è±¡çš„ä½¿ç”¨"></a>å…³è”å¯¹è±¡çš„ä½¿ç”¨</h3><a id="more"></a><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> Animal (Eat)</span><br><span class="line"><span class="variable">@property</span> (nonatomic, copy) NSString * name;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@implementation</span> Animal (Eat)</span><br><span class="line">- (void)<span class="attribute">setName</span>:(NSString *)name &#123;</span><br><span class="line">    <span class="selector-tag">objc_setAssociatedObject</span>(self, <span class="variable">@selector</span>(name), name, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (NSString *)<span class="selector-tag">name</span> &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">objc_getAssociatedObject</span>(self, _cmd);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure><p><code>keyå€¼å‡ ç§ä½¿ç”¨æ–¹æ³•</code></p><blockquote><p>1.static void *AnimalKey = &AnimalKey;<br>2.static char AnimalKey;<br>3.ä½¿ç”¨å±æ€§åä½œä¸ºkey;<br>4.ä½¿ç”¨getæ–¹æ³•çš„@selectorä½œä¸ºkey;</p></blockquote><h3 id="å…³è”å¯¹è±¡çš„æºç è§£è¯»"><a href="#å…³è”å¯¹è±¡çš„æºç è§£è¯»" class="headerlink" title="å…³è”å¯¹è±¡çš„æºç è§£è¯»"></a>å…³è”å¯¹è±¡çš„æºç è§£è¯»</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">void _object_set_associative_reference(<span class="name">id</span> object, void *key, id value, uintptr_t policy) &#123;</span><br><span class="line">    /**</span><br><span class="line">    * retain the new value (<span class="name">if</span> any) outside the lock.</span><br><span class="line">    * ç”¨æ¥è®°å½•åŸæœ‰å…³è”å€¼çš„å˜é‡</span><br><span class="line">    */ </span><br><span class="line">    ObjcAssociation old_association(<span class="number">0</span>, <span class="literal">nil</span>)<span class="comment">;</span></span><br><span class="line">    id new_value = value ? acquireValue(<span class="name">value</span>, policy) : <span class="literal">nil</span><span class="comment">;</span></span><br><span class="line">    &#123;</span><br><span class="line">        /**</span><br><span class="line">        * å…¨å±€çš„manager</span><br><span class="line">        */    </span><br><span class="line">        AssociationsManager manager<span class="comment">;</span></span><br><span class="line">        /**</span><br><span class="line">        * è·å– AssociationsHashMap</span><br><span class="line">        */</span><br><span class="line">        AssociationsHashMap <span class="symbol">&amp;associations</span>(<span class="name">manager</span>.associations())<span class="comment">;</span></span><br><span class="line">        /**</span><br><span class="line">        * æ ¹æ® object è·å–disguised_ptr_t</span><br><span class="line">        */</span><br><span class="line">        disguised_ptr_t disguised_object = DISGUISE(<span class="name">object</span>)<span class="comment">;</span></span><br><span class="line">        if (<span class="name">new_value</span>) &#123;</span><br><span class="line">            /**</span><br><span class="line">            * break any existing association.</span><br><span class="line">            * æ ¹æ® disguised_ptr_t æ‰¾åˆ°å¯¹åº”çš„AssociationsHashMap</span><br><span class="line">            */ </span><br><span class="line">            AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">            /**</span><br><span class="line">            * å¦‚æœæ‰¾åˆ°äº†AssociationsHashMap åˆ™å–å‡ºé‡Œé¢å¯¹åº”çš„ ObjectAssociationMaps</span><br><span class="line">            * æ ¹æ® key å–å‡ºObjectAssociationMaps é‡Œé¢çš„ObjectAssociationMap</span><br><span class="line">            */</span><br><span class="line">            if (<span class="name">i</span> != associations.end()) &#123;</span><br><span class="line">                // secondary table exists</span><br><span class="line">                ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">                ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">                /**</span><br><span class="line">                * å¦‚æœå­˜åœ¨keyå¯¹åº”çš„ObjectAssociationMap,åˆ™å–å‡ºé‡Œé¢çš„æ•°æ®:</span><br><span class="line">                * ObjcAssociation, å¦åˆ™æ–°å»ºObjcAssociation å¹¶å°†ObjcAssociationä»¥keyä¸ºé”®å­˜å…¥ObjectAssociationMapä¸­.</span><br><span class="line">                */</span><br><span class="line">                if (<span class="name">j</span> != refs-&gt;end()) &#123;</span><br><span class="line">                    old_association = j-&gt;second<span class="comment">;</span></span><br><span class="line">                    j-&gt;second = ObjcAssociation(<span class="name">policy</span>, new_value)<span class="comment">;</span></span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    (<span class="name">*refs</span>)[key] = ObjcAssociation(<span class="name">policy</span>, new_value)<span class="comment">;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                /**</span><br><span class="line">                * create the new association (first time).</span><br><span class="line">                * æ²¡æœ‰æ‰¾åˆ°disguised_objectå¯¹åº”çš„AssociationsHashMap,åˆ™åˆ›å»ºä¸€ä¸ªå¹¶å­˜å…¥</span><br><span class="line">                */</span><br><span class="line">                ObjectAssociationMap *refs = new ObjectAssociationMap<span class="comment">;</span></span><br><span class="line">                associations[disguised_object] = refs<span class="comment">;</span></span><br><span class="line">                (<span class="name">*refs</span>)[key] = ObjcAssociation(<span class="name">policy</span>, new_value)<span class="comment">;</span></span><br><span class="line">                object-&gt;setHasAssociatedObjects()<span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            /**</span><br><span class="line">            * setting the association to nil breaks the association.</span><br><span class="line">            * å½“è¦å­˜å…¥çš„ new_valueä¸ºç©ºæ—¶,æŸ¥æ‰¾å¯¹åº”çš„æ•°æ®ç©ºé—´,å¦‚æœæ‰¾åˆ°ç”¨old_associationè®°å½•å­˜å€¼çš„å†…å­˜,å¹¶å°†ObjectAssociationMapé‡Œé¢çš„æ•°æ®æ“¦é™¤</span><br><span class="line">            */ </span><br><span class="line">            AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">            if (i !=  associations.end()) &#123;</span><br><span class="line">                ObjectAssociationMap *refs = i-&gt;second<span class="comment">;</span></span><br><span class="line">                ObjectAssociationMap:<span class="symbol">:iterator</span> j = refs-&gt;find(<span class="name">key</span>)<span class="comment">;</span></span><br><span class="line">                if (<span class="name">j</span> != refs-&gt;end()) &#123;</span><br><span class="line">                    old_association = j-&gt;second<span class="comment">;</span></span><br><span class="line">                    refs-&gt;erase(<span class="name">j</span>)<span class="comment">;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">    * release the old value (outside of the lock).</span><br><span class="line">    * å¦‚æœold_association.hasValueçš„å€¼ä¸ä¸ºç©ºçš„è¯åˆ™é‡Šæ”¾è¿™å—å†…å­˜çš„æ•°æ®</span><br><span class="line">    */ </span><br><span class="line">    if (old_association.hasValue()) ReleaseValue()(old_association);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯å…³è”å¯¹è±¡æ—¶æ•°æ®çš„ç»“æ„.</p><p>çœ‹ä¸€ä¸‹AssociationsManagerçš„æ•°æ®ç»“æ„:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- AssociationsManager --&gt;</span></span><br><span class="line">class AssociationsManager &#123;</span><br><span class="line">    // associative references: object pointer -&gt; PtrPtrHashMap.</span><br><span class="line">    static AssociationsHashMap *_map;</span><br><span class="line">public:</span><br><span class="line">    AssociationsManager()   &#123; AssociationsManagerLock.lock(); &#125;</span><br><span class="line">    ~AssociationsManager()  &#123; AssociationsManagerLock.unlock(); &#125;</span><br><span class="line">    </span><br><span class="line">    AssociationsHashMap &amp;associations() &#123;</span><br><span class="line">        if (_map == NULL)</span><br><span class="line">            _map = new AssociationsHashMap();</span><br><span class="line">        return *_map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- AssociationsHashMap --&gt;</span></span><br><span class="line">class AssociationsHashMap : public unordered_map<span class="tag">&lt;<span class="name">disguised_ptr_t,</span> <span class="attr">ObjectAssociationMap</span> *, <span class="attr">DisguisedPointerHash</span>, <span class="attr">DisguisedPointerEqual</span>, <span class="attr">AssociationsHashMapAllocator</span>&gt;</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ObjectAssociationMap --&gt;</span></span><br><span class="line">class ObjectAssociationMap : public std::map<span class="tag">&lt;<span class="name">void</span> *, <span class="attr">ObjcAssociation</span>, <span class="attr">ObjectPointerLess</span>, <span class="attr">ObjectAssociationMapAllocator</span>&gt;</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ObjcAssociation --&gt;</span></span><br><span class="line">class ObjcAssociation &#123;</span><br><span class="line">uintptr_t _policy;</span><br><span class="line">id _value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° ObjcAssociation é‡Œé¢å­˜å‚¨çš„å°±æ˜¯æˆ‘ä»¬å­˜è´®ç›¸å…³çš„ç­–ç•¥å’Œå€¼: _policy : _value.</p><p>void objc_setAssociateObject(id object, const void *key, id value, Objc_AssociationPolicy policy);</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><blockquote><p>å…³è”å¯¹è±¡å¹¶ä¸æ˜¯å­˜å‚¨åœ¨è¢«å…³è”å¯¹è±¡æœ¬èº«å†…å­˜ä¸­<br>å…³è”å¯¹è±¡å­˜å‚¨åœ¨å…¨å±€çš„ç»Ÿä¸€çš„ä¸€ä¸ªAssociatesManagerä¸­<br>è®¾ç½®å…³è”å¯¹è±¡ä¸ºnil,å°±ç›¸å½“äºæ˜¯ç§»é™¤å…³è”å¯¹è±¡</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å…³è”å¯¹è±¡çš„ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#å…³è”å¯¹è±¡çš„ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;å…³è”å¯¹è±¡çš„ä½¿ç”¨&quot;&gt;&lt;/a&gt;å…³è”å¯¹è±¡çš„ä½¿ç”¨&lt;/h3&gt;
    
    </summary>
    
    
      <category term="category åŸç†" scheme="http://yoursite.com/tags/category-%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>categoryåŸç†æ¢ç©¶-2</title>
    <link href="http://yoursite.com/2018/07/22/category%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-2/"/>
    <id>http://yoursite.com/2018/07/22/categoryåŸç†æ¢ç©¶-2/</id>
    <published>2018-07-22T04:55:46.000Z</published>
    <updated>2020-08-15T14:28:22.319Z</updated>
    
    <content type="html"><![CDATA[<h3 id="load-æ–¹æ³•è§£æ"><a href="#load-æ–¹æ³•è§£æ" class="headerlink" title="+load æ–¹æ³•è§£æ"></a>+load æ–¹æ³•è§£æ</h3><a id="more"></a><p>åˆ†æloadæ–¹æ³•å‰å…ˆæ¥åšä¸€ä¸ªå°æµ‹éªŒï¼š</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Animal ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Animal</span></span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Animal -- load"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Dog ç±» (-&gt;superclass animal)</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Dog</span> : <span class="title">Animal</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Dog</span></span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Dog -- load"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cat ç±» (-&gt;superclass animal)</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Cat</span> : <span class="title">Animal</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Cat</span></span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Cat -- load"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Animal åˆ†ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> (<span class="title">Eat</span>)</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Animal</span> (<span class="title">Eat</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Animal (Eat) -- load"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Dog åˆ†ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Dog</span> (<span class="title">Eat</span>)</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Dog</span> (<span class="title">Eat</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Dog (Eat) -- load"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cat åˆ†ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Cat</span> (<span class="title">Eat</span>)</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Cat</span> (<span class="title">Eat</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Cat (Eat) -- load"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸‹ç¨‹åºï¼Œå‘ç°æ²¡æœ‰è°ƒç”¨è¿™äº›ç±»ä½†æ˜¯loadæ–¹æ³•éƒ½åŠ è½½äº†ï¼ŒåŠ è½½çš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">15</span><span class="selector-pseudo">:36</span><span class="selector-pseudo">:46.369503+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[11354:638134]</span> <span class="selector-tag">Animal</span> <span class="selector-tag">--</span> <span class="selector-tag">load</span></span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">15</span><span class="selector-pseudo">:36</span><span class="selector-pseudo">:46.369954+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[11354:638134]</span> <span class="selector-tag">Cat</span> <span class="selector-tag">--</span> <span class="selector-tag">load</span></span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">15</span><span class="selector-pseudo">:36</span><span class="selector-pseudo">:46.369965+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[11354:638134]</span> <span class="selector-tag">Dog</span> <span class="selector-tag">--</span> <span class="selector-tag">load</span></span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">15</span><span class="selector-pseudo">:36</span><span class="selector-pseudo">:46.369981+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[11354:638134]</span> <span class="selector-tag">Cat</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">load</span></span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">15</span><span class="selector-pseudo">:36</span><span class="selector-pseudo">:46.369996+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[11354:638134]</span> <span class="selector-tag">Dog</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">load</span></span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">15</span><span class="selector-pseudo">:36</span><span class="selector-pseudo">:46.370009+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[11354:638134]</span> <span class="selector-tag">Animal</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">load</span></span><br></pre></td></tr></table></figure><p><a href="https://jueying-xiangfeng.github.io/2018/07/21/category%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-1/" target="_blank" rel="noopener">ä¸Šä¸€ç¯‡</a>ä¸­æˆ‘ä»¬è®²åˆ°äº†categoryçš„åŸç†ï¼ŒçŒœæƒ³è¿™é‡Œçš„ç»“æœåº”è¯¥æ˜¯åªä¼šè°ƒç”¨åˆ†ç±»çš„æ–¹æ³•ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œéƒ½è°ƒç”¨äº†å‘¢ï¼Ÿè¿˜æœ‰çœ‹ä¸€ä¸‹ <code>PROJECT-&gt;TARGETS-&gt;Build Phases-&gt;Compole Source</code> çš„ç¼–è¯‘é¡ºåºï¼Œåˆ†ç±»çš„ç¼–è¯‘é¡ºåºå’Œè°ƒç”¨é¡ºåºèƒ½å¯¹ä¸Šï¼Œä½†æ˜¯catå’Œdogéƒ½åœ¨animalçš„å‰é¢ï¼Œä¸ºä»€ä¹ˆä¼šæ˜¯å…ˆè°ƒç”¨çš„animalçš„loadæ–¹æ³•å‘¢?</p><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹loadæ–¹æ³•åœ¨runtimeçš„æºç ï¼Œè€è§„çŸ©ï¼Œå…ˆä¸‹è½½runtimeæºç ï¼Œæ‰¾åˆ°å…¥å£ <code>_objc_init</code> çš„ <code>load_images</code> æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹ä¸Šé¢çš„å®˜æ–¹æ³¨è§£ï¼š<code>Process +load in the given images which are being mapped in by dyld.</code> ï¼Œå¯ä»¥å‘ç°loadæ–¹æ³•å°±æ˜¯åœ¨è¿™é‡Œé¢åŠ è½½çš„ï¼Œçœ‹æºç ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">load_images(<span class="keyword">const</span> <span class="built_in">char</span> *path __unused, <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mach_header</span></span> *mh) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å‡†å¤‡ load methods</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    prepare_load_methods((<span class="keyword">const</span> headerType *)mh);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è°ƒç”¨ load methods</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    call_load_methods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ–¹æ³•æˆ‘ä»¬æ‹¿å‡ºæ¥å•ç‹¬çœ‹ä¸€ä¸‹ï¼š</p><p><strong>a&gt;</strong> <code>prepare_load_methods</code>ï¼š</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void prepare_load_methods(<span class="name">const</span> headerType *mhdr) &#123;</span><br><span class="line">    /**</span><br><span class="line">    * åŠ è½½æ‰€æœ‰ç±»</span><br><span class="line">    */</span><br><span class="line">    classref_t *classlist = </span><br><span class="line">        _getObjc2NonlazyClassList(<span class="name">mhdr</span>, <span class="symbol">&amp;count</span>)<span class="comment">;</span></span><br><span class="line">    for (<span class="name">i</span> = <span class="number">0</span><span class="comment">; i &lt; count; i++) &#123;</span></span><br><span class="line">        /**</span><br><span class="line">        * è°ƒç”¨ class çš„ load æ–¹æ³•</span><br><span class="line">        */    </span><br><span class="line">        schedule_class_load(<span class="name">remapClass</span>(<span class="name">classlist</span>[i]))<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">    * åŠ è½½æ‰€æœ‰åˆ†ç±»</span><br><span class="line">    */</span><br><span class="line">    category_t **categorylist = _getObjc2NonlazyCategoryList(<span class="name">mhdr</span>, <span class="symbol">&amp;count</span>)<span class="comment">;</span></span><br><span class="line">    for (<span class="name">i</span> = <span class="number">0</span>ï¼› i &lt; countï¼›i++) &#123;</span><br><span class="line">        category_t *cat = categorylist[i]ï¼›</span><br><span class="line">        /**</span><br><span class="line">        * å°†categoryä¸­çš„loadæ–¹æ³•åŠ è½½åˆ°loadableçš„åˆ—è¡¨ä¸­</span><br><span class="line">        */</span><br><span class="line">        add_category_to_loadable_list(cat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæ°¸è¿œéƒ½æ˜¯å…ˆåŠ è½½ç±»çš„loadæ–¹æ³•ç„¶ååœ¨åŠ è½½åˆ†ç±»çš„loadæ–¹æ³•ï¼Œæ­£å¥½è§£é‡Šæˆ‘ä»¬ä¸Šé¢çš„å°æµ‹è¯•çš„ç»“æœï¼Œç±»çš„loadæ–¹æ³•ä¼šå…ˆä¸åˆ†ç±»è¢«è°ƒç”¨ã€‚å†æŠŠ <code>schedule_class_load</code> æ–¹æ³•æ‹¿å‡ºæ¥çœ‹ä¸€ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> void schedule_class_load(<span class="class"><span class="keyword">Class</span> <span class="title">cls</span>) </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ¤æ–­å¦‚æœå·²ç»åŠ è½½è¿‡loadæ–¹æ³•åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;data()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Ensure superclass-first ordering</span></span><br><span class="line"><span class="comment">    * è¿™é‡Œæ˜¯é€’å½’è°ƒç”¨ï¼Œä¼˜å…ˆåŠ è½½ classçš„superclassçš„loadæ–¹æ³•ï¼Œç›´åˆ°superclassä¸ºç©º</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    schedule_class_load(cls-&gt;superclass);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å°†ç±»çš„loadæ–¹æ³•åŠ è½½åˆ°loadableçš„ç±»è¡¨ä¸­</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    add_class_to_loadable_list(cls);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è®¾ç½®æ­¤ç±»çš„loadæ–¹æ³•æ ‡å¿—ä½ï¼Œè¡¨ç¤ºå·²ç»åŠ è½½è¿‡loadæ–¹æ³•</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    cls-&gt;setInfo(RW_LOADED); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„è°ƒç”¨éå¸¸å·§å¦™ï¼Œç”¨é€’å½’è°ƒç”¨ä¼˜å…ˆåŠ è½½superclassçš„loadæ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜ç™½äº†åŸæ¥åœ¨åŠ è½½ç±»çš„loadæ–¹æ³•æ—¶ä¼šä¼˜å…ˆåŠ è½½superclassçš„loadæ–¹æ³•ï¼Œåˆ°è¿™é‡Œæ˜ç™½äº†ä¸Šé¢çš„å°æµ‹éªŒä¸ºä»€ä¹ˆå…ˆå›è°ƒ animal çš„loadæ–¹æ³•äº†å—ï¼Ÿ<br>å†çœ‹ä¸€ä¸‹ <code>add_class_to_loadable_list</code> æ–¹æ³•ï¼š</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void add_class_to_loadable_list(Class cls) &#123;</span><br><span class="line">    IMP <span class="built_in">method</span>;</span><br><span class="line">    <span class="built_in">method</span> = cls-&gt;getLoadMethod();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">method</span>) <span class="built_in">return</span>;  // Don't bother <span class="keyword">if</span> cls has no +<span class="built_in">load</span> <span class="built_in">method</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è¿™é‡Œæ˜¯å°†clsçš„methodæ–¹æ³•å­˜æ”¾åˆ° loadable_classes æ•°ç»„ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">    * loadable_classes_used++ å¯ä»¥çœ‹å‡ºè¿™é‡Œæ˜¯æŒ‰ç¼–è¯‘æ—¶çš„é¡ºåºåŠ è½½çš„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    loadable_classes[loadable_classes_used].cls = cls;</span><br><span class="line">    loadable_classes[loadable_classes_used].<span class="built_in">method</span> = <span class="built_in">method</span>;</span><br><span class="line">    loadable_classes_used++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šä¸Šé¢è·å– method çš„æ—¶å€™æ˜¯è·å–çš„load method çš„ <code>IMP</code> ã€‚</p><p><code>prepare_load_methods</code> çš„åˆ†ç±»åŠ è½½çš„æ—¶å€™è°ƒç”¨çš„å°±æ˜¯ <code>add_class_to_loadable_list</code> æ–¹æ³•ï¼Œæ‰€ä»¥åˆ†ç±»çš„åŠ è½½é¡ºåºå°±æ˜¯æŒ‰ç¼–è¯‘çš„é¡ºåºåŠ è½½çš„ã€‚</p><p>åˆ°è¿™é‡Œæ‰€æœ‰çš„ç±»å’Œåˆ†ç±»çš„æ•°æ®loadå®Œæ¯•ï¼Œå¹¶ä¸”åŠ è½½é¡ºåºä¹Ÿå·²ç»ç¡®å®šã€‚</p><p><strong>b&gt;</strong> <code>call_load_methods</code>ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></span><br><span class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            call_class_loads();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. Call category +loads ONCE</span></span><br><span class="line">        more_categories = call_category_loads();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* call_class_loads æ–¹æ³•</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_class_loads</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * loadable_classes å°±æ˜¯æˆ‘ä»¬ä¸Šé¢ prepare çš„åŠ è½½å®Œæˆçš„æ•°æ®</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">loadable_class</span> *<span class="title">classes</span> = <span class="title">loadable_classes</span>;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * i ++  å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯æŒ‰ç€é¡ºåºåŠ è½½æˆ‘ä»¬åœ¨ prepare æ—¶å‡†å¤‡çš„æ•°æ®çš„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        Class cls = classes[i].cls;</span><br><span class="line">        <span class="keyword">load_method_t</span> load_method = (<span class="keyword">load_method_t</span>)classes[i].method;</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>; </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * è°ƒç”¨ load æ–¹æ³•</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        (*load_method)(cls, SEL_load);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šé¢çš„call_load_methodsæ–¹æ³•ï¼Œå…ˆåŠ è½½ç±»åœ¨åŠ è½½åˆ†ç±»ï¼Œåœ¨åŠ è½½ç±»çš„æ–¹æ³• <code>call_class_loads</code> ä¸­æ˜¯æŒ‰ç€æˆ‘ä»¬åœ¨ <code>prepare_load_methods</code> æ–¹æ³•ä¸­å‡†å¤‡å¥½çš„æ•°æ®é¡ºåºæ‰§è¡Œçš„ï¼Œæ‰€æœ‰prepareæ—¶åŠ è½½çš„é¡ºåºå°±æ˜¯loadè°ƒç”¨çš„é¡ºåºï¼Œå¯ä»¥æŸ¥çœ‹åˆ†ç±»çš„ <code>call_category_loads</code> æ–¹æ³•ï¼Œè·ŸåŠ è½½ç±»çš„æ–¹å¼æ˜¯ä¸€æ ·çš„ã€‚</p><p>åˆ°è¿™é‡Œç±»å’Œåˆ†ç±»çš„æ‰€æœ‰loadæ–¹æ³•è°ƒç”¨å®Œæ¯•ã€‚</p><p><code>å…³äºloadæ–¹æ³•æ€»ç»“</code>ï¼š</p><blockquote><ol><li>è°ƒç”¨æ–¹å¼ï¼šæ ¹æ®å‡½æ•°çš„ IMP ç›´æ¥è°ƒç”¨ã€‚</li><li>è°ƒç”¨æ—¶æœºï¼šåœ¨runtimeåŠ è½½ç±»ã€åˆ†ç±»æ—¶è°ƒç”¨ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰</li><li>è°ƒç”¨é¡ºåºï¼šâ€1ã€a&gt; å…ˆè°ƒç”¨ç±»çš„load(ä¼˜å…ˆç¼–è¯‘çš„ä¼˜å…ˆè°ƒç”¨)â€  â€œb&gt; è°ƒç”¨å­ç±»çš„loadæ–¹æ³•ä¹‹å‰ä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„loadæ–¹æ³•â€  â€œ1ã€a&gt; å†è°ƒç”¨åˆ†ç±»çš„loadæ–¹æ³•(ä¼˜å…ˆç¼–è¯‘çš„åˆ†ç±»ä¼˜å…ˆè°ƒç”¨)â€</li></ol></blockquote><h3 id="initialize-æ–¹æ³•"><a href="#initialize-æ–¹æ³•" class="headerlink" title="initialize æ–¹æ³•"></a>initialize æ–¹æ³•</h3><p><code>æˆ‘ä»¬çŸ¥é“ + initialize æ–¹æ³•ä¼šåœ¨ç±»çš„ç¬¬ä¸€æ¬¡æ¥æ”¶æ¶ˆæ¯æ—¶è°ƒç”¨ã€‚</code></p><p>å°†ä¸Šé¢çš„å°æµ‹è¯•çš„æ‰€æœ‰loadæ›¿æ¢ä¸ºinitializeï¼Œç„¶ååˆ†åˆ«è°ƒç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼š</span><br><span class="line"><span class="selector-attr">[Animal class]</span>;</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">16</span><span class="selector-pseudo">:52</span><span class="selector-pseudo">:15.039883+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[12499:710327]</span> <span class="selector-tag">Animal</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">initialize</span></span><br><span class="line"></span><br><span class="line">ç¬¬äºŒæ¬¡è°ƒç”¨ï¼š</span><br><span class="line"><span class="selector-attr">[Dog class]</span>;</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">16</span><span class="selector-pseudo">:53</span><span class="selector-pseudo">:35.175441+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[12534:711843]</span> <span class="selector-tag">Animal</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">initialize</span></span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">16</span><span class="selector-pseudo">:53</span><span class="selector-pseudo">:35.175637+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[12534:711843]</span> <span class="selector-tag">Dog</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">initialize</span></span><br><span class="line"></span><br><span class="line">ç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼š</span><br><span class="line"><span class="selector-attr">[Animal class]</span>;</span><br><span class="line"><span class="selector-attr">[Dog class]</span>;</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">16</span><span class="selector-pseudo">:54</span><span class="selector-pseudo">:04.664353+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[12553:712521]</span> <span class="selector-tag">Animal</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">initialize</span></span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">16</span><span class="selector-pseudo">:54</span><span class="selector-pseudo">:04.664578+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[12553:712521]</span> <span class="selector-tag">Dog</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">initialize</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°ä¸‰æ¬¡çš„æ‰“å°ç»“æœå¯ä»¥æ¨æµ‹ <code>initialize</code> çš„æ–¹æ³•çš„è°ƒç”¨ç¬¦åˆæˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²è§£ï¼Œæœ€ååŠ è½½çš„åˆ†ç±»ä¼šä¼˜å…ˆç±»è°ƒç”¨ï¼Œå¹¶ä¸”ç±»çš„æ–¹æ³•ä¸ä¼šå†è°ƒç”¨ï¼Œç¬¬äºŒæ¬¡çš„è°ƒç”¨å¯ä»¥æ¨æµ‹åœ¨è°ƒç”¨ <code>initialize</code> æ—¶ä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„ <code>initialize</code> æ–¹æ³•ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥æŠŠå­ç±»Dogå’Œdogåˆ†ç±»çš„ <code>initialize</code> æ–¹å¼åˆ é™¤ï¼Œå†æ¥æ‰“å°çœ‹çœ‹ç»“æœï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">è°ƒç”¨ï¼š</span><br><span class="line"><span class="selector-attr">[Dog class]</span>;</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">17</span><span class="selector-pseudo">:08</span><span class="selector-pseudo">:29.497283+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[12830:725499]</span> <span class="selector-tag">Animal</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">initialize</span></span><br><span class="line"><span class="selector-tag">2018-07-22</span> <span class="selector-tag">17</span><span class="selector-pseudo">:08</span><span class="selector-pseudo">:29.497558+0800</span> <span class="selector-tag">debug-objc</span><span class="selector-attr">[12830:725499]</span> <span class="selector-tag">Animal</span> (Eat) <span class="selector-tag">--</span> <span class="selector-tag">initialize</span></span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ Animnal çš„ <code>initialize</code> ä¼šå‡ºç°ä¸¤æ¬¡çš„è°ƒç”¨å‘¢ï¼Ÿ <code>initialize</code> ä¸æ˜¯åªåœ¨ç¬¬ä¸€æ¬¡æ¥æ”¶æ¶ˆæ¯æ—¶è°ƒç”¨å—ï¼Ÿ</p><p>initialize æ˜¯åœ¨å‘é€æ¶ˆæ¯æ—¶è°ƒç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰¾åˆ° <code>objc_msgSend</code> æ–¹æ³•ï¼Œæœ€ç»ˆæ‰¾åˆ° <code>class_getInstanceMethod</code> æ–¹æ³•ï¼Œæ ¹æ®è°ƒç”¨ï¼š<code>-&gt;class_getInstanceMethod -&gt; lookUpImpOrNil -&gt;lookUpImpOrForward</code> ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹runtimeçš„æºç ï¼š</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">IMP lookUpImpOrForward(Class <span class="keyword">cls</span>, SEL sel, id inst, </span><br><span class="line">                       <span class="keyword">bool</span> initialize, <span class="keyword">bool</span> cache, <span class="keyword">bool</span> resolver) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å¦‚æœclsè¿˜æ²¡æœ‰ Initialized è°ƒç”¨ _class_initialize</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (initialize  &amp;&amp;  !<span class="keyword">cls</span>-&gt;isInitialized()) &#123;</span><br><span class="line">        _class_initialize (_class_getNonMetaClass(<span class="keyword">cls</span>, inst));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void _class_initialize(Class <span class="keyword">cls</span>) &#123;</span><br><span class="line">    Class supercls;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * é€’å½’è°ƒç”¨ clsçˆ¶ç±»çš„ callInitialize</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    supercls = <span class="keyword">cls</span>-&gt;superclass;</span><br><span class="line">    <span class="keyword">if</span> (supercls  &amp;&amp;  !supercls-&gt;isInitialized()) &#123;</span><br><span class="line">        _class_initialize(supercls);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ²¡æœ‰ initialize æ—¶è®¾ç½® reallyInitializeä¸ºtrue</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">cls</span>-&gt;isInitialized() &amp;&amp; !<span class="keyword">cls</span>-&gt;isInitializing()) &#123;</span><br><span class="line">        <span class="keyword">cls</span>-&gt;setInitializing();</span><br><span class="line">        reallyInitialize = YES;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (reallyInitialize) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * è°ƒç”¨è¿”é€ SEL_initialize æ¶ˆæ¯æ–¹æ³•</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        callInitialize(<span class="keyword">cls</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å‘é€ SEL_initialize æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">void callInitialize(Class <span class="keyword">cls</span>) &#123;</span><br><span class="line">    ((void(*)(Class, SEL))objc_msgSend)(<span class="keyword">cls</span>, SEL_initialize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†ææºç å¯ä»¥çœ‹åˆ°ï¼Œ<code>initialize</code> æ–¹æ³•ä¼šå…ˆå»æŸ¥æ‰¾çˆ¶ç±»ï¼Œå¦‚æœçˆ¶ç±» <code>initialize</code> æ²¡æœ‰è°ƒç”¨è¿‡ï¼Œä¼šå…ˆå‘çˆ¶ç±»å‘é€ <code>SEL_initialize</code> æ¶ˆæ¯ï¼Œè¿™é‡Œå¯ä»¥è§£é‡Šä¸€ä¸‹æˆ‘ä»¬ä¸Šé¢çš„å°æµ‹è¯•ä¸ºä»€ä¹ˆ animal çš„æ–¹æ³•è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œå› ä¸ºåœ¨ <code>_class_initialize</code> æ–¹æ³•ä¸­ç¬¬ä¸€æ¬¡ç”±çˆ¶ç±» animal å‘é€ <code>SEL_initialize</code> æ¶ˆæ¯ï¼Œç¬¬äºŒæ¬¡ç”± dog ç±»å‘é€ <code>SEL_initialize</code> æ¶ˆæ¯ï¼Œè€Œç”±äº dog ç±»æ²¡æœ‰ <code>initialize</code> æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šå»è°ƒç”¨çˆ¶ç±» animal çš„æ–¹æ³•ã€‚</p><p><code>å…³äºinitializeæ–¹æ³•æ€»ç»“</code>ï¼š</p><blockquote><ol><li>è°ƒç”¨æ–¹å¼ï¼šinitializeæ˜¯é€šè¿‡objc_msgSendè°ƒç”¨ã€‚</li><li>è°ƒç”¨æ—¶æœºï¼šinitializeæ—¶ç±»åœ¨ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶è°ƒç”¨ï¼Œæ¯ä¸ªç±»åªä¼šinitializeä¸€æ¬¡ï¼ˆçˆ¶ç±»çš„initializeæ–¹æ³•å¯èƒ½ä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼‰ã€‚</li><li>è°ƒç”¨é¡ºåºï¼šå…ˆåˆå§‹åŒ–çˆ¶ç±» å†åˆå§‹åŒ–å­ç±»ï¼ˆå¯èƒ½æœ€ç»ˆè°ƒç”¨çš„æ˜¯çˆ¶ç±»çš„initializeæ–¹æ³•ï¼‰</li></ol></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;load-æ–¹æ³•è§£æ&quot;&gt;&lt;a href=&quot;#load-æ–¹æ³•è§£æ&quot; class=&quot;headerlink&quot; title=&quot;+load æ–¹æ³•è§£æ&quot;&gt;&lt;/a&gt;+load æ–¹æ³•è§£æ&lt;/h3&gt;
    
    </summary>
    
    
      <category term="category åŸç†" scheme="http://yoursite.com/tags/category-%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>categoryåŸç†æ¢ç©¶-1</title>
    <link href="http://yoursite.com/2018/07/21/category%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-1/"/>
    <id>http://yoursite.com/2018/07/21/categoryåŸç†æ¢ç©¶-1/</id>
    <published>2018-07-21T06:40:13.000Z</published>
    <updated>2020-08-15T14:28:13.813Z</updated>
    
    <content type="html"><![CDATA[<h3 id="categoryæ¢ç©¶å‡†å¤‡"><a href="#categoryæ¢ç©¶å‡†å¤‡" class="headerlink" title="categoryæ¢ç©¶å‡†å¤‡"></a>categoryæ¢ç©¶å‡†å¤‡</h3><p>å…ˆæ¥åˆ›å»ºæˆ‘ä»¬æµ‹è¯•éœ€è¦çš„ç±»ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Animalç±» --&gt;</span></span><br><span class="line">@interface Animal : NSObject</span><br><span class="line">- (void)animal;</span><br><span class="line">@end</span><br><span class="line"><span class="comment">&lt;!-- Animal+Eatåˆ†ç±» --&gt;</span></span><br><span class="line">@interface Animal (Eat) <span class="tag">&lt;<span class="name">NSCopying,</span> <span class="attr">NSCoding</span>&gt;</span></span><br><span class="line">@property (nonatomic, assign) int age;</span><br><span class="line">- (void)eat;</span><br><span class="line">@end</span><br><span class="line"><span class="comment">&lt;!-- Animal+Playåˆ†ç±» --&gt;</span></span><br><span class="line">@interface Animal (Play)</span><br><span class="line">- (void)play;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ä»¥Eatåˆ†ç±»ä¸ºä¾‹ï¼Œè¯·å‡º <code>clang</code> å‘½ä»¤ï¼š<code>clang -rewrite-objc Animal+Eat.m</code> ï¼Œç”Ÿæˆ.cppæ–‡ä»¶ã€‚</p><a id="more"></a><h3 id="categoryçš„çœŸé¢ç›®"><a href="#categoryçš„çœŸé¢ç›®" class="headerlink" title="categoryçš„çœŸé¢ç›®"></a>categoryçš„çœŸé¢ç›®</h3><p>åœ¨.cppæ–‡ä»¶æœ€ä¸‹é¢å¯ä»¥æ‰¾åˆ°categoryè¢«ç¼–è¯‘åçš„ç»“æ„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">category_t</span> &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">class_t</span> *<span class="title">cls</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">method_list_t</span> *<span class="title">instance_methods</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">method_list_t</span> *<span class="title">class_methods</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">prop_list_t</span> *<span class="title">properties</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>name</code> è¿™é‡Œçš„nameè¡¨ç¤ºçš„æ˜¯ <code>ç±»å</code> è€Œä¸æ˜¯categoryçš„åå­—ã€‚</li><li><code>cls</code> è¦æ‰©å±•çš„ç±»å¯¹è±¡ï¼Œç¼–è¯‘æœŸé—´å€¼ä¸ºç©ºï¼Œåœ¨è¢«runtimeåŠ è½½æ—¶æ ¹æ®nameå¯¹åº”åˆ°ç±»å¯¹è±¡ã€‚</li><li><code>instance_methods</code> categoryæ‰€æœ‰çš„å®ä¾‹æ–¹æ³•ã€‚</li><li><code>class_methods</code> categoryæ‰€æœ‰çš„ç±»æ–¹æ³•ã€‚</li><li><code>protocols</code> categoryå®ç°çš„æ‰€æœ‰åè®®ã€‚</li><li><code>properties</code> categoryçš„æ‰€æœ‰å±æ€§ã€‚</li></ul><p>å†æ¥çœ‹çœ‹æˆ‘ä»¬çš„Animal+Eatè¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static struct <span class="variable">_category_t</span> <span class="variable">_OBJC_</span>$<span class="variable">_CATEGORY_Animal_</span>$<span class="variable">_Eat</span> <span class="variable">__attribute__</span> ((used, section (<span class="string">"__DATA,__objc_const"</span>))) =  &#123;</span><br><span class="line"><span class="string">"Animal"</span>,</span><br><span class="line"><span class="number">0</span>, <span class="comment">// &amp;OBJC_CLASS_$_Animal,</span></span><br><span class="line">(const struct <span class="variable">_method_list_t</span> *)&amp;<span class="variable">_OBJC_</span>$<span class="variable">_CATEGORY_INSTANCE_METHODS_Animal_</span>$<span class="variable">_Eat</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">(const struct <span class="variable">_protocol_list_t</span> *)&amp;<span class="variable">_OBJC_CATEGORY_PROTOCOLS_</span>$<span class="variable">_Animal_</span>$<span class="variable">_Eat</span>,</span><br><span class="line">(const struct <span class="variable">_prop_list_t</span> *)&amp;<span class="variable">_OBJC_</span>$<span class="variable">_PROP_LIST_Animal_</span>$<span class="variable">_Eat</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹ç»“æ„ä½“çš„åç§°ï¼š<code>_OBJC_$_CATEGORY_Animal_$_Eat</code>ï¼Œæœ€åé¢çš„Eatå°±æ˜¯æˆ‘ä»¬åˆ†ç±»çš„åç§°ï¼Œå‰é¢æœ‰è¡¨ç¤ºCATEGORYå’Œç±»åAnimalï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåŒä¸€ä¸ªç±»çš„categoryä¸èƒ½é‡åçš„åŸå› äº†ã€‚<br>å†å¯¹åº”ä¸€ä¸‹å…¶ä»–çš„ç»“æ„ï¼Œä¾‹å¦‚instance_methodsï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">method_list_t</span>*/ &#123;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">objc_method</span> <span class="title">method_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_CATEGORY_INSTANCE_METHODS_Animal_$_Eat __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line"><span class="keyword">sizeof</span>(_objc_method),</span><br><span class="line"><span class="number">1</span>,</span><br><span class="line">&#123;&#123;(struct objc_selector *)<span class="string">"eat"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_I_Animal_Eat_eat&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é‡Œé¢åªæœ‰ä¸€ä¸ª <code>eat</code> æ–¹æ³•ï¼Œè¢«ç¼–è¯‘åä¸º <code>_I_Animal_Eat_eat</code>ã€‚</p><p>æœ€åå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„categoryè¢«æ”¾åˆ°äº†ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå­˜åœ¨äº† <code>__DATA</code> æ®µä¸‹çš„ <code>__objc_catlist section</code> é‡Œäº†ï¼š</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static struct <span class="variable">_category_t</span> *L_OBJC_LABEL_CATEGORY_$ [<span class="number">1</span>] <span class="variable">__attribute__</span>((used, section (<span class="string">"__DATA, __objc_catlist,regular,no_dead_strip"</span>)))= &#123;</span><br><span class="line">&amp;<span class="variable">_OBJC_</span>$<span class="variable">_CATEGORY_Animal_</span>$<span class="variable">_Eat</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¼–è¯‘æœŸé—´çš„å·¥ä½œå°±åšå®Œäº†ï¼Œæ¥ä¸‹æ¥è¿›å…¥runtimeã€‚</p><h3 id="runtimeåŠ è½½category"><a href="#runtimeåŠ è½½category" class="headerlink" title="runtimeåŠ è½½category"></a>runtimeåŠ è½½category</h3><p>å…ˆä¸‹è½½ä¸€ä¸‹è‹¹æœå®˜æ–¹runtimeçš„æºç  <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener"><strong>è¿™é‡Œ</strong></a>ï¼Œå½“ç„¶å®˜æ–¹çš„ç¼–è¯‘æ˜¯å¤±è´¥ï¼Œè¦æƒ³è°ƒè¯•runtimeçš„è¯·çœ‹ <a href="https://github.com/RetVal/objc-runtime" target="_blank" rel="noopener"><strong>è¿™é‡Œ</strong></a>ã€‚</p><p>å¤§è‡´åŠ è½½çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æ‰¾åˆ°runtimeçš„å…¥å£ï¼š<code>objc-os.mm</code> çš„ <code>_objc_init</code> æ–¹æ³•ï¼Œåœ¨libraryåŠ è½½å‰ç”±libSystem dyldè°ƒç”¨ï¼Œè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</li><li>è°ƒç”¨map_imagesæ–¹æ³•å°†æ–‡ä»¶ä¸­çš„image mapåˆ°å†…å­˜ã€‚</li><li>è°ƒç”¨_read_imagesæ–¹æ³•åˆå§‹åŒ–mapåçš„imageã€‚</li><li>æ‰¾åˆ° <code>Discover categories</code> å¯ä»¥çœ‹åˆ° <code>category_t</code> æ˜¯é€šè¿‡ <code>_getObjc2CategoryList</code> æ–¹æ³•åˆå§‹åŒ–çš„ï¼Œè¿™ä¸ªæ–¹æ³•æ‹¿å‡ºæ¥çœ‹çœ‹ï¼š</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define GETSECT(name, type, sectname)                                   \</span></span><br><span class="line">   <span class="built_in"> type </span>*name(const headerType *mhdr, size_t *outCount) &#123;              \</span><br><span class="line">        return getDataSection&lt;type&gt;(mhdr, sectname, <span class="literal">nil</span>, outCount);     \</span><br><span class="line">    &#125;                                                                   \</span><br><span class="line">   <span class="built_in"> type </span>*name(const header_info *hi, size_t *outCount) &#123;               \</span><br><span class="line">        return getDataSection&lt;type&gt;(hi-&gt;mhdr(), sectname, <span class="literal">nil</span>, outCount); \</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">GETSECT(_getObjc2CategoryList, category_t *, <span class="string">"__objc_catlist"</span>);</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œæœ‰æ²¡æœ‰å¾ˆç†Ÿæ‚‰ï¼Œåœ¨è¿™é‡ŒåŠ è½½çš„ <code>__objc_catlist</code> å°±æ˜¯åœ¨ç¼–è¯‘æœŸé—´å­˜æ”¾çš„æ•°æ®ã€‚</p><p>æ¥çœ‹ä¸€ä¸‹åŠ è½½çš„æºç ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * å–å‡º category æ•°æ® æ­¤å¤„ä¸ºæ•°ç»„ä»£è¡¨ä¸€ä¸ªç±»æ‰€æœ‰çš„åˆ†ç±»</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   category_t **catlist = _getObjc2CategoryList(hi, &amp;count);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">   </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æŒ‰é¡ºåºå–å‡º category_t </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  category_t *cat = catlist[i];</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * remapClassï¼šåŠ è½½category_tçš„classæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  C<span class="function"><span class="title">lass</span> cls = remapClass(cat-&gt;</span>cls);</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="title">if</span> (cat-&gt;</span><span class="function"><span class="title">instanceMethods</span> ||  cat-&gt;</span><span class="function"><span class="title">protocols</span>  ||  cat-&gt;</span>instanceProperties) </span><br><span class="line">  &#123;</span><br><span class="line">      addUnattachedCategoryForClass(cat, cls, hi);</span><br><span class="line">      <span class="function"><span class="title">if</span> (cls-&gt;</span>isRealized()) &#123;</span><br><span class="line">      remethodizeClass(cls);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">if</span> (cat-&gt;</span><span class="function"><span class="title">classMethods</span>  ||  cat-&gt;</span><span class="function"><span class="title">protocols</span> ||  (hasClassProperties &amp;&amp; cat-&gt;</span>_classProperties)) </span><br><span class="line">  &#123;</span><br><span class="line">      <span class="function"><span class="title">addUnattachedCategoryForClass</span>(cat, cls-&gt;</span>ISA(), hi);</span><br><span class="line">      <span class="function"><span class="title">if</span> (cls-&gt;</span>ISA()-&gt;isRealized()) &#123;</span><br><span class="line">      <span class="function"><span class="title">remethodizeClass</span>(cls-&gt;</span>ISA());</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¯æ¬¡å¾ªç¯ä¸­ <code>category_t</code> çš„åŠ è½½ <code>addUnattachedCategoryForClass</code> æ–¹æ³•æœ‰ä¸¤ä¸ªè°ƒç”¨ï¼Œå¯¹æ¯”ä¸€ä¸‹å‚æ•°å¯ä»¥å‘ç°ç¬¬äºŒä¸ªå‚æ•°ä¸åŒ cls å’Œ cls-&gt;ISA()ï¼Œå†ç»“åˆåˆ¤æ–­æ¡ä»¶çš„ cat-&gt;instanceMethods å’Œ cat-&gt;classMethodsï¼Œè¿™ä¸¤æ¬¡çš„åŠ è½½æ˜¯å°†categoryä¸­çš„ä¿¡æ¯åˆ†åˆ«åŠ è½½åˆ°ç±»å’Œå…ƒç±»ä¸­ï¼Œç„¶åå†è°ƒç”¨ <code>remethodizeClass</code> é‡æ–°ç»„ç»‡ç»“æ„ã€‚æ¥ä¸‹æ¥è°ƒç”¨é™„åŠ ä¿¡æ¯çš„æ–¹æ³• <code>attachCategories</code> ï¼Œå°†åˆ†ç±»çš„ä¿¡æ¯é™„åŠ åˆ°ç±»ä¸­ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">attachCategories(Class cls, category_list *cats, bool flush_caches)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ˜¯å¦ä¸ºå…ƒç±»</span></span><br><span class="line"><span class="comment">    */</span> </span><br><span class="line">    <span class="function"><span class="title">bool</span> isMeta = cls-&gt;</span>isMetaClass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ–¹æ³•æ•°ç»„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    method_list_t **mlists = (method_list_t **) </span><br><span class="line">        <span class="function"><span class="title">malloc</span>(cats-&gt;</span>count * sizeof(*mlists));</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å±æ€§æ•°ç»„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    property_list_t **proplists = (property_list_t **)</span><br><span class="line">        <span class="function"><span class="title">malloc</span>(cats-&gt;</span>count * sizeof(*proplists));</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åè®®æ•°ç»„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    protocol_list_t **protolists = (protocol_list_t **)</span><br><span class="line">        <span class="function"><span class="title">malloc</span>(cats-&gt;</span>count * sizeof(*protolists));</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    ********** æ³¨æ„ ï¼šè¿™é‡Œæ˜¯å€’åºå¾ªç¯ **********</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * å–å‡ºæŸä¸ªåˆ†ç±»</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="function"><span class="title">auto</span>&amp; entry = cats-&gt;</span>list[i];</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * å–å‡ºæŸä¸ªåˆ†ç±»çš„æ–¹æ³•åˆ—è¡¨ (æ ¹æ® isMeta æ¥åˆ¤æ–­å–å®ä¾‹æ–¹æ³•è¿˜æ˜¯ç±»æ–¹æ³•)</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="function"><span class="title">method_list_t</span> *mlist = entry.cat-&gt;</span>methodsForMeta(isMeta);</span><br><span class="line">        <span class="keyword">if</span> (mlist) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * å°†åˆ†ç±»æ–¹æ³•åˆ—è¡¨æ­£åºæ·»åŠ åˆ° mlists</span></span><br><span class="line"><span class="comment">            */</span>        </span><br><span class="line">            mlists[mcount++] = mlist;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * å–å‡ºæŸä¸ªåˆ†ç±»çš„å±æ€§åˆ—è¡¨</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        property_list_t *proplist = </span><br><span class="line">            <span class="function"><span class="title">entry</span>.cat-&gt;</span>propertiesForMeta(isMeta, entry.hi);</span><br><span class="line">        <span class="keyword">if</span> (proplist) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * å°†åˆ†ç±»å±æ€§åˆ—è¡¨æ­£åºæ·»åŠ åˆ° proplists</span></span><br><span class="line"><span class="comment">            */</span>  </span><br><span class="line">            proplists[propcount++] = proplist;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * å–å‡ºæŸä¸ªåˆ†ç±»çš„åè®®åˆ—è¡¨</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="function"><span class="title">protocol_list_t</span> *protolist = entry.cat-&gt;</span>protocols;</span><br><span class="line">        <span class="keyword">if</span> (protolist) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * å°†åˆ†ç±»åè®®åˆ—è¡¨æ­£åºæ·»åŠ åˆ° protolists</span></span><br><span class="line"><span class="comment">            */</span>  </span><br><span class="line">            protolists[protocount++] = protolist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å–å‡ºç±»çš„ä¿¡æ¯æ•°æ®  class_rw_t</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="title">auto</span> rw = cls-&gt;</span><span class="keyword">data</span>();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆå§‹åŒ–æ–¹æ³•çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚æœ‰æ²¡æœ‰å®ç°retainã€releaseã€allocWithZoneç­‰æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å°†æ‰€æœ‰åˆ†ç±»çš„æ–¹æ³•ã€å±æ€§ã€åè®®åˆ—è¡¨é™„åŠ åˆ°ç±»çš„æ–¹æ³•ã€å±æ€§ã€åè®®åˆ—è¡¨ä¸­ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="title">rw</span>-&gt;</span>methods.attachLists(mlists, mcount);</span><br><span class="line">    <span class="function"><span class="title">rw</span>-&gt;</span>properties.attachLists(proplists, propcount);</span><br><span class="line">    <span class="function"><span class="title">rw</span>-&gt;</span>protocols.attachLists(protolists, protocount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢çš„whileå¾ªç¯å¯ä»¥çœ‹åˆ°åŠ è½½æ–¹æ³•ã€åè®®ã€å±æ€§çš„æ—¶å€™æ˜¯ <code>å€’åº</code> åŠ è½½çš„ï¼Œæ˜¯ä¸æ˜¯æƒ³åˆ°äº†ä»€ä¹ˆï¼Ÿå¦‚æœAnimalç±»å’Œä¸¤ä¸ªåˆ†ç±»éƒ½æœ‰ä¸€ä¸ª <code>-(void)run</code> æ–¹æ³•ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šè°ƒç”¨å“ªä¸ªé‡Œé¢çš„runæ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯æœ€ååŠ è½½çš„é‚£ä¸ªrunæ–¹æ³•ï¼Œä¸è¿‡æ²¡æœ‰è¢«è°ƒç”¨çš„runæ–¹æ³•å¹¶æ²¡æœ‰è¢« <code>è¦†ç›–</code> ï¼Œæ–¹æ³•è¿˜åœ¨é‚£é‡Œåªæ˜¯æŒ‰é¡ºåºæ²¡æœ‰è¢«è°ƒç”¨ã€‚</p><p>æœ€åçœ‹ä¸€ä¸‹ <code>methods.attachLists</code> æ–¹æ³•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å°†åˆ†ç±»çš„ æ–¹æ³•ã€åè®®ã€å±æ€§ç­‰ä¿¡æ¯é™„åŠ åˆ°ç±»ä¸­</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">attachLists</span><span class="params">(List* <span class="keyword">const</span> * addedLists, <span class="keyword">uint32_t</span> addedCount)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">uint32_t</span> oldCount = <span class="built_in">array</span>()-&gt;count;</span><br><span class="line"><span class="keyword">uint32_t</span> newCount = oldCount + addedCount;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* é‡æ–°åˆ†é…å†…å­˜ï¼ˆå¤§å°ä¸ºï¼š oldCount addedCount åŸæœ‰countå’Œè¦æ·»åŠ çš„countæ€»å’Œï¼‰</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line">setArray((<span class="keyword">array_t</span> *)<span class="built_in">realloc</span>(<span class="built_in">array</span>(), <span class="keyword">array_t</span>::byteSize(newCount)));</span><br><span class="line"><span class="built_in">array</span>()-&gt;count = newCount;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* é‡æ–°å¸ƒå±€</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">memmove(<span class="built_in">array</span>()-&gt;lists + addedCount, <span class="built_in">array</span>()-&gt;lists,</span><br><span class="line"> oldCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</span><br><span class="line"><span class="built_in">memcpy</span>(<span class="built_in">array</span>()-&gt;lists, addedLists,</span><br><span class="line"> addedCount * <span class="keyword">sizeof</span>(<span class="built_in">array</span>()-&gt;lists[<span class="number">0</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡æ–°å¸ƒå±€çš„æ—¶å€™æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>memmove</code>ï¼š<code>void *memmove(void *__dst, const void *__src, size_t __len);</code> å¯ä»¥çœ‹åˆ°æ˜¯å°†srcå˜é‡çš„æ•°æ®ç§»åŠ¨åˆ°dstï¼Œæ‰€ä»¥æœ€ç»ˆæ˜¯å°† array()-&gt;lists çš„æ•°æ®ç§»åŠ¨åˆ°äº† array()-&gt;lists + addedCount çš„ä½ç½®ã€‚</li><li><code>memcpy</code>ï¼š<code>void    *memcpy(void *__dst, const void *__src, size_t __n);</code> å¯ä»¥çœ‹åˆ°æ˜¯å°†srcå˜é‡çš„æ•°æ®copyåˆ°dstï¼Œæ‰€ä»¥æœ€ç»ˆæ˜¯å°†åˆ†ç±»ä¸­çš„ä¿¡æ¯ <code>addedLists</code> copy åˆ° array()-&gt;lists çš„ä½ç½®ã€‚</li></ul><p>æ­£å¦‚æˆ‘ä»¬ä¸Šé¢è¯´çš„runæ–¹æ³•ï¼ŒAnimalç±»ä¸­çš„runæ–¹æ³•æ˜¯è¢«æœ€ååŠ è½½çš„ï¼Œå› ä¸ºAnimalç±»ä¸­çš„æ–¹æ³•åˆ—è¡¨è¢«ç§»åŠ¨åˆ°äº†åˆ†ç±»çš„åé¢ï¼ŒåŠ è½½çš„æ—¶å€™ä¼šå…ˆè°ƒç”¨åˆ†ç±»ä¸­çš„æ–¹æ³•ï¼Œè€Œä¸”å¯ä»¥çœ‹åˆ°Animalä¸­çš„runæ–¹æ³•ç¡®å®æ²¡æœ‰è¢«è¦†ç›–ï¼Œåªæ˜¯è°ƒç”¨çš„æ—¶å€™å‘ç°åˆ†ç±»ä¸­æœ‰ä¸ä¼šå†è°ƒç”¨Animalçš„runæ–¹æ³•è€Œå·²ã€‚</p><h3 id="class-extentionä¸category"><a href="#class-extentionä¸category" class="headerlink" title="class extentionä¸category"></a>class extentionä¸category</h3><p>ä¸Šé¢çŸ¥é“äº†categoryï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹class extentionï¼Œclass extentionç®—æ˜¯ä¸€ç§ç‰¹æ®Šçš„åˆ†ç±»ï¼ˆåŒ¿ååˆ†ç±»ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ€è€ƒå¹³æ—¶åœ¨ .m æ–‡ä»¶çš„åŒ¿ååˆ†ç±»ä¸­å†™çš„ç§æœ‰å±æ€§ã€æ–¹æ³•ç­‰åœ¨åŠ è½½çš„æ—¶å€™ä¼šä¸ä¼šå’Œåˆ†ç±»ä¸€æ ·å‘¢ï¼Ÿæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼Œåœ¨Animalçš„ .m æ–‡ä»¶é‡Œæ·»åŠ å±æ€§ height å’Œæ–¹æ³• testï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> Animal ()</span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) int height;</span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">test</span>;</span><br><span class="line">@<span class="selector-tag">end</span></span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">implementation</span> <span class="selector-tag">Animal</span></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">animal</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">test</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><p>ç”¨clangå‘½ä»¤æ¥ç¼–è¯‘ Animalï¼š<code>clang -rewrite-objc Animal.m</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å…ƒç±»ç»“æ„</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">_class_ro_t</span></span> _OBJC_METACLASS_RO_$_Animal __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line"><span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">_class_t</span></span>), <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">_class_t</span></span>), </span><br><span class="line">(unsigned int)<span class="number">0</span>, </span><br><span class="line"><span class="number">0</span>, </span><br><span class="line"><span class="string">"Animal"</span>,</span><br><span class="line"><span class="number">0</span>, </span><br><span class="line"><span class="number">0</span>, </span><br><span class="line"><span class="number">0</span>, </span><br><span class="line"><span class="number">0</span>, </span><br><span class="line"><span class="number">0</span>, </span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ç±»ç»“æ„</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">_class_ro_t</span></span> _OBJC_CLASS_RO_$_Animal __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line"><span class="number">0</span>, __OFFSETOFIVAR__(<span class="class"><span class="keyword">struct</span> <span class="title">Animal</span></span>, _height), <span class="keyword">sizeof</span>(<span class="class"><span class="keyword">struct</span> <span class="title">Animal_IMPL</span></span>), </span><br><span class="line">(unsigned int)<span class="number">0</span>, </span><br><span class="line"><span class="number">0</span>, </span><br><span class="line"><span class="string">"Animal"</span>,</span><br><span class="line">(<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">_method_list_t</span></span> *)&amp;_OBJC_$_INSTANCE_METHODS_Animal,</span><br><span class="line"><span class="number">0</span>, </span><br><span class="line">(<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">_ivar_list_t</span></span> *)&amp;_OBJC_$_INSTANCE_VARIABLES_Animal,</span><br><span class="line"><span class="number">0</span>, </span><br><span class="line"><span class="number">0</span>, </span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/***************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å¯ä»¥çœ‹åˆ°ç±»ä¸­æ–¹æ³•åˆ—è¡¨ â€˜_INSTANCE_METHODS_Animalâ€™å¯¹åº”ä¸‹é¢çš„ç»“æ„</span></span><br><span class="line"><span class="comment">* animalã€testã€heightã€setHeight æ–¹æ³•éƒ½åœ¨ç±»ç»“æ„ä¸­</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*<span class="title">_method_list_t</span></span>*/ &#123;</span><br><span class="line">unsigned int entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">unsigned int method_count;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">_objc_method</span></span> method_list[<span class="number">4</span>];</span><br><span class="line">&#125; _OBJC_$_INSTANCE_METHODS_Animal __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line"><span class="keyword">sizeof</span>(_objc_method),</span><br><span class="line"><span class="number">4</span>,</span><br><span class="line">&#123;&#123;(<span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span></span> *)<span class="string">"animal"</span>, <span class="string">"v16@0:8"</span>, (void *)_I_Animal_animal&#125;,</span><br><span class="line">&#123;(<span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span></span> *)<span class="string">"test"</span>, <span class="string">"v16@0:8"</span>, (void *)_I_Animal_test&#125;,</span><br><span class="line">&#123;(<span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span></span> *)<span class="string">"height"</span>, <span class="string">"i16@0:8"</span>, (void *)_I_Animal_height&#125;,</span><br><span class="line">&#123;(<span class="class"><span class="keyword">struct</span> <span class="title">objc_selector</span></span> *)<span class="string">"setHeight:"</span>, <span class="string">"v20@0:8i16"</span>, (void *)_I_Animal_setHeight_&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘çš„ç»“æœå¦‚ä¸Šï¼Œå¯ä»¥çœ‹åˆ°åŒ¿åç±»åˆ«çš„ç¼–è¯‘ç»“æœå¹¶ä¸æ˜¯ <code>category_t</code> çš„ç±»å‹åœ¨ runtime æ—¶åŠ è½½çš„ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ç¼–è¯‘æœŸé—´å°†ç›¸å…³çš„å±æ€§æ–¹æ³•ç­‰åŠ è½½åˆ°äº†ç±»ä¸­ï¼ŒåŒ¿ååˆ†ç±»å£°æ˜çš„å±æ€§æ–¹æ³•ç›¸å½“äºåœ¨ç±»çš„ .h æ–‡ä»¶çš„å£°æ˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;categoryæ¢ç©¶å‡†å¤‡&quot;&gt;&lt;a href=&quot;#categoryæ¢ç©¶å‡†å¤‡&quot; class=&quot;headerlink&quot; title=&quot;categoryæ¢ç©¶å‡†å¤‡&quot;&gt;&lt;/a&gt;categoryæ¢ç©¶å‡†å¤‡&lt;/h3&gt;&lt;p&gt;å…ˆæ¥åˆ›å»ºæˆ‘ä»¬æµ‹è¯•éœ€è¦çš„ç±»ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;&amp;lt;!-- Animalç±» --&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@interface Animal : NSObject&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (void)animal;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@end&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;&amp;lt;!-- Animal+Eatåˆ†ç±» --&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@interface Animal (Eat) &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;NSCopying,&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;NSCoding&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@property (nonatomic, assign) int age;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (void)eat;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@end&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;&amp;lt;!-- Animal+Playåˆ†ç±» --&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@interface Animal (Play)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;- (void)play;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@end&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;ä»¥Eatåˆ†ç±»ä¸ºä¾‹ï¼Œè¯·å‡º &lt;code&gt;clang&lt;/code&gt; å‘½ä»¤ï¼š&lt;code&gt;clang -rewrite-objc Animal+Eat.m&lt;/code&gt; ï¼Œç”Ÿæˆ.cppæ–‡ä»¶ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="category åŸç†" scheme="http://yoursite.com/tags/category-%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>KVO-KVCçš„åŸç†æ¢ç©¶ - KVCç¯‡</title>
    <link href="http://yoursite.com/2018/07/19/KVO-KVC%E7%9A%84%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-KVC%E7%AF%87/"/>
    <id>http://yoursite.com/2018/07/19/KVO-KVCçš„åŸç†æ¢ç©¶-KVCç¯‡/</id>
    <published>2018-07-19T07:12:40.000Z</published>
    <updated>2020-08-15T14:28:41.430Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å…³äºKVCçš„æ¢ç©¶"><a href="#å…³äºKVCçš„æ¢ç©¶" class="headerlink" title="å…³äºKVCçš„æ¢ç©¶"></a>å…³äºKVCçš„æ¢ç©¶</h3><h4 id="åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨"><a href="#åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨"></a>åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨</h4><a id="more"></a><p>KVCå…¨ç§°Key-Value Coding é”®å€¼ç¼–ç ï¼Œå¯ä»¥é€šè¿‡Keyæ¥è®¿é—®æŸä¸ªå±æ€§ï¼Œå¸¸è§çš„APIï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure></p><p>åˆ›å»ºPersonç±»ã€Animalç±»ï¼Œæ·»åŠ å±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">Animal </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) NSInteger height;</span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) NSInteger age;</span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong) Animal * dog;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œä½¿ç”¨KVCèµ‹å€¼çš„æ–¹å¼ä¸ºï¼š<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Animal</span> * dog = <span class="comment">[<span class="comment">[Animal alloc]</span> init]</span>;</span><br><span class="line"><span class="keyword">Person</span> * <span class="keyword">person</span> = <span class="comment">[<span class="comment">[Person alloc]</span> init]</span>;</span><br><span class="line"><span class="keyword">person</span>.dog = dog;</span><br><span class="line">// Key        </span><br><span class="line"><span class="comment">[person setValue:@11 forKey:@"age"]</span>;</span><br><span class="line">// KeyPath</span><br><span class="line"><span class="comment">[person setValue:@123 forKeyPath:@"dog.height"]</span>;</span><br><span class="line">        </span><br><span class="line">NSLog(@<span class="string">"---- %@ -- %@"</span>, @(<span class="keyword">person</span>.age), @(<span class="keyword">person</span>.dog.height));</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line">2018-07-19 23:00:48.546719+0800 KVC<span class="comment">[53839:3059207]</span> ---- 11 -- 123</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°ç›´æ¥èµ‹å€¼çš„è¯ä¸¤ä¸­æ–¹å¼éƒ½å¯ä»¥ï¼Œä½†æ˜¯ç±»ä¼¼ä¸Šé¢çš„dog.heightåµŒå¥—çš„æ–¹å¼å¿…é¡»é€šè¿‡KeyPathçš„æ–¹å¼èµ‹å€¼ã€‚</p><h4 id="KVCåŸç†"><a href="#KVCåŸç†" class="headerlink" title="KVCåŸç†"></a>KVCåŸç†</h4><p>è¿›å…¥Foundationé‡Œé¢æŸ¥çœ‹ <code>- (void)setValue:(nullable id)value forKey:(NSString *)key;</code> æ–¹æ³•çš„æ³¨è§£å¯ä»¥äº†è§£åˆ°ï¼Œ<strong><code>KVCçš„èµ‹å€¼æ­¥éª¤</code></strong> å¦‚ä¸‹å›¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: è°ƒç”¨setValueï¼šforKey</span><br><span class="line">e_findSucceed=&gt;end: ä¼ é€’å‚æ•°ï¼Œè°ƒç”¨æ–¹æ³•</span><br><span class="line">op1=&gt;operation: Operation1</span><br><span class="line">sub1=&gt;subroutine: My Subroutine</span><br><span class="line">cond_findMethod=&gt;condition: æŒ‰ç…§ setKeyï¼š</span><br><span class="line">_setKeyï¼š</span><br><span class="line">é¡ºåºæŸ¥æ‰¾æ–¹æ³•</span><br><span class="line">cond_instanceVariables=&gt;condition: æŸ¥çœ‹</span><br><span class="line">accessInstance</span><br><span class="line">VariablesDirectly</span><br><span class="line">ï¼ˆé»˜è®¤è¿”å›YESï¼‰</span><br><span class="line">æ–¹æ³•çš„è¿”å›å€¼</span><br><span class="line">cond_findIvar=&gt;condition: æŒ‰ç…§</span><br><span class="line">_keyã€_isKey</span><br><span class="line">keyã€isKey</span><br><span class="line">é¡ºåºæŸ¥æ‰¾</span><br><span class="line">æˆå‘˜å˜é‡</span><br><span class="line">e_findIvar=&gt;end: ç›´æ¥èµ‹å€¼</span><br><span class="line">e_exception=&gt;end: è°ƒç”¨</span><br><span class="line">setValueï¼šforUndefinedKeyï¼š</span><br><span class="line">å¹¶ä¸”æŠ›å‡º</span><br><span class="line">NSUnKnownKeyException</span><br><span class="line"></span><br><span class="line">st-&gt;cond_findMethod</span><br><span class="line">cond_findMethod(yes, bottom)-&gt;e_findSucceed</span><br><span class="line">cond_findMethod(no, right)-&gt;cond_instanceVariables</span><br><span class="line">cond_instanceVariables(yes, bottom)-&gt;cond_findIvar</span><br><span class="line">cond_findIvar(yes, bottom)-&gt;e_findIvar</span><br><span class="line">cond_instanceVariables(no, right)-&gt;e_exception</span><br><span class="line">cond_findIvar(no, right)-&gt;e_exception</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸ºmarkdownè¯­æ³•ï¼Œç”¨çš„ MWebLiteç¼–å†™çš„ï¼Œå¥ˆä½•blogä¸æ”¯æŒï¼Œæ‰€ä»¥ç›´æ¥å°†ç»“æœå¯¼å›¾æˆªå›¾è´´åœ¨ä¸‹é¢ï¼š<br><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ftgaf779vdj315m10a7c9.jpg" alt=""></p><p>è¿›å…¥Foundationé‡Œé¢æŸ¥çœ‹ <code>- (nullable id)valueForKey:(NSString *)key;</code> æ–¹æ³•çš„æ³¨è§£å¯ä»¥äº†è§£åˆ°ï¼Œ<strong><code>KVCçš„å–å€¼æ­¥éª¤</code></strong> å¦‚ä¸‹å›¾ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: è°ƒç”¨valueForKeyï¼š</span><br><span class="line">e_findSucceed=&gt;end: è°ƒç”¨æ–¹æ³•</span><br><span class="line">op1=&gt;operation: Operation1</span><br><span class="line">sub1=&gt;subroutine: My Subroutine</span><br><span class="line">cond_findMethod=&gt;condition: æŒ‰ç…§ getKey</span><br><span class="line">keyã€isKeyã€</span><br><span class="line">_keyã€_getKey</span><br><span class="line">é¡ºåºæŸ¥æ‰¾æ–¹æ³•</span><br><span class="line">cond_instanceVariables=&gt;condition: æŸ¥çœ‹</span><br><span class="line">accessInstance</span><br><span class="line">VariablesDirectly</span><br><span class="line">ï¼ˆé»˜è®¤è¿”å›YESï¼‰</span><br><span class="line">æ–¹æ³•çš„è¿”å›å€¼</span><br><span class="line">cond_findIvar=&gt;condition: æŒ‰ç…§</span><br><span class="line">_keyã€_isKey</span><br><span class="line">keyã€isKey</span><br><span class="line">é¡ºåºæŸ¥æ‰¾</span><br><span class="line">æˆå‘˜å˜é‡</span><br><span class="line">e_findIvar=&gt;end: ç›´æ¥å–å€¼</span><br><span class="line">e_exception=&gt;end: è°ƒç”¨</span><br><span class="line">valueForUndefinedKeyï¼š</span><br><span class="line">å¹¶ä¸”æŠ›å‡º</span><br><span class="line">NSUnKnownKeyException</span><br><span class="line"></span><br><span class="line">st-&gt;cond_findMethod</span><br><span class="line">cond_findMethod(yes, bottom)-&gt;e_findSucceed</span><br><span class="line">cond_findMethod(no, right)-&gt;cond_instanceVariables</span><br><span class="line">cond_instanceVariables(yes, bottom)-&gt;cond_findIvar</span><br><span class="line">cond_findIvar(yes, bottom)-&gt;e_findIvar</span><br><span class="line">cond_instanceVariables(no, right)-&gt;e_exception</span><br><span class="line">cond_findIvar(no, right)-&gt;e_exception</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ftgcd9stvjj30lx0i7mzu.jpg" alt=""></p><h4 id="æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š"><a href="#æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š" class="headerlink" title="æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š"></a>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š</h4><p><strong>setValueï¼šforKeyï¼šèµ‹å€¼</strong><br>ä½¿ç”¨ä¸Šé¢çš„Personç±»ï¼Œå°†å±æ€§å…¨éƒ¨åˆ é™¤ï¼Œæ·»åŠ ä»¥ä¸‹æˆå‘˜å˜é‡ï¼Œé‡å†™ä¸¤ä¸ªsetæ–¹æ³•ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@public</span></span><br><span class="line">    <span class="keyword">int</span> _age;</span><br><span class="line">    <span class="keyword">int</span> _isAge;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">int</span> isAge;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setAge:(<span class="built_in">NSInteger</span>)age &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"--- setAge"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)_setAge:(<span class="built_in">NSInteger</span>)age &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"--- _setAge"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç„¶åè°ƒç”¨KVCç»™ageèµ‹å€¼ï¼Œå¯ä»¥çœ‹æ‰“å°ç»“æœï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-20</span> <span class="number">14</span><span class="string">:41:18.679275+0800</span> <span class="string">KVC[65810:3455316]</span> <span class="meta">---</span> <span class="string">setAge</span></span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶è°ƒç”¨çš„æ˜¯ <code>setAge:</code> æ–¹æ³•ï¼Œæ³¨é‡Šæ‰ <code>setAge:</code> æ–¹æ³•å†æ¬¡è¿è¡Œï¼š<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="bullet">-07</span><span class="bullet">-20</span> <span class="number">14</span><span class="string">:41:43.561291+0800</span> <span class="string">KVC[65834:3456053]</span> <span class="meta">---</span> <span class="string">_setAge</span></span><br></pre></td></tr></table></figure></p><p>å½“è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ²¡æœ‰å®ç°çš„æ—¶å€™å°±ä¼šè°ƒç”¨ <code>accessInstanceVariablesDirectly</code> æ–¹æ³•ï¼Œè‹¥è¿”å›YESï¼Œåˆ™ç›´æ¥ç»™æˆå‘˜å˜é‡èµ‹å€¼ï¼Œå¦‚æ²¡æœ‰æˆ–è¿”å›å€¼ä¸ºNOåˆ™ä¼šè°ƒç”¨ <code>setValueï¼šforUndefinedKeyï¼š</code> å¹¶ä¸”æŠ›å‡ºNSUnKnownKeyExceptionå¼‚å¸¸ã€‚<br><strong>valueForKeyï¼šå–å€¼</strong><br>é‡å†™æµç¨‹å›¾ä¸­çš„getæ–¹æ³•ï¼š<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">int</span>)getAge &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)age &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">12</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)isAge &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">13</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)_age &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">14</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">int</span>)_getAge &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">15</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line">NSLog(@<span class="string">"---- %@"</span>, [person <span class="string">valueForKey:</span>@<span class="string">"age"</span>]);</span><br></pre></td></tr></table></figure></p><p>å¦‚ä¸Šæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å½“è°ƒç”¨è¿‡çš„æ–¹æ³•åå°±æ³¨é‡Šï¼Œç›´åˆ°æ‰§è¡Œå®Œæˆæ‰€æœ‰çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥æ§åˆ¶ <code>accessInstanceVariablesDirectly</code> æ–¹æ³•çš„è¿”å›å€¼æ¥è¯æ˜æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚</p><h4 id="æ€è€ƒä¸€ä¸‹KVCèƒ½è§¦å‘KVOå—ï¼Ÿ"><a href="#æ€è€ƒä¸€ä¸‹KVCèƒ½è§¦å‘KVOå—ï¼Ÿ" class="headerlink" title="æ€è€ƒä¸€ä¸‹KVCèƒ½è§¦å‘KVOå—ï¼Ÿ"></a>æ€è€ƒä¸€ä¸‹KVCèƒ½è§¦å‘KVOå—ï¼Ÿ</h4><p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œæ·»åŠ Observerç±»æ¥ç›‘å¬å¹¶è¾“å‡ºLogï¼š<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@implementation</span> Observer</span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">observeValueForKeyPath:</span>(NSString *)keyPath <span class="string">ofObject:</span>(id)object <span class="string">change:</span>(NSDictionary&lt;NSKeyValueChangeKey, id&gt; *)change <span class="string">context:</span>(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    NSLog(@<span class="string">"observeValueForKeyPath - %@"</span>, change);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@end</span></span><br><span class="line"></span><br><span class="line">æµ‹è¯•ä»£ç ï¼š</span><br><span class="line">Observer * ob = [Observer <span class="keyword">new</span>];</span><br><span class="line">Person * person = [[Person alloc] init];</span><br><span class="line">[person <span class="string">addObserver:</span>ob <span class="string">forKeyPath:</span>@<span class="string">"age"</span> <span class="string">options:</span>NSKeyValueObservingOptionOld | NSKeyValueObservingOptionNew <span class="string">context:</span>nil];</span><br><span class="line">        </span><br><span class="line">[person <span class="string">setValue:</span>@<span class="number">1</span> <span class="string">forKey:</span>@<span class="string">"age"</span>];</span><br><span class="line">[person <span class="string">removeObserver:</span>ob <span class="string">forKeyPath:</span>@<span class="string">"age"</span>];</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœä¸ºï¼š</span><br><span class="line"><span class="number">2018</span><span class="number">-07</span><span class="number">-20</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">30.526730</span>+<span class="number">0800</span> KVC[<span class="number">67145</span>:<span class="number">3507833</span>] observeValueForKeyPath - &#123;</span><br><span class="line">    kind = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">new</span> = <span class="number">1</span>;</span><br><span class="line">    old = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°KVCç¡®å®è°ƒç”¨äº†KVOï¼Œ<a href="https://jueying-xiangfeng.github.io/2018/07/17/KVO-KVC%E7%9A%84%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-KVO%E7%AF%87/" target="_blank" rel="noopener">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­æˆ‘ä»¬äº†è§£åˆ°äº†KVOçš„å®ç°ï¼Œæ¥ä¸‹æ¥å¯ä»¥å¤§æ¦‚éªŒè¯ä¸€ä¸‹ï¼š<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">åœ¨Personç±»ä¸­å®ç°å¦‚ä¸‹æ–¹æ³•ï¼š</span><br><span class="line">- (void)willChangeValueForKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@<span class="string">"willChangeValueForKey"</span>)<span class="comment">;</span></span><br><span class="line">    [super willChangeValueForKey:key]<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)<span class="keyword">didChangeValueForKey:(NSString </span>*)key &#123;</span><br><span class="line">    NSLog(@<span class="string">"didChangeValueForKey-- begin"</span>)<span class="comment">;</span></span><br><span class="line">    [super <span class="keyword">didChangeValueForKey:key];</span></span><br><span class="line"><span class="keyword"> </span>   NSLog(@<span class="string">"didChangeValueForKey-- end"</span>)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line"><span class="number">2018</span>-07-20 <span class="number">15</span>:<span class="number">23</span>:<span class="number">34</span>.<span class="number">761496</span>+<span class="number">0800</span> KVC[<span class="number">67256</span>:<span class="number">3513685</span>] willChangeValueForKey</span><br><span class="line"><span class="number">2018</span>-07-20 <span class="number">15</span>:<span class="number">23</span>:<span class="number">34</span>.<span class="number">761836</span>+<span class="number">0800</span> KVC[<span class="number">67256</span>:<span class="number">3513685</span>] <span class="keyword">didChangeValueForKey-- </span><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">2018-07-20 </span><span class="number">15</span>:<span class="number">23</span>:<span class="number">34</span>.<span class="number">762151</span>+<span class="number">0800</span> KVC[<span class="number">67256</span>:<span class="number">3513685</span>] observeValueForKeyPath - &#123;</span><br><span class="line">    kind = <span class="number">1</span><span class="comment">;</span></span><br><span class="line">    new = <span class="number">1</span><span class="comment">;</span></span><br><span class="line">    old = <span class="number">0</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2018</span>-07-20 <span class="number">15</span>:<span class="number">23</span>:<span class="number">34</span>.<span class="number">762202</span>+<span class="number">0800</span> KVC[<span class="number">67256</span>:<span class="number">3513685</span>] <span class="keyword">didChangeValueForKey-- </span>end</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°æ‰“å°ç»“æœè·ŸKVOæ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå¯ä»¥çŒœæµ‹è‹¹æœå¤§å¤§åœ¨KVCå†…éƒ¨çš„å®ç°ï¼š<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">person willChangeValueForKey:@<span class="meta-string">"age"</span></span>];</span><br><span class="line">person-&gt;_age = <span class="number">1</span>;</span><br><span class="line">[<span class="meta">person didChangeValueForKey:@<span class="meta-string">"age"</span></span>];</span><br></pre></td></tr></table></figure></p><p>KVCç›¸å½“äºæ‰‹åŠ¨è°ƒç”¨äº†KVOã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å…³äºKVCçš„æ¢ç©¶&quot;&gt;&lt;a href=&quot;#å…³äºKVCçš„æ¢ç©¶&quot; class=&quot;headerlink&quot; title=&quot;å…³äºKVCçš„æ¢ç©¶&quot;&gt;&lt;/a&gt;å…³äºKVCçš„æ¢ç©¶&lt;/h3&gt;&lt;h4 id=&quot;åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨&quot;&gt;&lt;a href=&quot;#åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨&quot;&gt;&lt;/a&gt;åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨&lt;/h4&gt;
    
    </summary>
    
    
      <category term="KVC" scheme="http://yoursite.com/tags/KVC/"/>
    
  </entry>
  
  <entry>
    <title>KVO-KVCçš„åŸç†æ¢ç©¶ - KVOç¯‡</title>
    <link href="http://yoursite.com/2018/07/17/KVO-KVC%E7%9A%84%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-KVO%E7%AF%87/"/>
    <id>http://yoursite.com/2018/07/17/KVO-KVCçš„åŸç†æ¢ç©¶-KVOç¯‡/</id>
    <published>2018-07-17T03:38:17.000Z</published>
    <updated>2020-08-15T14:28:52.633Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å…³äºKVOçš„æ¢ç©¶"><a href="#å…³äºKVOçš„æ¢ç©¶" class="headerlink" title="å…³äºKVOçš„æ¢ç©¶"></a>å…³äºKVOçš„æ¢ç©¶</h3><h4 id="KVOçš„åŸºæœ¬ä½¿ç”¨"><a href="#KVOçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="KVOçš„åŸºæœ¬ä½¿ç”¨"></a>KVOçš„åŸºæœ¬ä½¿ç”¨</h4><a id="more"></a><p>åˆ›å»ºPersonç±»ï¼Œæ·»åŠ å±æ€§ageï¼š</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: NSObject</span><br><span class="line"><span class="variable">@property</span> (nonatomic, assign) NSInteger age;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure><p>åœ¨ViewControllerä¸­æ·»åŠ å±æ€§<code>@property (nonatomic, strong) Person * person1;</code><br>å®ä¾‹åŒ–å¹¶æ·»åŠ KVOè§‚å¯Ÿageå±æ€§ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.person1 = [[Person alloc] init];    </span><br><span class="line"><span class="keyword">self</span>.person1.age = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSKeyValueObservingOptions</span> options = <span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span>;</span><br><span class="line">[<span class="keyword">self</span>.person1 addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"age"</span> options:options context:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure></p><p>æ·»åŠ è§‚å¯Ÿç›‘å¬å›è°ƒå¹¶æ‰“å°ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"è¢«ç›‘å¬çš„ %@ çš„å€¼ %@ æ”¹å˜ä¸º %@"</span>, object, keyPath, change);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶å‡†å¤‡å·¥ä½œå®Œæˆï¼Œå½“ç‚¹å‡»viewæ—¶å°±ä¼šä¿®æ”¹ageçš„å€¼ï¼Œå¹¶ä¸”å›è°ƒæ‰“å°å‡ºç›‘å¬çš„ç»“æœï¼Œè¿™é‡Œåœ¨ViewControllerçš„touchedBeganä¸­ä¿®æ”¹å€¼ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="keyword">self</span>.person.age = <span class="number">11</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è®°å¾—åœ¨æœ€åç§»é™¤é”®å€¼è§‚å¯Ÿ<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [self.person1 <span class="string">removeObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"age"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»¥ä¸Šä¸ºKVOçš„åŸºæœ¬ä½¿ç”¨ã€‚</p><h4 id="å…³äºKVOçš„ç–‘é—®å’Œåˆ†æ"><a href="#å…³äºKVOçš„ç–‘é—®å’Œåˆ†æ" class="headerlink" title="å…³äºKVOçš„ç–‘é—®å’Œåˆ†æ"></a>å…³äºKVOçš„ç–‘é—®å’Œåˆ†æ</h4><p>å†æ¬¡æ·»åŠ å±æ€§ <code>@property (nonatomic, strong) Person * person2;</code><br>å®ä¾‹åŒ–person2ï¼Œåœ¨touchedBeganæ–¹æ³•ä¸­ä¿®æ”¹å€¼ä½†æ˜¯ä¸æ·»åŠ KVOï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.person2 = [[Person alloc] init];</span><br><span class="line"><span class="keyword">self</span>.person2.age = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="keyword">self</span>.person.age = <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">self</span>.person1.age = <span class="number">22</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç‚¹å‡»viewå¯ä»¥çœ‹åˆ°æ‰“å°å°çš„æ—¥å¿—ä¸ºï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-17</span> <span class="number">14</span>:<span class="number">09</span>:<span class="number">26.944619</span>+<span class="number">0800</span> KVO-KVC[<span class="number">36344</span>:<span class="number">935709</span>] è¢«ç›‘å¬çš„ &lt;Person: <span class="number">0</span>x6<span class="number">040000106d0</span>&gt; çš„å€¼ age æ”¹å˜ä¸º &#123;</span><br><span class="line">    kind = <span class="number">1</span><span class="comment">;</span></span><br><span class="line">    new = <span class="number">11</span><span class="comment">;</span></span><br><span class="line">    old = <span class="number">1</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥æ€è€ƒéƒ½æ˜¯ä¿®æ”¹ageå±æ€§å€¼ï¼Œä¸ºä»€ä¹ˆperson1ä¼šæœ‰å›è°ƒè€Œperson2æ²¡æœ‰ï¼Œä¿®æ”¹çš„æœ¬è´¨éƒ½æ˜¯è°ƒç”¨ageçš„setæ–¹æ³•ã€‚çŒœæƒ³person1å’Œperson2çš„setæ–¹æ³•å®ç°å¯èƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯å®ä¾‹æ–¹æ³•éƒ½æ˜¯å­˜æ”¾åœ¨classä¸­çš„ï¼Œsetæ–¹æ³•åº”è¯¥æ˜¯ä¸€æ ·çš„æ‰å¯¹ï¼Œåœ¨<code>touchesBeganå¤„æ‰“æ–­ç‚¹</code>ï¼Œç„¶åç›´æ¥æŸ¥çœ‹person1å’Œperson2çš„isaæŒ‡é’ˆï¼Œçœ‹çœ‹person1å’Œperson2çš„classæ˜¯å¦ä¸€æ ·ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(lldb) <span class="selector-tag">p</span> self<span class="selector-class">.person1</span><span class="selector-class">.isa</span></span><br><span class="line">(Class) $<span class="number">0</span> = NSKVONotifying_Person</span><br><span class="line">  Fix-it applied, fixed expression was: </span><br><span class="line">    self.person1-&gt;isa</span><br><span class="line">(lldb) <span class="selector-tag">p</span> self<span class="selector-class">.person2</span><span class="selector-class">.isa</span></span><br><span class="line">(Class) $<span class="number">1</span> = Person</span><br><span class="line">  Fix-it applied, fixed expression was: </span><br><span class="line">    self.person2-&gt;isa</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°person1çš„classä¸º <code>NSKVONotifying_Person</code> person2çš„classä¸º <code>Person</code> ï¼ŒisaæŒ‡é’ˆæŒ‡å‘çš„å°±æ˜¯instanceçš„classï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆperson1å’Œperson2ä¼šä¸ä¸€æ ·å‘¢ï¼Ÿæˆ‘ä»¬åœ¨æ·»åŠ é”®å€¼è§‚å¯Ÿä¹‹å‰å’Œä¹‹ååˆ†åˆ«æ‰“å°personçš„ç±»å‹ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"æ·»åŠ å‰ person1 : %@    person2 : %@"</span>, object_getClass(<span class="keyword">self</span>.person1), object_getClass(<span class="keyword">self</span>.person2));</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSKeyValueObservingOptions</span> options = <span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span>;</span><br><span class="line">    [<span class="keyword">self</span>.person1 addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"age"</span> options:options context:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"æ·»åŠ å person1 : %@    person2 : %@"</span>, object_getClass(<span class="keyword">self</span>.person1), object_getClass(<span class="keyword">self</span>.person2));</span><br></pre></td></tr></table></figure></p><p>æ‰“å°çš„ç»“æœä¸º</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="selector-tag">-07-17</span> 14<span class="selector-pseudo">:40</span><span class="selector-pseudo">:59.918227+0800</span> <span class="selector-tag">KVO-KVC</span><span class="selector-attr">[37038:970983]</span> æ·»åŠ å‰ <span class="selector-tag">person1</span> : <span class="selector-tag">Person</span>    <span class="selector-tag">person2</span> : <span class="selector-tag">Person</span></span><br><span class="line">2018<span class="selector-tag">-07-17</span> 14<span class="selector-pseudo">:40</span><span class="selector-pseudo">:59.918636+0800</span> <span class="selector-tag">KVO-KVC</span><span class="selector-attr">[37038:970983]</span> æ·»åŠ å <span class="selector-tag">person1</span> : <span class="selector-tag">NSKVONotifying_Person</span>    <span class="selector-tag">person2</span> : <span class="selector-tag">Person</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ·»åŠ é”®å€¼è§‚å¯Ÿä¹‹åperson1çš„isaæŒ‡é’ˆæŒ‡å‘ç¡®å®è¢«ä¿®æ”¹äº†ï¼ŒæŒ‡å‘äº† <code>NSKVONotifying_Person</code> ç±»ï¼Œç»“åˆä¸Šé¢çš„çŒœæƒ³ï¼Œä¼šä¸ä¼šæ˜¯ <code>NSKVONotifying_Person</code> è¿™ä¸ªç±»é‡æ–°å®ç°äº†person1çš„ <code>setAge:</code> ï¼Œå¦åˆ™æ€ä¹ˆä¼šå’Œperson2ä¸ä¸€æ ·å‘¢ï¼Ÿ<br>æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼Œé€šè¿‡ <code>methodForSelector:</code> æ¥è·å– <code>setAge:</code> çš„å®ç°ï¼š<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">NSLog</span>(@<span class="string">"æ·»åŠ å‰ person1 : %p    person2 : %p"</span>,</span><br><span class="line">          [self.person1 <span class="attribute">methodForSelector</span>:<span class="variable">@selector</span>(<span class="attribute">setAge</span>:)],</span><br><span class="line">          [self.person2 <span class="attribute">methodForSelector</span>:<span class="variable">@selector</span>(<span class="attribute">setAge</span>:)]);</span><br><span class="line">          </span><br><span class="line"><span class="selector-tag">NSLog</span>(@<span class="string">"æ·»åŠ å person1 : %p    person2 : %p"</span>,</span><br><span class="line">          [self.person1 <span class="attribute">methodForSelector</span>:<span class="variable">@selector</span>(<span class="attribute">setAge</span>:)],</span><br><span class="line">          [self.person2 <span class="attribute">methodForSelector</span>:<span class="variable">@selector</span>(<span class="attribute">setAge</span>:)]);</span><br></pre></td></tr></table></figure></p><p>æ‰“å°çš„ç»“æœä¸º</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018-07-17</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">56.489956</span>+<span class="number">0800</span> KVO-KVC[<span class="number">37183</span>:<span class="number">978368</span>] æ·»åŠ å‰ person1 : <span class="number">0x102493570</span>    person2 : <span class="number">0x102493570</span></span><br><span class="line"><span class="number">2018-07-17</span> <span class="number">14</span>:<span class="number">46</span>:<span class="number">56.490699</span>+<span class="number">0800</span> KVO-KVC[<span class="number">37183</span>:<span class="number">978368</span>] æ·»åŠ å person1 : <span class="number">0</span>x1027d9bf4    person2 : <span class="number">0x102493570</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“instanceçš„æ–¹æ³•ã€å±æ€§ã€åè®®ç­‰ä¿¡æ¯éƒ½å­˜åœ¨ä¸classä¸­ï¼Œæ‰€ä»¥å½“person1å’Œperson2è°ƒç”¨ <code>setAge:</code> æ—¶å¾—åˆ°çš„åœ°å€åº”è¯¥æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯åœ¨æ·»åŠ é”®å€¼è§‚å¯Ÿä¹‹åperson1çš„è°ƒç”¨æ–¹æ³•åœ°å€æ”¹å˜äº†ï¼Œä¸ºä»€ä¹ˆä¼šæ”¹å˜å‘¢ï¼Ÿè®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªåœ°å€çš„IMPï¼Œåœ¨æ·»åŠ é”®å€¼è§‚å¯Ÿä¹‹åæ–­ç‚¹ï¼Œç›´æ¥æŸ¥çœ‹ä¸¤ä¸ªåœ°å€çš„IMPï¼š</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">(lldb)</span> p <span class="comment">(IMP)</span><span class="number">0</span>x<span class="number">100</span>a<span class="number">43570</span></span><br><span class="line"><span class="comment">(IMP)</span> $<span class="number">0</span> = <span class="number">0</span>x<span class="number">0000000100</span>a<span class="number">43570</span> <span class="comment">(KVO-KVC -[Person setAge:] at Person.m:13)</span></span><br><span class="line"><span class="comment">(lldb)</span> p <span class="comment">(IMP)</span><span class="number">0</span>x<span class="number">100</span>d<span class="number">89</span>bf<span class="number">4</span></span><br><span class="line"><span class="comment">(IMP)</span> $<span class="number">1</span> = <span class="number">0</span>x<span class="number">0000000100</span>d<span class="number">89</span>bf<span class="number">4</span> <span class="comment">(Foundation _NSSetLongLongValueAndNotify)</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ·»åŠ é”®å€¼è§‚å¯Ÿä¹‹åè°ƒç”¨ <code>setAge:</code> æ–¹æ³•å…¶å®å°±æ˜¯è°ƒç”¨äº† <code>Foundation _NSSetLongLongValueAndNotify</code> </p><p>ç”±æ­¤å¯ä»¥çŒœæµ‹åœ¨æ·»åŠ é”®å€¼è§‚å¯Ÿä¹‹åperson1çš„isaæŒ‡å‘äº†æ–°ç”Ÿæˆçš„ç±» <code>NSKVONotifying_Person</code> ï¼Œ<code>NSKVONotifying_Person</code> å¯èƒ½ç»§æ‰¿è‡ª <code>Person</code> ç±»ï¼Œå¹¶ä¸”é‡å†™äº† <code>setAge:</code> æ–¹æ³•ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="string">setAge:</span>(NSInteger)age &#123;</span><br><span class="line">    _NSSetLongLongValueAndNotify();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> _NSSetLongLongValueAndNotify() &#123;</span><br><span class="line">    [self <span class="string">willChangeValueForKey:</span>@<span class="string">"age"</span>];</span><br><span class="line">    [<span class="keyword">super</span> <span class="string">setAge:</span>age];</span><br><span class="line">    [self <span class="string">didChangeValueForKey:</span>@<span class="string">"age"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)<span class="string">didChangeValueForKey:</span>(NSString *)key &#123;</span><br><span class="line">    [observer <span class="string">observeValueForKeyPath:</span>key <span class="string">ofObject:</span>self <span class="string">change:</span>opetions <span class="string">context:</span>nil];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>ç»¼ä¸Šæˆ‘ä»¬çš„çŒœæƒ³KVOçš„å®ç°ï¼šinstanceæ·»åŠ é”®å€¼è§‚å¯Ÿä¹‹åisaæŒ‡é’ˆä¼šè¢«ä¿®æ”¹ä¸ºæŒ‡å‘ <code>NSKVONotifying_Person</code> ï¼Œ<code>NSKVONotifying_Person</code> ç»§æ‰¿è‡ª <code>Person</code> å¹¶ä¸”é‡å†™äº† <code>setAge:</code> æ–¹æ³•ï¼Œæ–¹æ³•å®ç°å¦‚ä¸Šã€‚</strong><br>åœ¨è¿™é‡Œå°±æœ‰äº†é‚£é“æœ€ç»å…¸çš„é¢è¯•é¢˜ï¼š<strong>å¦‚ä½•æ‰‹åŠ¨å®ç°KVO</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä¿®æ”¹å€¼çš„æ—¶å€™æ›¿æ¢ <code>_NSSetLongLongValueAndNotify</code> æ–¹æ³•é‡Œé¢çš„ <code>[super setAge:age];</code> å°±å¥½äº†ã€‚</p><h4 id="KVOå†…éƒ¨å®ç°çª¥æ¢"><a href="#KVOå†…éƒ¨å®ç°çª¥æ¢" class="headerlink" title="KVOå†…éƒ¨å®ç°çª¥æ¢"></a>KVOå†…éƒ¨å®ç°çª¥æ¢</h4><p>ç”±ä¸Šæˆ‘ä»¬çŒœæµ‹å‡ºäº†KVOçš„å®ç°åŸç†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç»§ç»­æ¢ç´¢ä¸€ä¸‹KVOå†…éƒ¨çš„å®ç°ã€‚<br>æˆ‘ä»¬åˆ†åˆ«åœ¨æ·»åŠ KVOå‰åæ‰“å°person1å’Œperson2çš„classï¼Œè¿™æ¬¡æˆ‘ä»¬ç”¨ä¸¤ç§æ–¹å¼ï¼š<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"æ·»åŠ å‰ person1 : %@ -- %@   person2 : %@ -- %@"</span>, [<span class="keyword">self</span>.person1 <span class="keyword">class</span>], object_getClass(<span class="keyword">self</span>.person1), [<span class="keyword">self</span>.person2 <span class="keyword">class</span>], object_getClass(<span class="keyword">self</span>.person2));</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"æ·»åŠ å person1 : %@ -- %@   person2 : %@ -- %@"</span>, [<span class="keyword">self</span>.person1 <span class="keyword">class</span>], object_getClass(<span class="keyword">self</span>.person1), [<span class="keyword">self</span>.person2 <span class="keyword">class</span>], object_getClass(<span class="keyword">self</span>.person2));</span><br></pre></td></tr></table></figure></p><p>æ‰“å°å‡ºçš„ç»“æœä¸ºï¼š<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2018-07-19 11:05:50.553735+0800 KVO-KVC<span class="comment">[40616:2560144]</span> æ·»åŠ å‰ person1 : <span class="keyword">Person</span> -- <span class="keyword">Person</span>   person2 : <span class="keyword">Person</span> -- <span class="keyword">Person</span></span><br><span class="line">2018-07-19 11:05:52.772905+0800 KVO-KVC<span class="comment">[40616:2560144]</span> æ·»åŠ å person1 : <span class="keyword">Person</span> -- NSKVONotifying_Person   person2 : <span class="keyword">Person</span> -- <span class="keyword">Person</span></span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šå¸¸ç”¨æ¥è·å–classçš„æ–¹æ³•åœ¨æ·»åŠ å‰åç»“æœéƒ½æ˜¯ <code>Person</code> ï¼Œé€šè¿‡runtime APIè·å–åˆ°çš„classä¸ç›¸åŒï¼Œæ€ä¹ˆå›äº‹å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹è‹¹æœå®˜æ–¹runtimeçš„æºç  <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener"><strong>è¿™é‡Œ</strong></a>ï¼Œå½“ç„¶å®˜æ–¹çš„ç¼–è¯‘æ˜¯å¤±è´¥ï¼Œè¦æƒ³è°ƒè¯•runtimeçš„è¯·çœ‹ <a href="https://github.com/RetVal/objc-runtime" target="_blank" rel="noopener"><strong>è¿™é‡Œ</strong></a>ã€‚<br>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æºç ï¼š<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>æ–¹æ³•ï¼š</span></span><br><span class="line"></span><br><span class="line">+ (Class)<span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)<span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> object_getClass(self);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">runtime object_getClassæ–¹æ³•ï¼š</span><br><span class="line"></span><br><span class="line">Class object_getClass(id obj) &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj) <span class="keyword">return</span> obj-&gt;getIsa();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> Nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>class</code> çš„ç±»æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•æœ€ç»ˆè¿”å›çš„éƒ½æ˜¯classçš„selfï¼Œè€Œ <code>object_getClass</code> æ–¹æ³•è¿”å›çš„æ˜¯objçš„isaæŒ‡é’ˆï¼Œæ‰€ä»¥é€šè¿‡ <code>object_getClass</code> è·å–çš„æ‰æ˜¯å½“å‰objçš„çœŸæ­£classï¼Œæ‰€ä»¥åœ¨æ·»åŠ KVOä¹‹åperson1çš„isaæŒ‡é’ˆç¡®ç¡®å®å®æ˜¯è¢«ä¿®æ”¹äº†ã€‚<br>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ•æ‰åˆ°çš„ <code>NSKVONotifying_Person</code> åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Ÿ<br>å…ˆæ¥çœ‹ä¸€ä¸‹ <code>NSKVONotifying_Person</code> çš„meta-classï¼š<br><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSLog(@<span class="string">"å…ƒç±»å¯¹è±¡ person : %@    person1 : %@"</span>,</span><br><span class="line">          <span class="keyword">object</span><span class="number">_</span>getClass(<span class="keyword">object</span><span class="number">_</span>getClass(self.person<span class="number">1</span>)),</span><br><span class="line">          <span class="keyword">object</span><span class="number">_</span>getClass(<span class="keyword">object</span><span class="number">_</span>getClass(self.person<span class="number">2</span>)));</span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line"><span class="number">2018</span>-<span class="number">07</span>-<span class="number">19</span> <span class="number">11</span>:<span class="number">39</span>:<span class="number">30.2</span><span class="number">10378</span>+<span class="number">0800</span> KVO-KVC[<span class="number">41164</span>:<span class="number">2599225</span>] å…ƒç±»å¯¹è±¡ person : NSKVONotifying<span class="number">_P</span>erson    person<span class="number">1</span> : Person</span><br></pre></td></tr></table></figure></p><p><code>NSKVONotifying_Person</code> çš„meta-classä¸º <code>NSKVONotifying_Person</code>ã€‚</p><p>åœ¨æ·»åŠ KVOä¹‹åæ‰“ä½æ–­ç‚¹ï¼Œå€Ÿç”¨ <strong><a href="https://github.com/delebedev/DLIntrospection" target="_blank" rel="noopener">DLIntrospection</a></strong> å†æ¥æŸ¥çœ‹ä¸€ä¸‹æ­¤æ—¶classé‡Œé¢æ–¹æ³•éƒ½æœ‰ä»€ä¹ˆï¼š<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po [[self.person1 class] instanceMethods]</span><br><span class="line">&lt;__NSArrayI 0x60400023daa0&gt;(</span><br><span class="line">-<span class="ruby"> (void)<span class="symbol">setAge:</span>(q)arg<span class="number">0</span> ,</span></span><br><span class="line"><span class="ruby">- (q)age</span></span><br><span class="line"><span class="ruby">)</span></span><br><span class="line"><span class="ruby">(lldb) po [object_getClass(<span class="keyword">self</span>.person1) instanceMethods]</span></span><br><span class="line"><span class="ruby">&lt;__NSArrayI <span class="number">0x60400025fb30</span>&gt;(</span></span><br><span class="line"><span class="ruby">- (void)<span class="symbol">setAge:</span>(q)arg<span class="number">0</span> ,</span></span><br><span class="line"><span class="ruby">- (<span class="class"><span class="keyword">class</span>)<span class="title">class</span>,</span></span></span><br><span class="line"><span class="ruby">- (void)dealloc,</span></span><br><span class="line"><span class="ruby">- (BOOL)_isKVOA</span></span><br><span class="line"><span class="ruby">)</span></span><br></pre></td></tr></table></figure></p><p>ç»“æœå¯ä»¥çœ‹åˆ° <code>NSKVONotifying_Person</code> é‡å†™äº† <code>setAge:</code> æ–¹æ³•ï¼Œå¹¶ä¸”è¿˜æœ‰å…¶ä»–çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œå¯è¯ä¸Šé¢çš„çŒœæƒ³ç¡®å®æ²¡é”™ï¼Œ<code>NSKVONotifying_Person</code>é‡å†™äº† <code>setAge:</code> æ–¹æ³•ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªä¸Šé¢çš„çŒœæƒ³æ²¡æœ‰éªŒè¯ï¼Œé‚£å°±æ˜¯ <code>NSKVONotifying_Person</code> çš„superClassåˆ°åº•æ˜¯è°ï¼Ÿ<br>ç±»ä¼¼isaæŒ‡é’ˆçš„æ–¹å¼ï¼Œæˆ‘ä»¬æ–­ç‚¹ç›´æ¥æ‰“å°ï¼š<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po self<span class="selector-class">.person1</span><span class="selector-class">.superclass</span></span><br><span class="line">NSObject</span><br><span class="line"></span><br><span class="line">(lldb) po self<span class="selector-class">.person2</span><span class="selector-class">.superclass</span></span><br><span class="line">NSObject</span><br></pre></td></tr></table></figure></p><p>å’¦~~~ ç­‰ç­‰ï¼Œè¿™è·Ÿæˆ‘ä»¬çŒœæµ‹çš„ä¸ä¸€æ ·å•Šï¼Œæ€ä¹ˆsuperclasséƒ½æ˜¯NSObjectå‘¢ï¼Ÿé‚£æˆ‘ä»¬çš„çŒœæµ‹æ˜¯ä¸æ˜¯éƒ½é”™äº†ï¼Ÿ<br>ä¸ºäº†çœ‹çœ‹superClassé‡Œé¢åˆ°åº•æ˜¯ä»€ä¹ˆä¸‹é¢æˆ‘ä»¬è¯·å‡º <code>clang</code> å¤§ç¥ï¼š<br><code>clang -rewrite-objc Person.m</code><br>å¯ä»¥çœ‹å‡ºç¼–è¯‘å®ŒæˆåPersonç±»è¢«ç¼–è¯‘æˆäº†è¿™æ ·ï¼š<br><figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NSObject_IMPL</span> </span>&#123;</span><br><span class="line">    Class isa;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person_IMPL</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">NSObject_IMPL</span> NSObject_IVARS;</span></span><br><span class="line"><span class="class">    NSInteger _age;</span></span><br><span class="line"><span class="class">&#125;;</span></span><br></pre></td></tr></table></figure></p><p>ç»“åˆruntimeæºç åˆ†æï¼ŒClassä¸º <code>typedef struct objc_class *Class;</code> ç±»å‹çš„ç»“æ„ä½“ï¼Œå†çœ‹ä¸‹ç»“æ„ä½“é‡Œé¢çš„ç»“æ„ï¼š<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">isa_t</span> isa;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="keyword">cache_t</span> cache;</span><br><span class="line">    <span class="keyword">class_data_bits_t</span> bits;</span><br><span class="line">    Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é‡Œé¢ç¡®å®æœ‰superclassï¼Œä»¿ç…§runtimeçš„ç»“æ„æˆ‘ä»¬è‡ªå·±æ¥åˆ›å»ºä¸€ä¸ªç±»ä¼¼çš„ç»“æ„ä½“ï¼š<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct XFPerson_IMPL &#123;</span><br><span class="line">    Class isa<span class="comment">;</span></span><br><span class="line">    Class super_Class<span class="comment">;</span></span><br><span class="line">    NSInteger _age<span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure></p><p>ç”¨æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ç»“æ„ä½“æ¥æ¥æ”¶ <code>NSKVONotifying_Person</code> ï¼Œçœ‹çœ‹ä»–çš„superclassåˆ°åº•æ˜¯ä»€ä¹ˆç±»å‹ï¼š<br><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">XFPerson_IMPL</span></span> * xfPerson1 = (__bridge <span class="class"><span class="keyword">struct</span> <span class="title">XFPerson_IMPL</span></span> *)(object_getClass(<span class="keyword">self</span>.person1));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">XFPerson_IMPL</span></span> * xfPerson2 = (__bridge <span class="class"><span class="keyword">struct</span> <span class="title">XFPerson_IMPL</span></span> *)(object_getClass(<span class="keyword">self</span>.person2));</span><br><span class="line"></span><br><span class="line">NSLog(@<span class="string">"person1--- %@"</span>, xfPerson1-&gt;super_Class);</span><br><span class="line">NSLog(@<span class="string">"person2--- %@"</span>, xfPerson2-&gt;super_Class);</span><br><span class="line"></span><br><span class="line">æ‰“å°ç»“æœï¼š</span><br><span class="line"><span class="number">2018</span>-<span class="number">07</span>-<span class="number">19</span> <span class="number">14</span>:<span class="number">05</span>:<span class="number">38.855549</span>+<span class="number">0800</span> KVO-KVC[<span class="number">43578</span>:<span class="number">2717734</span>] person1--- Person</span><br><span class="line"><span class="number">2018</span>-<span class="number">07</span>-<span class="number">19</span> <span class="number">14</span>:<span class="number">05</span>:<span class="number">38.855658</span>+<span class="number">0800</span> KVO-KVC[<span class="number">43578</span>:<span class="number">2717734</span>] person2--- NSObject</span><br></pre></td></tr></table></figure></p><p>ç»“æœå¯è§æ˜¯ç¬¦åˆæˆ‘ä»¬çš„çŒœæƒ³çš„ï¼Œ<code>NSKVONotifying_Person</code> ç¡®å®æ˜¯Personçš„å­ç±»ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢ç›´æ¥æ‰“å°instanceçš„superclasså´éƒ½æ˜¯NSObjectå‘¢ï¼Ÿ<br>å›è¿‡å¤´æ¥çœ‹ä¸€ä¸‹ä¸Šé¢æˆ‘ä»¬æ‰¾åˆ°çš„ <code>NSKVONotifying_Person</code> é™¤äº† <code>setAge:</code> è¿˜æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­å°±æœ‰classæ–¹æ³•ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“runtimeçš„classçš„å®ç°ï¼Œclassè¿”å›çš„å°±æ˜¯selfï¼Œè€Œé€šè¿‡ <code>[self.person1 class]</code> å¾—åˆ°çš„æ˜¯ <code>Person</code> ï¼Œè¿™å°±è¯æ˜äº† <code>NSKVONotifying_Person</code> é‡å†™äº†classæ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›çš„æ˜¯ <code>Person</code> ç±»ï¼Œé€šè¿‡æºç æŸ¥çœ‹runtimeçš„superclassæ–¹æ³•çš„å®ç°ï¼š<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="class"><span class="keyword">Class</span>)<span class="title">superclass</span> &#123;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">self</span>-&gt;superclass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="class"><span class="keyword">Class</span>)<span class="title">superclass</span> &#123;</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">self</span> <span class="class"><span class="keyword">class</span>]-&gt;<span class="title">superclass</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å°±æ˜¯å…ˆé€šè¿‡classæ–¹æ³•æ‰¾åˆ°classï¼Œç„¶ååœ¨æ ¹æ®classæ‰¾åˆ°superclassï¼Œæ‰€ä»¥å‰é¢ç›´æ¥é€šè¿‡ <code>self.person1.superclass</code> æ‰¾åˆ°çš„æ˜¯ <code>Person</code>ï¼Œå› ä¸ºæ­¤æ—¶çš„classæ–¹æ³•è¿”å›å·²ç»è¢«ä¿®æ”¹äº†ã€‚</p><p>è‹¹æœå¤§å¤§å¯èƒ½æ˜¯å› ä¸ºæ•´ä¸ªäº‹ä»¶ä¸­ <code>NSKVONotifying_Person</code> æ˜¯ä¸ªäººç•œæ— å®³çš„ä¸œè¥¿ï¼Œå¯¹äºå¼€å‘è€…ä½¿ç”¨KVOæ˜¯å¯ä»¥ä¸ç”¨çŸ¥é“çš„ï¼Œæ‰€ä»¥ç”¨è¿™ç§æ–¹å¼æ¥éª—éª—å¼€å‘è€…ï¼ŒçœŸä¸å®¹æ˜“ï¼Œè¿˜å¥½æœ€è¿‘çœ‹ <strong>ç™½å¤œè¿½å‡¶</strong> çœ‹çš„æ•´ä¸ªäººéƒ½æ¯”è¾ƒæœ‰è€å¿ƒäº†å°±æ˜¯è¦æ‰¾åˆ°çœŸç›¸ï¼Œå“ˆ(ä¸)å“ˆ(è¦)å“ˆ(è„¸)ğŸ˜ã€‚<br>å†çœ‹çœ‹çœ‹å…¶ä»–çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œ<code>dealloc</code> æ–¹æ³•å¯èƒ½å°±æ˜¯åšä¸€äº›é”€æ¯ç°åœºçš„äº‹æƒ…ï¼Œæ¯•ç«Ÿä¸­é—´åŠ¨æ€åˆ›å»ºäº† <code>NSKVONotifying_Person</code> ï¼Œä¸ç”¨äº†ä¸€å®šè¦é”€æ¯ï¼Œè€Œ   <code>_isKVOA</code> è¿”å›çš„ä¸€å®šæ˜¯ YES ï¼Œè¡¨ç¤ºå½“å‰ç¡®å®æ˜¯åœ¨ç”¨KVOï¼Œåˆ°æ­¤å…³äºKVOçš„é»‘ç§‘æŠ€å·²ç»æ¢ç©¶æ˜ç™½äº†ï¼Œå¥½äº†ï¼Œæ‰“å®Œæ”¶å·¥ï¼Œæ¥ç€å»çœ‹ä¸¤é›† <strong>ç™½å¤œè¿½å‡¶</strong>ï¼Œ å“ˆå“ˆå“ˆã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å…³äºKVOçš„æ¢ç©¶&quot;&gt;&lt;a href=&quot;#å…³äºKVOçš„æ¢ç©¶&quot; class=&quot;headerlink&quot; title=&quot;å…³äºKVOçš„æ¢ç©¶&quot;&gt;&lt;/a&gt;å…³äºKVOçš„æ¢ç©¶&lt;/h3&gt;&lt;h4 id=&quot;KVOçš„åŸºæœ¬ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#KVOçš„åŸºæœ¬ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;KVOçš„åŸºæœ¬ä½¿ç”¨&quot;&gt;&lt;/a&gt;KVOçš„åŸºæœ¬ä½¿ç”¨&lt;/h4&gt;
    
    </summary>
    
    
      <category term="KVO" scheme="http://yoursite.com/tags/KVO/"/>
    
  </entry>
  
</feed>
