<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>block5-block内存管理 | 白夜追凶</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">block5-block内存管理</h1><a id="logo" href="/.">白夜追凶</a><p class="description">Talk is cheap. Show me the code.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">block5-block内存管理</h1><div class="post-meta">2020年07月06日</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#block-内存管理"><span class="toc-number">1.</span> <span class="toc-text">block 内存管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#结论总结"><span class="toc-number">1.1.</span> <span class="toc-text">结论总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#block-的-forwarding-指针"><span class="toc-number">2.</span> <span class="toc-text">block 的 forwarding 指针</span></a></li></ol></div></div><div class="post-content"><h3 id="block-内存管理"><a href="#block-内存管理" class="headerlink" title="block 内存管理"></a>block 内存管理</h3><p>测试代码：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NSObject * object = [[NSObject alloc] init]<span class="comment">;</span></span><br><span class="line">__block NSObject * <span class="keyword">blockObject </span>= [[NSObject alloc] init]<span class="comment">;</span></span><br><span class="line">void (^<span class="keyword">block)(void) </span>= ^&#123;</span><br><span class="line">  NSLog(@<span class="string">"--- %@"</span>, object)<span class="comment">;</span></span><br><span class="line">  NSLog(@<span class="string">"--- %@"</span>, <span class="keyword">blockObject);</span></span><br><span class="line"><span class="keyword">&#125;;</span></span><br><span class="line"><span class="keyword">block(); </span></span><br><span class="line">NSLog(@<span class="string">"----"</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>查看 cpp 文件代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __Block_byref_blockObject_0 &#123;</span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_blockObject_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_copy)(<span class="keyword">void</span>*, <span class="keyword">void</span>*);</span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_dispose)(<span class="keyword">void</span>*);</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/// 最终被捕获到的 blockObject 变量</span></span><br><span class="line"> <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> blockObject;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> object;</span><br><span class="line">  __Block_byref_blockObject_0 *blockObject; <span class="comment">// by ref</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> _object, __Block_byref_blockObject_0 *_blockObject, <span class="keyword">int</span> flags=<span class="number">0</span>) : object(_object), blockObject(_blockObject-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    </span><br><span class="line">    __Block_byref_blockObject_0 *blockObject = __cself-&gt;blockObject; <span class="comment">// bound by ref</span></span><br><span class="line">    <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> object = __cself-&gt;object; <span class="comment">// bound by copy</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_3a341f_mi_0, object);</span><br><span class="line">    <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_3a341f_mi_1, (blockObject-&gt;__forwarding-&gt;blockObject));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;</span><br><span class="line">    </span><br><span class="line">    _Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;object, (<span class="keyword">void</span>*)src-&gt;object, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);</span><br><span class="line">    _Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;blockObject, (<span class="keyword">void</span>*)src-&gt;blockObject, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;</span><br><span class="line">    </span><br><span class="line">    _Block_object_dispose((<span class="keyword">void</span>*)src-&gt;object, <span class="number">3</span><span class="comment">/*BLOCK_FIELD_IS_OBJECT*/</span>);</span><br><span class="line">    _Block_object_dispose((<span class="keyword">void</span>*)src-&gt;blockObject, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*<span class="keyword">copy</span>)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> &#123; __AtAutoreleasePool __autoreleasepool;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSObject</span> * object = ((<span class="built_in">NSObject</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)((<span class="built_in">NSObject</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)objc_getClass(<span class="string">"NSObject"</span>), sel_registerName(<span class="string">"alloc"</span>)), sel_registerName(<span class="string">"init"</span>));</span><br><span class="line"></span><br><span class="line">        __attribute__((__blocks__(<span class="keyword">byref</span>))) __Block_byref_blockObject_0 blockObject = &#123;</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            (__Block_byref_blockObject_0 *)&amp;blockObject,</span><br><span class="line">            <span class="number">33554432</span>, <span class="keyword">sizeof</span>(__Block_byref_blockObject_0),</span><br><span class="line">            __Block_byref_id_object_copy_131,</span><br><span class="line">            __Block_byref_id_object_dispose_131,</span><br><span class="line">            ((<span class="built_in">NSObject</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)((<span class="built_in">NSObject</span> *(*)(<span class="keyword">id</span>, SEL))(<span class="keyword">void</span> *)objc_msgSend)((<span class="keyword">id</span>)objc_getClass(<span class="string">"NSObject"</span>), sel_registerName(<span class="string">"alloc"</span>)), sel_registerName(<span class="string">"init"</span>))&#125;;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">void</span> (*block)(<span class="keyword">void</span>) = &amp;__main_block_impl_0(__main_block_func_0,</span><br><span class="line">                                                   &amp;__main_block_desc_0_DATA,</span><br><span class="line">                                                   object,</span><br><span class="line">                                                   (__Block_byref_blockObject_0 *)&amp;blockObject,</span><br><span class="line">                                                   <span class="number">570425344</span>));</span><br><span class="line"></span><br><span class="line">        block-&gt;FuncPtr(block);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_1x_bw2dcypj2dng06lb8qw1h8gh0000gn_T_main_3a341f_mi_2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析上面的代码可以看出，对于非 __block 修饰的 auto 变量 object 内存管理和我们 <a href="https://jueying-xiangfeng.github.io/2020/07/02/block3-%E7%B1%BB%E5%9E%8B%E3%80%81copy%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">前面</a> 讲过的 copy 过程一样：</p>
<p>持有：</p>
<blockquote>
<p>1、block 内部调用 desp 里面的 copy 函数<br>2、copy 函数会调用 <code>_Block_object_assign</code><br>3、<code>_Block_object_assign</code> 函数会根据 auto 变量修饰符的类型（<code>__strong</code>、<code>__weak</code>、<code>__unsafe_unretained</code>）做出相应的操作，形成强引用或弱引用</p>
</blockquote>
<p>销毁：</p>
<blockquote>
<p>1、block 内部调用 得搜 里面的 dispose 函数<br>2、dispose 函数会调用 <code>_Block_object_dispose</code><br>3、<code>_Block_object_dispose</code> 函数会释放引用的 auto 变量</p>
</blockquote>
<p>上面就是非 __block 修饰的对象类型的 auto 变量内存管理。</p>
<p><br></p>
<p>下面来分析下 __block 修饰的对象类型的 auto 变量内存管理：<br><a href="https://jueying-xiangfeng.github.io/2020/07/03/block3-block%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">上一节</a> 讲到了 __block 的原理，可以想到 blockObject 被包装成了一个对象，而 <code>\_\_Block\_byref\_blockObject\_0</code> 里面的 <code>NSObject *\_\_strong blockObject;</code> 就是最终被捕获的变量，可以看到这里的修饰符是 __strong，根据前面讲过的 copy 原理猜想一下这里的捕获结果可能和被修饰的 auto 变量的强弱有关，来做一个测试：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void (^<span class="keyword">block)(void);</span></span><br><span class="line"><span class="keyword">&#123;</span></span><br><span class="line"><span class="keyword"> </span> Animal * object = [[Animal alloc] init]<span class="comment">;</span></span><br><span class="line">  __block __weak Animal * weakObject = object<span class="comment">;</span></span><br><span class="line">  <span class="keyword">block </span>= ^&#123;</span><br><span class="line">      NSLog(@<span class="string">"--- %@"</span>, weakObject)<span class="comment">;</span></span><br><span class="line">  &#125;<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看打印结果，Animal 是在作用域结束后就释放了，而此时 block 还没有被释放，看下 cpp 文件的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_weakObject_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_weakObject_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_copy)(<span class="keyword">void</span>*, <span class="keyword">void</span>*);</span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_dispose)(<span class="keyword">void</span>*);</span><br><span class="line"> Animal *__weak weakObject;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>说明捕获到的确实是 __weak 的类型。</p>
<p>再来看一下上面 blockObject 被捕获对象初始化的地方，这里多了两个函数：<code>__Block_byref_id_object_copy_131</code>、<code>__Block_byref_id_object_dispose_131</code>，来看一下这两个函数的实现：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">__Block_byref_id_object_copy_131</span><span class="params">(<span class="keyword">void</span> *dst, <span class="keyword">void</span> *src)</span> </span>&#123;</span><br><span class="line"> _Block_object_assign((<span class="keyword">char</span>*)dst + <span class="number">40</span>, *(<span class="keyword">void</span> * *) ((<span class="keyword">char</span>*)src + <span class="number">40</span>), <span class="number">131</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">__Block_byref_id_object_dispose_131</span><span class="params">(<span class="keyword">void</span> *src)</span> </span>&#123;</span><br><span class="line"> _Block_object_dispose(*(<span class="keyword">void</span> * *) ((<span class="keyword">char</span>*)src + <span class="number">40</span>), <span class="number">131</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这两个方法是不是很熟悉，跟我们前面讲 copy 的时候调用的方法是一样，看下 _Block_object_assign 函数的参数：<code>(char*)dst + 40</code>，这里的 dst 就是 <code>__Block_byref_blockObject_0</code>，那么 +40 代表什么呢？看下 <code>__Block_byref_blockObject_0</code> 的结构：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __Block_byref_blockObject_0 &#123;</span><br><span class="line">  <span class="keyword">void</span> *__isa;	  <span class="number">8</span></span><br><span class="line">__Block_byref_blockObject_0 *__forwarding; <span class="number">8</span></span><br><span class="line"> <span class="keyword">int</span> __flags; <span class="number">4</span></span><br><span class="line"> <span class="keyword">int</span> __size; <span class="number">4</span></span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_copy)(<span class="keyword">void</span>*, <span class="keyword">void</span>*); <span class="number">8</span></span><br><span class="line"> <span class="keyword">void</span> (*__Block_byref_id_object_dispose)(<span class="keyword">void</span>*); <span class="number">8</span></span><br><span class="line"> <span class="built_in">NSObject</span> *__<span class="keyword">strong</span> blockObject;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>+40 的地址正好是 blockObject 的地址，所以这两个函数是用来管理 blockObject 的。</p>
<p>总结下 __block 修饰变量的内存管理：</p>
<p>持有：</p>
<blockquote>
<p>1、blockObject 被包装成 <code>__Block_byref_blockObject_0</code> 对象，<code>__Block_byref_blockObject_0</code> 对象里面持有 blockObject（blockObject 的强弱是根据自身的修饰符决定的）<br>2、<code>__main_block_impl_0</code> 持有 <code>__Block_byref_blockObject_0</code><br>3、<code>__Block_byref_blockObject_0</code> 的内存管理依赖 <code>__main_block_impl_0</code> 的 desp 的 copy 函数（<code>_Block_object_assign</code>）<br>4、blockObject 对象的内存管理依赖 <code>__Block_byref_blockObject_0</code> 的 copy 函数（<code>_Block_object_assign</code>）</p>
</blockquote>
<p>销毁：</p>
<blockquote>
<p>1、<code>__main_block_impl_0</code> 通过 desp 的 dispose 函数释放 <code>__Block_byref_blockObject_0</code>（<code>_Block_object_dispose</code>）<br>2、<code>__Block_byref_blockObject_0</code> 通过调用内部的 <code>__Block_byref_blockObject_0</code> 函数释放最终的 blockObject 对象</p>
</blockquote>
<p><br></p>
<h4 id="结论总结"><a href="#结论总结" class="headerlink" title="结论总结"></a>结论总结</h4><ul>
<li>当 block 在栈上时，对对象类型的 auto 变量、__block 变量不会产生强引用</li>
<li>当 block 被 copy 到堆上面时会通过 copy 函数来处理 (__block 变量：    _Block_object_assign((void<em>)&amp;dst-&gt;a, (void</em>)src-&gt;a, 8/<em>BLOCK_FIELD_IS_BYREF</em>/)， auto 变量：_Block_object_assign((void<em>)&amp;dst-&gt;p, (void</em>)src-&gt;p, 3/<em>BLOCK_FIELD_IS_OBJECT</em>/))</li>
<li>_Block_object_assign函数会根据所指向对象的修饰符（<strong>strong、</strong>weak、__unsafe_unretained）做出相应的操作，形成强引用（retain）或者弱引用（注意：这里仅限于ARC时会retain，MRC时不会retain）</li>
<li>当 block 从堆上移除时会调用 dispose 函数处理（__block 变量：_Block_object_dispose((void<em>)src-&gt;a, 8/</em>BLOCK_FIELD_IS_BYREF<em>/)， auto 变量：_Block_object_dispose((void</em>)src-&gt;p, 3/<em>BLOCK_FIELD_IS_OBJECT</em>/)）</li>
<li>_Block_object_dispose函数会自动释放指向的对象（release）</li>
</ul>
<h3 id="block-的-forwarding-指针"><a href="#block-的-forwarding-指针" class="headerlink" title="block 的 forwarding 指针"></a><strong>block 的 </strong>forwarding 指针</h3><p>上面 blockObject 的访问其实是：blockObject-&gt;__forwarding-&gt;blockObject，为什么这里要多一步 __forwarding 的操作呢，而且 __forwarding 还是指向自己的。<br>因为当栈上的 block copy 到堆上时，block 实际访问的其实是堆上的内存，如果这时再访问栈内存是不正确的，所以此时栈上的 __forwarding 指针会指向堆上面的内存，当访问 blockObject 的时候其实访问的是最终被 copy 到堆上面的内存，这样就不会出现访问错乱的问题。</p>
<p>可以来验证一下，使用 MRC 的环境：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSObject</span> * object = [[<span class="built_in">NSObject</span> alloc] init];     </span><br><span class="line">__block <span class="built_in">NSObject</span> * blockObject = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"--- %@"</span>, object);</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"--- %@"</span>, blockObject);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 * blockImpl = (<span class="keyword">struct</span> __main_block_impl_0 *)block;   </span><br><span class="line">[block <span class="keyword">copy</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"---- %@"</span>, blockImpl);</span><br></pre></td></tr></table></figure>
<p>此时 block 是在栈上面，来打印下此时的地址：<code>(__Block_byref_blockObject_0 *) __forwarding = 0x00007ffeefbff468</code><br>当调用完 copy 函数之后：<code>(__Block_byref_blockObject_0 *) __forwarding = 0x000000010053af80</code>，很明显，此时的地址从栈上指向了堆空间。</p>
</div><div class="tags"><a href="/tags/block-内存管理/"><i class="fa fa-tag"></i>block 内存管理</a></div><div class="post-nav"><a class="pre" href="/2020/07/06/block6-循环引用/">block6-循环引用</a><a class="next" href="/2020/07/03/block3-block原理/">block4-__block原理</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/crash-捕获/" style="font-size: 15px;">crash 捕获</a> <a href="/tags/KVC/" style="font-size: 15px;">KVC</a> <a href="/tags/block-变量捕获/" style="font-size: 15px;">block 变量捕获</a> <a href="/tags/block-类型、copy/" style="font-size: 15px;">block 类型、copy</a> <a href="/tags/block-循环引用/" style="font-size: 15px;">block 循环引用</a> <a href="/tags/category-原理/" style="font-size: 15px;">category 原理</a> <a href="/tags/block/" style="font-size: 15px;">block</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/swift/" style="font-size: 15px;">swift</a> <a href="/tags/async-to-sync/" style="font-size: 15px;">async to sync</a> <a href="/tags/KVO/" style="font-size: 15px;">KVO</a> <a href="/tags/block-原理/" style="font-size: 15px;">block 原理</a> <a href="/tags/block-内存管理/" style="font-size: 15px;">block 内存管理</a> <a href="/tags/内存管理、RunLoop、Autorelease/" style="font-size: 15px;">内存管理、RunLoop、Autorelease</a> <a href="/tags/Runtime/" style="font-size: 15px;">Runtime</a> <a href="/tags/RunLoop/" style="font-size: 15px;">RunLoop</a> <a href="/tags/内存管理/" style="font-size: 15px;">内存管理</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/09/13/Crash捕获/">Crash捕获</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/12/异步转同步/">异步转同步</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/17/swift学习/">swift学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/14/内存管理原理探究-续/">内存管理原理探究-续</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/08/内存管理原理探究/">内存管理原理探究</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/05/多线程/">多线程</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/29/RunLoop原理探究/">RunLoop原理探究</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/20/Runtime原理探究/">Runtime原理探究</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/06/block6-循环引用/">block6-循环引用</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/06/block5-block内存管理/">block5-block内存管理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/jueying-xiangfeng" title="github" target="_blank">github</a><ul></ul><a title="生活随笔-复盘(最近正在整理)" target="_blank">生活随笔-复盘(最近正在整理)</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">白夜追凶.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>