<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>å†…å­˜ç®¡ç†åŸç†æ¢ç©¶ | ç™½å¤œè¿½å‡¶</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">å†…å­˜ç®¡ç†åŸç†æ¢ç©¶</h1><a id="logo" href="/.">ç™½å¤œè¿½å‡¶</a><p class="description">Talk is cheap. Show me the code.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">å†…å­˜ç®¡ç†åŸç†æ¢ç©¶</h1><div class="post-meta">2020å¹´08æœˆ08æ—¥</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#å®šæ—¶å™¨"><span class="toc-number">1.</span> <span class="toc-text">å®šæ—¶å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#iOS-ç¨‹åºå†…å­˜å¸ƒå±€"><span class="toc-number">2.</span> <span class="toc-text">iOS ç¨‹åºå†…å­˜å¸ƒå±€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tagged-Pointer"><span class="toc-number">3.</span> <span class="toc-text">Tagged Pointer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OC-å¯¹è±¡çš„å†…å­˜ç®¡ç†"><span class="toc-number">4.</span> <span class="toc-text">OC å¯¹è±¡çš„å†…å­˜ç®¡ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copyã€mutableCopy"><span class="toc-number">5.</span> <span class="toc-text">copyã€mutableCopy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#weak-åŸç†"><span class="toc-number">6.</span> <span class="toc-text">weak åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Autorelease-åŸç†"><span class="toc-number">7.</span> <span class="toc-text">Autorelease åŸç†</span></a></li></ol></div></div><div class="post-content"><p>æœ€è¿‘æ—¶é—´æ¯”è¾ƒæ•£ï¼Œè¿˜æœ‰å°±æ˜¯å…¬å¸æ¯”è¾ƒåŠ¨è¡ğŸ˜Œï¼Œå½“åˆæ€€ç€ä¸€é¢—åšäº‹çš„å¿ƒæ¥åˆ°è¿™é‡Œï¼Œæ²¡æƒ³åˆ°æœ€åè½å¾—è¿™æ ·çš„ç»“å±€ã€‚ä¸è¯´äº†ï¼Œè¿˜æ˜¯ä¿æŒæœ¬å¿ƒæ¯”è¾ƒå¥½ï¼Œå°½ç®¡æƒ³åšå¥½é£è¯»ï¼Œä½†æ˜¯æˆ‘ä»¬å°èŒå‘˜ä¹Ÿæ”¹å˜ä¸äº†ä»€ä¹ˆã€‚åšå¥½è‡ªå·±çš„äº‹æƒ…å°±å¥½ï¼ŒæŒ‰ç€å­¦ä¹ è®¡åˆ’ç»§ç»­ã€‚ã€‚ã€‚</p>
<a id="more"></a>
<h3 id="å®šæ—¶å™¨"><a href="#å®šæ—¶å™¨" class="headerlink" title="å®šæ—¶å™¨"></a>å®šæ—¶å™¨</h3><p>iOS çš„å†…å­˜ç®¡ç†å¿…ç„¶å°‘ä¸äº†å®šæ—¶å™¨ï¼Œä»¥å‰æ²¡æœ‰æ·±ç©¶è¿‡å…·ä½“çš„åŸç†ï¼ŒåªçŸ¥é“ timer ä¼šå¯¹ target äº§ç”Ÿå¼ºå¼•ç”¨ï¼Œç°åœ¨æ¥åˆ†æä¸‹ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå¼ºå¼•ç”¨ä»¥åŠæ€æ ·è§£å†³ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€æ®µæµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)testTimer &#123;   </span><br><span class="line">    self.timer = [NSTimer timerWithTimeInterval:1 target:self selector:@selector(timerAction) userInfo:nil repeats:YES];</span><br><span class="line">    [[NSRunLoop currentRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)timerAction &#123;</span><br><span class="line">    NSLog(@&quot;-- %s&quot;, __func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼Œå½“æˆ‘ä»¬é”€æ¯æ§åˆ¶å™¨æ—¶æ²¡æœ‰è°ƒç”¨ dealloc æ–¹æ³•ï¼Œ è¯´æ˜æ­¤æ—¶æœ‰å¾ªç¯å¼•ç”¨ã€‚ä¹‹å‰åªæ˜¯çŸ¥é“ timer ä¼šå¯¹ self äº§ç”Ÿå¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆå…·ä½“æ€ä¹ˆäº§ç”Ÿçš„å‘¢ï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹ <a href="http://www.gnustep.org/resources/downloads.php" target="_blank" rel="noopener">GNU</a> æºç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (id) initWithFireDate: (NSDate*)fd</span><br><span class="line">	       interval: (NSTimeInterval)ti</span><br><span class="line">		 target: (id)object</span><br><span class="line">	       selector: (SEL)selector</span><br><span class="line">	       userInfo: (id)info</span><br><span class="line">		repeats: (BOOL)f</span><br><span class="line">&#123;</span><br><span class="line">  if (ti &lt;= 0.0)</span><br><span class="line">    &#123;</span><br><span class="line">      ti = 0.0001;</span><br><span class="line">    &#125;</span><br><span class="line">  if (fd == nil)</span><br><span class="line">    &#123;</span><br><span class="line">      _date = [[NSDate_class allocWithZone: NSDefaultMallocZone()]</span><br><span class="line">        initWithTimeIntervalSinceNow: ti];</span><br><span class="line">    &#125;</span><br><span class="line">  else</span><br><span class="line">    &#123;</span><br><span class="line">      _date = [fd copyWithZone: NSDefaultMallocZone()];</span><br><span class="line">    &#125;</span><br><span class="line">  _target = RETAIN(object);</span><br><span class="line">  _selector = selector;</span><br><span class="line">  _info = RETAIN(info);</span><br><span class="line">  if (f == YES)</span><br><span class="line">    &#123;</span><br><span class="line">      _repeats = YES;</span><br><span class="line">      _interval = ti;</span><br><span class="line">    &#125;</span><br><span class="line">  else</span><br><span class="line">    &#123;</span><br><span class="line">      _repeats = NO;</span><br><span class="line">      _interval = 0.0;</span><br><span class="line">    &#125;</span><br><span class="line">  return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šå¯ä»¥çœ‹å‡º timer ä¼šå¯¹ target åšä¸€æ¬¡ retain æ“ä½œï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆä½¿ç”¨ __weak è§£å†³ä¸äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå› ä¸ºä¸ç®¡ target ä¼ å…¥ self è¿˜æ˜¯ weakSelfï¼Œtimer éƒ½ä¼šå¯¹ self åšä¸€æ¬¡ retain æ“ä½œã€‚</p>
<p><br></p>
<p>è¦æƒ³è§£å†³å¾ªç¯å¼•ç”¨ï¼Œé‚£ä¹ˆç›´æ¥çš„åŠæ³•å°±æ˜¯æ·»åŠ ä¸€ä¸ªä¸­é—´ä»£ç†ï¼Œä½¿ç”¨åˆ°äº† NSProxyï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@interface TargetProxy : NSProxy</span><br><span class="line">@property (nonatomic, weak) id target;</span><br><span class="line">+ (instancetype)proxyWithTarget:(id)target;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation TargetProxy</span><br><span class="line">+ (instancetype)proxyWithTarget:(id)target &#123;</span><br><span class="line">    TargetProxy * proxy = [TargetProxy alloc];</span><br><span class="line">    proxy.target = target;</span><br><span class="line">    return proxy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel &#123;</span><br><span class="line">    return [self.target methodSignatureForSelector:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)invocation &#123;</span><br><span class="line">    [invocation invokeWithTarget:self.target];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±èƒ½è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ³¨æ„ç‚¹ï¼šå½“ç¨‹åºé€€åˆ°åå°æ—¶ timer å°±ä¼šåœæ­¢ï¼Œå› ä¸º timer æ˜¯åŸºäº RunLoop çš„ï¼Œå¦‚ä¹‹å‰ RunLoop ç« èŠ‚æ‰€è®²ï¼Œ timer ä¹Ÿæ˜¯ä¸ç²¾å‡†çš„ã€‚å¯ä»¥é€šè¿‡æ·»åŠ  observer æ¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œå½“ç¨‹åºé€€åˆ°åå°æ—¶ï¼Œæœ€ç»ˆä¼šèµ°åˆ° kCFRunLoopBeforeWaiting çŠ¶æ€ï¼Œä»è€Œ timer åœæ­¢å·¥ä½œï¼Œå½“ç¨‹åºä»åå°å›åˆ°å‰å°æ—¶ï¼ŒRunLoop åˆä» kCFRunLoopAfterWaiting çŠ¶æ€å¼€å§‹æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [self testTimer];</span><br><span class="line">    </span><br><span class="line">    CFRunLoopObserverRef observer = CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, kCFRunLoopAllActivities, YES, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity activity) &#123;</span><br><span class="line">        NSLog(@&quot;%lu&quot;, activity);</span><br><span class="line">    &#125;);</span><br><span class="line">    CFRunLoopAddObserver(CFRunLoopGetMain(), observer, kCFRunLoopCommonModes);</span><br><span class="line">    CFRelease(observer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CADisplayLink</code> åŸç†å’Œ <code>NSTimer</code> ç›¸åŒã€‚</p>
<p>å¦‚æœæƒ³è¦æ›´ç²¾å‡†çš„è®¾ç½® timerï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ GCD æ¥å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">@interface CTTimer : NSObject</span><br><span class="line">+ (id)executeTask:(dispatch_block_t)task</span><br><span class="line">            start:(NSTimeInterval)star</span><br><span class="line">         interval:(NSTimeInterval)interval</span><br><span class="line">         repeates:(BOOL)repeates</span><br><span class="line">            async:(BOOL)async;</span><br><span class="line"></span><br><span class="line">+ (id)executeWithTarget:(id)target</span><br><span class="line">                 action:(SEL)action</span><br><span class="line">                  start:(NSTimeInterval)star</span><br><span class="line">               interval:(NSTimeInterval)interval</span><br><span class="line">               repeates:(BOOL)repeates</span><br><span class="line">                  async:(BOOL)async;</span><br><span class="line"></span><br><span class="line">+ (void)cancelTask:(id)key;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation CTTimer</span><br><span class="line">static NSMutableDictionary * timers_;</span><br><span class="line">dispatch_semaphore_t semphore_;</span><br><span class="line"></span><br><span class="line">+ (void)initialize &#123;</span><br><span class="line">    timers_ = [NSMutableDictionary dictionary];</span><br><span class="line">    semphore_ = dispatch_semaphore_create(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (id)executeTask:(dispatch_block_t)task</span><br><span class="line">            start:(NSTimeInterval)star</span><br><span class="line">         interval:(NSTimeInterval)interval</span><br><span class="line">         repeates:(BOOL)repeates</span><br><span class="line">            async:(BOOL)async &#123;</span><br><span class="line">    </span><br><span class="line">    if (!task || star &lt; 0 || (interval &lt; 0 &amp;&amp; repeates)) &#123; return nil; &#125;</span><br><span class="line">    </span><br><span class="line">    static dispatch_queue_t _queue;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        _queue = dispatch_queue_create(&quot;queue timer&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_queue_t timerQueue = async ? _queue : dispatch_get_main_queue();</span><br><span class="line">    dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, timerQueue);</span><br><span class="line">    dispatch_source_set_timer(timer, dispatch_time(DISPATCH_TIME_NOW, star), interval * NSEC_PER_SEC, 0 * NSEC_PER_SEC);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(semphore_, DISPATCH_TIME_FOREVER);</span><br><span class="line">    NSString * key = [NSString stringWithFormat:@&quot;key_%lu&quot;, (unsigned long)timers_.count];</span><br><span class="line">    timers_[key] = timer;</span><br><span class="line">    dispatch_semaphore_signal(semphore_);</span><br><span class="line">    </span><br><span class="line">    dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">        if (task) &#123; task(); &#125;</span><br><span class="line">        if (!repeates) &#123;</span><br><span class="line">            [self cancelTask:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_resume(timer);</span><br><span class="line">    return key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (id)executeWithTarget:(id)target</span><br><span class="line">                 action:(SEL)action</span><br><span class="line">                  start:(NSTimeInterval)star</span><br><span class="line">               interval:(NSTimeInterval)interval</span><br><span class="line">               repeates:(BOOL)repeates</span><br><span class="line">                  async:(BOOL)async &#123;</span><br><span class="line">    </span><br><span class="line">    if (!target || !action) &#123; return nil; &#125;</span><br><span class="line">    </span><br><span class="line">    return [self executeTask:^&#123;</span><br><span class="line">        if ([target respondsToSelector:action]) &#123;</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;</span><br><span class="line">            [target performSelector:action];</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; start:star interval:interval repeates:repeates async:async];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)cancelTask:(id)key &#123;</span><br><span class="line">    if (!key) &#123; return; &#125;</span><br><span class="line">    dispatch_semaphore_wait(semphore_, DISPATCH_TIME_FOREVER);</span><br><span class="line">    dispatch_source_t timer = timers_[key];</span><br><span class="line">    if (timer) &#123;</span><br><span class="line">        dispatch_source_cancel(timer);</span><br><span class="line">        [timers_ removeObjectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_semaphore_signal(semphore_);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<h3 id="iOS-ç¨‹åºå†…å­˜å¸ƒå±€"><a href="#iOS-ç¨‹åºå†…å­˜å¸ƒå±€" class="headerlink" title="iOS ç¨‹åºå†…å­˜å¸ƒå±€"></a>iOS ç¨‹åºå†…å­˜å¸ƒå±€</h3><p>iOS å†…å­˜å¸ƒå±€å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80.png" alt="å†…å­˜å¸ƒå±€"></p>
<p>æ¥åšä¸ªç®€å•éªŒè¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">int a = 10;</span><br><span class="line">int b;</span><br><span class="line"></span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        static int c = 20;</span><br><span class="line">        static int d;</span><br><span class="line">        int e;</span><br><span class="line">        int f = 20;</span><br><span class="line">        NSString *str = @&quot;123&quot;;</span><br><span class="line">        NSObject *obj = [[NSObject alloc] init];</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;\n&amp;a=%p\n&amp;b=%p\n&amp;c=%p\n&amp;d=%p\n&amp;e=%p\n&amp;f=%p\nstr=%p\nobj=%p\n&quot;,</span><br><span class="line">              &amp;a, &amp;b, &amp;c, &amp;d, &amp;e, &amp;f, str, obj);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç»“æœ</span><br><span class="line">/*</span><br><span class="line"> å­—ç¬¦ä¸²å¸¸é‡</span><br><span class="line"> str=0x10dfa0068</span><br><span class="line"> </span><br><span class="line"> å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡</span><br><span class="line"> &amp;a =0x10dfa0db8</span><br><span class="line"> &amp;c =0x10dfa0dbc</span><br><span class="line"> </span><br><span class="line"> æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡</span><br><span class="line"> &amp;d =0x10dfa0e80</span><br><span class="line"> &amp;b =0x10dfa0e84</span><br><span class="line"> </span><br><span class="line"> å †</span><br><span class="line"> obj=0x608000012210</span><br><span class="line"> </span><br><span class="line"> æ ˆ</span><br><span class="line"> &amp;f =0x7ffee1c60fe0</span><br><span class="line"> &amp;e =0x7ffee1c60fe4</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<h3 id="Tagged-Pointer"><a href="#Tagged-Pointer" class="headerlink" title="Tagged Pointer"></a>Tagged Pointer</h3><blockquote>
<p>ä»64 bit å¼€å§‹ï¼ŒiOS å¼•å…¥äº† TaggedPointer æŠ€æœ¯ï¼Œç”¨äºä¼˜åŒ– NSNumberã€NSDateã€NSString ç­‰å°å¯¹è±¡çš„å­˜å‚¨ã€‚</p>
<p>åœ¨æ²¡æœ‰ Tagged Pointer ä¹‹å‰ï¼ŒNSNumber ç­‰å¯¹è±¡éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜ã€ç»´æŠ¤å¼•ç”¨è®¡æ•°ç­‰ï¼ŒNSNumber æŒ‡é’ˆå­˜å‚¨çš„æ˜¯å †ä¸­ NSNumber å¯¹è±¡çš„åœ°å€å€¼ã€‚</p>
<p>åœ¨ä½¿ç”¨äº† Tagged Pointer ä¹‹åï¼ŒNSNumber æŒ‡é’ˆé‡Œé¢å­˜å‚¨çš„æ•°æ®æ ‡ç§°äº†ï¼šTag+Dataï¼Œä¹Ÿå°±æ˜¯å°†æ•°æ®ç›´æ¥å­˜å‚¨åœ¨äº†æŒ‡é’ˆä¸­ã€‚</p>
<p>å½“æŒ‡é’ˆä¸å¤Ÿå­˜å‚¨æ•°æ®æ—¶ï¼Œæ‰ä¼šä½¿ç”¨åŠ¨æ€åˆ†é…å†…å­˜çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®ã€‚</p>
<p>objc_msgSend èƒ½è¯†åˆ« Tagged Pointerï¼Œæ¯”å¦‚ NSNumber çš„ intValue æ–¹æ³•ï¼Œç›´æ¥ä»æŒ‡é’ˆæå–æ•°æ®ï¼ŒèŠ‚çœäº†ä»¥å‰çš„è°ƒç”¨å¼€é”€ã€‚</p>
</blockquote>
<p>ä¸‹é¢æ¥çœ‹ä¸‹æ€ä¹ˆæ ·åˆ¤æ–­ä¸€ä¸ªæŒ‡é’ˆæ˜¯å¦æ˜¯ Tagged Pointer å‘¢ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">static inline bool </span><br><span class="line">_objc_isTaggedPointer(const void * _Nullable ptr) </span><br><span class="line">&#123;</span><br><span class="line">    return ((uintptr_t)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#if TARGET_OS_OSX &amp;&amp; __x86_64__</span><br><span class="line">    // 64-bit Mac - tag bit is LSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 0</span><br><span class="line">#else</span><br><span class="line">    // Everything else - tag bit is MSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 1</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if OBJC_MSB_TAGGED_POINTERS</span><br><span class="line">#   define _OBJC_TAG_MASK (1UL&lt;&lt;63)</span><br><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 60</span><br><span class="line">#   define _OBJC_TAG_SLOT_SHIFT 60</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_LSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_RSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_MASK (0xfUL&lt;&lt;60)</span><br><span class="line">#   define _OBJC_TAG_EXT_INDEX_SHIFT 52</span><br><span class="line">#   define _OBJC_TAG_EXT_SLOT_SHIFT 52</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_LSHIFT 12</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_RSHIFT 12</span><br><span class="line">#else</span><br><span class="line">#   define _OBJC_TAG_MASK 1UL</span><br><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 1</span><br><span class="line">#   define _OBJC_TAG_SLOT_SHIFT 0</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_LSHIFT 0</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_RSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_MASK 0xfUL</span><br><span class="line">#   define _OBJC_TAG_EXT_INDEX_SHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_SLOT_SHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_LSHIFT 0</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_RSHIFT 12</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼ŒæŒ‡é’ˆæ˜¯å¦æ˜¯ Tagged Pointer æ˜¯é€šè¿‡ <code>&amp;mask</code> å¾—åˆ°çš„ï¼Œçœ‹ä¸‹ä¸Šé¢çš„ mask å€¼æ˜¯åŒºåˆ† <code>iPhone</code> å’Œ <code>Mac</code> çš„ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>iOS å¹³å°ï¼šæœ€é«˜æœ‰æ•ˆä½æ˜¯ 1ï¼ˆç¬¬64 bitï¼‰</li>
<li>Mac å¹³å°ï¼šæœ€ä½æœ‰æ•ˆä½æ˜¯ 1</li>
</ul>
<p>å…·ä½“çš„ isa æŒ‡é’ˆå„ä¸ªä½çš„æ ‡è¯†ä¹‹å‰åœ¨ <a href="https://jueying-xiangfeng.github.io/2020/07/20/Runtime%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/" target="_blank" rel="noopener">RuntimeåŸç†æ¢ç©¶</a> ä¸­æœ‰è®²åˆ°è¿‡ã€‚</p>
<h3 id="OC-å¯¹è±¡çš„å†…å­˜ç®¡ç†"><a href="#OC-å¯¹è±¡çš„å†…å­˜ç®¡ç†" class="headerlink" title="OC å¯¹è±¡çš„å†…å­˜ç®¡ç†"></a>OC å¯¹è±¡çš„å†…å­˜ç®¡ç†</h3><p>åœ¨ iOS ä¸­ï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥ç®¡ç† OC å¯¹è±¡çš„å†…å­˜ã€‚</p>
<p>ä¸€ä¸ªæ–°åˆ›å»ºçš„ OC å¯¹è±¡å¼•ç”¨è®¡æ•°é»˜è®¤ä¸º 1ï¼Œå½“å¼•ç”¨è®¡æ•°å™¨å‡ä¸º0ï¼ŒOC å¯¹è±¡å°±é”€æ¯ï¼Œé‡Šæ”¾å ç”¨çš„å†…å­˜ç©ºé—´ã€‚</p>
<p>è°ƒç”¨ retain ä¼šè®© OC å¯¹è±¡çš„å¼•ç”¨è®¡æ•° +1ï¼Œrelease ä¼š -1.</p>
<p>å†…å­˜ç®¡ç†ç»éªŒæ€»ç»“ï¼š</p>
<ul>
<li>å½“è°ƒç”¨ allocã€mallocã€copyã€mutableCopy æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ä¸éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œè¦è°ƒç”¨ release æˆ–è€… autorelease æ¥é‡Šæ”¾ã€‚</li>
<li>æƒ³æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©å®ƒçš„å¼•ç”¨è®¡æ•° +1ï¼Œä¸æƒ³åœ¨æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©å®ƒçš„å¼•ç”¨è®¡æ•° -1ã€‚</li>
</ul>
<h3 id="copyã€mutableCopy"><a href="#copyã€mutableCopy" class="headerlink" title="copyã€mutableCopy"></a>copyã€mutableCopy</h3><p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/copy%E3%80%81mutableCopy.png" alt="copyã€mutableCopy"></p>
<h3 id="weak-åŸç†"><a href="#weak-åŸç†" class="headerlink" title="weak åŸç†"></a>weak åŸç†</h3><p>å…ˆæ¥çœ‹ä¸‹ dealloc æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">inline void</span><br><span class="line">objc_object::rootDealloc()</span><br><span class="line">&#123;</span><br><span class="line">    if (isTaggedPointer()) return;  // fixme necessary?</span><br><span class="line"></span><br><span class="line">    if (fastpath(isa.nonpointer  &amp;&amp;  </span><br><span class="line">                 !isa.weakly_referenced  &amp;&amp;  </span><br><span class="line">                 !isa.has_assoc  &amp;&amp;  </span><br><span class="line">                 !isa.has_cxx_dtor  &amp;&amp;  </span><br><span class="line">                 !isa.has_sidetable_rc))</span><br><span class="line">    &#123;</span><br><span class="line">        assert(!sidetable_present());</span><br><span class="line">        free(this);</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">        object_dispose((id)this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id </span><br><span class="line">object_dispose(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (!obj) return nil;</span><br><span class="line"></span><br><span class="line">    objc_destructInstance(obj);    </span><br><span class="line">    free(obj);</span><br><span class="line"></span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void *objc_destructInstance(id obj) </span><br><span class="line">&#123;</span><br><span class="line">    if (obj) &#123;</span><br><span class="line">        // Read all of the flags at once for performance.</span><br><span class="line">        bool cxx = obj-&gt;hasCxxDtor();</span><br><span class="line">        bool assoc = obj-&gt;hasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">        // This order is important.</span><br><span class="line">        if (cxx) object_cxxDestruct(obj);</span><br><span class="line">        if (assoc) _object_remove_assocations(obj);</span><br><span class="line">        obj-&gt;clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline void </span><br><span class="line">objc_object::clearDeallocating()</span><br><span class="line">&#123;</span><br><span class="line">    if (slowpath(!isa.nonpointer)) &#123;</span><br><span class="line">        // Slow path for raw pointer isa.</span><br><span class="line">        sidetable_clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">    else if (slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</span><br><span class="line">        // Slow path for non-pointer isa with weak refs and/or side table data.</span><br><span class="line">        clearDeallocating_slow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assert(!sidetable_present());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">objc_object::clearDeallocating_slow()</span><br><span class="line">&#123;</span><br><span class="line">    assert(isa.nonpointer  &amp;&amp;  (isa.weakly_referenced || isa.has_sidetable_rc));</span><br><span class="line"></span><br><span class="line">    SideTable&amp; table = SideTables()[this];</span><br><span class="line">    table.lock();</span><br><span class="line">    if (isa.weakly_referenced) &#123;</span><br><span class="line">        weak_clear_no_lock(&amp;table.weak_table, (id)this);</span><br><span class="line">    &#125;</span><br><span class="line">    if (isa.has_sidetable_rc) &#123;</span><br><span class="line">        table.refcnts.erase(this);</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <a href="https://jueying-xiangfeng.github.io/2020/07/20/Runtime%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/" target="_blank" rel="noopener">RuntimeåŸç†æ¢ç©¶</a> ä¸­æˆ‘ä»¬è®²åˆ°è¿‡ ISA æŒ‡é’ˆçš„å„ä¸ªä½çš„ä½œç”¨ï¼Œåœ¨ dealloc æ—¶å¦‚æœæ²¡æœ‰ <code>å…³è”å¯¹è±¡(has_assoc)</code>ã€<code>c++ææ„å‡½æ•°(has_cxx_dtor)</code>ã€<code>å¼±å¼•ç”¨(weakly_referenced)</code>ã€<code>æ˜¯å¦ä½¿ç”¨ sidetable(has_sidetable_rc)</code> æ—¶é‡Šæ”¾ä¼šæ›´å¿«ã€‚è¿™é‡Œæˆ‘ä»¬å•ç‹¬çœ‹ä¸€ä¸‹ weakï¼Œè·Ÿåˆ° <code>clearDeallocating_slow</code> æ–¹æ³•å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„ç»“æ„ï¼š<code>SideTable</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">struct SideTable &#123;</span><br><span class="line">    spinlock_t slock;</span><br><span class="line">    RefcountMap refcnts;</span><br><span class="line">    weak_table_t weak_table;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// RefcountMap disguises its pointers because we </span><br><span class="line">// don&apos;t want the table to act as a root for `leaks`.</span><br><span class="line">typedef objc::DenseMap&lt;DisguisedPtr&lt;objc_object&gt;,size_t,true&gt; RefcountMap;</span><br><span class="line"></span><br><span class="line">struct weak_table_t &#123;</span><br><span class="line">    weak_entry_t *weak_entries;</span><br><span class="line">    size_t    num_entries;</span><br><span class="line">    uintptr_t mask;</span><br><span class="line">    uintptr_t max_hash_displacement;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">typedef DisguisedPtr&lt;objc_object *&gt; weak_referrer_t;</span><br><span class="line"></span><br><span class="line">struct weak_entry_t &#123;</span><br><span class="line">    DisguisedPtr&lt;objc_object&gt; referent;</span><br><span class="line">    union &#123;</span><br><span class="line">        struct &#123;</span><br><span class="line">            weak_referrer_t *referrers;</span><br><span class="line">            uintptr_t        out_of_line_ness : 2;</span><br><span class="line">            uintptr_t        num_refs : PTR_MINUS_2;</span><br><span class="line">            uintptr_t        mask;</span><br><span class="line">            uintptr_t        max_hash_displacement;</span><br><span class="line">        &#125;;</span><br><span class="line">        struct &#123;</span><br><span class="line">            // out_of_line_ness field is low bits of inline_referrers[1]</span><br><span class="line">            weak_referrer_t  inline_referrers[WEAK_INLINE_COUNT];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    bool out_of_line() &#123;</span><br><span class="line">        return (out_of_line_ness == REFERRERS_OUT_OF_LINE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    weak_entry_t&amp; operator=(const weak_entry_t&amp; other) &#123;</span><br><span class="line">        memcpy(this, &amp;other, sizeof(other));</span><br><span class="line">        return *this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    weak_entry_t(objc_object *newReferent, objc_object **newReferrer)</span><br><span class="line">        : referent(newReferent)</span><br><span class="line">    &#123;</span><br><span class="line">        inline_referrers[0] = newReferrer;</span><br><span class="line">        for (int i = 1; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">            inline_referrers[i] = nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šï¼ŒSidetable åŒ…å«ä¸‰éƒ¨åˆ†å†…å®¹ï¼Œlock éƒ¨åˆ†ä¸ç”¨ç®¡ï¼Œè¿™é‡Œçš„ RefcountMap å°±æ˜¯å½“ ISA æŒ‡é’ˆå­˜å‚¨ä¸ä¸‹å¼•ç”¨è®¡æ•°æ—¶æœ‰ Sidetable å­˜å‚¨çš„æ•£åˆ—è¡¨ã€‚å¦‚æœ <code>isa.has_sidetable_rc</code> ä¸º trueï¼Œåˆ™ä¼šè°ƒç”¨ <code>table.refcnts.erase(this);</code> æ¸…é™¤ç›¸å…³çš„å¼•ç”¨ã€‚</p>
<p>å†æ¥çœ‹ä¸‹ <code>weak_table</code> ç»“æ„ï¼Œå¯ä»¥çœ‹åˆ° weak_table ä¸ä¼šå¯¹ä¿®é¥°çš„å¯¹è±¡äº§ç”Ÿå¼ºå¼•ç”¨ï¼Œè€Œå½“å¯¹è±¡è¢« <code>weak</code> ä¿®é¥°è¿‡ï¼Œåˆ™åœ¨é‡Šæ”¾æ—¶å°±ä¼šè°ƒç”¨ <code>weak_clear_no_lock(&amp;table.weak_table, (id)this);</code> æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">void </span><br><span class="line">weak_clear_no_lock(weak_table_t *weak_table, id referent_id) </span><br><span class="line">&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line"></span><br><span class="line">    weak_entry_t *entry = weak_entry_for_referent(weak_table, referent);</span><br><span class="line">    if (entry == nil) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    for (size_t i = 0; i &lt; count; ++i) &#123;</span><br><span class="line">        objc_object **referrer = referrers[i];</span><br><span class="line">        if (referrer) &#123;</span><br><span class="line">            // é‡ç‚¹ï¼šè¿™é‡Œå°† weakReference ç½®ä¸º nil</span><br><span class="line">            if (*referrer == referent) &#123;</span><br><span class="line">                *referrer = nil;</span><br><span class="line">            &#125;</span><br><span class="line">            else if (*referrer) &#123;</span><br><span class="line">                objc_weak_error();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    weak_entry_remove(weak_table, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæºç æ‰€ç¤ºï¼Œåœ¨é‡Šæ”¾å†…å­˜æ—¶ï¼Œä¼šå°†ç›¸å…³çš„ weak reference è®¾ç½®ä¸º nilï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨ <code>__weak</code> ä¿®é¥°è¿‡çš„å˜é‡åœ¨è¢«ä¿®é¥°çš„å¯¹è±¡é‡Šæ”¾æ—¶èƒ½ç½®ä¸º nil çš„åŸç†ã€‚</p>
<blockquote>
<p>ARC å°±æ˜¯ LLVM ç¼–è¯‘å™¨å’Œ Runtime ç³»ç»Ÿç›¸äº’åä½œçš„ç»“æœ</p>
</blockquote>
<h3 id="Autorelease-åŸç†"><a href="#Autorelease-åŸç†" class="headerlink" title="Autorelease åŸç†"></a>Autorelease åŸç†</h3><p>å½“å°†å¯¹è±¡è°ƒç”¨ <code>autorelease</code> æ–¹æ³•åï¼Œå°±ä¼šè¢«åŠ å…¥åˆ° <code>è‡ªåŠ¨é‡Šæ”¾æ± </code> é‡Œé¢ï¼Œä½¿ç”¨ clang å‘½ä»¤æ¥çœ‹ä¸‹ autoreleasepool åˆ°åº•è¢«ç¼–è¯‘æˆäº†ä»€ä¹ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¢«ç¼–è¯‘æˆäº† <code>__AtAutoreleasePool</code>ï¼Œç„¶ååœ¨ objc æºç é‡Œé¢æŸ¥æ‰¾ <code>autorelease</code> æ–¹æ³•ï¼Œæœ€ç»ˆå¯ä»¥çœ‹åˆ° autorelease çš„ç®¡ç†ç±»ï¼š<code>autoreleasepoolpage</code>ã€‚</p>
<p>æ‰€ä»¥è‡ªåŠ¨é‡Šæ”¾æ± çš„ä¸»è¦åº•å±‚æ•°æ®ç»“æ„æ˜¯ï¼š<code>__AtAutoreleasePool</code>ã€<code>AutoreleasePoolPage</code>ã€‚è°ƒç”¨äº† autorelease çš„å¯¹è±¡æœ€ç»ˆéƒ½æ˜¯é€šè¿‡ AutoreleasePoolPage å¯¹è±¡æ¥ç®¡ç†çš„ã€‚æ¥çœ‹ä¸‹ AutoreleasePoolPage çš„ç»“æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class AutoreleasePoolPage </span><br><span class="line">&#123;</span><br><span class="line">    static size_t const SIZE = </span><br><span class="line">#if PROTECT_AUTORELEASEPOOL</span><br><span class="line">        PAGE_MAX_SIZE;  // must be multiple of vm page size</span><br><span class="line">#else</span><br><span class="line">        PAGE_MAX_SIZE;  // size and alignment, power of 2 -- 4096</span><br><span class="line">#endif</span><br><span class="line">    static size_t const COUNT = SIZE / sizeof(id);</span><br><span class="line">  </span><br><span class="line">    magic_t const magic;</span><br><span class="line">    id *next;</span><br><span class="line">    pthread_t const thread;</span><br><span class="line">    AutoreleasePoolPage * const parent;</span><br><span class="line">    AutoreleasePoolPage *child;</span><br><span class="line">    uint32_t const depth;</span><br><span class="line">    uint32_t hiwat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® AutoreleasePoolPage å®šä¹‰é‡Œé¢çš„ PAGE_MAX_SIZE å¯ä»¥çœ‹åˆ°å ç”¨ 4096 å­—èŠ‚çš„å†…å­˜ã€‚é™¤äº†ç”¨æ¥å­˜æ”¾å®ƒå†…å­˜çš„æˆå‘˜å˜é‡ï¼Œå‰©ä¸‹çš„ç©ºé—´ç”¨æ¥å­˜æ”¾ autorelease å¯¹è±¡çš„åœ°å€ã€‚</p>
<p>æ‰€æœ‰çš„ AutoreleasePoolPage å¯¹è±¡éƒ½æ˜¯é€šè¿‡åŒå‘é‡è¡¨çš„å½¢å¼è¿æ¥åœ¨ä¸€èµ·çš„ã€‚</p>
<p>æ¥çœ‹ä¸‹åŸç†ç»“æ„å›¾ï¼š</p>
<p><img src="https://blog-key.oss-cn-beijing.aliyuncs.com/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/autoreleasepoolpage.png" alt="autoreleasepoolpageåŸç†"></p>
<p>è°ƒç”¨ push æ–¹æ³•ä¼šå°†ä¸€ä¸ª POOL_BOUNDARY å…¥æ ˆï¼Œå¹¶ä¸”è¿”å›å…¶å­˜æ”¾çš„å†…å­˜åœ°å€ã€‚</p>
<p>è°ƒç”¨ pop æ–¹æ³•æ—¶ä¼ å…¥ä¸€ä¸ª POOL_BOUNDARY çš„å†…å­˜åœ°å€ï¼Œä¼šä»æœ€åä¸€ä¸ªå…¥æ ˆçš„å¯¹è±¡å¼€å§‹å‘é€ release æ¶ˆæ¯ï¼Œç›´åˆ°é‡åˆ°è¿™ä¸ª POOL)BOUNDARYã€‚</p>
<p>id *next æŒ‡å‘äº†ä¸‹ä¸€ä¸ªèƒ½å­˜æ”¾ autorelease å¯¹è±¡åœ°å€çš„åŒºåŸŸã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">push</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    id *dest;</span><br><span class="line">    <span class="comment">// push æ—¶å°† POOL_BOUNDARY å…¥æ ˆï¼Œå¹¶è¿”å› POOL_BOUNDARY å…¥æ ˆçš„åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (DebugPoolAllocation) &#123;</span><br><span class="line">        <span class="comment">// Each autorelease pool starts on a new pool page.</span></span><br><span class="line">        dest = autoreleaseNewPage(POOL_BOUNDARY);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dest = autoreleaseFast(POOL_BOUNDARY);</span><br><span class="line">    &#125;</span><br><span class="line">    assert(dest == EMPTY_POOL_PLACEHOLDER || *dest == POOL_BOUNDARY);</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">pop</span><span class="params">(<span class="keyword">void</span> *token)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoreleasePoolPage *page;</span><br><span class="line">    id *stop;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯ hotpageï¼Œå¦‚æœä¸æ˜¯åˆ™è°ƒç”¨ coldePage çš„ pop æ–¹æ³•</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰æ˜¯ hotPageï¼Œåˆ™è°ƒç”¨ releaseUntil æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (token == (<span class="keyword">void</span>*)EMPTY_POOL_PLACEHOLDER) &#123;</span><br><span class="line">        <span class="comment">// Popping the top-level placeholder pool.</span></span><br><span class="line">        <span class="keyword">if</span> (hotPage()) &#123;</span><br><span class="line">            <span class="comment">// Pool was used. Pop its contents normally.</span></span><br><span class="line">            <span class="comment">// Pool pages remain allocated for re-use as usual.</span></span><br><span class="line">            pop(coldPage()-&gt;begin());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Pool was never used. Clear the placeholder.</span></span><br><span class="line">            setHotPage(nil);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    page = pageForPointer(token);</span><br><span class="line">    stop = (id *)token;</span><br><span class="line">    <span class="keyword">if</span> (*stop != POOL_BOUNDARY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stop == page-&gt;begin()  &amp;&amp;  !page-&gt;parent) &#123;</span><br><span class="line">            <span class="comment">// Start of coldest page may correctly not be POOL_BOUNDARY:</span></span><br><span class="line">            <span class="comment">// 1. top-level pool is popped, leaving the cold page in place</span></span><br><span class="line">            <span class="comment">// 2. an object is autoreleased with no pool</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Error. For bincompat purposes this is not </span></span><br><span class="line">            <span class="comment">// fatal in executables built with old SDKs.</span></span><br><span class="line">            <span class="keyword">return</span> badPop(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PrintPoolHiwat) printHiwat();</span><br><span class="line"></span><br><span class="line">    page-&gt;releaseUntil(stop);</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">releaseUntil</span><span class="params">(id *stop)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>-&gt;next != stop) &#123;</span><br><span class="line">        AutoreleasePoolPage *page = hotPage();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fixme I think this `while` can be `if`, but I can't prove it</span></span><br><span class="line">        <span class="keyword">while</span> (page-&gt;empty()) &#123;</span><br><span class="line">            page = page-&gt;parent;</span><br><span class="line">            setHotPage(page);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        page-&gt;unprotect();</span><br><span class="line">        id obj = *--page-&gt;next;</span><br><span class="line">        <span class="built_in">memset</span>((<span class="keyword">void</span>*)page-&gt;next, SCRIBBLE, <span class="keyword">sizeof</span>(*page-&gt;next));</span><br><span class="line">        page-&gt;protect();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// çŸ¥é“æ‰¾åˆ°ä¸Šä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ POOL_BOUNDARYï¼Œå¦åˆ™ä¸­é—´çš„å¯¹è±¡éƒ½è°ƒç”¨ release æ–¹æ³•è¿›è¡Œé‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">if</span> (obj != POOL_BOUNDARY) &#123;</span><br><span class="line">            objc_release(obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†æ¥çœ‹ä¸‹ä¸€ä¸ªå˜é‡è¢«æ ‡è®°ä¸º autorelease åï¼Œæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ release çš„ã€‚</p>
<p>è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯æœ‰ RunLoop æ§åˆ¶çš„ï¼ŒåŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± çš„å˜é‡ä¼šåœ¨æŸæ¬¡ RunLoop å¾ªç¯ä¸­ï¼ŒRunLoopä¼‘çœ ä¹‹å‰è°ƒç”¨ releaseã€‚</p>
<p>è€Œæˆ‘ä»¬å¹³æ—¶å¼€å‘æ—¶ä¸»çº¿ç¨‹çš„ RunLoop ä¸­å·²ç»æ³¨å†Œäº† 2 ä¸ª observerï¼š</p>
<ol>
<li>ç¬¬ä¸€ä¸ª observer ç›‘å¬äº† kCFRunLoopEntry äº‹ä»¶ï¼Œä¼šè°ƒç”¨ objc_autoreleasePoolPush()ã€‚</li>
<li>ç¬¬äºŒä¸ª observer ç›‘å¬äº†ä¸¤ä¸ªäº‹ä»¶<ul>
<li>kCFRunLoopBeforeWaiting äº‹ä»¶ï¼Œä¼šè°ƒç”¨ objc_autoreleasePoolPop()ã€objc_autoreleasePoolPush()ã€‚</li>
<li>kCFRunLoopBeforeExit äº‹ä»¶ï¼Œä¼šè°ƒç”¨ objc_autoreleasePoolPop()ã€‚</li>
</ul>
</li>
</ol>
<p>å…·ä½“çš„åº”ç”¨å¯ä»¥çœ‹ä¸‹ YY å¤§ç¥çš„ <a href="https://github.com/ibireme/YYKit/blob/master/YYKit/Base/Foundation/NSThread%2BYYAdd.m" target="_blank" rel="noopener">YYKit</a>  NSThread+YYAdd ç›¸å…³ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">static inline void YYAutoreleasePoolPush() &#123;</span><br><span class="line">    NSMutableDictionary *dic =  [NSThread currentThread].threadDictionary;</span><br><span class="line">    NSMutableArray *poolStack = dic[YYNSThreadAutoleasePoolStackKey];</span><br><span class="line">    </span><br><span class="line">    if (!poolStack) &#123;</span><br><span class="line">        /*</span><br><span class="line">         do not retain pool on push,</span><br><span class="line">         but release on pop to avoid memory analyze warning</span><br><span class="line">         */</span><br><span class="line">        CFArrayCallBacks callbacks = &#123;0&#125;;</span><br><span class="line">        callbacks.retain = PoolStackRetainCallBack;</span><br><span class="line">        callbacks.release = PoolStackReleaseCallBack;</span><br><span class="line">        poolStack = (id)CFArrayCreateMutable(CFAllocatorGetDefault(), 0, &amp;callbacks);</span><br><span class="line">        dic[YYNSThreadAutoleasePoolStackKey] = poolStack;</span><br><span class="line">        CFRelease(poolStack);</span><br><span class="line">    &#125;</span><br><span class="line">    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init]; // create</span><br><span class="line">    [poolStack addObject:pool]; // push</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void YYAutoreleasePoolPop() &#123;</span><br><span class="line">    NSMutableDictionary *dic =  [NSThread currentThread].threadDictionary;</span><br><span class="line">    NSMutableArray *poolStack = dic[YYNSThreadAutoleasePoolStackKey];</span><br><span class="line">    [poolStack removeLastObject]; // pop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void YYRunLoopAutoreleasePoolObserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info) &#123;</span><br><span class="line">    switch (activity) &#123;</span><br><span class="line">        // è¿›å…¥ loop æ—¶ push</span><br><span class="line">        case kCFRunLoopEntry: &#123;</span><br><span class="line">            YYAutoreleasePoolPush();</span><br><span class="line">        &#125; break;</span><br><span class="line">        // loop ä¸€åœˆèµ°å®Œï¼Œå…ˆ pop ç„¶ååœ¨ push</span><br><span class="line">        case kCFRunLoopBeforeWaiting: &#123;</span><br><span class="line">            YYAutoreleasePoolPop();</span><br><span class="line">            YYAutoreleasePoolPush();</span><br><span class="line">        &#125; break;</span><br><span class="line">        // é€€å‡ºæ—¶ pop</span><br><span class="line">        case kCFRunLoopExit: &#123;</span><br><span class="line">            YYAutoreleasePoolPop();</span><br><span class="line">        &#125; break;</span><br><span class="line">        default: break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void YYRunloopAutoreleasePoolSetup() &#123;</span><br><span class="line">    CFRunLoopRef runloop = CFRunLoopGetCurrent();</span><br><span class="line">    // å½“å‰çº¿ç¨‹æ·»åŠ ç›‘å¬ï¼škCFRunLoopEntryã€kCFRunLoopBeforeWaiting | kCFRunLoopExit</span><br><span class="line">    CFRunLoopObserverRef pushObserver;</span><br><span class="line">    pushObserver = CFRunLoopObserverCreate(CFAllocatorGetDefault(), kCFRunLoopEntry,</span><br><span class="line">                                           true,         // repeat</span><br><span class="line">                                           -0x7FFFFFFF,  // before other observers</span><br><span class="line">                                           YYRunLoopAutoreleasePoolObserverCallBack, NULL);</span><br><span class="line">    CFRunLoopAddObserver(runloop, pushObserver, kCFRunLoopCommonModes);</span><br><span class="line">    CFRelease(pushObserver);</span><br><span class="line">    </span><br><span class="line">    CFRunLoopObserverRef popObserver;</span><br><span class="line">    popObserver = CFRunLoopObserverCreate(CFAllocatorGetDefault(), kCFRunLoopBeforeWaiting | kCFRunLoopExit,</span><br><span class="line">                                          true,        // repeat</span><br><span class="line">                                          0x7FFFFFFF,  // after other observers</span><br><span class="line">                                          YYRunLoopAutoreleasePoolObserverCallBack, NULL);</span><br><span class="line">    CFRunLoopAddObserver(runloop, popObserver, kCFRunLoopCommonModes);</span><br><span class="line">    CFRelease(popObserver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@implementation NSThread (YYAdd)</span><br><span class="line"></span><br><span class="line">+ (void)addAutoreleasePoolToCurrentRunloop &#123;</span><br><span class="line">    // ä¸»çº¿ç¨‹å­˜åœ¨è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦åœ¨å­çº¿ç¨‹ä¸­æ·»åŠ   </span><br><span class="line">    if ([NSThread isMainThread]) return; // The main thread already has autorelease pool.</span><br><span class="line">    NSThread *thread = [self currentThread];</span><br><span class="line">    if (!thread) return;</span><br><span class="line">    if (thread.threadDictionary[YYNSThreadAutoleasePoolKey]) return; // already added</span><br><span class="line">    YYRunloopAutoreleasePoolSetup();</span><br><span class="line">    thread.threadDictionary[YYNSThreadAutoleasePoolKey] = YYNSThreadAutoleasePoolKey; // mark the state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/å†…å­˜ç®¡ç†/"><i class="fa fa-tag"></i>å†…å­˜ç®¡ç†</a></div><div class="post-nav"><a class="pre" href="/2020/08/14/å†…å­˜ç®¡ç†åŸç†æ¢ç©¶-ç»­/">å†…å­˜ç®¡ç†åŸç†æ¢ç©¶-ç»­</a><a class="next" href="/2020/08/05/å¤šçº¿ç¨‹/">å¤šçº¿ç¨‹</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/KVC/" style="font-size: 15px;">KVC</a> <a href="/tags/block-å˜é‡æ•è·/" style="font-size: 15px;">block å˜é‡æ•è·</a> <a href="/tags/block-ç±»å‹ã€copy/" style="font-size: 15px;">block ç±»å‹ã€copy</a> <a href="/tags/block-å¾ªç¯å¼•ç”¨/" style="font-size: 15px;">block å¾ªç¯å¼•ç”¨</a> <a href="/tags/block/" style="font-size: 15px;">block</a> <a href="/tags/category-åŸç†/" style="font-size: 15px;">category åŸç†</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/KVO/" style="font-size: 15px;">KVO</a> <a href="/tags/block-åŸç†/" style="font-size: 15px;">block åŸç†</a> <a href="/tags/block-å†…å­˜ç®¡ç†/" style="font-size: 15px;">block å†…å­˜ç®¡ç†</a> <a href="/tags/Runtime/" style="font-size: 15px;">Runtime</a> <a href="/tags/å†…å­˜ç®¡ç†ã€RunLoopã€Autorelease/" style="font-size: 15px;">å†…å­˜ç®¡ç†ã€RunLoopã€Autorelease</a> <a href="/tags/å†…å­˜ç®¡ç†/" style="font-size: 15px;">å†…å­˜ç®¡ç†</a> <a href="/tags/RunLoop/" style="font-size: 15px;">RunLoop</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/08/14/å†…å­˜ç®¡ç†åŸç†æ¢ç©¶-ç»­/">å†…å­˜ç®¡ç†åŸç†æ¢ç©¶-ç»­</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/08/å†…å­˜ç®¡ç†åŸç†æ¢ç©¶/">å†…å­˜ç®¡ç†åŸç†æ¢ç©¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/05/å¤šçº¿ç¨‹/">å¤šçº¿ç¨‹</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/29/RunLoopåŸç†æ¢ç©¶/">RunLoopåŸç†æ¢ç©¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/20/RuntimeåŸç†æ¢ç©¶/">RuntimeåŸç†æ¢ç©¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/06/block6-å¾ªç¯å¼•ç”¨/">block6-å¾ªç¯å¼•ç”¨</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/06/block5-blockå†…å­˜ç®¡ç†/">block5-blockå†…å­˜ç®¡ç†</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/03/block3-blockåŸç†/">block4-__blockåŸç†</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/02/block3-ç±»å‹ã€copyåŸç†/">block3-ç±»å‹ã€copyåŸç†</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/02/block2-å˜é‡çš„æ•è·/">block2-å˜é‡çš„æ•è·</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="https://github.com/jueying-xiangfeng" title="github" target="_blank">github</a><ul></ul><a title="ç”Ÿæ´»éšç¬”-å¤ç›˜(æœ€è¿‘æ­£åœ¨æ•´ç†)" target="_blank">ç”Ÿæ´»éšç¬”-å¤ç›˜(æœ€è¿‘æ­£åœ¨æ•´ç†)</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2020 <a href="/." rel="nofollow">ç™½å¤œè¿½å‡¶.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>