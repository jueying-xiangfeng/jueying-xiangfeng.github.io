<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> KVO-KVC的原理探究 - KVC篇 · 白夜追凶</title><meta name="description" content="KVO-KVC的原理探究 - KVC篇 - Key"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="白夜追凶"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://www.jianshu.com/u/56cc07423502" target="_blank" class="nav-list-link">JIANSHU</a></li><li class="nav-list-item"><a href="https://github.com/jueying-xiangfeng" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">KVO-KVC的原理探究 - KVC篇</h1><div class="post-info">2018年07月19日</div><div class="post-content"><h3 id="关于KVC的探究"><a href="#关于KVC的探究" class="headerlink" title="关于KVC的探究"></a>关于KVC的探究</h3><h4 id="基本介绍和使用"><a href="#基本介绍和使用" class="headerlink" title="基本介绍和使用"></a>基本介绍和使用</h4><p>KVC全称Key-Value Coding 键值编码，可以通过Key来访问某个属性，常见的API：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (nullable id)valueForKeyPath:(NSString *)keyPath;</span><br><span class="line">- (void)setValue:(nullable id)value forKeyPath:(NSString *)keyPath;</span><br><span class="line"></span><br><span class="line">- (nullable id)valueForKey:(NSString *)key;</span><br><span class="line">- (void)setValue:(nullable id)value forKey:(NSString *)key;</span><br></pre></td></tr></table></figure></p>
<p>创建Person类、Animal类，添加属性如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@interface Animal : NSObject</span><br><span class="line">@property (nonatomic, assign) NSInteger height;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface Person : NSObject</span><br><span class="line">@property (nonatomic, assign) NSInteger age;</span><br><span class="line">@property (nonatomic, strong) Animal * dog;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p>如上，使用KVC赋值的方式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Animal * dog = [[Animal alloc] init];</span><br><span class="line">Person * person = [[Person alloc] init];</span><br><span class="line">person.dog = dog;</span><br><span class="line">// Key        </span><br><span class="line">[person setValue:@11 forKey:@&quot;age&quot;];</span><br><span class="line">// KeyPath</span><br><span class="line">[person setValue:@123 forKeyPath:@&quot;dog.height&quot;];</span><br><span class="line">        </span><br><span class="line">NSLog(@&quot;---- %@ -- %@&quot;, @(person.age), @(person.dog.height));</span><br><span class="line"></span><br><span class="line">打印结果：</span><br><span class="line">2018-07-19 23:00:48.546719+0800 KVC[53839:3059207] ---- 11 -- 123</span><br></pre></td></tr></table></figure></p>
<p>可以看到直接赋值的话两中方式都可以，但是类似上面的dog.height嵌套的方式必须通过KeyPath的方式赋值。</p>
<h4 id="KVC原理"><a href="#KVC原理" class="headerlink" title="KVC原理"></a>KVC原理</h4><p>进入Foundation里面查看 <code>- (void)setValue:(nullable id)value forKey:(NSString *)key;</code> 方法的注解可以了解到，<strong><code>KVC的赋值步骤</code></strong> 如下图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 调用setValue：forKey</span><br><span class="line">e_findSucceed=&gt;end: 传递参数，调用方法</span><br><span class="line">op1=&gt;operation: Operation1</span><br><span class="line">sub1=&gt;subroutine: My Subroutine</span><br><span class="line">cond_findMethod=&gt;condition: 按照 setKey：</span><br><span class="line">_setKey：</span><br><span class="line">顺序查找方法</span><br><span class="line">cond_instanceVariables=&gt;condition: 查看</span><br><span class="line">accessInstance</span><br><span class="line">VariablesDirectly</span><br><span class="line">（默认返回YES）</span><br><span class="line">方法的返回值</span><br><span class="line">cond_findIvar=&gt;condition: 按照</span><br><span class="line">_key、_isKey</span><br><span class="line">key、isKey</span><br><span class="line">顺序查找</span><br><span class="line">成员变量</span><br><span class="line">e_findIvar=&gt;end: 直接赋值</span><br><span class="line">e_exception=&gt;end: 调用</span><br><span class="line">setValue：forUndefinedKey：</span><br><span class="line">并且抛出</span><br><span class="line">NSUnKnownKeyException</span><br><span class="line"></span><br><span class="line">st-&gt;cond_findMethod</span><br><span class="line">cond_findMethod(yes, bottom)-&gt;e_findSucceed</span><br><span class="line">cond_findMethod(no, right)-&gt;cond_instanceVariables</span><br><span class="line">cond_instanceVariables(yes, bottom)-&gt;cond_findIvar</span><br><span class="line">cond_findIvar(yes, bottom)-&gt;e_findIvar</span><br><span class="line">cond_instanceVariables(no, right)-&gt;e_exception</span><br><span class="line">cond_findIvar(no, right)-&gt;e_exception</span><br></pre></td></tr></table></figure>
<p>以上为markdown语法，用的 MWebLite编写的，奈何blog不支持，所以直接将结果导图截图贴在下面：<br><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ftgaf779vdj315m10a7c9.jpg" alt=""></p>
<p>进入Foundation里面查看 <code>- (nullable id)valueForKey:(NSString *)key;</code> 方法的注解可以了解到，<strong><code>KVC的取值步骤</code></strong> 如下图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 调用valueForKey：</span><br><span class="line">e_findSucceed=&gt;end: 调用方法</span><br><span class="line">op1=&gt;operation: Operation1</span><br><span class="line">sub1=&gt;subroutine: My Subroutine</span><br><span class="line">cond_findMethod=&gt;condition: 按照 getKey</span><br><span class="line">key、isKey、</span><br><span class="line">_key、_getKey</span><br><span class="line">顺序查找方法</span><br><span class="line">cond_instanceVariables=&gt;condition: 查看</span><br><span class="line">accessInstance</span><br><span class="line">VariablesDirectly</span><br><span class="line">（默认返回YES）</span><br><span class="line">方法的返回值</span><br><span class="line">cond_findIvar=&gt;condition: 按照</span><br><span class="line">_key、_isKey</span><br><span class="line">key、isKey</span><br><span class="line">顺序查找</span><br><span class="line">成员变量</span><br><span class="line">e_findIvar=&gt;end: 直接取值</span><br><span class="line">e_exception=&gt;end: 调用</span><br><span class="line">valueForUndefinedKey：</span><br><span class="line">并且抛出</span><br><span class="line">NSUnKnownKeyException</span><br><span class="line"></span><br><span class="line">st-&gt;cond_findMethod</span><br><span class="line">cond_findMethod(yes, bottom)-&gt;e_findSucceed</span><br><span class="line">cond_findMethod(no, right)-&gt;cond_instanceVariables</span><br><span class="line">cond_instanceVariables(yes, bottom)-&gt;cond_findIvar</span><br><span class="line">cond_findIvar(yes, bottom)-&gt;e_findIvar</span><br><span class="line">cond_instanceVariables(no, right)-&gt;e_exception</span><br><span class="line">cond_findIvar(no, right)-&gt;e_exception</span><br></pre></td></tr></table></figure>
<p><img src="http://ww1.sinaimg.cn/large/005O0Zogly1ftgcd9stvjj30lx0i7mzu.jpg" alt=""></p>
<h4 id="接下来我们来验证一下："><a href="#接下来我们来验证一下：" class="headerlink" title="接下来我们来验证一下："></a>接下来我们来验证一下：</h4><p><strong>setValue：forKey：赋值</strong><br>使用上面的Person类，将属性全部删除，添加以下成员变量，重写两个set方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject &#123;</span><br><span class="line">    @public</span><br><span class="line">    int _age;</span><br><span class="line">    int _isAge;</span><br><span class="line">    int age;</span><br><span class="line">    int isAge;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">- (void)setAge:(NSInteger)age &#123;</span><br><span class="line">    NSLog(@&quot;--- setAge&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)_setAge:(NSInteger)age &#123;</span><br><span class="line">    NSLog(@&quot;--- _setAge&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后调用KVC给age赋值，可以看打印结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-07-20 14:41:18.679275+0800 KVC[65810:3455316] --- setAge</span><br></pre></td></tr></table></figure></p>
<p>此时调用的是 <code>setAge:</code> 方法，注释掉 <code>setAge:</code> 方法再次运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-07-20 14:41:43.561291+0800 KVC[65834:3456053] --- _setAge</span><br></pre></td></tr></table></figure></p>
<p>当这两个方法都没有实现的时候就会调用 <code>accessInstanceVariablesDirectly</code> 方法，若返回YES，则直接给成员变量赋值，如没有或返回值为NO则会调用 <code>setValue：forUndefinedKey：</code> 并且抛出NSUnKnownKeyException异常。<br><strong>valueForKey：取值</strong><br>重写流程图中的get方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (int)getAge &#123;</span><br><span class="line">    return 11;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int)age &#123;</span><br><span class="line">    return 12;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int)isAge &#123;</span><br><span class="line">    return 13;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int)_age &#123;</span><br><span class="line">    return 14;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (int)_getAge &#123;</span><br><span class="line">    return 15;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">打印结果：</span><br><span class="line">NSLog(@&quot;---- %@&quot;, [person valueForKey:@&quot;age&quot;]);</span><br></pre></td></tr></table></figure></p>
<p>如上我们可以查看当调用过的方法后就注释，直到执行完成所有的方法。我们可以控制 <code>accessInstanceVariablesDirectly</code> 方法的返回值来证明我们想要的结果。</p>
<h4 id="思考一下KVC能触发KVO吗？"><a href="#思考一下KVC能触发KVO吗？" class="headerlink" title="思考一下KVC能触发KVO吗？"></a>思考一下KVC能触发KVO吗？</h4><p>我们来测试一下，添加Observer类来监听并输出Log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@implementation Observer</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey, id&gt; *)change context:(void *)context &#123;</span><br><span class="line">    NSLog(@&quot;observeValueForKeyPath - %@&quot;, change);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">测试代码：</span><br><span class="line">Observer * ob = [Observer new];</span><br><span class="line">Person * person = [[Person alloc] init];</span><br><span class="line">[person addObserver:ob forKeyPath:@&quot;age&quot; options:NSKeyValueObservingOptionOld | NSKeyValueObservingOptionNew context:nil];</span><br><span class="line">        </span><br><span class="line">[person setValue:@1 forKey:@&quot;age&quot;];</span><br><span class="line">[person removeObserver:ob forKeyPath:@&quot;age&quot;];</span><br><span class="line"></span><br><span class="line">打印结果为：</span><br><span class="line">2018-07-20 15:19:30.526730+0800 KVC[67145:3507833] observeValueForKeyPath - &#123;</span><br><span class="line">    kind = 1;</span><br><span class="line">    new = 1;</span><br><span class="line">    old = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到KVC确实调用了KVO，<a href="https://jueying-xiangfeng.github.io/2018/07/17/KVO-KVC%E7%9A%84%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6-KVO%E7%AF%87/" target="_blank" rel="noopener">上一篇文章</a>中我们了解到了KVO的实现，接下来可以大概验证一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">在Person类中实现如下方法：</span><br><span class="line">- (void)willChangeValueForKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@&quot;willChangeValueForKey&quot;);</span><br><span class="line">    [super willChangeValueForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)didChangeValueForKey:(NSString *)key &#123;</span><br><span class="line">    NSLog(@&quot;didChangeValueForKey-- begin&quot;);</span><br><span class="line">    [super didChangeValueForKey:key];</span><br><span class="line">    NSLog(@&quot;didChangeValueForKey-- end&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">打印结果：</span><br><span class="line">2018-07-20 15:23:34.761496+0800 KVC[67256:3513685] willChangeValueForKey</span><br><span class="line">2018-07-20 15:23:34.761836+0800 KVC[67256:3513685] didChangeValueForKey-- begin</span><br><span class="line">2018-07-20 15:23:34.762151+0800 KVC[67256:3513685] observeValueForKeyPath - &#123;</span><br><span class="line">    kind = 1;</span><br><span class="line">    new = 1;</span><br><span class="line">    old = 0;</span><br><span class="line">&#125;</span><br><span class="line">2018-07-20 15:23:34.762202+0800 KVC[67256:3513685] didChangeValueForKey-- end</span><br></pre></td></tr></table></figure></p>
<p>可以看到打印结果跟KVO是一样的，这里可以猜测苹果大大在KVC内部的实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[person willChangeValueForKey:@&quot;age&quot;];</span><br><span class="line">person-&gt;_age = 1;</span><br><span class="line">[person didChangeValueForKey:@&quot;age&quot;];</span><br></pre></td></tr></table></figure></p>
<p>KVC相当于手动调用了KVO。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/21/category原理探究-1/" class="prev">上一篇</a><a href="/2018/07/17/KVO-KVC的原理探究-KVO篇/" class="next">下一篇</a></div><div class="copyright"><p>© 2018 - 2019 <a href="http://yoursite.com">Key</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>